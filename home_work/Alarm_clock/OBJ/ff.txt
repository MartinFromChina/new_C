; generated by Component: ARM Compiler 5.06 update 6 (build 750) Tool: ArmCC [4d3637]
; commandline ArmCC [--c99 --list --split_sections --debug -c --asm --interleave -o..\obj\ff.o --asm_dir=..\OBJ\ --list_dir=..\OBJ\ --depend=..\obj\ff.d --cpu=Cortex-M4.fp --apcs=interwork -O0 --diag_suppress=9931,870 -I..\CORE -I..\SYSTEM\delay -I..\SYSTEM\sys -I..\SYSTEM\usart -I..\USER -I..\HARDWARE\LED -I..\HARDWARE\LCD -I..\HARDWARE\KEY -I..\HARDWARE\SRAM -I..\HARDWARE\SDIO -I..\MALLOC -I..\USMART -I..\HARDWARE\SPI -I..\HARDWARE\W25QXX -I..\FATFS\exfuns -I..\FATFS\src -I..\TEXT -I..\FWLIB\inc -I..\HARDWARE\24CXX -I..\HARDWARE\IIC -I..\HARDWARE\I2S -I..\HARDWARE\WM8978 -I..\APP -I..\AUDIOCODEC\wav -I..\new_user -I..\new_user\task -I..\new_user\MVC -I..\..\..\module\common -I..\..\..\module\common\InsertLog -I..\..\..\module\common\loopqueue -I..\..\..\module\common\StateMachine -I..\..\..\module\common\priorityqueue -I..\..\..\module\common\Math -I..\..\..\module\component\const_loop_scheduler -I..\..\..\module\component\const_loop_scheduler\TemplateTask -I..\..\..\module\component\const_loop_scheduler\HierarchicalSM -I..\..\..\module\component\BlockableStateMachine -I..\..\..\module\customize\ButtonModule -I..\..\..\module\external\Segger\SEGGER_RTT_V640\Syscalls -I..\..\..\module\external\Segger\SEGGER_RTT_V640\RTT -I.\RTE\_AudioPlayer -I"D:\Program Files\ARM\PACK\Keil\STM32F4xx_DFP\2.7.0\Drivers\CMSIS\Device\ST\STM32F4xx\Include" -I"D:\Program Files\ARM\CMSIS\Include" -I"D:\Program Files\ARM\PACK\Keil\STM32F4xx_DFP\2.7.0\Device\Include" -D__MICROLIB -D__UVISION_VERSION=525 -DSTM32F407xx -DSTM32F40_41xxx -DUSE_STDPERIPH_DRIVER -DARM_COMPILER_PRESENT -DX_TASK_LOG_DEBUG_METHOD=SeggerRTT_LogDebug --omf_browse=..\obj\ff.crf ..\FATFS\src\ff.c]
                          THUMB

                          AREA ||i.check_fs||, CODE, READONLY, ALIGN=2

                  check_fs PROC
;;;2134   static
;;;2135   BYTE check_fs (	/* 0:FAT boor sector, 1:Valid boor sector but not FAT, 2:Not a boot sector, 3:Disk error */
000000  b570              PUSH     {r4-r6,lr}
;;;2136   	FATFS* fs,	/* File system object */
;;;2137   	DWORD sect	/* Sector# (lba) to check if it is an FAT boot record or not */
;;;2138   )
;;;2139   {
000002  4604              MOV      r4,r0
000004  460d              MOV      r5,r1
;;;2140   	fs->wflag = 0; fs->winsect = 0xFFFFFFFF;	/* Invaidate window */
000006  2000              MOVS     r0,#0
000008  7120              STRB     r0,[r4,#4]
00000a  1e40              SUBS     r0,r0,#1
00000c  62e0              STR      r0,[r4,#0x2c]
;;;2141   	if (move_window(fs, sect) != FR_OK)			/* Load boot record */
00000e  4629              MOV      r1,r5
000010  4620              MOV      r0,r4
000012  f7fffffe          BL       move_window
000016  b108              CBZ      r0,|L1.28|
;;;2142   		return 3;
000018  2003              MOVS     r0,#3
                  |L1.26|
;;;2143   
;;;2144   	if (LD_WORD(&fs->win[BS_55AA]) != 0xAA55)	/* Check boot record signature (always placed at offset 510 even if the sector size is >512) */
;;;2145   		return 2;
;;;2146   
;;;2147   	if ((LD_DWORD(&fs->win[BS_FilSysType]) & 0xFFFFFF) == 0x544146)		/* Check "FAT" string */
;;;2148   		return 0;
;;;2149   	if ((LD_DWORD(&fs->win[BS_FilSysType32]) & 0xFFFFFF) == 0x544146)	/* Check "FAT" string */
;;;2150   		return 0;
;;;2151   
;;;2152   	return 1;
;;;2153   }
00001a  bd70              POP      {r4-r6,pc}
                  |L1.28|
00001c  f894122e          LDRB     r1,[r4,#0x22e]        ;2144
000020  f894022f          LDRB     r0,[r4,#0x22f]        ;2144
000024  ea412000          ORR      r0,r1,r0,LSL #8       ;2144
000028  f64a2155          MOV      r1,#0xaa55            ;2144
00002c  4288              CMP      r0,r1                 ;2144
00002e  d001              BEQ      |L1.52|
000030  2002              MOVS     r0,#2                 ;2145
000032  e7f2              B        |L1.26|
                  |L1.52|
000034  f8940069          LDRB     r0,[r4,#0x69]         ;2147
000038  0601              LSLS     r1,r0,#24             ;2147
00003a  f8940068          LDRB     r0,[r4,#0x68]         ;2147
00003e  ea414100          ORR      r1,r1,r0,LSL #16      ;2147
000042  f8940067          LDRB     r0,[r4,#0x67]         ;2147
000046  ea412000          ORR      r0,r1,r0,LSL #8       ;2147
00004a  f8941066          LDRB     r1,[r4,#0x66]         ;2147
00004e  4308              ORRS     r0,r0,r1              ;2147
000050  f020407f          BIC      r0,r0,#0xff000000     ;2147
000054  490d              LDR      r1,|L1.140|
000056  4288              CMP      r0,r1                 ;2147
000058  d101              BNE      |L1.94|
00005a  2000              MOVS     r0,#0                 ;2148
00005c  e7dd              B        |L1.26|
                  |L1.94|
00005e  f8940085          LDRB     r0,[r4,#0x85]         ;2149
000062  0601              LSLS     r1,r0,#24             ;2149
000064  f8940084          LDRB     r0,[r4,#0x84]         ;2149
000068  ea414100          ORR      r1,r1,r0,LSL #16      ;2149
00006c  f8940083          LDRB     r0,[r4,#0x83]         ;2149
000070  ea412000          ORR      r0,r1,r0,LSL #8       ;2149
000074  f8941082          LDRB     r1,[r4,#0x82]         ;2149
000078  4308              ORRS     r0,r0,r1              ;2149
00007a  f020407f          BIC      r0,r0,#0xff000000     ;2149
00007e  4903              LDR      r1,|L1.140|
000080  4288              CMP      r0,r1                 ;2149
000082  d101              BNE      |L1.136|
000084  2000              MOVS     r0,#0                 ;2150
000086  e7c8              B        |L1.26|
                  |L1.136|
000088  2001              MOVS     r0,#1                 ;2152
00008a  e7c6              B        |L1.26|
;;;2154   
                          ENDP

                  |L1.140|
                          DCD      0x00544146

                          AREA ||i.chk_chr||, CODE, READONLY, ALIGN=1

                  chk_chr PROC
;;;597    static
;;;598    int chk_chr (const char* str, int chr) {
000000  4602              MOV      r2,r0
;;;599    	while (*str && *str != chr) str++;
000002  e000              B        |L2.6|
                  |L2.4|
000004  1c52              ADDS     r2,r2,#1
                  |L2.6|
000006  7810              LDRB     r0,[r2,#0]
000008  b110              CBZ      r0,|L2.16|
00000a  7810              LDRB     r0,[r2,#0]
00000c  4288              CMP      r0,r1
00000e  d1f9              BNE      |L2.4|
                  |L2.16|
;;;600    	return *str;
000010  7810              LDRB     r0,[r2,#0]
;;;601    }
000012  4770              BX       lr
;;;602    
                          ENDP


                          AREA ||i.clmt_clust||, CODE, READONLY, ALIGN=1

                  clmt_clust PROC
;;;1088   static
;;;1089   DWORD clmt_clust (	/* <2:Error, >=2:Cluster number */
000000  b570              PUSH     {r4-r6,lr}
;;;1090   	FIL* fp,		/* Pointer to the file object */
;;;1091   	DWORD ofs		/* File offset to be converted to cluster# */
;;;1092   )
;;;1093   {
000002  4603              MOV      r3,r0
000004  460d              MOV      r5,r1
;;;1094   	DWORD cl, ncl, *tbl;
;;;1095   
;;;1096   
;;;1097   	tbl = fp->cltbl + 1;	/* Top of CLMT */
000006  6a58              LDR      r0,[r3,#0x24]
000008  1d02              ADDS     r2,r0,#4
;;;1098   	cl = ofs / SS(fp->fs) / fp->fs->csize;	/* Cluster order from top of the file */
00000a  0a68              LSRS     r0,r5,#9
00000c  681e              LDR      r6,[r3,#0]
00000e  78b6              LDRB     r6,[r6,#2]
000010  fbb0f4f6          UDIV     r4,r0,r6
;;;1099   	for (;;) {
000014  bf00              NOP      
                  |L3.22|
;;;1100   		ncl = *tbl++;			/* Number of cluters in the fragment */
000016  ca02              LDM      r2!,{r1}
;;;1101   		if (!ncl) return 0;		/* End of table? (error) */
000018  b909              CBNZ     r1,|L3.30|
00001a  2000              MOVS     r0,#0
                  |L3.28|
;;;1102   		if (cl < ncl) break;	/* In this fragment? */
;;;1103   		cl -= ncl; tbl++;		/* Next fragment */
;;;1104   	}
;;;1105   	return cl + *tbl;	/* Return the cluster number */
;;;1106   }
00001c  bd70              POP      {r4-r6,pc}
                  |L3.30|
00001e  428c              CMP      r4,r1                 ;1102
000020  d200              BCS      |L3.36|
000022  e002              B        |L3.42|
                  |L3.36|
000024  1a64              SUBS     r4,r4,r1              ;1103
000026  1d12              ADDS     r2,r2,#4              ;1103
000028  e7f5              B        |L3.22|
                  |L3.42|
00002a  bf00              NOP                            ;1102
00002c  6810              LDR      r0,[r2,#0]            ;1105
00002e  4420              ADD      r0,r0,r4              ;1105
000030  e7f4              B        |L3.28|
;;;1107   #endif	/* _USE_FASTSEEK */
                          ENDP


                          AREA ||i.clust2sect||, CODE, READONLY, ALIGN=1

                  clust2sect PROC
;;;846    
;;;847    DWORD clust2sect (	/* !=0: Sector number, 0: Failed - invalid cluster# */
000000  4602              MOV      r2,r0
;;;848    	FATFS* fs,		/* File system object */
;;;849    	DWORD clst		/* Cluster# to be converted */
;;;850    )
;;;851    {
;;;852    	clst -= 2;
000002  1e89              SUBS     r1,r1,#2
;;;853    	if (clst >= (fs->n_fatent - 2)) return 0;		/* Invalid cluster# */
000004  6950              LDR      r0,[r2,#0x14]
000006  1e80              SUBS     r0,r0,#2
000008  4288              CMP      r0,r1
00000a  d801              BHI      |L4.16|
00000c  2000              MOVS     r0,#0
                  |L4.14|
;;;854    	return clst * fs->csize + fs->database;
;;;855    }
00000e  4770              BX       lr
                  |L4.16|
000010  7893              LDRB     r3,[r2,#2]            ;854
000012  6a90              LDR      r0,[r2,#0x28]         ;854
000014  fb010003          MLA      r0,r1,r3,r0           ;854
000018  e7f9              B        |L4.14|
;;;856    
                          ENDP


                          AREA ||i.cmp_lfn||, CODE, READONLY, ALIGN=2

                  cmp_lfn PROC
;;;1307   static
;;;1308   int cmp_lfn (			/* 1:Matched, 0:Not matched */
000000  e92d47f0          PUSH     {r4-r10,lr}
;;;1309   	WCHAR* lfnbuf,		/* Pointer to the LFN to be compared */
;;;1310   	BYTE* dir			/* Pointer to the directory entry containing a part of LFN */
;;;1311   )
;;;1312   {
000004  4605              MOV      r5,r0
000006  460c              MOV      r4,r1
;;;1313   	UINT i, s;
;;;1314   	WCHAR wc, uc;
;;;1315   
;;;1316   
;;;1317   	i = ((dir[LDIR_Ord] & ~LLE) - 1) * 13;	/* Get offset in the LFN buffer */
000008  7820              LDRB     r0,[r4,#0]
00000a  f0200040          BIC      r0,r0,#0x40
00000e  1e40              SUBS     r0,r0,#1
000010  eb000180          ADD      r1,r0,r0,LSL #2
000014  eb0106c0          ADD      r6,r1,r0,LSL #3
;;;1318   	s = 0; wc = 1;
000018  2700              MOVS     r7,#0
00001a  f04f0801          MOV      r8,#1
;;;1319   	do {
00001e  bf00              NOP      
                  |L5.32|
;;;1320   		uc = LD_WORD(dir+LfnOfs[s]);	/* Pick an LFN character from the entry */
000020  481a              LDR      r0,|L5.140|
000022  5dc0              LDRB     r0,[r0,r7]
000024  5c20              LDRB     r0,[r4,r0]
000026  4919              LDR      r1,|L5.140|
000028  5dc9              LDRB     r1,[r1,r7]
00002a  4421              ADD      r1,r1,r4
00002c  7849              LDRB     r1,[r1,#1]
00002e  ea402901          ORR      r9,r0,r1,LSL #8
;;;1321   		if (wc) {	/* Last character has not been processed */
000032  f1b80f00          CMP      r8,#0
000036  d010              BEQ      |L5.90|
;;;1322   			wc = ff_wtoupper(uc);		/* Convert it to upper case */
000038  4648              MOV      r0,r9
00003a  f7fffffe          BL       ff_wtoupper
00003e  4680              MOV      r8,r0
;;;1323   			if (i >= _MAX_LFN || wc != ff_wtoupper(lfnbuf[i++]))	/* Compare it */
000040  2eff              CMP      r6,#0xff
000042  d207              BCS      |L5.84|
000044  4631              MOV      r1,r6
000046  1c76              ADDS     r6,r6,#1
000048  f8350011          LDRH     r0,[r5,r1,LSL #1]
00004c  f7fffffe          BL       ff_wtoupper
000050  4540              CMP      r0,r8
000052  d008              BEQ      |L5.102|
                  |L5.84|
;;;1324   				return 0;				/* Not matched */
000054  2000              MOVS     r0,#0
                  |L5.86|
;;;1325   		} else {
;;;1326   			if (uc != 0xFFFF) return 0;	/* Check filler */
;;;1327   		}
;;;1328   	} while (++s < 13);				/* Repeat until all characters in the entry are checked */
;;;1329   
;;;1330   	if ((dir[LDIR_Ord] & LLE) && wc && lfnbuf[i])	/* Last segment matched but different length */
;;;1331   		return 0;
;;;1332   
;;;1333   	return 1;						/* The part of LFN matched */
;;;1334   }
000056  e8bd87f0          POP      {r4-r10,pc}
                  |L5.90|
00005a  f64f70ff          MOV      r0,#0xffff            ;1326
00005e  4581              CMP      r9,r0                 ;1326
000060  d001              BEQ      |L5.102|
000062  2000              MOVS     r0,#0                 ;1326
000064  e7f7              B        |L5.86|
                  |L5.102|
000066  1c78              ADDS     r0,r7,#1              ;1328
000068  4607              MOV      r7,r0                 ;1328
00006a  280d              CMP      r0,#0xd               ;1328
00006c  d3d8              BCC      |L5.32|
00006e  7820              LDRB     r0,[r4,#0]            ;1330
000070  f0000040          AND      r0,r0,#0x40           ;1330
000074  b138              CBZ      r0,|L5.134|
000076  f1b80f00          CMP      r8,#0                 ;1330
00007a  d004              BEQ      |L5.134|
00007c  f8350016          LDRH     r0,[r5,r6,LSL #1]     ;1330
000080  b108              CBZ      r0,|L5.134|
000082  2000              MOVS     r0,#0                 ;1331
000084  e7e7              B        |L5.86|
                  |L5.134|
000086  2001              MOVS     r0,#1                 ;1333
000088  e7e5              B        |L5.86|
;;;1335   
                          ENDP

00008a  0000              DCW      0x0000
                  |L5.140|
                          DCD      LfnOfs

                          AREA ||i.create_chain||, CODE, READONLY, ALIGN=1

                  create_chain PROC
;;;1026   static
;;;1027   DWORD create_chain (	/* 0:No free cluster, 1:Internal error, 0xFFFFFFFF:Disk error, >=2:New cluster# */
000000  e92d47f0          PUSH     {r4-r10,lr}
;;;1028   	FATFS* fs,			/* File system object */
;;;1029   	DWORD clst			/* Cluster# to stretch. 0 means create a new chain. */
;;;1030   )
;;;1031   {
000004  4604              MOV      r4,r0
000006  4689              MOV      r9,r1
;;;1032   	DWORD cs, ncl, scl;
;;;1033   	FRESULT res;
;;;1034   
;;;1035   
;;;1036   	if (clst == 0) {		/* Create a new chain */
000008  f1b90f00          CMP      r9,#0
00000c  d106              BNE      |L6.28|
;;;1037   		scl = fs->last_clust;			/* Get suggested start point */
00000e  68e7              LDR      r7,[r4,#0xc]
;;;1038   		if (!scl || scl >= fs->n_fatent) scl = 1;
000010  b117              CBZ      r7,|L6.24|
000012  6960              LDR      r0,[r4,#0x14]
000014  42b8              CMP      r0,r7
000016  d815              BHI      |L6.68|
                  |L6.24|
000018  2701              MOVS     r7,#1
00001a  e013              B        |L6.68|
                  |L6.28|
;;;1039   	}
;;;1040   	else {					/* Stretch the current chain */
;;;1041   		cs = get_fat(fs, clst);			/* Check the cluster status */
00001c  4649              MOV      r1,r9
00001e  4620              MOV      r0,r4
000020  f7fffffe          BL       get_fat
000024  4606              MOV      r6,r0
;;;1042   		if (cs < 2) return 1;			/* Invalid value */
000026  2e02              CMP      r6,#2
000028  d202              BCS      |L6.48|
00002a  2001              MOVS     r0,#1
                  |L6.44|
;;;1043   		if (cs == 0xFFFFFFFF) return cs;	/* A disk error occurred */
;;;1044   		if (cs < fs->n_fatent) return cs;	/* It is already followed by next cluster */
;;;1045   		scl = clst;
;;;1046   	}
;;;1047   
;;;1048   	ncl = scl;				/* Start cluster */
;;;1049   	for (;;) {
;;;1050   		ncl++;							/* Next cluster */
;;;1051   		if (ncl >= fs->n_fatent) {		/* Check wrap around */
;;;1052   			ncl = 2;
;;;1053   			if (ncl > scl) return 0;	/* No free cluster */
;;;1054   		}
;;;1055   		cs = get_fat(fs, ncl);			/* Get the cluster status */
;;;1056   		if (cs == 0) break;				/* Found a free cluster */
;;;1057   		if (cs == 0xFFFFFFFF || cs == 1)/* An error occurred */
;;;1058   			return cs;
;;;1059   		if (ncl == scl) return 0;		/* No free cluster */
;;;1060   	}
;;;1061   
;;;1062   	res = put_fat(fs, ncl, 0x0FFFFFFF);	/* Mark the new cluster "last link" */
;;;1063   	if (res == FR_OK && clst != 0) {
;;;1064   		res = put_fat(fs, clst, ncl);	/* Link it to the previous one if needed */
;;;1065   	}
;;;1066   	if (res == FR_OK) {
;;;1067   		fs->last_clust = ncl;			/* Update FSINFO */
;;;1068   		if (fs->free_clust != 0xFFFFFFFF) {
;;;1069   			fs->free_clust--;
;;;1070   			fs->fsi_flag |= 1;
;;;1071   		}
;;;1072   	} else {
;;;1073   		ncl = (res == FR_DISK_ERR) ? 0xFFFFFFFF : 1;
;;;1074   	}
;;;1075   
;;;1076   	return ncl;		/* Return new cluster number or error code */
;;;1077   }
00002c  e8bd87f0          POP      {r4-r10,pc}
                  |L6.48|
000030  1c70              ADDS     r0,r6,#1              ;1043
000032  b908              CBNZ     r0,|L6.56|
000034  4630              MOV      r0,r6                 ;1043
000036  e7f9              B        |L6.44|
                  |L6.56|
000038  6960              LDR      r0,[r4,#0x14]         ;1044
00003a  42b0              CMP      r0,r6                 ;1044
00003c  d901              BLS      |L6.66|
00003e  4630              MOV      r0,r6                 ;1044
000040  e7f4              B        |L6.44|
                  |L6.66|
000042  464f              MOV      r7,r9                 ;1045
                  |L6.68|
000044  463d              MOV      r5,r7                 ;1048
000046  bf00              NOP                            ;1049
                  |L6.72|
000048  1c6d              ADDS     r5,r5,#1              ;1050
00004a  6960              LDR      r0,[r4,#0x14]         ;1051
00004c  42a8              CMP      r0,r5                 ;1051
00004e  d804              BHI      |L6.90|
000050  2502              MOVS     r5,#2                 ;1052
000052  42bd              CMP      r5,r7                 ;1053
000054  d901              BLS      |L6.90|
000056  2000              MOVS     r0,#0                 ;1053
000058  e7e8              B        |L6.44|
                  |L6.90|
00005a  4629              MOV      r1,r5                 ;1055
00005c  4620              MOV      r0,r4                 ;1055
00005e  f7fffffe          BL       get_fat
000062  4606              MOV      r6,r0                 ;1055
000064  b906              CBNZ     r6,|L6.104|
000066  e009              B        |L6.124|
                  |L6.104|
000068  1c70              ADDS     r0,r6,#1              ;1057
00006a  b108              CBZ      r0,|L6.112|
00006c  2e01              CMP      r6,#1                 ;1057
00006e  d101              BNE      |L6.116|
                  |L6.112|
000070  4630              MOV      r0,r6                 ;1058
000072  e7db              B        |L6.44|
                  |L6.116|
000074  42bd              CMP      r5,r7                 ;1059
000076  d1e7              BNE      |L6.72|
000078  2000              MOVS     r0,#0                 ;1059
00007a  e7d7              B        |L6.44|
                  |L6.124|
00007c  bf00              NOP                            ;1056
00007e  f06f4270          MVN      r2,#0xf0000000        ;1062
000082  4629              MOV      r1,r5                 ;1062
000084  4620              MOV      r0,r4                 ;1062
000086  f7fffffe          BL       put_fat
00008a  4680              MOV      r8,r0                 ;1062
00008c  f1b80f00          CMP      r8,#0                 ;1063
000090  d108              BNE      |L6.164|
000092  f1b90f00          CMP      r9,#0                 ;1063
000096  d005              BEQ      |L6.164|
000098  462a              MOV      r2,r5                 ;1064
00009a  4649              MOV      r1,r9                 ;1064
00009c  4620              MOV      r0,r4                 ;1064
00009e  f7fffffe          BL       put_fat
0000a2  4680              MOV      r8,r0                 ;1064
                  |L6.164|
0000a4  f1b80f00          CMP      r8,#0                 ;1066
0000a8  d10b              BNE      |L6.194|
0000aa  60e5              STR      r5,[r4,#0xc]          ;1067
0000ac  6920              LDR      r0,[r4,#0x10]         ;1068
0000ae  1c40              ADDS     r0,r0,#1              ;1068
0000b0  b178              CBZ      r0,|L6.210|
0000b2  6920              LDR      r0,[r4,#0x10]         ;1069
0000b4  1e40              SUBS     r0,r0,#1              ;1069
0000b6  6120              STR      r0,[r4,#0x10]         ;1069
0000b8  7960              LDRB     r0,[r4,#5]            ;1070
0000ba  f0400001          ORR      r0,r0,#1              ;1070
0000be  7160              STRB     r0,[r4,#5]            ;1070
0000c0  e007              B        |L6.210|
                  |L6.194|
0000c2  f1b80f01          CMP      r8,#1                 ;1073
0000c6  d102              BNE      |L6.206|
0000c8  f04f30ff          MOV      r0,#0xffffffff        ;1073
0000cc  e000              B        |L6.208|
                  |L6.206|
0000ce  2001              MOVS     r0,#1                 ;1073
                  |L6.208|
0000d0  4605              MOV      r5,r0                 ;1073
                  |L6.210|
0000d2  4628              MOV      r0,r5                 ;1076
0000d4  e7aa              B        |L6.44|
;;;1078   #endif /* !_FS_READONLY */
                          ENDP


                          AREA ||i.create_name||, CODE, READONLY, ALIGN=2

                  create_name PROC
;;;1803   static
;;;1804   FRESULT create_name (
000000  e92d4ff3          PUSH     {r0,r1,r4-r11,lr}
;;;1805   	DIR* dp,			/* Pointer to the directory object */
;;;1806   	const TCHAR** path	/* Pointer to pointer to the segment in the path string */
;;;1807   )
;;;1808   {
000004  b083              SUB      sp,sp,#0xc
000006  4681              MOV      r9,r0
;;;1809   #if _USE_LFN	/* LFN configuration */
;;;1810   	BYTE b, cf;
;;;1811   	WCHAR w, *lfn;
;;;1812   	UINT i, ni, si, di;
;;;1813   	const TCHAR *p;
;;;1814   
;;;1815   	/* Create LFN in Unicode */
;;;1816   	for (p = *path; *p == '/' || *p == '\\'; p++) ;	/* Strip duplicated separator */
000008  9804              LDR      r0,[sp,#0x10]
00000a  6800              LDR      r0,[r0,#0]
00000c  9001              STR      r0,[sp,#4]
00000e  e002              B        |L7.22|
                  |L7.16|
000010  9801              LDR      r0,[sp,#4]
000012  1c40              ADDS     r0,r0,#1
000014  9001              STR      r0,[sp,#4]
                  |L7.22|
000016  9801              LDR      r0,[sp,#4]
000018  7800              LDRB     r0,[r0,#0]
00001a  282f              CMP      r0,#0x2f
00001c  d0f8              BEQ      |L7.16|
00001e  9801              LDR      r0,[sp,#4]
000020  7800              LDRB     r0,[r0,#0]
000022  285c              CMP      r0,#0x5c
000024  d0f4              BEQ      |L7.16|
;;;1817   	lfn = dp->lfn;
000026  f8d9a01c          LDR      r10,[r9,#0x1c]
;;;1818   	si = di = 0;
00002a  2500              MOVS     r5,#0
00002c  462f              MOV      r7,r5
;;;1819   	for (;;) {
00002e  bf00              NOP      
                  |L7.48|
;;;1820   		w = p[si++];					/* Get a character */
000030  4638              MOV      r0,r7
000032  1c7f              ADDS     r7,r7,#1
000034  9901              LDR      r1,[sp,#4]
000036  5c0c              LDRB     r4,[r1,r0]
;;;1821   		if (w < ' ' || w == '/' || w == '\\') break;	/* Break on end of segment */
000038  2c20              CMP      r4,#0x20
00003a  db03              BLT      |L7.68|
00003c  2c2f              CMP      r4,#0x2f
00003e  d001              BEQ      |L7.68|
000040  2c5c              CMP      r4,#0x5c
000042  d100              BNE      |L7.70|
                  |L7.68|
000044  e032              B        |L7.172|
                  |L7.70|
;;;1822   		if (di >= _MAX_LFN)				/* Reject too long name */
000046  2dff              CMP      r5,#0xff
000048  d303              BCC      |L7.82|
;;;1823   			return FR_INVALID_NAME;
00004a  2006              MOVS     r0,#6
                  |L7.76|
;;;1824   #if !_LFN_UNICODE
;;;1825   		w &= 0xFF;
;;;1826   		if (IsDBCS1(w)) {				/* Check if it is a DBC 1st byte (always false on SBCS cfg) */
;;;1827   			b = (BYTE)p[si++];			/* Get 2nd byte */
;;;1828   			if (!IsDBCS2(b))
;;;1829   				return FR_INVALID_NAME;	/* Reject invalid sequence */
;;;1830   			w = (w << 8) + b;			/* Create a DBC */
;;;1831   		}
;;;1832   		w = ff_convert(w, 1);			/* Convert ANSI/OEM to Unicode */
;;;1833   		if (!w) return FR_INVALID_NAME;	/* Reject invalid code */
;;;1834   #endif
;;;1835   		if (w < 0x80 && chk_chr("\"*:<>\?|\x7F", w)) /* Reject illegal characters for LFN */
;;;1836   			return FR_INVALID_NAME;
;;;1837   		lfn[di++] = w;					/* Store the Unicode character */
;;;1838   	}
;;;1839   	*path = &p[si];						/* Return pointer to the next segment */
;;;1840   	cf = (w < ' ') ? NS_LAST : 0;		/* Set last segment flag if end of path */
;;;1841   #if _FS_RPATH
;;;1842   	if ((di == 1 && lfn[di-1] == '.') || /* Is this a dot entry? */
;;;1843   		(di == 2 && lfn[di-1] == '.' && lfn[di-2] == '.')) {
;;;1844   		lfn[di] = 0;
;;;1845   		for (i = 0; i < 11; i++)
;;;1846   			dp->fn[i] = (i < di) ? '.' : ' ';
;;;1847   		dp->fn[i] = cf | NS_DOT;		/* This is a dot entry */
;;;1848   		return FR_OK;
;;;1849   	}
;;;1850   #endif
;;;1851   	while (di) {						/* Strip trailing spaces and dots */
;;;1852   		w = lfn[di-1];
;;;1853   		if (w != ' ' && w != '.') break;
;;;1854   		di--;
;;;1855   	}
;;;1856   	if (!di) return FR_INVALID_NAME;	/* Reject nul string */
;;;1857   
;;;1858   	lfn[di] = 0;						/* LFN is created */
;;;1859   
;;;1860   	/* Create SFN in directory form */
;;;1861   	mem_set(dp->fn, ' ', 11);
;;;1862   	for (si = 0; lfn[si] == ' ' || lfn[si] == '.'; si++) ;	/* Strip leading spaces and dots */
;;;1863   	if (si) cf |= NS_LOSS | NS_LFN;
;;;1864   	while (di && lfn[di - 1] != '.') di--;	/* Find extension (di<=si: no extension) */
;;;1865   
;;;1866   	b = i = 0; ni = 8;
;;;1867   	for (;;) {
;;;1868   		w = lfn[si++];					/* Get an LFN character */
;;;1869   		if (!w) break;					/* Break on end of the LFN */
;;;1870   		if (w == ' ' || (w == '.' && si != di)) {	/* Remove spaces and dots */
;;;1871   			cf |= NS_LOSS | NS_LFN; continue;
;;;1872   		}
;;;1873   
;;;1874   		if (i >= ni || si == di) {		/* Extension or end of SFN */
;;;1875   			if (ni == 11) {				/* Long extension */
;;;1876   				cf |= NS_LOSS | NS_LFN; break;
;;;1877   			}
;;;1878   			if (si != di) cf |= NS_LOSS | NS_LFN;	/* Out of 8.3 format */
;;;1879   			if (si > di) break;			/* No extension */
;;;1880   			si = di; i = 8; ni = 11;	/* Enter extension section */
;;;1881   			b <<= 2; continue;
;;;1882   		}
;;;1883   
;;;1884   		if (w >= 0x80) {				/* Non ASCII character */
;;;1885   #ifdef _EXCVT
;;;1886   			w = ff_convert(w, 0);		/* Unicode -> OEM code */
;;;1887   			if (w) w = ExCvt[w - 0x80];	/* Convert extended character to upper (SBCS) */
;;;1888   #else
;;;1889   			w = ff_convert(ff_wtoupper(w), 0);	/* Upper converted Unicode -> OEM code */
;;;1890   #endif
;;;1891   			cf |= NS_LFN;				/* Force create LFN entry */
;;;1892   		}
;;;1893   
;;;1894   		if (_DF1S && w >= 0x100) {		/* Double byte character (always false on SBCS cfg) */
;;;1895   			if (i >= ni - 1) {
;;;1896   				cf |= NS_LOSS | NS_LFN; i = ni; continue;
;;;1897   			}
;;;1898   			dp->fn[i++] = (BYTE)(w >> 8);
;;;1899   		} else {						/* Single byte character */
;;;1900   			if (!w || chk_chr("+,;=[]", w)) {	/* Replace illegal characters for SFN */
;;;1901   				w = '_'; cf |= NS_LOSS | NS_LFN;/* Lossy conversion */
;;;1902   			} else {
;;;1903   				if (IsUpper(w)) {		/* ASCII large capital */
;;;1904   					b |= 2;
;;;1905   				} else {
;;;1906   					if (IsLower(w)) {	/* ASCII small capital */
;;;1907   						b |= 1; w -= 0x20;
;;;1908   					}
;;;1909   				}
;;;1910   			}
;;;1911   		}
;;;1912   		dp->fn[i++] = (BYTE)w;
;;;1913   	}
;;;1914   
;;;1915   	if (dp->fn[0] == DDE) dp->fn[0] = NDDE;	/* If the first character collides with deleted mark, replace it with 0x05 */
;;;1916   
;;;1917   	if (ni == 8) b <<= 2;
;;;1918   	if ((b & 0x0C) == 0x0C || (b & 0x03) == 0x03)	/* Create LFN entry when there are composite capitals */
;;;1919   		cf |= NS_LFN;
;;;1920   	if (!(cf & NS_LFN)) {						/* When LFN is in 8.3 format without extended character, NT flags are created */
;;;1921   		if ((b & 0x03) == 0x01) cf |= NS_EXT;	/* NT flag (Extension has only small capital) */
;;;1922   		if ((b & 0x0C) == 0x04) cf |= NS_BODY;	/* NT flag (Filename has only small capital) */
;;;1923   	}
;;;1924   
;;;1925   	dp->fn[NS] = cf;	/* SFN is created */
;;;1926   
;;;1927   	return FR_OK;
;;;1928   
;;;1929   
;;;1930   #else	/* Non-LFN configuration */
;;;1931   	BYTE b, c, d, *sfn;
;;;1932   	UINT ni, si, i;
;;;1933   	const char *p;
;;;1934   
;;;1935   	/* Create file name in directory form */
;;;1936   	for (p = *path; *p == '/' || *p == '\\'; p++) ;	/* Strip duplicated separator */
;;;1937   	sfn = dp->fn;
;;;1938   	mem_set(sfn, ' ', 11);
;;;1939   	si = i = b = 0; ni = 8;
;;;1940   #if _FS_RPATH
;;;1941   	if (p[si] == '.') { /* Is this a dot entry? */
;;;1942   		for (;;) {
;;;1943   			c = (BYTE)p[si++];
;;;1944   			if (c != '.' || si >= 3) break;
;;;1945   			sfn[i++] = c;
;;;1946   		}
;;;1947   		if (c != '/' && c != '\\' && c > ' ') return FR_INVALID_NAME;
;;;1948   		*path = &p[si];									/* Return pointer to the next segment */
;;;1949   		sfn[NS] = (c <= ' ') ? NS_LAST | NS_DOT : NS_DOT;	/* Set last segment flag if end of path */
;;;1950   		return FR_OK;
;;;1951   	}
;;;1952   #endif
;;;1953   	for (;;) {
;;;1954   		c = (BYTE)p[si++];
;;;1955   		if (c <= ' ' || c == '/' || c == '\\') break;	/* Break on end of segment */
;;;1956   		if (c == '.' || i >= ni) {
;;;1957   			if (ni != 8 || c != '.') return FR_INVALID_NAME;
;;;1958   			i = 8; ni = 11;
;;;1959   			b <<= 2; continue;
;;;1960   		}
;;;1961   		if (c >= 0x80) {				/* Extended character? */
;;;1962   			b |= 3;						/* Eliminate NT flag */
;;;1963   #ifdef _EXCVT
;;;1964   			c = ExCvt[c - 0x80];		/* To upper extended characters (SBCS cfg) */
;;;1965   #else
;;;1966   #if !_DF1S
;;;1967   			return FR_INVALID_NAME;		/* Reject extended characters (ASCII cfg) */
;;;1968   #endif
;;;1969   #endif
;;;1970   		}
;;;1971   		if (IsDBCS1(c)) {				/* Check if it is a DBC 1st byte (always false on SBCS cfg) */
;;;1972   			d = (BYTE)p[si++];			/* Get 2nd byte */
;;;1973   			if (!IsDBCS2(d) || i >= ni - 1)	/* Reject invalid DBC */
;;;1974   				return FR_INVALID_NAME;
;;;1975   			sfn[i++] = c;
;;;1976   			sfn[i++] = d;
;;;1977   		} else {						/* Single byte code */
;;;1978   			if (chk_chr("\"*+,:;<=>\?[]|\x7F", c))	/* Reject illegal chrs for SFN */
;;;1979   				return FR_INVALID_NAME;
;;;1980   			if (IsUpper(c)) {			/* ASCII large capital? */
;;;1981   				b |= 2;
;;;1982   			} else {
;;;1983   				if (IsLower(c)) {		/* ASCII small capital? */
;;;1984   					b |= 1; c -= 0x20;
;;;1985   				}
;;;1986   			}
;;;1987   			sfn[i++] = c;
;;;1988   		}
;;;1989   	}
;;;1990   	*path = &p[si];						/* Return pointer to the next segment */
;;;1991   	c = (c <= ' ') ? NS_LAST : 0;		/* Set last segment flag if end of path */
;;;1992   
;;;1993   	if (!i) return FR_INVALID_NAME;		/* Reject nul string */
;;;1994   	if (sfn[0] == DDE) sfn[0] = NDDE;	/* When first character collides with DDE, replace it with 0x05 */
;;;1995   
;;;1996   	if (ni == 8) b <<= 2;
;;;1997   	if ((b & 0x03) == 0x01) c |= NS_EXT;	/* NT flag (Name extension has only small capital) */
;;;1998   	if ((b & 0x0C) == 0x04) c |= NS_BODY;	/* NT flag (Name body has only small capital) */
;;;1999   
;;;2000   	sfn[NS] = c;		/* Store NT flag, File name is created */
;;;2001   
;;;2002   	return FR_OK;
;;;2003   #endif
;;;2004   }
00004c  b005              ADD      sp,sp,#0x14
00004e  e8bd8ff0          POP      {r4-r11,pc}
                  |L7.82|
000052  b2e4              UXTB     r4,r4                 ;1825
000054  2c81              CMP      r4,#0x81              ;1826
000056  db13              BLT      |L7.128|
000058  b2e0              UXTB     r0,r4                 ;1826
00005a  28fe              CMP      r0,#0xfe              ;1826
00005c  dc10              BGT      |L7.128|
00005e  4638              MOV      r0,r7                 ;1827
000060  1c7f              ADDS     r7,r7,#1              ;1827
000062  9901              LDR      r1,[sp,#4]            ;1827
000064  5c0e              LDRB     r6,[r1,r0]            ;1827
000066  2e40              CMP      r6,#0x40              ;1828
000068  db01              BLT      |L7.110|
00006a  2e7e              CMP      r6,#0x7e              ;1828
00006c  dd05              BLE      |L7.122|
                  |L7.110|
00006e  2e80              CMP      r6,#0x80              ;1828
000070  db01              BLT      |L7.118|
000072  2efe              CMP      r6,#0xfe              ;1828
000074  dd01              BLE      |L7.122|
                  |L7.118|
000076  2006              MOVS     r0,#6                 ;1829
000078  e7e8              B        |L7.76|
                  |L7.122|
00007a  eb062004          ADD      r0,r6,r4,LSL #8       ;1830
00007e  b284              UXTH     r4,r0                 ;1830
                  |L7.128|
000080  2101              MOVS     r1,#1                 ;1832
000082  4620              MOV      r0,r4                 ;1832
000084  f7fffffe          BL       ff_convert
000088  4604              MOV      r4,r0                 ;1832
00008a  b90c              CBNZ     r4,|L7.144|
00008c  2006              MOVS     r0,#6                 ;1833
00008e  e7dd              B        |L7.76|
                  |L7.144|
000090  2c80              CMP      r4,#0x80              ;1835
000092  da06              BGE      |L7.162|
000094  4621              MOV      r1,r4                 ;1835
000096  a071              ADR      r0,|L7.604|
000098  f7fffffe          BL       chk_chr
00009c  b108              CBZ      r0,|L7.162|
00009e  2006              MOVS     r0,#6                 ;1836
0000a0  e7d4              B        |L7.76|
                  |L7.162|
0000a2  4628              MOV      r0,r5                 ;1837
0000a4  1c6d              ADDS     r5,r5,#1              ;1837
0000a6  f82a4010          STRH     r4,[r10,r0,LSL #1]    ;1837
0000aa  e7c1              B        |L7.48|
                  |L7.172|
0000ac  bf00              NOP                            ;1821
0000ae  9801              LDR      r0,[sp,#4]            ;1839
0000b0  19c1              ADDS     r1,r0,r7              ;1839
0000b2  9804              LDR      r0,[sp,#0x10]         ;1839
0000b4  6001              STR      r1,[r0,#0]            ;1839
0000b6  2c20              CMP      r4,#0x20              ;1840
0000b8  da01              BGE      |L7.190|
0000ba  2004              MOVS     r0,#4                 ;1840
0000bc  e000              B        |L7.192|
                  |L7.190|
0000be  2000              MOVS     r0,#0                 ;1840
                  |L7.192|
0000c0  4680              MOV      r8,r0                 ;1840
0000c2  e008              B        |L7.214|
                  |L7.196|
0000c4  1e68              SUBS     r0,r5,#1              ;1852
0000c6  f83a4010          LDRH     r4,[r10,r0,LSL #1]    ;1852
0000ca  2c20              CMP      r4,#0x20              ;1853
0000cc  d002              BEQ      |L7.212|
0000ce  2c2e              CMP      r4,#0x2e              ;1853
0000d0  d000              BEQ      |L7.212|
0000d2  e002              B        |L7.218|
                  |L7.212|
0000d4  1e6d              SUBS     r5,r5,#1              ;1854
                  |L7.214|
0000d6  2d00              CMP      r5,#0                 ;1851
0000d8  d1f4              BNE      |L7.196|
                  |L7.218|
0000da  bf00              NOP                            ;1853
0000dc  b90d              CBNZ     r5,|L7.226|
0000de  2006              MOVS     r0,#6                 ;1856
0000e0  e7b4              B        |L7.76|
                  |L7.226|
0000e2  2000              MOVS     r0,#0                 ;1858
0000e4  f82a0015          STRH     r0,[r10,r5,LSL #1]    ;1858
0000e8  220b              MOVS     r2,#0xb               ;1861
0000ea  2120              MOVS     r1,#0x20              ;1861
0000ec  f8d90018          LDR      r0,[r9,#0x18]         ;1861
0000f0  f7fffffe          BL       mem_set
0000f4  2700              MOVS     r7,#0                 ;1862
0000f6  e000              B        |L7.250|
                  |L7.248|
0000f8  1c7f              ADDS     r7,r7,#1              ;1862
                  |L7.250|
0000fa  f83a0017          LDRH     r0,[r10,r7,LSL #1]    ;1862
0000fe  2820              CMP      r0,#0x20              ;1862
000100  d0fa              BEQ      |L7.248|
000102  f83a0017          LDRH     r0,[r10,r7,LSL #1]    ;1862
000106  282e              CMP      r0,#0x2e              ;1862
000108  d0f6              BEQ      |L7.248|
00010a  b10f              CBZ      r7,|L7.272|
00010c  f0480803          ORR      r8,r8,#3              ;1863
                  |L7.272|
000110  e000              B        |L7.276|
                  |L7.274|
000112  1e6d              SUBS     r5,r5,#1              ;1864
                  |L7.276|
000114  b125              CBZ      r5,|L7.288|
000116  1e68              SUBS     r0,r5,#1              ;1864
000118  f83a0010          LDRH     r0,[r10,r0,LSL #1]    ;1864
00011c  282e              CMP      r0,#0x2e              ;1864
00011e  d1f8              BNE      |L7.274|
                  |L7.288|
000120  2000              MOVS     r0,#0                 ;1866
000122  4606              MOV      r6,r0                 ;1866
000124  9002              STR      r0,[sp,#8]            ;1866
000126  f04f0b08          MOV      r11,#8                ;1866
00012a  bf00              NOP                            ;1867
                  |L7.300|
00012c  4638              MOV      r0,r7                 ;1868
00012e  1c7f              ADDS     r7,r7,#1              ;1868
000130  f83a4010          LDRH     r4,[r10,r0,LSL #1]    ;1868
000134  b904              CBNZ     r4,|L7.312|
000136  e063              B        |L7.512|
                  |L7.312|
000138  2c20              CMP      r4,#0x20              ;1870
00013a  d003              BEQ      |L7.324|
00013c  2c2e              CMP      r4,#0x2e              ;1870
00013e  d104              BNE      |L7.330|
000140  42af              CMP      r7,r5                 ;1870
000142  d002              BEQ      |L7.330|
                  |L7.324|
000144  f0480803          ORR      r8,r8,#3              ;1871
000148  e7f0              B        |L7.300|
                  |L7.330|
00014a  9802              LDR      r0,[sp,#8]            ;1874
00014c  4558              CMP      r0,r11                ;1874
00014e  d201              BCS      |L7.340|
000150  42af              CMP      r7,r5                 ;1874
000152  d114              BNE      |L7.382|
                  |L7.340|
000154  f1bb0f0b          CMP      r11,#0xb              ;1875
000158  d102              BNE      |L7.352|
00015a  f0480803          ORR      r8,r8,#3              ;1876
00015e  e04f              B        |L7.512|
                  |L7.352|
000160  42af              CMP      r7,r5                 ;1878
000162  d001              BEQ      |L7.360|
000164  f0480803          ORR      r8,r8,#3              ;1878
                  |L7.360|
000168  42af              CMP      r7,r5                 ;1879
00016a  d900              BLS      |L7.366|
00016c  e048              B        |L7.512|
                  |L7.366|
00016e  462f              MOV      r7,r5                 ;1880
000170  2008              MOVS     r0,#8                 ;1880
000172  9002              STR      r0,[sp,#8]            ;1880
000174  f04f0b0b          MOV      r11,#0xb              ;1880
000178  06b0              LSLS     r0,r6,#26             ;1881
00017a  0e06              LSRS     r6,r0,#24             ;1881
00017c  e7d6              B        |L7.300|
                  |L7.382|
00017e  2c80              CMP      r4,#0x80              ;1884
000180  db09              BLT      |L7.406|
000182  4620              MOV      r0,r4                 ;1889
000184  f7fffffe          BL       ff_wtoupper
000188  2100              MOVS     r1,#0                 ;1889
00018a  9000              STR      r0,[sp,#0]            ;1889
00018c  f7fffffe          BL       ff_convert
000190  4604              MOV      r4,r0                 ;1889
000192  f0480802          ORR      r8,r8,#2              ;1891
                  |L7.406|
000196  2cff              CMP      r4,#0xff              ;1894
000198  dd11              BLE      |L7.446|
00019a  f1ab0001          SUB      r0,r11,#1             ;1895
00019e  9902              LDR      r1,[sp,#8]            ;1895
0001a0  4288              CMP      r0,r1                 ;1895
0001a2  d804              BHI      |L7.430|
0001a4  f0480803          ORR      r8,r8,#3              ;1896
0001a8  f8cdb008          STR      r11,[sp,#8]           ;1896
0001ac  e7be              B        |L7.300|
                  |L7.430|
0001ae  1222              ASRS     r2,r4,#8              ;1898
0001b0  f8d93018          LDR      r3,[r9,#0x18]         ;1898
0001b4  9802              LDR      r0,[sp,#8]            ;1898
0001b6  1c41              ADDS     r1,r0,#1              ;1898
0001b8  9102              STR      r1,[sp,#8]            ;1898
0001ba  541a              STRB     r2,[r3,r0]            ;1898
0001bc  e019              B        |L7.498|
                  |L7.446|
0001be  b124              CBZ      r4,|L7.458|
0001c0  4621              MOV      r1,r4                 ;1900
0001c2  a029              ADR      r0,|L7.616|
0001c4  f7fffffe          BL       chk_chr
0001c8  b118              CBZ      r0,|L7.466|
                  |L7.458|
0001ca  245f              MOVS     r4,#0x5f              ;1901
0001cc  f0480803          ORR      r8,r8,#3              ;1901
0001d0  e00f              B        |L7.498|
                  |L7.466|
0001d2  2c41              CMP      r4,#0x41              ;1903
0001d4  db04              BLT      |L7.480|
0001d6  2c5a              CMP      r4,#0x5a              ;1903
0001d8  dc02              BGT      |L7.480|
0001da  f0460602          ORR      r6,r6,#2              ;1904
0001de  e008              B        |L7.498|
                  |L7.480|
0001e0  2c61              CMP      r4,#0x61              ;1906
0001e2  db06              BLT      |L7.498|
0001e4  2c7a              CMP      r4,#0x7a              ;1906
0001e6  dc04              BGT      |L7.498|
0001e8  f0460601          ORR      r6,r6,#1              ;1907
0001ec  f1a40020          SUB      r0,r4,#0x20           ;1907
0001f0  b284              UXTH     r4,r0                 ;1907
                  |L7.498|
0001f2  f8d93018          LDR      r3,[r9,#0x18]         ;1912
0001f6  9802              LDR      r0,[sp,#8]            ;1912
0001f8  1c41              ADDS     r1,r0,#1              ;1912
0001fa  9102              STR      r1,[sp,#8]            ;1912
0001fc  541c              STRB     r4,[r3,r0]            ;1912
0001fe  e795              B        |L7.300|
                  |L7.512|
000200  bf00              NOP                            ;1869
000202  f8d90018          LDR      r0,[r9,#0x18]         ;1915
000206  7800              LDRB     r0,[r0,#0]            ;1915
000208  28e5              CMP      r0,#0xe5              ;1915
00020a  d103              BNE      |L7.532|
00020c  2005              MOVS     r0,#5                 ;1915
00020e  f8d91018          LDR      r1,[r9,#0x18]         ;1915
000212  7008              STRB     r0,[r1,#0]            ;1915
                  |L7.532|
000214  f1bb0f08          CMP      r11,#8                ;1917
000218  d101              BNE      |L7.542|
00021a  06b0              LSLS     r0,r6,#26             ;1917
00021c  0e06              LSRS     r6,r0,#24             ;1917
                  |L7.542|
00021e  f006000c          AND      r0,r6,#0xc            ;1918
000222  280c              CMP      r0,#0xc               ;1918
000224  d003              BEQ      |L7.558|
000226  f0060003          AND      r0,r6,#3              ;1918
00022a  2803              CMP      r0,#3                 ;1918
00022c  d101              BNE      |L7.562|
                  |L7.558|
00022e  f0480802          ORR      r8,r8,#2              ;1919
                  |L7.562|
000232  f0080002          AND      r0,r8,#2              ;1920
000236  b958              CBNZ     r0,|L7.592|
000238  f0060003          AND      r0,r6,#3              ;1921
00023c  2801              CMP      r0,#1                 ;1921
00023e  d101              BNE      |L7.580|
000240  f0480810          ORR      r8,r8,#0x10           ;1921
                  |L7.580|
000244  f006000c          AND      r0,r6,#0xc            ;1922
000248  2804              CMP      r0,#4                 ;1922
00024a  d101              BNE      |L7.592|
00024c  f0480808          ORR      r8,r8,#8              ;1922
                  |L7.592|
000250  f8d90018          LDR      r0,[r9,#0x18]         ;1925
000254  f880800b          STRB     r8,[r0,#0xb]          ;1925
000258  2000              MOVS     r0,#0                 ;1927
00025a  e6f7              B        |L7.76|
;;;2005   
                          ENDP

                  |L7.604|
00025c  222a3a3c          DCB      """*:<>?|",127,0
000260  3e3f7c7f
000264  00      
000265  00                DCB      0
000266  00                DCB      0
000267  00                DCB      0
                  |L7.616|
000268  2b2c3b3d          DCB      "+,;=[]",0
00026c  5b5d00  
00026f  00                DCB      0

                          AREA ||i.dir_alloc||, CODE, READONLY, ALIGN=1

                  dir_alloc PROC
;;;1232   static
;;;1233   FRESULT dir_alloc (
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;1234   	DIR* dp,	/* Pointer to the directory object */
;;;1235   	UINT nent	/* Number of contiguous entries to allocate (1-21) */
;;;1236   )
;;;1237   {
000004  4604              MOV      r4,r0
000006  460e              MOV      r6,r1
;;;1238   	FRESULT res;
;;;1239   	UINT n;
;;;1240   
;;;1241   
;;;1242   	res = dir_sdi(dp, 0);
000008  2100              MOVS     r1,#0
00000a  4620              MOV      r0,r4
00000c  f7fffffe          BL       dir_sdi
000010  4605              MOV      r5,r0
;;;1243   	if (res == FR_OK) {
000012  b9ed              CBNZ     r5,|L8.80|
;;;1244   		n = 0;
000014  2700              MOVS     r7,#0
;;;1245   		do {
000016  bf00              NOP      
                  |L8.24|
;;;1246   			res = move_window(dp->fs, dp->sect);
000018  6921              LDR      r1,[r4,#0x10]
00001a  6820              LDR      r0,[r4,#0]
00001c  f7fffffe          BL       move_window
000020  4605              MOV      r5,r0
;;;1247   			if (res != FR_OK) break;
000022  b105              CBZ      r5,|L8.38|
000024  e013              B        |L8.78|
                  |L8.38|
;;;1248   			if (dp->dir[0] == DDE || dp->dir[0] == 0) {	/* Is it a blank entry? */
000026  6960              LDR      r0,[r4,#0x14]
000028  7800              LDRB     r0,[r0,#0]
00002a  28e5              CMP      r0,#0xe5
00002c  d002              BEQ      |L8.52|
00002e  6960              LDR      r0,[r4,#0x14]
000030  7800              LDRB     r0,[r0,#0]
000032  b920              CBNZ     r0,|L8.62|
                  |L8.52|
;;;1249   				if (++n == nent) break;	/* A block of contiguous entries is found */
000034  1c78              ADDS     r0,r7,#1
000036  4607              MOV      r7,r0
000038  42b0              CMP      r0,r6
00003a  d101              BNE      |L8.64|
00003c  e007              B        |L8.78|
                  |L8.62|
;;;1250   			} else {
;;;1251   				n = 0;					/* Not a blank entry. Restart to search */
00003e  2700              MOVS     r7,#0
                  |L8.64|
;;;1252   			}
;;;1253   			res = dir_next(dp, 1);		/* Next entry with table stretch enabled */
000040  2101              MOVS     r1,#1
000042  4620              MOV      r0,r4
000044  f7fffffe          BL       dir_next
000048  4605              MOV      r5,r0
;;;1254   		} while (res == FR_OK);
00004a  2d00              CMP      r5,#0
00004c  d0e4              BEQ      |L8.24|
                  |L8.78|
00004e  bf00              NOP                            ;1247
                  |L8.80|
;;;1255   	}
;;;1256   	if (res == FR_NO_FILE) res = FR_DENIED;	/* No directory entry to allocate */
000050  2d04              CMP      r5,#4
000052  d100              BNE      |L8.86|
000054  2507              MOVS     r5,#7
                  |L8.86|
;;;1257   	return res;
000056  4628              MOV      r0,r5
;;;1258   }
000058  e8bd81f0          POP      {r4-r8,pc}
;;;1259   #endif
                          ENDP


                          AREA ||i.dir_find||, CODE, READONLY, ALIGN=1

                  dir_find PROC
;;;1488   static
;;;1489   FRESULT dir_find (
000000  e92d47f0          PUSH     {r4-r10,lr}
;;;1490   	DIR* dp			/* Pointer to the directory object linked to the file name */
;;;1491   )
;;;1492   {
000004  4604              MOV      r4,r0
;;;1493   	FRESULT res;
;;;1494   	BYTE c, *dir;
;;;1495   #if _USE_LFN
;;;1496   	BYTE a, ord, sum;
;;;1497   #endif
;;;1498   
;;;1499   	res = dir_sdi(dp, 0);			/* Rewind directory object */
000006  2100              MOVS     r1,#0
000008  4620              MOV      r0,r4
00000a  f7fffffe          BL       dir_sdi
00000e  4607              MOV      r7,r0
;;;1500   	if (res != FR_OK) return res;
000010  b117              CBZ      r7,|L9.24|
000012  4638              MOV      r0,r7
                  |L9.20|
;;;1501   
;;;1502   #if _USE_LFN
;;;1503   	ord = sum = 0xFF; dp->lfn_idx = 0xFFFF;	/* Reset LFN sequence */
;;;1504   #endif
;;;1505   	do {
;;;1506   		res = move_window(dp->fs, dp->sect);
;;;1507   		if (res != FR_OK) break;
;;;1508   		dir = dp->dir;					/* Ptr to the directory entry of current index */
;;;1509   		c = dir[DIR_Name];
;;;1510   		if (c == 0) { res = FR_NO_FILE; break; }	/* Reached to end of table */
;;;1511   #if _USE_LFN	/* LFN configuration */
;;;1512   		a = dir[DIR_Attr] & AM_MASK;
;;;1513   		if (c == DDE || ((a & AM_VOL) && a != AM_LFN)) {	/* An entry without valid data */
;;;1514   			ord = 0xFF; dp->lfn_idx = 0xFFFF;	/* Reset LFN sequence */
;;;1515   		} else {
;;;1516   			if (a == AM_LFN) {			/* An LFN entry is found */
;;;1517   				if (dp->lfn) {
;;;1518   					if (c & LLE) {		/* Is it start of LFN sequence? */
;;;1519   						sum = dir[LDIR_Chksum];
;;;1520   						c &= ~LLE; ord = c;	/* LFN start order */
;;;1521   						dp->lfn_idx = dp->index;	/* Start index of LFN */
;;;1522   					}
;;;1523   					/* Check validity of the LFN entry and compare it with given name */
;;;1524   					ord = (c == ord && sum == dir[LDIR_Chksum] && cmp_lfn(dp->lfn, dir)) ? ord - 1 : 0xFF;
;;;1525   				}
;;;1526   			} else {					/* An SFN entry is found */
;;;1527   				if (!ord && sum == sum_sfn(dir)) break;	/* LFN matched? */
;;;1528   				if (!(dp->fn[NS] & NS_LOSS) && !mem_cmp(dir, dp->fn, 11)) break;	/* SFN matched? */
;;;1529   				ord = 0xFF; dp->lfn_idx = 0xFFFF;	/* Reset LFN sequence */
;;;1530   			}
;;;1531   		}
;;;1532   #else		/* Non LFN configuration */
;;;1533   		if (!(dir[DIR_Attr] & AM_VOL) && !mem_cmp(dir, dp->fn, 11)) /* Is it a valid entry? */
;;;1534   			break;
;;;1535   #endif
;;;1536   		res = dir_next(dp, 0);		/* Next entry */
;;;1537   	} while (res == FR_OK);
;;;1538   
;;;1539   	return res;
;;;1540   }
000014  e8bd87f0          POP      {r4-r10,pc}
                  |L9.24|
000018  f04f09ff          MOV      r9,#0xff              ;1503
00001c  46ca              MOV      r10,r9                ;1503
00001e  f64f70ff          MOV      r0,#0xffff            ;1503
000022  8420              STRH     r0,[r4,#0x20]         ;1503
000024  bf00              NOP                            ;1505
                  |L9.38|
000026  6921              LDR      r1,[r4,#0x10]         ;1506
000028  6820              LDR      r0,[r4,#0]            ;1506
00002a  f7fffffe          BL       move_window
00002e  4607              MOV      r7,r0                 ;1506
000030  b107              CBZ      r7,|L9.52|
000032  e057              B        |L9.228|
                  |L9.52|
000034  6965              LDR      r5,[r4,#0x14]         ;1508
000036  782e              LDRB     r6,[r5,#0]            ;1509
000038  b90e              CBNZ     r6,|L9.62|
00003a  2704              MOVS     r7,#4                 ;1510
00003c  e052              B        |L9.228|
                  |L9.62|
00003e  7ae8              LDRB     r0,[r5,#0xb]          ;1512
000040  f000083f          AND      r8,r0,#0x3f           ;1512
000044  2ee5              CMP      r6,#0xe5              ;1513
000046  d005              BEQ      |L9.84|
000048  f0080008          AND      r0,r8,#8              ;1513
00004c  b140              CBZ      r0,|L9.96|
00004e  f1b80f0f          CMP      r8,#0xf               ;1513
000052  d005              BEQ      |L9.96|
                  |L9.84|
000054  f04f09ff          MOV      r9,#0xff              ;1514
000058  f64f70ff          MOV      r0,#0xffff            ;1514
00005c  8420              STRH     r0,[r4,#0x20]         ;1514
00005e  e03a              B        |L9.214|
                  |L9.96|
000060  f1b80f0f          CMP      r8,#0xf               ;1516
000064  d11c              BNE      |L9.160|
000066  69e0              LDR      r0,[r4,#0x1c]         ;1517
000068  b378              CBZ      r0,|L9.202|
00006a  f0060040          AND      r0,r6,#0x40           ;1518
00006e  b130              CBZ      r0,|L9.126|
000070  f895a00d          LDRB     r10,[r5,#0xd]         ;1519
000074  f0260640          BIC      r6,r6,#0x40           ;1520
000078  46b1              MOV      r9,r6                 ;1520
00007a  88e0              LDRH     r0,[r4,#6]            ;1521
00007c  8420              STRH     r0,[r4,#0x20]         ;1521
                  |L9.126|
00007e  454e              CMP      r6,r9                 ;1524
000080  d10a              BNE      |L9.152|
000082  7b68              LDRB     r0,[r5,#0xd]          ;1524
000084  4550              CMP      r0,r10                ;1524
000086  d107              BNE      |L9.152|
000088  4629              MOV      r1,r5                 ;1524
00008a  69e0              LDR      r0,[r4,#0x1c]         ;1524
00008c  f7fffffe          BL       cmp_lfn
000090  b110              CBZ      r0,|L9.152|
000092  f1a90001          SUB      r0,r9,#1              ;1524
000096  e000              B        |L9.154|
                  |L9.152|
000098  20ff              MOVS     r0,#0xff              ;1524
                  |L9.154|
00009a  f00009ff          AND      r9,r0,#0xff           ;1524
00009e  e01a              B        |L9.214|
                  |L9.160|
0000a0  f1b90f00          CMP      r9,#0                 ;1527
0000a4  d105              BNE      |L9.178|
0000a6  4628              MOV      r0,r5                 ;1527
0000a8  f7fffffe          BL       sum_sfn
0000ac  4550              CMP      r0,r10                ;1527
0000ae  d100              BNE      |L9.178|
0000b0  e018              B        |L9.228|
                  |L9.178|
0000b2  69a0              LDR      r0,[r4,#0x18]         ;1528
0000b4  7ac0              LDRB     r0,[r0,#0xb]          ;1528
0000b6  f0000001          AND      r0,r0,#1              ;1528
0000ba  b938              CBNZ     r0,|L9.204|
0000bc  220b              MOVS     r2,#0xb               ;1528
0000be  4628              MOV      r0,r5                 ;1528
0000c0  69a1              LDR      r1,[r4,#0x18]         ;1528
0000c2  f7fffffe          BL       mem_cmp
0000c6  b908              CBNZ     r0,|L9.204|
0000c8  e00c              B        |L9.228|
                  |L9.202|
0000ca  e004              B        |L9.214|
                  |L9.204|
0000cc  f04f09ff          MOV      r9,#0xff              ;1529
0000d0  f64f70ff          MOV      r0,#0xffff            ;1529
0000d4  8420              STRH     r0,[r4,#0x20]         ;1529
                  |L9.214|
0000d6  2100              MOVS     r1,#0                 ;1536
0000d8  4620              MOV      r0,r4                 ;1536
0000da  f7fffffe          BL       dir_next
0000de  4607              MOV      r7,r0                 ;1536
0000e0  2f00              CMP      r7,#0                 ;1537
0000e2  d0a0              BEQ      |L9.38|
                  |L9.228|
0000e4  bf00              NOP                            ;1507
0000e6  4638              MOV      r0,r7                 ;1539
0000e8  e794              B        |L9.20|
;;;1541   
                          ENDP


                          AREA ||i.dir_next||, CODE, READONLY, ALIGN=1

                  dir_next PROC
;;;1163   static
;;;1164   FRESULT dir_next (	/* FR_OK:Succeeded, FR_NO_FILE:End of table, FR_DENIED:Could not stretch */
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;1165   	DIR* dp,		/* Pointer to the directory object */
;;;1166   	int stretch		/* 0: Do not stretch table, 1: Stretch table if needed */
;;;1167   )
;;;1168   {
000004  4604              MOV      r4,r0
000006  4688              MOV      r8,r1
;;;1169   	DWORD clst;
;;;1170   	UINT i;
;;;1171   
;;;1172   
;;;1173   	i = dp->index + 1;
000008  88e0              LDRH     r0,[r4,#6]
00000a  1c46              ADDS     r6,r0,#1
;;;1174   	if (!(i & 0xFFFF) || !dp->sect)	/* Report EOT when index has reached 65535 */
00000c  b2b0              UXTH     r0,r6
00000e  b108              CBZ      r0,|L10.20|
000010  6920              LDR      r0,[r4,#0x10]
000012  b910              CBNZ     r0,|L10.26|
                  |L10.20|
;;;1175   		return FR_NO_FILE;
000014  2004              MOVS     r0,#4
                  |L10.22|
;;;1176   
;;;1177   	if (!(i % (SS(dp->fs) / SZ_DIR))) {	/* Sector changed? */
;;;1178   		dp->sect++;					/* Next sector */
;;;1179   
;;;1180   		if (!dp->clust) {		/* Static table */
;;;1181   			if (i >= dp->fs->n_rootdir)	/* Report EOT if it reached end of static table */
;;;1182   				return FR_NO_FILE;
;;;1183   		}
;;;1184   		else {					/* Dynamic table */
;;;1185   			if (((i / (SS(dp->fs) / SZ_DIR)) & (dp->fs->csize - 1)) == 0) {	/* Cluster changed? */
;;;1186   				clst = get_fat(dp->fs, dp->clust);				/* Get next cluster */
;;;1187   				if (clst <= 1) return FR_INT_ERR;
;;;1188   				if (clst == 0xFFFFFFFF) return FR_DISK_ERR;
;;;1189   				if (clst >= dp->fs->n_fatent) {					/* If it reached end of dynamic table, */
;;;1190   #if !_FS_READONLY
;;;1191   					UINT c;
;;;1192   					if (!stretch) return FR_NO_FILE;			/* If do not stretch, report EOT */
;;;1193   					clst = create_chain(dp->fs, dp->clust);		/* Stretch cluster chain */
;;;1194   					if (clst == 0) return FR_DENIED;			/* No free cluster */
;;;1195   					if (clst == 1) return FR_INT_ERR;
;;;1196   					if (clst == 0xFFFFFFFF) return FR_DISK_ERR;
;;;1197   					/* Clean-up stretched table */
;;;1198   					if (sync_window(dp->fs)) return FR_DISK_ERR;/* Flush disk access window */
;;;1199   					mem_set(dp->fs->win, 0, SS(dp->fs));		/* Clear window buffer */
;;;1200   					dp->fs->winsect = clust2sect(dp->fs, clst);	/* Cluster start sector */
;;;1201   					for (c = 0; c < dp->fs->csize; c++) {		/* Fill the new cluster with 0 */
;;;1202   						dp->fs->wflag = 1;
;;;1203   						if (sync_window(dp->fs)) return FR_DISK_ERR;
;;;1204   						dp->fs->winsect++;
;;;1205   					}
;;;1206   					dp->fs->winsect -= c;						/* Rewind window offset */
;;;1207   #else
;;;1208   					if (!stretch) return FR_NO_FILE;			/* If do not stretch, report EOT (this is to suppress warning) */
;;;1209   					return FR_NO_FILE;							/* Report EOT */
;;;1210   #endif
;;;1211   				}
;;;1212   				dp->clust = clst;				/* Initialize data for new cluster */
;;;1213   				dp->sect = clust2sect(dp->fs, clst);
;;;1214   			}
;;;1215   		}
;;;1216   	}
;;;1217   
;;;1218   	dp->index = (WORD)i;	/* Current index */
;;;1219   	dp->dir = dp->fs->win + (i % (SS(dp->fs) / SZ_DIR)) * SZ_DIR;	/* Current entry in the window */
;;;1220   
;;;1221   	return FR_OK;
;;;1222   }
000016  e8bd81f0          POP      {r4-r8,pc}
                  |L10.26|
00001a  f006000f          AND      r0,r6,#0xf            ;1177
00001e  2800              CMP      r0,#0                 ;1177
000020  d16c              BNE      |L10.252|
000022  6920              LDR      r0,[r4,#0x10]         ;1178
000024  1c40              ADDS     r0,r0,#1              ;1178
000026  6120              STR      r0,[r4,#0x10]         ;1178
000028  68e0              LDR      r0,[r4,#0xc]          ;1180
00002a  b928              CBNZ     r0,|L10.56|
00002c  6820              LDR      r0,[r4,#0]            ;1181
00002e  8900              LDRH     r0,[r0,#8]            ;1181
000030  42b0              CMP      r0,r6                 ;1181
000032  d863              BHI      |L10.252|
000034  2004              MOVS     r0,#4                 ;1182
000036  e7ee              B        |L10.22|
                  |L10.56|
000038  6820              LDR      r0,[r4,#0]            ;1185
00003a  7880              LDRB     r0,[r0,#2]            ;1185
00003c  1e40              SUBS     r0,r0,#1              ;1185
00003e  ea001016          AND      r0,r0,r6,LSR #4       ;1185
000042  2800              CMP      r0,#0                 ;1185
000044  d15a              BNE      |L10.252|
000046  68e1              LDR      r1,[r4,#0xc]          ;1186
000048  6820              LDR      r0,[r4,#0]            ;1186
00004a  f7fffffe          BL       get_fat
00004e  4605              MOV      r5,r0                 ;1186
000050  2d01              CMP      r5,#1                 ;1187
000052  d801              BHI      |L10.88|
000054  2002              MOVS     r0,#2                 ;1187
000056  e7de              B        |L10.22|
                  |L10.88|
000058  1c68              ADDS     r0,r5,#1              ;1188
00005a  b908              CBNZ     r0,|L10.96|
00005c  2001              MOVS     r0,#1                 ;1188
00005e  e7da              B        |L10.22|
                  |L10.96|
000060  6820              LDR      r0,[r4,#0]            ;1189
000062  6940              LDR      r0,[r0,#0x14]         ;1189
000064  42a8              CMP      r0,r5                 ;1189
000066  d843              BHI      |L10.240|
000068  f1b80f00          CMP      r8,#0                 ;1192
00006c  d101              BNE      |L10.114|
00006e  2004              MOVS     r0,#4                 ;1192
000070  e7d1              B        |L10.22|
                  |L10.114|
000072  68e1              LDR      r1,[r4,#0xc]          ;1193
000074  6820              LDR      r0,[r4,#0]            ;1193
000076  f7fffffe          BL       create_chain
00007a  4605              MOV      r5,r0                 ;1193
00007c  b90d              CBNZ     r5,|L10.130|
00007e  2007              MOVS     r0,#7                 ;1194
000080  e7c9              B        |L10.22|
                  |L10.130|
000082  2d01              CMP      r5,#1                 ;1195
000084  d101              BNE      |L10.138|
000086  2002              MOVS     r0,#2                 ;1195
000088  e7c5              B        |L10.22|
                  |L10.138|
00008a  1c68              ADDS     r0,r5,#1              ;1196
00008c  b908              CBNZ     r0,|L10.146|
00008e  2001              MOVS     r0,#1                 ;1196
000090  e7c1              B        |L10.22|
                  |L10.146|
000092  6820              LDR      r0,[r4,#0]            ;1198
000094  f7fffffe          BL       sync_window
000098  b108              CBZ      r0,|L10.158|
00009a  2001              MOVS     r0,#1                 ;1198
00009c  e7bb              B        |L10.22|
                  |L10.158|
00009e  6821              LDR      r1,[r4,#0]            ;1199
0000a0  f1010030          ADD      r0,r1,#0x30           ;1199
0000a4  f44f7200          MOV      r2,#0x200             ;1199
0000a8  2100              MOVS     r1,#0                 ;1199
0000aa  f7fffffe          BL       mem_set
0000ae  4629              MOV      r1,r5                 ;1200
0000b0  6820              LDR      r0,[r4,#0]            ;1200
0000b2  f7fffffe          BL       clust2sect
0000b6  6821              LDR      r1,[r4,#0]            ;1200
0000b8  62c8              STR      r0,[r1,#0x2c]         ;1200
0000ba  2700              MOVS     r7,#0                 ;1201
0000bc  e00e              B        |L10.220|
                  |L10.190|
0000be  2001              MOVS     r0,#1                 ;1202
0000c0  6821              LDR      r1,[r4,#0]            ;1202
0000c2  7108              STRB     r0,[r1,#4]            ;1202
0000c4  6820              LDR      r0,[r4,#0]            ;1203
0000c6  f7fffffe          BL       sync_window
0000ca  b108              CBZ      r0,|L10.208|
0000cc  2001              MOVS     r0,#1                 ;1203
0000ce  e7a2              B        |L10.22|
                  |L10.208|
0000d0  6820              LDR      r0,[r4,#0]            ;1204
0000d2  6ac0              LDR      r0,[r0,#0x2c]         ;1204
0000d4  1c40              ADDS     r0,r0,#1              ;1204
0000d6  6821              LDR      r1,[r4,#0]            ;1204
0000d8  62c8              STR      r0,[r1,#0x2c]         ;1204
0000da  1c7f              ADDS     r7,r7,#1              ;1201
                  |L10.220|
0000dc  6820              LDR      r0,[r4,#0]            ;1201
0000de  7880              LDRB     r0,[r0,#2]            ;1201
0000e0  42b8              CMP      r0,r7                 ;1201
0000e2  d8ec              BHI      |L10.190|
0000e4  6820              LDR      r0,[r4,#0]            ;1206
0000e6  6ac0              LDR      r0,[r0,#0x2c]         ;1206
0000e8  1bc0              SUBS     r0,r0,r7              ;1206
0000ea  6821              LDR      r1,[r4,#0]            ;1206
0000ec  62c8              STR      r0,[r1,#0x2c]         ;1206
0000ee  bf00              NOP                            ;1211
                  |L10.240|
0000f0  60e5              STR      r5,[r4,#0xc]          ;1212
0000f2  4629              MOV      r1,r5                 ;1213
0000f4  6820              LDR      r0,[r4,#0]            ;1213
0000f6  f7fffffe          BL       clust2sect
0000fa  6120              STR      r0,[r4,#0x10]         ;1213
                  |L10.252|
0000fc  80e6              STRH     r6,[r4,#6]            ;1218
0000fe  6820              LDR      r0,[r4,#0]            ;1219
000100  3030              ADDS     r0,r0,#0x30           ;1219
000102  f006010f          AND      r1,r6,#0xf            ;1219
000106  eb001041          ADD      r0,r0,r1,LSL #5       ;1219
00010a  6160              STR      r0,[r4,#0x14]         ;1219
00010c  2000              MOVS     r0,#0                 ;1221
00010e  e782              B        |L10.22|
;;;1223   
                          ENDP


                          AREA ||i.dir_read||, CODE, READONLY, ALIGN=1

                  dir_read PROC
;;;1549   static
;;;1550   FRESULT dir_read (
000000  e92d5ff0          PUSH     {r4-r12,lr}
;;;1551   	DIR* dp,		/* Pointer to the directory object */
;;;1552   	int vol			/* Filtered by 0:file/directory or 1:volume label */
;;;1553   )
;;;1554   {
000004  4604              MOV      r4,r0
000006  468a              MOV      r10,r1
;;;1555   	FRESULT res;
;;;1556   	BYTE a, c, *dir;
;;;1557   #if _USE_LFN
;;;1558   	BYTE ord = 0xFF, sum = 0xFF;
000008  f04f09ff          MOV      r9,#0xff
00000c  46cb              MOV      r11,r9
;;;1559   #endif
;;;1560   
;;;1561   	res = FR_NO_FILE;
00000e  2704              MOVS     r7,#4
;;;1562   	while (dp->sect) {
000010  e04e              B        |L11.176|
                  |L11.18|
;;;1563   		res = move_window(dp->fs, dp->sect);
000012  6921              LDR      r1,[r4,#0x10]
000014  6820              LDR      r0,[r4,#0]
000016  f7fffffe          BL       move_window
00001a  4607              MOV      r7,r0
;;;1564   		if (res != FR_OK) break;
00001c  b107              CBZ      r7,|L11.32|
00001e  e04a              B        |L11.182|
                  |L11.32|
;;;1565   		dir = dp->dir;					/* Ptr to the directory entry of current index */
000020  6966              LDR      r6,[r4,#0x14]
;;;1566   		c = dir[DIR_Name];
000022  7835              LDRB     r5,[r6,#0]
;;;1567   		if (c == 0) { res = FR_NO_FILE; break; }	/* Reached to end of table */
000024  b90d              CBNZ     r5,|L11.42|
000026  2704              MOVS     r7,#4
000028  e045              B        |L11.182|
                  |L11.42|
;;;1568   		a = dir[DIR_Attr] & AM_MASK;
00002a  7af0              LDRB     r0,[r6,#0xb]
00002c  f000083f          AND      r8,r0,#0x3f
;;;1569   #if _USE_LFN	/* LFN configuration */
;;;1570   		if (c == DDE || (!_FS_RPATH && c == '.') || (int)(a == AM_VOL) != vol) {	/* An entry without valid data */
000030  2de5              CMP      r5,#0xe5
000032  d009              BEQ      |L11.72|
000034  2d2e              CMP      r5,#0x2e
000036  d007              BEQ      |L11.72|
000038  f1b80f08          CMP      r8,#8
00003c  d101              BNE      |L11.66|
00003e  2001              MOVS     r0,#1
000040  e000              B        |L11.68|
                  |L11.66|
000042  2000              MOVS     r0,#0
                  |L11.68|
000044  4550              CMP      r0,r10
000046  d002              BEQ      |L11.78|
                  |L11.72|
;;;1571   			ord = 0xFF;
000048  f04f09ff          MOV      r9,#0xff
00004c  e029              B        |L11.162|
                  |L11.78|
;;;1572   		} else {
;;;1573   			if (a == AM_LFN) {			/* An LFN entry is found */
00004e  f1b80f0f          CMP      r8,#0xf
000052  d11a              BNE      |L11.138|
;;;1574   				if (c & LLE) {			/* Is it start of LFN sequence? */
000054  f0050040          AND      r0,r5,#0x40
000058  b130              CBZ      r0,|L11.104|
;;;1575   					sum = dir[LDIR_Chksum];
00005a  f896b00d          LDRB     r11,[r6,#0xd]
;;;1576   					c &= ~LLE; ord = c;
00005e  f0250540          BIC      r5,r5,#0x40
000062  46a9              MOV      r9,r5
;;;1577   					dp->lfn_idx = dp->index;
000064  88e0              LDRH     r0,[r4,#6]
000066  8420              STRH     r0,[r4,#0x20]
                  |L11.104|
;;;1578   				}
;;;1579   				/* Check LFN validity and capture it */
;;;1580   				ord = (c == ord && sum == dir[LDIR_Chksum] && pick_lfn(dp->lfn, dir)) ? ord - 1 : 0xFF;
000068  454d              CMP      r5,r9
00006a  d10a              BNE      |L11.130|
00006c  7b70              LDRB     r0,[r6,#0xd]
00006e  4558              CMP      r0,r11
000070  d107              BNE      |L11.130|
000072  4631              MOV      r1,r6
000074  69e0              LDR      r0,[r4,#0x1c]
000076  f7fffffe          BL       pick_lfn
00007a  b110              CBZ      r0,|L11.130|
00007c  f1a90001          SUB      r0,r9,#1
000080  e000              B        |L11.132|
                  |L11.130|
000082  20ff              MOVS     r0,#0xff
                  |L11.132|
000084  f00009ff          AND      r9,r0,#0xff
000088  e00b              B        |L11.162|
                  |L11.138|
;;;1581   			} else {					/* An SFN entry is found */
;;;1582   				if (ord || sum != sum_sfn(dir))	/* Is there a valid LFN? */
00008a  f1b90f00          CMP      r9,#0
00008e  d104              BNE      |L11.154|
000090  4630              MOV      r0,r6
000092  f7fffffe          BL       sum_sfn
000096  4558              CMP      r0,r11
000098  d002              BEQ      |L11.160|
                  |L11.154|
;;;1583   					dp->lfn_idx = 0xFFFF;		/* It has no LFN. */
00009a  f64f70ff          MOV      r0,#0xffff
00009e  8420              STRH     r0,[r4,#0x20]
                  |L11.160|
;;;1584   				break;
0000a0  e009              B        |L11.182|
                  |L11.162|
;;;1585   			}
;;;1586   		}
;;;1587   #else		/* Non LFN configuration */
;;;1588   		if (c != DDE && (_FS_RPATH || c != '.') && a != AM_LFN && (int)(a == AM_VOL) == vol)	/* Is it a valid entry? */
;;;1589   			break;
;;;1590   #endif
;;;1591   		res = dir_next(dp, 0);				/* Next entry */
0000a2  2100              MOVS     r1,#0
0000a4  4620              MOV      r0,r4
0000a6  f7fffffe          BL       dir_next
0000aa  4607              MOV      r7,r0
;;;1592   		if (res != FR_OK) break;
0000ac  b107              CBZ      r7,|L11.176|
0000ae  e002              B        |L11.182|
                  |L11.176|
0000b0  6920              LDR      r0,[r4,#0x10]         ;1562
0000b2  2800              CMP      r0,#0                 ;1562
0000b4  d1ad              BNE      |L11.18|
                  |L11.182|
0000b6  bf00              NOP                            ;1564
;;;1593   	}
;;;1594   
;;;1595   	if (res != FR_OK) dp->sect = 0;
0000b8  b10f              CBZ      r7,|L11.190|
0000ba  2000              MOVS     r0,#0
0000bc  6120              STR      r0,[r4,#0x10]
                  |L11.190|
;;;1596   
;;;1597   	return res;
0000be  4638              MOV      r0,r7
;;;1598   }
0000c0  e8bd9ff0          POP      {r4-r12,pc}
;;;1599   #endif	/* _FS_MINIMIZE <= 1 || _USE_LABEL || _FS_RPATH >= 2 */
                          ENDP


                          AREA ||i.dir_register||, CODE, READONLY, ALIGN=1

                  dir_register PROC
;;;1608   static
;;;1609   FRESULT dir_register (	/* FR_OK:Successful, FR_DENIED:No free entry or too many SFN collision, FR_DISK_ERR:Disk error */
000000  e92d4ffe          PUSH     {r1-r11,lr}
;;;1610   	DIR* dp				/* Target directory with object name to be created */
;;;1611   )
;;;1612   {
000004  4604              MOV      r4,r0
;;;1613   	FRESULT res;
;;;1614   #if _USE_LFN	/* LFN configuration */
;;;1615   	UINT n, nent;
;;;1616   	BYTE sn[12], *fn, sum;
;;;1617   	WCHAR *lfn;
;;;1618   
;;;1619   
;;;1620   	fn = dp->fn; lfn = dp->lfn;
000006  f8d48018          LDR      r8,[r4,#0x18]
00000a  f8d4901c          LDR      r9,[r4,#0x1c]
;;;1621   	mem_cpy(sn, fn, 12);
00000e  220c              MOVS     r2,#0xc
000010  4641              MOV      r1,r8
000012  4668              MOV      r0,sp
000014  f7fffffe          BL       mem_cpy
;;;1622   
;;;1623   	if (_FS_RPATH && (sn[NS] & NS_DOT))		/* Cannot create dot entry */
000018  bf00              NOP      
;;;1624   		return FR_INVALID_NAME;
;;;1625   
;;;1626   	if (sn[NS] & NS_LOSS) {			/* When LFN is out of 8.3 format, generate a numbered name */
00001a  f89d000b          LDRB     r0,[sp,#0xb]
00001e  f0000001          AND      r0,r0,#1
000022  b320              CBZ      r0,|L12.110|
;;;1627   		fn[NS] = 0; dp->lfn = 0;			/* Find only SFN */
000024  2000              MOVS     r0,#0
000026  f888000b          STRB     r0,[r8,#0xb]
00002a  61e0              STR      r0,[r4,#0x1c]
;;;1628   		for (n = 1; n < 100; n++) {
00002c  2601              MOVS     r6,#1
00002e  e00c              B        |L12.74|
                  |L12.48|
;;;1629   			gen_numname(fn, sn, lfn, n);	/* Generate a numbered name */
000030  4633              MOV      r3,r6
000032  464a              MOV      r2,r9
000034  4669              MOV      r1,sp
000036  4640              MOV      r0,r8
000038  f7fffffe          BL       gen_numname
;;;1630   			res = dir_find(dp);				/* Check if the name collides with existing SFN */
00003c  4620              MOV      r0,r4
00003e  f7fffffe          BL       dir_find
000042  4605              MOV      r5,r0
;;;1631   			if (res != FR_OK) break;
000044  b105              CBZ      r5,|L12.72|
000046  e002              B        |L12.78|
                  |L12.72|
000048  1c76              ADDS     r6,r6,#1              ;1628
                  |L12.74|
00004a  2e64              CMP      r6,#0x64              ;1628
00004c  d3f0              BCC      |L12.48|
                  |L12.78|
00004e  bf00              NOP      
;;;1632   		}
;;;1633   		if (n == 100) return FR_DENIED;		/* Abort if too many collisions */
000050  2e64              CMP      r6,#0x64
000052  d102              BNE      |L12.90|
000054  2007              MOVS     r0,#7
                  |L12.86|
;;;1634   		if (res != FR_NO_FILE) return res;	/* Abort if the result is other than 'not collided' */
;;;1635   		fn[NS] = sn[NS]; dp->lfn = lfn;
;;;1636   	}
;;;1637   
;;;1638   	if (sn[NS] & NS_LFN) {			/* When LFN is to be created, allocate entries for an SFN + LFNs. */
;;;1639   		for (n = 0; lfn[n]; n++) ;
;;;1640   		nent = (n + 25) / 13;
;;;1641   	} else {						/* Otherwise allocate an entry for an SFN  */
;;;1642   		nent = 1;
;;;1643   	}
;;;1644   	res = dir_alloc(dp, nent);		/* Allocate entries */
;;;1645   
;;;1646   	if (res == FR_OK && --nent) {	/* Set LFN entry if needed */
;;;1647   		res = dir_sdi(dp, dp->index - nent);
;;;1648   		if (res == FR_OK) {
;;;1649   			sum = sum_sfn(dp->fn);	/* Sum value of the SFN tied to the LFN */
;;;1650   			do {					/* Store LFN entries in bottom first */
;;;1651   				res = move_window(dp->fs, dp->sect);
;;;1652   				if (res != FR_OK) break;
;;;1653   				fit_lfn(dp->lfn, dp->dir, (BYTE)nent, sum);
;;;1654   				dp->fs->wflag = 1;
;;;1655   				res = dir_next(dp, 0);	/* Next entry */
;;;1656   			} while (res == FR_OK && --nent);
;;;1657   		}
;;;1658   	}
;;;1659   #else	/* Non LFN configuration */
;;;1660   	res = dir_alloc(dp, 1);		/* Allocate an entry for SFN */
;;;1661   #endif
;;;1662   
;;;1663   	if (res == FR_OK) {				/* Set SFN entry */
;;;1664   		res = move_window(dp->fs, dp->sect);
;;;1665   		if (res == FR_OK) {
;;;1666   			mem_set(dp->dir, 0, SZ_DIR);	/* Clean the entry */
;;;1667   			mem_cpy(dp->dir, dp->fn, 11);	/* Put SFN */
;;;1668   #if _USE_LFN
;;;1669   			dp->dir[DIR_NTres] = dp->fn[NS] & (NS_BODY | NS_EXT);	/* Put NT flag */
;;;1670   #endif
;;;1671   			dp->fs->wflag = 1;
;;;1672   		}
;;;1673   	}
;;;1674   
;;;1675   	return res;
;;;1676   }
000056  e8bd8ffe          POP      {r1-r11,pc}
                  |L12.90|
00005a  2d04              CMP      r5,#4                 ;1634
00005c  d001              BEQ      |L12.98|
00005e  4628              MOV      r0,r5                 ;1634
000060  e7f9              B        |L12.86|
                  |L12.98|
000062  f89d000b          LDRB     r0,[sp,#0xb]          ;1635
000066  f888000b          STRB     r0,[r8,#0xb]          ;1635
00006a  f8c4901c          STR      r9,[r4,#0x1c]         ;1635
                  |L12.110|
00006e  f89d000b          LDRB     r0,[sp,#0xb]          ;1638
000072  f0000002          AND      r0,r0,#2              ;1638
000076  b160              CBZ      r0,|L12.146|
000078  2600              MOVS     r6,#0                 ;1639
00007a  e000              B        |L12.126|
                  |L12.124|
00007c  1c76              ADDS     r6,r6,#1              ;1639
                  |L12.126|
00007e  f8390016          LDRH     r0,[r9,r6,LSL #1]     ;1639
000082  2800              CMP      r0,#0                 ;1639
000084  d1fa              BNE      |L12.124|
000086  f1060019          ADD      r0,r6,#0x19           ;1640
00008a  210d              MOVS     r1,#0xd               ;1640
00008c  fbb0f7f1          UDIV     r7,r0,r1              ;1640
000090  e000              B        |L12.148|
                  |L12.146|
000092  2701              MOVS     r7,#1                 ;1642
                  |L12.148|
000094  4639              MOV      r1,r7                 ;1644
000096  4620              MOV      r0,r4                 ;1644
000098  f7fffffe          BL       dir_alloc
00009c  4605              MOV      r5,r0                 ;1644
00009e  bb45              CBNZ     r5,|L12.242|
0000a0  1e78              SUBS     r0,r7,#1              ;1646
0000a2  1e07              SUBS     r7,r0,#0              ;1646
0000a4  d025              BEQ      |L12.242|
0000a6  88e0              LDRH     r0,[r4,#6]            ;1647
0000a8  1bc1              SUBS     r1,r0,r7              ;1647
0000aa  4620              MOV      r0,r4                 ;1647
0000ac  f7fffffe          BL       dir_sdi
0000b0  4605              MOV      r5,r0                 ;1647
0000b2  b9f5              CBNZ     r5,|L12.242|
0000b4  69a0              LDR      r0,[r4,#0x18]         ;1649
0000b6  f7fffffe          BL       sum_sfn
0000ba  4682              MOV      r10,r0                ;1649
0000bc  bf00              NOP                            ;1650
                  |L12.190|
0000be  6921              LDR      r1,[r4,#0x10]         ;1651
0000c0  6820              LDR      r0,[r4,#0]            ;1651
0000c2  f7fffffe          BL       move_window
0000c6  4605              MOV      r5,r0                 ;1651
0000c8  b105              CBZ      r5,|L12.204|
0000ca  e011              B        |L12.240|
                  |L12.204|
0000cc  b2fa              UXTB     r2,r7                 ;1653
0000ce  4653              MOV      r3,r10                ;1653
0000d0  6961              LDR      r1,[r4,#0x14]         ;1653
0000d2  69e0              LDR      r0,[r4,#0x1c]         ;1653
0000d4  f7fffffe          BL       fit_lfn
0000d8  2001              MOVS     r0,#1                 ;1654
0000da  6821              LDR      r1,[r4,#0]            ;1654
0000dc  7108              STRB     r0,[r1,#4]            ;1654
0000de  2100              MOVS     r1,#0                 ;1655
0000e0  4620              MOV      r0,r4                 ;1655
0000e2  f7fffffe          BL       dir_next
0000e6  4605              MOV      r5,r0                 ;1655
0000e8  b915              CBNZ     r5,|L12.240|
0000ea  1e78              SUBS     r0,r7,#1              ;1656
0000ec  1e07              SUBS     r7,r0,#0              ;1656
0000ee  d1e6              BNE      |L12.190|
                  |L12.240|
0000f0  bf00              NOP                            ;1652
                  |L12.242|
0000f2  b9c5              CBNZ     r5,|L12.294|
0000f4  6921              LDR      r1,[r4,#0x10]         ;1664
0000f6  6820              LDR      r0,[r4,#0]            ;1664
0000f8  f7fffffe          BL       move_window
0000fc  4605              MOV      r5,r0                 ;1664
0000fe  b995              CBNZ     r5,|L12.294|
000100  2220              MOVS     r2,#0x20              ;1666
000102  2100              MOVS     r1,#0                 ;1666
000104  6960              LDR      r0,[r4,#0x14]         ;1666
000106  f7fffffe          BL       mem_set
00010a  220b              MOVS     r2,#0xb               ;1667
00010c  e9d40105          LDRD     r0,r1,[r4,#0x14]      ;1667
000110  f7fffffe          BL       mem_cpy
000114  69a0              LDR      r0,[r4,#0x18]         ;1669
000116  7ac0              LDRB     r0,[r0,#0xb]          ;1669
000118  f0000018          AND      r0,r0,#0x18           ;1669
00011c  6961              LDR      r1,[r4,#0x14]         ;1669
00011e  7308              STRB     r0,[r1,#0xc]          ;1669
000120  2001              MOVS     r0,#1                 ;1671
000122  6821              LDR      r1,[r4,#0]            ;1671
000124  7108              STRB     r0,[r1,#4]            ;1671
                  |L12.294|
000126  4628              MOV      r0,r5                 ;1675
000128  e795              B        |L12.86|
;;;1677   #endif /* !_FS_READONLY */
                          ENDP


                          AREA ||i.dir_remove||, CODE, READONLY, ALIGN=1

                  dir_remove PROC
;;;1686   static
;;;1687   FRESULT dir_remove (	/* FR_OK: Successful, FR_DISK_ERR: A disk error */
000000  b570              PUSH     {r4-r6,lr}
;;;1688   	DIR* dp				/* Directory object pointing the entry to be removed */
;;;1689   )
;;;1690   {
000002  4604              MOV      r4,r0
;;;1691   	FRESULT res;
;;;1692   #if _USE_LFN	/* LFN configuration */
;;;1693   	UINT i;
;;;1694   
;;;1695   	i = dp->index;	/* SFN index */
000004  88e6              LDRH     r6,[r4,#6]
;;;1696   	res = dir_sdi(dp, (dp->lfn_idx == 0xFFFF) ? i : dp->lfn_idx);	/* Goto the SFN or top of the LFN entries */
000006  8c20              LDRH     r0,[r4,#0x20]
000008  f64f72ff          MOV      r2,#0xffff
00000c  4290              CMP      r0,r2
00000e  d101              BNE      |L13.20|
000010  4630              MOV      r0,r6
000012  e000              B        |L13.22|
                  |L13.20|
000014  8c20              LDRH     r0,[r4,#0x20]
                  |L13.22|
000016  4601              MOV      r1,r0
000018  4620              MOV      r0,r4
00001a  f7fffffe          BL       dir_sdi
00001e  4605              MOV      r5,r0
;;;1697   	if (res == FR_OK) {
000020  bb0d              CBNZ     r5,|L13.102|
;;;1698   		do {
000022  bf00              NOP      
                  |L13.36|
;;;1699   			res = move_window(dp->fs, dp->sect);
000024  6921              LDR      r1,[r4,#0x10]
000026  6820              LDR      r0,[r4,#0]
000028  f7fffffe          BL       move_window
00002c  4605              MOV      r5,r0
;;;1700   			if (res != FR_OK) break;
00002e  b105              CBZ      r5,|L13.50|
000030  e015              B        |L13.94|
                  |L13.50|
;;;1701   			mem_set(dp->dir, 0, SZ_DIR);	/* Clear and mark the entry "deleted" */
000032  2220              MOVS     r2,#0x20
000034  2100              MOVS     r1,#0
000036  6960              LDR      r0,[r4,#0x14]
000038  f7fffffe          BL       mem_set
;;;1702   			*dp->dir = DDE;
00003c  20e5              MOVS     r0,#0xe5
00003e  6961              LDR      r1,[r4,#0x14]
000040  7008              STRB     r0,[r1,#0]
;;;1703   			dp->fs->wflag = 1;
000042  2001              MOVS     r0,#1
000044  6821              LDR      r1,[r4,#0]
000046  7108              STRB     r0,[r1,#4]
;;;1704   			if (dp->index >= i) break;	/* When reached SFN, all entries of the object has been deleted. */
000048  88e0              LDRH     r0,[r4,#6]
00004a  42b0              CMP      r0,r6
00004c  d300              BCC      |L13.80|
00004e  e006              B        |L13.94|
                  |L13.80|
;;;1705   			res = dir_next(dp, 0);		/* Next entry */
000050  2100              MOVS     r1,#0
000052  4620              MOV      r0,r4
000054  f7fffffe          BL       dir_next
000058  4605              MOV      r5,r0
;;;1706   		} while (res == FR_OK);
00005a  2d00              CMP      r5,#0
00005c  d0e2              BEQ      |L13.36|
                  |L13.94|
00005e  bf00              NOP                            ;1700
;;;1707   		if (res == FR_NO_FILE) res = FR_INT_ERR;
000060  2d04              CMP      r5,#4
000062  d100              BNE      |L13.102|
000064  2502              MOVS     r5,#2
                  |L13.102|
;;;1708   	}
;;;1709   
;;;1710   #else			/* Non LFN configuration */
;;;1711   	res = dir_sdi(dp, dp->index);
;;;1712   	if (res == FR_OK) {
;;;1713   		res = move_window(dp->fs, dp->sect);
;;;1714   		if (res == FR_OK) {
;;;1715   			mem_set(dp->dir, 0, SZ_DIR);	/* Clear and mark the entry "deleted" */
;;;1716   			*dp->dir = DDE;
;;;1717   			dp->fs->wflag = 1;
;;;1718   		}
;;;1719   	}
;;;1720   #endif
;;;1721   
;;;1722   	return res;
000066  4628              MOV      r0,r5
;;;1723   }
000068  bd70              POP      {r4-r6,pc}
;;;1724   #endif /* !_FS_READONLY */
                          ENDP


                          AREA ||i.dir_sdi||, CODE, READONLY, ALIGN=1

                  dir_sdi PROC
;;;1115   //static //
;;;1116   FRESULT dir_sdi (
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;1117   	DIR* dp,		/* Pointer to directory object */
;;;1118   	UINT idx		/* Index of directory table */
;;;1119   )
;;;1120   {
000004  4604              MOV      r4,r0
000006  460e              MOV      r6,r1
;;;1121   	DWORD clst, sect;
;;;1122   	UINT ic;
;;;1123   
;;;1124   
;;;1125   	dp->index = (WORD)idx;	/* Current index */
000008  80e6              STRH     r6,[r4,#6]
;;;1126   	clst = dp->sclust;		/* Table start cluster (0:root) */
00000a  68a5              LDR      r5,[r4,#8]
;;;1127   	if (clst == 1 || clst >= dp->fs->n_fatent)	/* Check start cluster range */
00000c  2d01              CMP      r5,#1
00000e  d003              BEQ      |L14.24|
000010  6820              LDR      r0,[r4,#0]
000012  6940              LDR      r0,[r0,#0x14]
000014  42a8              CMP      r0,r5
000016  d802              BHI      |L14.30|
                  |L14.24|
;;;1128   		return FR_INT_ERR;
000018  2002              MOVS     r0,#2
                  |L14.26|
;;;1129   	if (!clst && dp->fs->fs_type == FS_FAT32)	/* Replace cluster# 0 with root cluster# if in FAT32 */
;;;1130   		clst = dp->fs->dirbase;
;;;1131   
;;;1132   	if (clst == 0) {	/* Static table (root-directory in FAT12/16) */
;;;1133   		if (idx >= dp->fs->n_rootdir)	/* Is index out of range? */
;;;1134   			return FR_INT_ERR;
;;;1135   		sect = dp->fs->dirbase;
;;;1136   	}
;;;1137   	else {				/* Dynamic table (root-directory in FAT32 or sub-directory) */
;;;1138   		ic = SS(dp->fs) / SZ_DIR * dp->fs->csize;	/* Entries per cluster */
;;;1139   		while (idx >= ic) {	/* Follow cluster chain */
;;;1140   			clst = get_fat(dp->fs, clst);				/* Get next cluster */
;;;1141   			if (clst == 0xFFFFFFFF) return FR_DISK_ERR;	/* Disk error */
;;;1142   			if (clst < 2 || clst >= dp->fs->n_fatent)	/* Reached to end of table or internal error */
;;;1143   				return FR_INT_ERR;
;;;1144   			idx -= ic;
;;;1145   		}
;;;1146   		sect = clust2sect(dp->fs, clst);
;;;1147   	}
;;;1148   	dp->clust = clst;	/* Current cluster# */
;;;1149   	if (!sect) return FR_INT_ERR;
;;;1150   	dp->sect = sect + idx / (SS(dp->fs) / SZ_DIR);					/* Sector# of the directory entry */
;;;1151   	dp->dir = dp->fs->win + (idx % (SS(dp->fs) / SZ_DIR)) * SZ_DIR;	/* Ptr to the entry in the sector */
;;;1152   
;;;1153   	return FR_OK;
;;;1154   }
00001a  e8bd81f0          POP      {r4-r8,pc}
                  |L14.30|
00001e  b92d              CBNZ     r5,|L14.44|
000020  6820              LDR      r0,[r4,#0]            ;1129
000022  7800              LDRB     r0,[r0,#0]            ;1129
000024  2803              CMP      r0,#3                 ;1129
000026  d101              BNE      |L14.44|
000028  6820              LDR      r0,[r4,#0]            ;1130
00002a  6a45              LDR      r5,[r0,#0x24]         ;1130
                  |L14.44|
00002c  b945              CBNZ     r5,|L14.64|
00002e  6820              LDR      r0,[r4,#0]            ;1133
000030  8900              LDRH     r0,[r0,#8]            ;1133
000032  42b0              CMP      r0,r6                 ;1133
000034  d801              BHI      |L14.58|
000036  2002              MOVS     r0,#2                 ;1134
000038  e7ef              B        |L14.26|
                  |L14.58|
00003a  6820              LDR      r0,[r4,#0]            ;1135
00003c  6a47              LDR      r7,[r0,#0x24]         ;1135
00003e  e01e              B        |L14.126|
                  |L14.64|
000040  6820              LDR      r0,[r4,#0]            ;1138
000042  7880              LDRB     r0,[r0,#2]            ;1138
000044  ea4f1800          LSL      r8,r0,#4              ;1138
000048  e012              B        |L14.112|
                  |L14.74|
00004a  4629              MOV      r1,r5                 ;1140
00004c  6820              LDR      r0,[r4,#0]            ;1140
00004e  f7fffffe          BL       get_fat
000052  4605              MOV      r5,r0                 ;1140
000054  1c68              ADDS     r0,r5,#1              ;1141
000056  b908              CBNZ     r0,|L14.92|
000058  2001              MOVS     r0,#1                 ;1141
00005a  e7de              B        |L14.26|
                  |L14.92|
00005c  2d02              CMP      r5,#2                 ;1142
00005e  d303              BCC      |L14.104|
000060  6820              LDR      r0,[r4,#0]            ;1142
000062  6940              LDR      r0,[r0,#0x14]         ;1142
000064  42a8              CMP      r0,r5                 ;1142
000066  d801              BHI      |L14.108|
                  |L14.104|
000068  2002              MOVS     r0,#2                 ;1143
00006a  e7d6              B        |L14.26|
                  |L14.108|
00006c  eba60608          SUB      r6,r6,r8              ;1144
                  |L14.112|
000070  4546              CMP      r6,r8                 ;1139
000072  d2ea              BCS      |L14.74|
000074  4629              MOV      r1,r5                 ;1146
000076  6820              LDR      r0,[r4,#0]            ;1146
000078  f7fffffe          BL       clust2sect
00007c  4607              MOV      r7,r0                 ;1146
                  |L14.126|
00007e  60e5              STR      r5,[r4,#0xc]          ;1148
000080  b90f              CBNZ     r7,|L14.134|
000082  2002              MOVS     r0,#2                 ;1149
000084  e7c9              B        |L14.26|
                  |L14.134|
000086  eb071016          ADD      r0,r7,r6,LSR #4       ;1150
00008a  6120              STR      r0,[r4,#0x10]         ;1150
00008c  6820              LDR      r0,[r4,#0]            ;1151
00008e  3030              ADDS     r0,r0,#0x30           ;1151
000090  f006010f          AND      r1,r6,#0xf            ;1151
000094  eb001041          ADD      r0,r0,r1,LSL #5       ;1151
000098  6160              STR      r0,[r4,#0x14]         ;1151
00009a  2000              MOVS     r0,#0                 ;1153
00009c  e7bd              B        |L14.26|
;;;1155   
                          ENDP


                          AREA ||i.f_chmod||, CODE, READONLY, ALIGN=1

                  f_chmod PROC
;;;3584   
;;;3585   FRESULT f_chmod (
000000  e92d41f7          PUSH     {r0-r2,r4-r8,lr}
;;;3586   	const TCHAR* path,	/* Pointer to the file path */
;;;3587   	BYTE value,			/* Attribute bits */
;;;3588   	BYTE mask			/* Attribute mask to change */
;;;3589   )
;;;3590   {
000004  b08d              SUB      sp,sp,#0x34
000006  4688              MOV      r8,r1
000008  4614              MOV      r4,r2
;;;3591   	FRESULT res;
;;;3592   	DIR dj;
;;;3593   	BYTE *dir;
;;;3594   	DEF_NAMEBUF;
;;;3595   
;;;3596   
;;;3597   	/* Get logical drive number */
;;;3598   	res = find_volume(&dj.fs, &path, 1);
00000a  2201              MOVS     r2,#1
00000c  a90d              ADD      r1,sp,#0x34
00000e  a804              ADD      r0,sp,#0x10
000010  f7fffffe          BL       find_volume
000014  4607              MOV      r7,r0
;;;3599   	if (res == FR_OK) {
000016  bb4f              CBNZ     r7,|L15.108|
;;;3600   		INIT_BUF(dj);
000018  f44f7000          MOV      r0,#0x200
00001c  f7fffffe          BL       ff_memalloc
000020  4606              MOV      r6,r0
000022  b91e              CBNZ     r6,|L15.44|
000024  2011              MOVS     r0,#0x11
                  |L15.38|
;;;3601   		res = follow_path(&dj, path);		/* Follow the file path */
;;;3602   		FREE_BUF();
;;;3603   		if (_FS_RPATH && res == FR_OK && (dj.fn[NS] & NS_DOT))
;;;3604   			res = FR_INVALID_NAME;
;;;3605   		if (res == FR_OK) {
;;;3606   			dir = dj.dir;
;;;3607   			if (!dir) {						/* Is it a root directory? */
;;;3608   				res = FR_INVALID_NAME;
;;;3609   			} else {						/* File or sub directory */
;;;3610   				mask &= AM_RDO|AM_HID|AM_SYS|AM_ARC;	/* Valid attribute mask */
;;;3611   				dir[DIR_Attr] = (value & mask) | (dir[DIR_Attr] & (BYTE)~mask);	/* Apply attribute change */
;;;3612   				dj.fs->wflag = 1;
;;;3613   				res = sync_fs(dj.fs);
;;;3614   			}
;;;3615   		}
;;;3616   	}
;;;3617   
;;;3618   	LEAVE_FF(dj.fs, res);
;;;3619   }
000026  b010              ADD      sp,sp,#0x40
000028  e8bd81f0          POP      {r4-r8,pc}
                  |L15.44|
00002c  960b              STR      r6,[sp,#0x2c]         ;3600
00002e  a801              ADD      r0,sp,#4              ;3600
000030  900a              STR      r0,[sp,#0x28]         ;3600
000032  a804              ADD      r0,sp,#0x10           ;3601
000034  990d              LDR      r1,[sp,#0x34]         ;3601
000036  f7fffffe          BL       follow_path
00003a  4607              MOV      r7,r0                 ;3601
00003c  4630              MOV      r0,r6                 ;3602
00003e  f7fffffe          BL       ff_memfree
000042  bf00              NOP                            ;3603
000044  b997              CBNZ     r7,|L15.108|
000046  9d09              LDR      r5,[sp,#0x24]         ;3606
000048  b90d              CBNZ     r5,|L15.78|
00004a  2706              MOVS     r7,#6                 ;3608
00004c  e00e              B        |L15.108|
                  |L15.78|
00004e  f0040427          AND      r4,r4,#0x27           ;3610
000052  ea080004          AND      r0,r8,r4              ;3611
000056  7ae9              LDRB     r1,[r5,#0xb]          ;3611
000058  43a1              BICS     r1,r1,r4              ;3611
00005a  4308              ORRS     r0,r0,r1              ;3611
00005c  72e8              STRB     r0,[r5,#0xb]          ;3611
00005e  2001              MOVS     r0,#1                 ;3612
000060  9904              LDR      r1,[sp,#0x10]         ;3612
000062  7108              STRB     r0,[r1,#4]            ;3612
000064  9804              LDR      r0,[sp,#0x10]         ;3613
000066  f7fffffe          BL       sync_fs
00006a  4607              MOV      r7,r0                 ;3613
                  |L15.108|
00006c  4638              MOV      r0,r7                 ;3618
00006e  e7da              B        |L15.38|
;;;3620   
                          ENDP


                          AREA ||i.f_close||, CODE, READONLY, ALIGN=1

                  f_close PROC
;;;2820   
;;;2821   FRESULT f_close (
000000  b570              PUSH     {r4-r6,lr}
;;;2822   	FIL *fp		/* Pointer to the file object to be closed */
;;;2823   )
;;;2824   {
000002  4605              MOV      r5,r0
;;;2825   	FRESULT res;
;;;2826   
;;;2827   
;;;2828   #if !_FS_READONLY
;;;2829   	res = f_sync(fp);					/* Flush cached data */
000004  4628              MOV      r0,r5
000006  f7fffffe          BL       f_sync
00000a  4604              MOV      r4,r0
;;;2830   	if (res == FR_OK)
00000c  b944              CBNZ     r4,|L16.32|
;;;2831   #endif
;;;2832   	{
;;;2833   		res = validate(fp);				/* Lock volume */
00000e  4628              MOV      r0,r5
000010  f7fffffe          BL       validate
000014  4604              MOV      r4,r0
;;;2834   		if (res == FR_OK) {
000016  b90c              CBNZ     r4,|L16.28|
;;;2835   #if _FS_REENTRANT
;;;2836   			FATFS *fs = fp->fs;
;;;2837   #endif
;;;2838   #if _FS_LOCK
;;;2839   			res = dec_lock(fp->lockid);	/* Decrement file open counter */
;;;2840   			if (res == FR_OK)
;;;2841   #endif
;;;2842   				fp->fs = 0;				/* Invalidate file object */
000018  2000              MOVS     r0,#0
00001a  6028              STR      r0,[r5,#0]
                  |L16.28|
;;;2843   #if _FS_REENTRANT
;;;2844   			unlock_fs(fs, FR_OK);		/* Unlock volume */
;;;2845   #endif	
;;;2846   		}
;;;2847   		LEAVE_FF(fp->fs,res);			//FATFSbug,,OS,,,.
00001c  4620              MOV      r0,r4
                  |L16.30|
;;;2848   	}
;;;2849   	return res;
;;;2850   }
00001e  bd70              POP      {r4-r6,pc}
                  |L16.32|
000020  4620              MOV      r0,r4                 ;2849
000022  e7fc              B        |L16.30|
;;;2851   
                          ENDP


                          AREA ||i.f_closedir||, CODE, READONLY, ALIGN=1

                  f_closedir PROC
;;;3207   
;;;3208   FRESULT f_closedir (
000000  b570              PUSH     {r4-r6,lr}
;;;3209   	DIR *dp		/* Pointer to the directory object to be closed */
;;;3210   )
;;;3211   {
000002  4604              MOV      r4,r0
;;;3212   	FRESULT res;
;;;3213   
;;;3214   
;;;3215   	res = validate(dp);
000004  4620              MOV      r0,r4
000006  f7fffffe          BL       validate
00000a  4605              MOV      r5,r0
;;;3216   	if (res == FR_OK) {
00000c  b90d              CBNZ     r5,|L17.18|
;;;3217   #if _FS_REENTRANT
;;;3218   		FATFS *fs = dp->fs;
;;;3219   #endif			
;;;3220   #if _FS_LOCK
;;;3221   		if (dp->lockid)				/* Decrement sub-directory open counter */
;;;3222   			res = dec_lock(dp->lockid);
;;;3223   		if (res == FR_OK)
;;;3224   #endif
;;;3225   			dp->fs = 0;				/* Invalidate directory object */
00000e  2000              MOVS     r0,#0
000010  6020              STR      r0,[r4,#0]
                  |L17.18|
;;;3226   #if _FS_REENTRANT
;;;3227   		unlock_fs(fs, FR_OK);		/* Unlock volume */
;;;3228   #endif
;;;3229   	}
;;;3230   	LEAVE_FF(dp->fs,res);		//FATFSbug,,OS,,,.
000012  4628              MOV      r0,r5
;;;3231   	//return res;
;;;3232   }
000014  bd70              POP      {r4-r6,pc}
;;;3233   
                          ENDP


                          AREA ||i.f_getfree||, CODE, READONLY, ALIGN=1

                  f_getfree PROC
;;;3317   
;;;3318   FRESULT f_getfree (
000000  e92d4ff7          PUSH     {r0-r2,r4-r11,lr}
;;;3319   	const TCHAR* path,	/* Path name of the logical drive number */
;;;3320   	DWORD* nclst,		/* Pointer to a variable to return number of free clusters */
;;;3321   	FATFS** fatfs		/* Pointer to return pointer to corresponding file system object */
;;;3322   )
;;;3323   {
000004  b082              SUB      sp,sp,#8
000006  468a              MOV      r10,r1
;;;3324   	FRESULT res;
;;;3325   	FATFS *fs;
;;;3326   	DWORD n, clst, sect, stat;
;;;3327   	UINT i;
;;;3328   	BYTE fat, *p;
;;;3329   
;;;3330   
;;;3331   	/* Get logical drive number */
;;;3332   	res = find_volume(fatfs, &path, 0);
000008  2200              MOVS     r2,#0
00000a  a902              ADD      r1,sp,#8
00000c  9804              LDR      r0,[sp,#0x10]
00000e  f7fffffe          BL       find_volume
000012  9001              STR      r0,[sp,#4]
;;;3333   	fs = *fatfs;
000014  9804              LDR      r0,[sp,#0x10]
000016  6804              LDR      r4,[r0,#0]
;;;3334   	if (res == FR_OK) {
000018  9801              LDR      r0,[sp,#4]
00001a  2800              CMP      r0,#0
00001c  d16d              BNE      |L18.250|
;;;3335   		/* If free_clust is valid, return it without full cluster scan */
;;;3336   		if (fs->free_clust <= fs->n_fatent - 2) {
00001e  e9d41004          LDRD     r1,r0,[r4,#0x10]
000022  1e80              SUBS     r0,r0,#2
000024  4281              CMP      r1,r0
000026  d803              BHI      |L18.48|
;;;3337   			*nclst = fs->free_clust;
000028  6920              LDR      r0,[r4,#0x10]
00002a  f8ca0000          STR      r0,[r10,#0]
00002e  e064              B        |L18.250|
                  |L18.48|
;;;3338   		} else {
;;;3339   			/* Get number of free clusters */
;;;3340   			fat = fs->fs_type;
000030  f894b000          LDRB     r11,[r4,#0]
;;;3341   			n = 0;
000034  2600              MOVS     r6,#0
;;;3342   			if (fat == FS_FAT12) {
000036  f1bb0f01          CMP      r11,#1
00003a  d11c              BNE      |L18.118|
;;;3343   				clst = 2;
00003c  2702              MOVS     r7,#2
;;;3344   				do {
00003e  bf00              NOP      
                  |L18.64|
;;;3345   					stat = get_fat(fs, clst);
000040  4639              MOV      r1,r7
000042  4620              MOV      r0,r4
000044  f7fffffe          BL       get_fat
000048  4680              MOV      r8,r0
;;;3346   					if (stat == 0xFFFFFFFF) { res = FR_DISK_ERR; break; }
00004a  f1080001          ADD      r0,r8,#1
00004e  b910              CBNZ     r0,|L18.86|
000050  2001              MOVS     r0,#1
000052  9001              STR      r0,[sp,#4]
000054  e00e              B        |L18.116|
                  |L18.86|
;;;3347   					if (stat == 1) { res = FR_INT_ERR; break; }
000056  f1b80f01          CMP      r8,#1
00005a  d102              BNE      |L18.98|
00005c  2002              MOVS     r0,#2
00005e  9001              STR      r0,[sp,#4]
000060  e008              B        |L18.116|
                  |L18.98|
;;;3348   					if (stat == 0) n++;
000062  f1b80f00          CMP      r8,#0
000066  d100              BNE      |L18.106|
000068  1c76              ADDS     r6,r6,#1
                  |L18.106|
;;;3349   				} while (++clst < fs->n_fatent);
00006a  1c78              ADDS     r0,r7,#1
00006c  4607              MOV      r7,r0
00006e  6961              LDR      r1,[r4,#0x14]
000070  4288              CMP      r0,r1
000072  d3e5              BCC      |L18.64|
                  |L18.116|
000074  e03a              B        |L18.236|
                  |L18.118|
;;;3350   			} else {
;;;3351   				clst = fs->n_fatent;
000076  6967              LDR      r7,[r4,#0x14]
;;;3352   				sect = fs->fatbase;
000078  6a20              LDR      r0,[r4,#0x20]
00007a  9000              STR      r0,[sp,#0]
;;;3353   				i = 0; p = 0;
00007c  f04f0900          MOV      r9,#0
000080  2500              MOVS     r5,#0
;;;3354   				do {
000082  bf00              NOP      
                  |L18.132|
;;;3355   					if (!i) {
000084  f1b90f00          CMP      r9,#0
000088  d10e              BNE      |L18.168|
;;;3356   						res = move_window(fs, sect++);
00008a  9800              LDR      r0,[sp,#0]
00008c  1c42              ADDS     r2,r0,#1
00008e  4601              MOV      r1,r0
000090  4620              MOV      r0,r4
000092  9200              STR      r2,[sp,#0]
000094  f7fffffe          BL       move_window
000098  9001              STR      r0,[sp,#4]
;;;3357   						if (res != FR_OK) break;
00009a  9801              LDR      r0,[sp,#4]
00009c  b100              CBZ      r0,|L18.160|
00009e  e024              B        |L18.234|
                  |L18.160|
;;;3358   						p = fs->win;
0000a0  f1040530          ADD      r5,r4,#0x30
;;;3359   						i = SS(fs);
0000a4  f44f7900          MOV      r9,#0x200
                  |L18.168|
;;;3360   					}
;;;3361   					if (fat == FS_FAT16) {
0000a8  f1bb0f02          CMP      r11,#2
0000ac  d109              BNE      |L18.194|
;;;3362   						if (LD_WORD(p) == 0) n++;
0000ae  7828              LDRB     r0,[r5,#0]
0000b0  7869              LDRB     r1,[r5,#1]
0000b2  ea402001          ORR      r0,r0,r1,LSL #8
0000b6  b900              CBNZ     r0,|L18.186|
0000b8  1c76              ADDS     r6,r6,#1
                  |L18.186|
;;;3363   						p += 2; i -= 2;
0000ba  1cad              ADDS     r5,r5,#2
0000bc  f1a90902          SUB      r9,r9,#2
0000c0  e010              B        |L18.228|
                  |L18.194|
;;;3364   					} else {
;;;3365   						if ((LD_DWORD(p) & 0x0FFFFFFF) == 0) n++;
0000c2  78e8              LDRB     r0,[r5,#3]
0000c4  0600              LSLS     r0,r0,#24
0000c6  78a9              LDRB     r1,[r5,#2]
0000c8  ea404001          ORR      r0,r0,r1,LSL #16
0000cc  7869              LDRB     r1,[r5,#1]
0000ce  ea402001          ORR      r0,r0,r1,LSL #8
0000d2  7829              LDRB     r1,[r5,#0]
0000d4  4308              ORRS     r0,r0,r1
0000d6  f0204070          BIC      r0,r0,#0xf0000000
0000da  b900              CBNZ     r0,|L18.222|
0000dc  1c76              ADDS     r6,r6,#1
                  |L18.222|
;;;3366   						p += 4; i -= 4;
0000de  1d2d              ADDS     r5,r5,#4
0000e0  f1a90904          SUB      r9,r9,#4
                  |L18.228|
;;;3367   					}
;;;3368   				} while (--clst);
0000e4  1e78              SUBS     r0,r7,#1
0000e6  1e07              SUBS     r7,r0,#0
0000e8  d1cc              BNE      |L18.132|
                  |L18.234|
0000ea  bf00              NOP                            ;3357
                  |L18.236|
;;;3369   			}
;;;3370   			fs->free_clust = n;
0000ec  6126              STR      r6,[r4,#0x10]
;;;3371   			fs->fsi_flag |= 1;
0000ee  7960              LDRB     r0,[r4,#5]
0000f0  f0400001          ORR      r0,r0,#1
0000f4  7160              STRB     r0,[r4,#5]
;;;3372   			*nclst = n;
0000f6  f8ca6000          STR      r6,[r10,#0]
                  |L18.250|
;;;3373   		}
;;;3374   	}
;;;3375   	LEAVE_FF(fs, res);
0000fa  9801              LDR      r0,[sp,#4]
;;;3376   }
0000fc  b005              ADD      sp,sp,#0x14
0000fe  e8bd8ff0          POP      {r4-r11,pc}
;;;3377   
                          ENDP


                          AREA ||i.f_getlabel||, CODE, READONLY, ALIGN=1

                  f_getlabel PROC
;;;3753   
;;;3754   FRESULT f_getlabel (
000000  e92d41f7          PUSH     {r0-r2,r4-r8,lr}
;;;3755   	const TCHAR* path,	/* Path name of the logical drive number */
;;;3756   	TCHAR* label,		/* Pointer to a buffer to return the volume label */
;;;3757   	DWORD* vsn			/* Pointer to a variable to return the volume serial number */
;;;3758   )
;;;3759   {
000004  b089              SUB      sp,sp,#0x24
000006  460d              MOV      r5,r1
000008  4690              MOV      r8,r2
;;;3760   	FRESULT res;
;;;3761   	DIR dj;
;;;3762   	UINT i, j;
;;;3763   
;;;3764   
;;;3765   	/* Get logical drive number */
;;;3766   	res = find_volume(&dj.fs, &path, 0);
00000a  2200              MOVS     r2,#0
00000c  a909              ADD      r1,sp,#0x24
00000e  4668              MOV      r0,sp
000010  f7fffffe          BL       find_volume
000014  4604              MOV      r4,r0
;;;3767   
;;;3768   	/* Get volume label */
;;;3769   	if (res == FR_OK && label) {
000016  bb24              CBNZ     r4,|L19.98|
000018  b31d              CBZ      r5,|L19.98|
;;;3770   		dj.sclust = 0;					/* Open root directory */
00001a  2000              MOVS     r0,#0
00001c  9002              STR      r0,[sp,#8]
;;;3771   		res = dir_sdi(&dj, 0);
00001e  2100              MOVS     r1,#0
000020  4668              MOV      r0,sp
000022  f7fffffe          BL       dir_sdi
000026  4604              MOV      r4,r0
;;;3772   		if (res == FR_OK) {
000028  b9dc              CBNZ     r4,|L19.98|
;;;3773   			res = dir_read(&dj, 1);		/* Get an entry with AM_VOL */
00002a  2101              MOVS     r1,#1
00002c  4668              MOV      r0,sp
00002e  f7fffffe          BL       dir_read
000032  4604              MOV      r4,r0
;;;3774   			if (res == FR_OK) {			/* A volume label is exist */
000034  b984              CBNZ     r4,|L19.88|
;;;3775   #if _USE_LFN && _LFN_UNICODE
;;;3776   				WCHAR w;
;;;3777   				i = j = 0;
;;;3778   				do {
;;;3779   					w = (i < 11) ? dj.dir[i++] : ' ';
;;;3780   					if (IsDBCS1(w) && i < 11 && IsDBCS2(dj.dir[i]))
;;;3781   						w = w << 8 | dj.dir[i++];
;;;3782   					label[j++] = ff_convert(w, 1);	/* OEM -> Unicode */
;;;3783   				} while (j < 11);
;;;3784   #else
;;;3785   				mem_cpy(label, dj.dir, 11);
000036  220b              MOVS     r2,#0xb
000038  4628              MOV      r0,r5
00003a  9905              LDR      r1,[sp,#0x14]
00003c  f7fffffe          BL       mem_cpy
;;;3786   #endif
;;;3787   				j = 11;
000040  270b              MOVS     r7,#0xb
;;;3788   				do {
000042  bf00              NOP      
                  |L19.68|
;;;3789   					label[j] = 0;
000044  2000              MOVS     r0,#0
000046  55e8              STRB     r0,[r5,r7]
;;;3790   					if (!j) break;
000048  b907              CBNZ     r7,|L19.76|
00004a  e004              B        |L19.86|
                  |L19.76|
;;;3791   				} while (label[--j] == ' ');
00004c  1e78              SUBS     r0,r7,#1
00004e  4607              MOV      r7,r0
000050  5c28              LDRB     r0,[r5,r0]
000052  2820              CMP      r0,#0x20
000054  d0f6              BEQ      |L19.68|
                  |L19.86|
000056  bf00              NOP                            ;3790
                  |L19.88|
;;;3792   			}
;;;3793   			if (res == FR_NO_FILE) {	/* No label, return nul string */
000058  2c04              CMP      r4,#4
00005a  d102              BNE      |L19.98|
;;;3794   				label[0] = 0;
00005c  2000              MOVS     r0,#0
00005e  7028              STRB     r0,[r5,#0]
;;;3795   				res = FR_OK;
000060  2400              MOVS     r4,#0
                  |L19.98|
;;;3796   			}
;;;3797   		}
;;;3798   	}
;;;3799   
;;;3800   	/* Get volume serial number */
;;;3801   	if (res == FR_OK && vsn) {
000062  bb44              CBNZ     r4,|L19.182|
000064  f1b80f00          CMP      r8,#0
000068  d025              BEQ      |L19.182|
;;;3802   		res = move_window(dj.fs, dj.fs->volbase);
00006a  9a00              LDR      r2,[sp,#0]
00006c  4610              MOV      r0,r2
00006e  69d1              LDR      r1,[r2,#0x1c]
000070  f7fffffe          BL       move_window
000074  4604              MOV      r4,r0
;;;3803   		if (res == FR_OK) {
000076  b9f4              CBNZ     r4,|L19.182|
;;;3804   			i = dj.fs->fs_type == FS_FAT32 ? BS_VolID32 : BS_VolID;
000078  9800              LDR      r0,[sp,#0]
00007a  7800              LDRB     r0,[r0,#0]
00007c  2803              CMP      r0,#3
00007e  d101              BNE      |L19.132|
000080  2043              MOVS     r0,#0x43
000082  e000              B        |L19.134|
                  |L19.132|
000084  2027              MOVS     r0,#0x27
                  |L19.134|
000086  4606              MOV      r6,r0
;;;3805   			*vsn = LD_DWORD(&dj.fs->win[i]);
000088  9800              LDR      r0,[sp,#0]
00008a  3030              ADDS     r0,r0,#0x30
00008c  4430              ADD      r0,r0,r6
00008e  78c0              LDRB     r0,[r0,#3]
000090  0601              LSLS     r1,r0,#24
000092  9800              LDR      r0,[sp,#0]
000094  3030              ADDS     r0,r0,#0x30
000096  4430              ADD      r0,r0,r6
000098  7880              LDRB     r0,[r0,#2]
00009a  ea414100          ORR      r1,r1,r0,LSL #16
00009e  9800              LDR      r0,[sp,#0]
0000a0  3030              ADDS     r0,r0,#0x30
0000a2  4430              ADD      r0,r0,r6
0000a4  7840              LDRB     r0,[r0,#1]
0000a6  ea412000          ORR      r0,r1,r0,LSL #8
0000aa  9900              LDR      r1,[sp,#0]
0000ac  3130              ADDS     r1,r1,#0x30
0000ae  5d89              LDRB     r1,[r1,r6]
0000b0  4308              ORRS     r0,r0,r1
0000b2  f8c80000          STR      r0,[r8,#0]
                  |L19.182|
;;;3806   		}
;;;3807   	}
;;;3808   
;;;3809   	LEAVE_FF(dj.fs, res);
0000b6  4620              MOV      r0,r4
;;;3810   }
0000b8  b00c              ADD      sp,sp,#0x30
0000ba  e8bd81f0          POP      {r4-r8,pc}
;;;3811   
                          ENDP


                          AREA ||i.f_gets||, CODE, READONLY, ALIGN=1

                  f_gets PROC
;;;4294   
;;;4295   TCHAR* f_gets (
000000  e92d47fc          PUSH     {r2-r10,lr}
;;;4296   	TCHAR* buff,	/* Pointer to the string buffer to read */
;;;4297   	int len,		/* Size of string buffer (characters) */
;;;4298   	FIL* fp			/* Pointer to the file object */
;;;4299   )
;;;4300   {
000004  4607              MOV      r7,r0
000006  4688              MOV      r8,r1
000008  4691              MOV      r9,r2
;;;4301   	int n = 0;
00000a  2400              MOVS     r4,#0
;;;4302   	TCHAR c, *p = buff;
00000c  463e              MOV      r6,r7
;;;4303   	BYTE s[2];
;;;4304   	UINT rc;
;;;4305   
;;;4306   
;;;4307   	while (n < len - 1) {	/* Read characters until buffer gets filled */
00000e  e013              B        |L20.56|
                  |L20.16|
;;;4308   #if _USE_LFN && _LFN_UNICODE
;;;4309   #if _STRF_ENCODE == 3		/* Read a character in UTF-8 */
;;;4310   		f_read(fp, s, 1, &rc);
;;;4311   		if (rc != 1) break;
;;;4312   		c = s[0];
;;;4313   		if (c >= 0x80) {
;;;4314   			if (c < 0xC0) continue;	/* Skip stray trailer */
;;;4315   			if (c < 0xE0) {			/* Two-byte sequence */
;;;4316   				f_read(fp, s, 1, &rc);
;;;4317   				if (rc != 1) break;
;;;4318   				c = (c & 0x1F) << 6 | (s[0] & 0x3F);
;;;4319   				if (c < 0x80) c = '?';
;;;4320   			} else {
;;;4321   				if (c < 0xF0) {		/* Three-byte sequence */
;;;4322   					f_read(fp, s, 2, &rc);
;;;4323   					if (rc != 2) break;
;;;4324   					c = c << 12 | (s[0] & 0x3F) << 6 | (s[1] & 0x3F);
;;;4325   					if (c < 0x800) c = '?';
;;;4326   				} else {			/* Reject four-byte sequence */
;;;4327   					c = '?';
;;;4328   				}
;;;4329   			}
;;;4330   		}
;;;4331   #elif _STRF_ENCODE == 2		/* Read a character in UTF-16BE */
;;;4332   		f_read(fp, s, 2, &rc);
;;;4333   		if (rc != 2) break;
;;;4334   		c = s[1] + (s[0] << 8);
;;;4335   #elif _STRF_ENCODE == 1		/* Read a character in UTF-16LE */
;;;4336   		f_read(fp, s, 2, &rc);
;;;4337   		if (rc != 2) break;
;;;4338   		c = s[0] + (s[1] << 8);
;;;4339   #else						/* Read a character in ANSI/OEM */
;;;4340   		f_read(fp, s, 1, &rc);
;;;4341   		if (rc != 1) break;
;;;4342   		c = s[0];
;;;4343   		if (IsDBCS1(c)) {
;;;4344   			f_read(fp, s, 1, &rc);
;;;4345   			if (rc != 1) break;
;;;4346   			c = (c << 8) + s[0];
;;;4347   		}
;;;4348   		c = ff_convert(c, 1);	/* OEM -> Unicode */
;;;4349   		if (!c) c = '?';
;;;4350   #endif
;;;4351   #else						/* Read a character without conversion */
;;;4352   		f_read(fp, s, 1, &rc);
000010  466b              MOV      r3,sp
000012  2201              MOVS     r2,#1
000014  a901              ADD      r1,sp,#4
000016  4648              MOV      r0,r9
000018  f7fffffe          BL       f_read
;;;4353   		if (rc != 1) break;
00001c  9800              LDR      r0,[sp,#0]
00001e  2801              CMP      r0,#1
000020  d000              BEQ      |L20.36|
000022  e00d              B        |L20.64|
                  |L20.36|
;;;4354   		c = s[0];
000024  f89d5004          LDRB     r5,[sp,#4]
;;;4355   #endif
;;;4356   		if (_USE_STRFUNC == 2 && c == '\r') continue;	/* Strip '\r' */
000028  bf00              NOP      
;;;4357   		*p++ = c;
00002a  f8065b01          STRB     r5,[r6],#1
;;;4358   		n++;
00002e  1c64              ADDS     r4,r4,#1
;;;4359   		if (c == '\n') break;		/* Break on EOL */
000030  2d0a              CMP      r5,#0xa
000032  d100              BNE      |L20.54|
000034  e004              B        |L20.64|
                  |L20.54|
000036  bf00              NOP                            ;4356
                  |L20.56|
000038  f1a80001          SUB      r0,r8,#1              ;4307
00003c  42a0              CMP      r0,r4                 ;4307
00003e  dce7              BGT      |L20.16|
                  |L20.64|
000040  bf00              NOP                            ;4353
;;;4360   	}
;;;4361   	*p = 0;
000042  2000              MOVS     r0,#0
000044  7030              STRB     r0,[r6,#0]
;;;4362   	return n ? buff : 0;			/* When no data read (eof or error), return with error. */
000046  b114              CBZ      r4,|L20.78|
000048  4638              MOV      r0,r7
                  |L20.74|
;;;4363   }
00004a  e8bd87fc          POP      {r2-r10,pc}
                  |L20.78|
00004e  2000              MOVS     r0,#0                 ;4362
000050  e7fb              B        |L20.74|
;;;4364   
                          ENDP


                          AREA ||i.f_lseek||, CODE, READONLY, ALIGN=1

                  f_lseek PROC
;;;2993   
;;;2994   FRESULT f_lseek (
000000  e92d4ffe          PUSH     {r1-r11,lr}
;;;2995   	FIL* fp,		/* Pointer to the file object */
;;;2996   	DWORD ofs		/* File pointer from top of file */
;;;2997   )
;;;2998   {
000004  4604              MOV      r4,r0
000006  460d              MOV      r5,r1
;;;2999   	FRESULT res;
;;;3000   
;;;3001   
;;;3002   	res = validate(fp);					/* Check validity of the object */
000008  4620              MOV      r0,r4
00000a  f7fffffe          BL       validate
00000e  9002              STR      r0,[sp,#8]
;;;3003   	if (res != FR_OK) LEAVE_FF(fp->fs, res);
000010  9802              LDR      r0,[sp,#8]
000012  b110              CBZ      r0,|L21.26|
000014  9802              LDR      r0,[sp,#8]
                  |L21.22|
;;;3004   	if (fp->err)						/* Check error */
;;;3005   		LEAVE_FF(fp->fs, (FRESULT)fp->err);
;;;3006   
;;;3007   #if _USE_FASTSEEK
;;;3008   	if (fp->cltbl) {	/* Fast seek */
;;;3009   		DWORD cl, pcl, ncl, tcl, dsc, tlen, ulen, *tbl;
;;;3010   
;;;3011   		if (ofs == CREATE_LINKMAP) {	/* Create CLMT */
;;;3012   			tbl = fp->cltbl;
;;;3013   			tlen = *tbl++; ulen = 2;	/* Given table size and required table size */
;;;3014   			cl = fp->sclust;			/* Top of the chain */
;;;3015   			if (cl) {
;;;3016   				do {
;;;3017   					/* Get a fragment */
;;;3018   					tcl = cl; ncl = 0; ulen += 2;	/* Top, length and used items */
;;;3019   					do {
;;;3020   						pcl = cl; ncl++;
;;;3021   						cl = get_fat(fp->fs, cl);
;;;3022   						if (cl <= 1) ABORT(fp->fs, FR_INT_ERR);
;;;3023   						if (cl == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;3024   					} while (cl == pcl + 1);
;;;3025   					if (ulen <= tlen) {		/* Store the length and top of the fragment */
;;;3026   						*tbl++ = ncl; *tbl++ = tcl;
;;;3027   					}
;;;3028   				} while (cl < fp->fs->n_fatent);	/* Repeat until end of chain */
;;;3029   			}
;;;3030   			*fp->cltbl = ulen;	/* Number of items used */
;;;3031   			if (ulen <= tlen)
;;;3032   				*tbl = 0;		/* Terminate table */
;;;3033   			else
;;;3034   				res = FR_NOT_ENOUGH_CORE;	/* Given table size is smaller than required */
;;;3035   
;;;3036   		} else {						/* Fast seek */
;;;3037   			if (ofs > fp->fsize)		/* Clip offset at the file size */
;;;3038   				ofs = fp->fsize;
;;;3039   			fp->fptr = ofs;				/* Set file pointer */
;;;3040   			if (ofs) {
;;;3041   				fp->clust = clmt_clust(fp, ofs - 1);
;;;3042   				dsc = clust2sect(fp->fs, fp->clust);
;;;3043   				if (!dsc) ABORT(fp->fs, FR_INT_ERR);
;;;3044   				dsc += (ofs - 1) / SS(fp->fs) & (fp->fs->csize - 1);
;;;3045   				if (fp->fptr % SS(fp->fs) && dsc != fp->dsect) {	/* Refill sector cache if needed */
;;;3046   #if !_FS_TINY
;;;3047   #if !_FS_READONLY
;;;3048   					if (fp->flag & FA__DIRTY) {		/* Write-back dirty sector cache */
;;;3049   						if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
;;;3050   							ABORT(fp->fs, FR_DISK_ERR);
;;;3051   						fp->flag &= ~FA__DIRTY;
;;;3052   					}
;;;3053   #endif
;;;3054   					if (disk_read(fp->fs->drv, fp->buf, dsc, 1))	/* Load current sector */
;;;3055   						ABORT(fp->fs, FR_DISK_ERR);
;;;3056   #endif
;;;3057   					fp->dsect = dsc;
;;;3058   				}
;;;3059   			}
;;;3060   		}
;;;3061   	} else
;;;3062   #endif
;;;3063   
;;;3064   	/* Normal Seek */
;;;3065   	{
;;;3066   		DWORD clst, bcs, nsect, ifptr;
;;;3067   
;;;3068   		if (ofs > fp->fsize					/* In read-only mode, clip offset with the file size */
;;;3069   #if !_FS_READONLY
;;;3070   			 && !(fp->flag & FA_WRITE)
;;;3071   #endif
;;;3072   			) ofs = fp->fsize;
;;;3073   
;;;3074   		ifptr = fp->fptr;
;;;3075   		fp->fptr = nsect = 0;
;;;3076   		if (ofs) {
;;;3077   			bcs = (DWORD)fp->fs->csize * SS(fp->fs);	/* Cluster size (byte) */
;;;3078   			if (ifptr > 0 &&
;;;3079   				(ofs - 1) / bcs >= (ifptr - 1) / bcs) {	/* When seek to same or following cluster, */
;;;3080   				fp->fptr = (ifptr - 1) & ~(bcs - 1);	/* start from the current cluster */
;;;3081   				ofs -= fp->fptr;
;;;3082   				clst = fp->clust;
;;;3083   			} else {									/* When seek to back cluster, */
;;;3084   				clst = fp->sclust;						/* start from the first cluster */
;;;3085   #if !_FS_READONLY
;;;3086   				if (clst == 0) {						/* If no cluster chain, create a new chain */
;;;3087   					clst = create_chain(fp->fs, 0);
;;;3088   					if (clst == 1) ABORT(fp->fs, FR_INT_ERR);
;;;3089   					if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;3090   					fp->sclust = clst;
;;;3091   				}
;;;3092   #endif
;;;3093   				fp->clust = clst;
;;;3094   			}
;;;3095   			if (clst != 0) {
;;;3096   				while (ofs > bcs) {						/* Cluster following loop */
;;;3097   #if !_FS_READONLY
;;;3098   					if (fp->flag & FA_WRITE) {			/* Check if in write mode or not */
;;;3099   						clst = create_chain(fp->fs, clst);	/* Force stretch if in write mode */
;;;3100   						if (clst == 0) {				/* When disk gets full, clip file size */
;;;3101   							ofs = bcs; break;
;;;3102   						}
;;;3103   					} else
;;;3104   #endif
;;;3105   						clst = get_fat(fp->fs, clst);	/* Follow cluster chain if not in write mode */
;;;3106   					if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;3107   					if (clst <= 1 || clst >= fp->fs->n_fatent) ABORT(fp->fs, FR_INT_ERR);
;;;3108   					fp->clust = clst;
;;;3109   					fp->fptr += bcs;
;;;3110   					ofs -= bcs;
;;;3111   				}
;;;3112   				fp->fptr += ofs;
;;;3113   				if (ofs % SS(fp->fs)) {
;;;3114   					nsect = clust2sect(fp->fs, clst);	/* Current sector */
;;;3115   					if (!nsect) ABORT(fp->fs, FR_INT_ERR);
;;;3116   					nsect += ofs / SS(fp->fs);
;;;3117   				}
;;;3118   			}
;;;3119   		}
;;;3120   		if (fp->fptr % SS(fp->fs) && nsect != fp->dsect) {	/* Fill sector cache if needed */
;;;3121   #if !_FS_TINY
;;;3122   #if !_FS_READONLY
;;;3123   			if (fp->flag & FA__DIRTY) {			/* Write-back dirty sector cache */
;;;3124   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
;;;3125   					ABORT(fp->fs, FR_DISK_ERR);
;;;3126   				fp->flag &= ~FA__DIRTY;
;;;3127   			}
;;;3128   #endif
;;;3129   			if (disk_read(fp->fs->drv, fp->buf, nsect, 1))	/* Fill sector cache */
;;;3130   				ABORT(fp->fs, FR_DISK_ERR);
;;;3131   #endif
;;;3132   			fp->dsect = nsect;
;;;3133   		}
;;;3134   #if !_FS_READONLY
;;;3135   		if (fp->fptr > fp->fsize) {			/* Set file change flag if the file size is extended */
;;;3136   			fp->fsize = fp->fptr;
;;;3137   			fp->flag |= FA__WRITTEN;
;;;3138   		}
;;;3139   #endif
;;;3140   	}
;;;3141   
;;;3142   	LEAVE_FF(fp->fs, res);
;;;3143   }
000016  e8bd8ffe          POP      {r1-r11,pc}
                  |L21.26|
00001a  79e0              LDRB     r0,[r4,#7]            ;3004
00001c  b108              CBZ      r0,|L21.34|
00001e  79e0              LDRB     r0,[r4,#7]            ;3005
000020  e7f9              B        |L21.22|
                  |L21.34|
000022  6a60              LDR      r0,[r4,#0x24]         ;3008
000024  2800              CMP      r0,#0                 ;3008
000026  d071              BEQ      |L21.268|
000028  1c68              ADDS     r0,r5,#1              ;3011
00002a  2800              CMP      r0,#0                 ;3011
00002c  d13b              BNE      |L21.166|
00002e  f8d48024          LDR      r8,[r4,#0x24]         ;3012
000032  f858ab04          LDR      r10,[r8],#4           ;3013
000036  f04f0902          MOV      r9,#2                 ;3013
00003a  6926              LDR      r6,[r4,#0x10]         ;3014
00003c  b33e              CBZ      r6,|L21.142|
00003e  bf00              NOP                            ;3016
                  |L21.64|
000040  9600              STR      r6,[sp,#0]            ;3018
000042  f04f0b00          MOV      r11,#0                ;3018
000046  f1090902          ADD      r9,r9,#2              ;3018
00004a  bf00              NOP                            ;3019
                  |L21.76|
00004c  9601              STR      r6,[sp,#4]            ;3020
00004e  f10b0b01          ADD      r11,r11,#1            ;3020
000052  4631              MOV      r1,r6                 ;3021
000054  6820              LDR      r0,[r4,#0]            ;3021
000056  f7fffffe          BL       get_fat
00005a  4606              MOV      r6,r0                 ;3021
00005c  2e01              CMP      r6,#1                 ;3022
00005e  d802              BHI      |L21.102|
000060  2002              MOVS     r0,#2                 ;3022
000062  71e0              STRB     r0,[r4,#7]            ;3022
000064  e7d7              B        |L21.22|
                  |L21.102|
000066  1c70              ADDS     r0,r6,#1              ;3023
000068  b910              CBNZ     r0,|L21.112|
00006a  2001              MOVS     r0,#1                 ;3023
00006c  71e0              STRB     r0,[r4,#7]            ;3023
00006e  e7d2              B        |L21.22|
                  |L21.112|
000070  9801              LDR      r0,[sp,#4]            ;3024
000072  1c40              ADDS     r0,r0,#1              ;3024
000074  4286              CMP      r6,r0                 ;3024
000076  d0e9              BEQ      |L21.76|
000078  45d1              CMP      r9,r10                ;3025
00007a  d804              BHI      |L21.134|
00007c  f848bb04          STR      r11,[r8],#4           ;3026
000080  9800              LDR      r0,[sp,#0]            ;3026
000082  f8480b04          STR      r0,[r8],#4            ;3026
                  |L21.134|
000086  6820              LDR      r0,[r4,#0]            ;3028
000088  6940              LDR      r0,[r0,#0x14]         ;3028
00008a  42b0              CMP      r0,r6                 ;3028
00008c  d8d8              BHI      |L21.64|
                  |L21.142|
00008e  6a60              LDR      r0,[r4,#0x24]         ;3030
000090  f8c09000          STR      r9,[r0,#0]            ;3030
000094  45d1              CMP      r9,r10                ;3031
000096  d803              BHI      |L21.160|
000098  2000              MOVS     r0,#0                 ;3032
00009a  f8c80000          STR      r0,[r8,#0]            ;3032
00009e  e047              B        |L21.304|
                  |L21.160|
0000a0  2011              MOVS     r0,#0x11              ;3034
0000a2  9002              STR      r0,[sp,#8]            ;3034
0000a4  e044              B        |L21.304|
                  |L21.166|
0000a6  68e0              LDR      r0,[r4,#0xc]          ;3037
0000a8  42a8              CMP      r0,r5                 ;3037
0000aa  d200              BCS      |L21.174|
0000ac  68e5              LDR      r5,[r4,#0xc]          ;3038
                  |L21.174|
0000ae  60a5              STR      r5,[r4,#8]            ;3039
0000b0  2d00              CMP      r5,#0                 ;3040
0000b2  d03d              BEQ      |L21.304|
0000b4  1e69              SUBS     r1,r5,#1              ;3041
0000b6  4620              MOV      r0,r4                 ;3041
0000b8  f7fffffe          BL       clmt_clust
0000bc  6160              STR      r0,[r4,#0x14]         ;3041
0000be  6961              LDR      r1,[r4,#0x14]         ;3042
0000c0  6820              LDR      r0,[r4,#0]            ;3042
0000c2  f7fffffe          BL       clust2sect
0000c6  4607              MOV      r7,r0                 ;3042
0000c8  b917              CBNZ     r7,|L21.208|
0000ca  2002              MOVS     r0,#2                 ;3043
0000cc  71e0              STRB     r0,[r4,#7]            ;3043
0000ce  e7a2              B        |L21.22|
                  |L21.208|
0000d0  6820              LDR      r0,[r4,#0]            ;3044
0000d2  7880              LDRB     r0,[r0,#2]            ;3044
0000d4  1e40              SUBS     r0,r0,#1              ;3044
0000d6  1e69              SUBS     r1,r5,#1              ;3044
0000d8  ea002051          AND      r0,r0,r1,LSR #9       ;3044
0000dc  4407              ADD      r7,r7,r0              ;3044
0000de  8920              LDRH     r0,[r4,#8]            ;3045
0000e0  f3c00008          UBFX     r0,r0,#0,#9           ;3045
0000e4  b320              CBZ      r0,|L21.304|
0000e6  69a0              LDR      r0,[r4,#0x18]         ;3045
0000e8  42b8              CMP      r0,r7                 ;3045
0000ea  d021              BEQ      |L21.304|
0000ec  79a0              LDRB     r0,[r4,#6]            ;3048
0000ee  f0000040          AND      r0,r0,#0x40           ;3048
0000f2  b180              CBZ      r0,|L21.278|
0000f4  6821              LDR      r1,[r4,#0]            ;3049
0000f6  7848              LDRB     r0,[r1,#1]            ;3049
0000f8  2301              MOVS     r3,#1                 ;3049
0000fa  f1040128          ADD      r1,r4,#0x28           ;3049
0000fe  69a2              LDR      r2,[r4,#0x18]         ;3049
000100  f7fffffe          BL       disk_write
000104  b118              CBZ      r0,|L21.270|
000106  2001              MOVS     r0,#1                 ;3050
000108  71e0              STRB     r0,[r4,#7]            ;3050
00010a  e784              B        |L21.22|
                  |L21.268|
00010c  e011              B        |L21.306|
                  |L21.270|
00010e  79a0              LDRB     r0,[r4,#6]            ;3051
000110  f0200040          BIC      r0,r0,#0x40           ;3051
000114  71a0              STRB     r0,[r4,#6]            ;3051
                  |L21.278|
000116  6821              LDR      r1,[r4,#0]            ;3054
000118  7848              LDRB     r0,[r1,#1]            ;3054
00011a  2301              MOVS     r3,#1                 ;3054
00011c  463a              MOV      r2,r7                 ;3054
00011e  f1040128          ADD      r1,r4,#0x28           ;3054
000122  f7fffffe          BL       disk_read
000126  b110              CBZ      r0,|L21.302|
000128  2001              MOVS     r0,#1                 ;3055
00012a  71e0              STRB     r0,[r4,#7]            ;3055
00012c  e773              B        |L21.22|
                  |L21.302|
00012e  61a7              STR      r7,[r4,#0x18]         ;3057
                  |L21.304|
000130  e0ab              B        |L21.650|
                  |L21.306|
000132  68e0              LDR      r0,[r4,#0xc]          ;3068
000134  42a8              CMP      r0,r5                 ;3068
000136  d204              BCS      |L21.322|
000138  79a0              LDRB     r0,[r4,#6]            ;3070
00013a  f0000002          AND      r0,r0,#2              ;3070
00013e  b900              CBNZ     r0,|L21.322|
000140  68e5              LDR      r5,[r4,#0xc]          ;3072
                  |L21.322|
000142  f8d49008          LDR      r9,[r4,#8]            ;3074
000146  f04f0800          MOV      r8,#0                 ;3075
00014a  f8c48008          STR      r8,[r4,#8]            ;3075
00014e  2d00              CMP      r5,#0                 ;3076
000150  d067              BEQ      |L21.546|
000152  6820              LDR      r0,[r4,#0]            ;3077
000154  7880              LDRB     r0,[r0,#2]            ;3077
000156  0247              LSLS     r7,r0,#9              ;3077
000158  f1b90f00          CMP      r9,#0                 ;3078
00015c  d011              BEQ      |L21.386|
00015e  1e68              SUBS     r0,r5,#1              ;3079
000160  fbb0f1f7          UDIV     r1,r0,r7              ;3079
000164  f1a90001          SUB      r0,r9,#1              ;3079
000168  fbb0f0f7          UDIV     r0,r0,r7              ;3079
00016c  4281              CMP      r1,r0                 ;3079
00016e  d308              BCC      |L21.386|
000170  f1a90001          SUB      r0,r9,#1              ;3080
000174  1e79              SUBS     r1,r7,#1              ;3080
000176  4388              BICS     r0,r0,r1              ;3080
000178  60a0              STR      r0,[r4,#8]            ;3080
00017a  68a0              LDR      r0,[r4,#8]            ;3081
00017c  1a2d              SUBS     r5,r5,r0              ;3081
00017e  6966              LDR      r6,[r4,#0x14]         ;3082
000180  e012              B        |L21.424|
                  |L21.386|
000182  6926              LDR      r6,[r4,#0x10]         ;3084
000184  b97e              CBNZ     r6,|L21.422|
000186  2100              MOVS     r1,#0                 ;3087
000188  6820              LDR      r0,[r4,#0]            ;3087
00018a  f7fffffe          BL       create_chain
00018e  4606              MOV      r6,r0                 ;3087
000190  2e01              CMP      r6,#1                 ;3088
000192  d102              BNE      |L21.410|
000194  2002              MOVS     r0,#2                 ;3088
000196  71e0              STRB     r0,[r4,#7]            ;3088
000198  e73d              B        |L21.22|
                  |L21.410|
00019a  1c70              ADDS     r0,r6,#1              ;3089
00019c  b910              CBNZ     r0,|L21.420|
00019e  2001              MOVS     r0,#1                 ;3089
0001a0  71e0              STRB     r0,[r4,#7]            ;3089
0001a2  e738              B        |L21.22|
                  |L21.420|
0001a4  6126              STR      r6,[r4,#0x10]         ;3090
                  |L21.422|
0001a6  6166              STR      r6,[r4,#0x14]         ;3093
                  |L21.424|
0001a8  b3c6              CBZ      r6,|L21.540|
0001aa  e023              B        |L21.500|
                  |L21.428|
0001ac  79a0              LDRB     r0,[r4,#6]            ;3098
0001ae  f0000002          AND      r0,r0,#2              ;3098
0001b2  b138              CBZ      r0,|L21.452|
0001b4  4631              MOV      r1,r6                 ;3099
0001b6  6820              LDR      r0,[r4,#0]            ;3099
0001b8  f7fffffe          BL       create_chain
0001bc  4606              MOV      r6,r0                 ;3099
0001be  b936              CBNZ     r6,|L21.462|
0001c0  463d              MOV      r5,r7                 ;3101
0001c2  e019              B        |L21.504|
                  |L21.452|
0001c4  4631              MOV      r1,r6                 ;3105
0001c6  6820              LDR      r0,[r4,#0]            ;3105
0001c8  f7fffffe          BL       get_fat
0001cc  4606              MOV      r6,r0                 ;3105
                  |L21.462|
0001ce  1c70              ADDS     r0,r6,#1              ;3106
0001d0  b910              CBNZ     r0,|L21.472|
0001d2  2001              MOVS     r0,#1                 ;3106
0001d4  71e0              STRB     r0,[r4,#7]            ;3106
0001d6  e71e              B        |L21.22|
                  |L21.472|
0001d8  2e01              CMP      r6,#1                 ;3107
0001da  d903              BLS      |L21.484|
0001dc  6820              LDR      r0,[r4,#0]            ;3107
0001de  6940              LDR      r0,[r0,#0x14]         ;3107
0001e0  42b0              CMP      r0,r6                 ;3107
0001e2  d802              BHI      |L21.490|
                  |L21.484|
0001e4  2002              MOVS     r0,#2                 ;3107
0001e6  71e0              STRB     r0,[r4,#7]            ;3107
0001e8  e715              B        |L21.22|
                  |L21.490|
0001ea  6166              STR      r6,[r4,#0x14]         ;3108
0001ec  68a0              LDR      r0,[r4,#8]            ;3109
0001ee  4438              ADD      r0,r0,r7              ;3109
0001f0  60a0              STR      r0,[r4,#8]            ;3109
0001f2  1bed              SUBS     r5,r5,r7              ;3110
                  |L21.500|
0001f4  42bd              CMP      r5,r7                 ;3096
0001f6  d8d9              BHI      |L21.428|
                  |L21.504|
0001f8  bf00              NOP                            ;3101
0001fa  68a0              LDR      r0,[r4,#8]            ;3112
0001fc  4428              ADD      r0,r0,r5              ;3112
0001fe  60a0              STR      r0,[r4,#8]            ;3112
000200  f3c50008          UBFX     r0,r5,#0,#9           ;3113
000204  b150              CBZ      r0,|L21.540|
000206  4631              MOV      r1,r6                 ;3114
000208  6820              LDR      r0,[r4,#0]            ;3114
00020a  f7fffffe          BL       clust2sect
00020e  4680              MOV      r8,r0                 ;3114
000210  f1b80f00          CMP      r8,#0                 ;3115
000214  d103              BNE      |L21.542|
000216  2002              MOVS     r0,#2                 ;3115
000218  71e0              STRB     r0,[r4,#7]            ;3115
00021a  e6fc              B        |L21.22|
                  |L21.540|
00021c  e001              B        |L21.546|
                  |L21.542|
00021e  eb082855          ADD      r8,r8,r5,LSR #9       ;3116
                  |L21.546|
000222  8920              LDRH     r0,[r4,#8]            ;3120
000224  f3c00008          UBFX     r0,r0,#0,#9           ;3120
000228  b320              CBZ      r0,|L21.628|
00022a  69a0              LDR      r0,[r4,#0x18]         ;3120
00022c  4540              CMP      r0,r8                 ;3120
00022e  d021              BEQ      |L21.628|
000230  79a0              LDRB     r0,[r4,#6]            ;3123
000232  f0000040          AND      r0,r0,#0x40           ;3123
000236  b178              CBZ      r0,|L21.600|
000238  6821              LDR      r1,[r4,#0]            ;3124
00023a  7848              LDRB     r0,[r1,#1]            ;3124
00023c  2301              MOVS     r3,#1                 ;3124
00023e  f1040128          ADD      r1,r4,#0x28           ;3124
000242  69a2              LDR      r2,[r4,#0x18]         ;3124
000244  f7fffffe          BL       disk_write
000248  b110              CBZ      r0,|L21.592|
00024a  2001              MOVS     r0,#1                 ;3125
00024c  71e0              STRB     r0,[r4,#7]            ;3125
00024e  e6e2              B        |L21.22|
                  |L21.592|
000250  79a0              LDRB     r0,[r4,#6]            ;3126
000252  f0200040          BIC      r0,r0,#0x40           ;3126
000256  71a0              STRB     r0,[r4,#6]            ;3126
                  |L21.600|
000258  6821              LDR      r1,[r4,#0]            ;3129
00025a  7848              LDRB     r0,[r1,#1]            ;3129
00025c  2301              MOVS     r3,#1                 ;3129
00025e  4642              MOV      r2,r8                 ;3129
000260  f1040128          ADD      r1,r4,#0x28           ;3129
000264  f7fffffe          BL       disk_read
000268  b110              CBZ      r0,|L21.624|
00026a  2001              MOVS     r0,#1                 ;3130
00026c  71e0              STRB     r0,[r4,#7]            ;3130
00026e  e6d2              B        |L21.22|
                  |L21.624|
000270  f8c48018          STR      r8,[r4,#0x18]         ;3132
                  |L21.628|
000274  e9d40102          LDRD     r0,r1,[r4,#8]         ;3135
000278  4288              CMP      r0,r1                 ;3135
00027a  d905              BLS      |L21.648|
00027c  68a0              LDR      r0,[r4,#8]            ;3136
00027e  60e0              STR      r0,[r4,#0xc]          ;3136
000280  79a0              LDRB     r0,[r4,#6]            ;3137
000282  f0400020          ORR      r0,r0,#0x20           ;3137
000286  71a0              STRB     r0,[r4,#6]            ;3137
                  |L21.648|
000288  bf00              NOP                            ;3140
                  |L21.650|
00028a  9802              LDR      r0,[sp,#8]            ;3142
00028c  e6c3              B        |L21.22|
;;;3144   
                          ENDP


                          AREA ||i.f_mkdir||, CODE, READONLY, ALIGN=1

                  f_mkdir PROC
;;;3510   
;;;3511   FRESULT f_mkdir (
000000  e92d4ff1          PUSH     {r0,r4-r11,lr}
;;;3512   	const TCHAR* path		/* Pointer to the directory path */
;;;3513   )
;;;3514   {
000004  b08c              SUB      sp,sp,#0x30
;;;3515   	FRESULT res;
;;;3516   	DIR dj;
;;;3517   	BYTE *dir, n;
;;;3518   	DWORD dsc, dcl, pcl, tm = get_fattime();
000006  f7fffffe          BL       get_fattime
00000a  4606              MOV      r6,r0
;;;3519   	DEF_NAMEBUF;
;;;3520   
;;;3521   
;;;3522   	/* Get logical drive number */
;;;3523   	res = find_volume(&dj.fs, &path, 1);
00000c  2201              MOVS     r2,#1
00000e  a90c              ADD      r1,sp,#0x30
000010  a803              ADD      r0,sp,#0xc
000012  f7fffffe          BL       find_volume
000016  4605              MOV      r5,r0
;;;3524   	if (res == FR_OK) {
000018  2d00              CMP      r5,#0
00001a  d17b              BNE      |L22.276|
;;;3525   		INIT_BUF(dj);
00001c  f44f7000          MOV      r0,#0x200
000020  f7fffffe          BL       ff_memalloc
000024  4680              MOV      r8,r0
000026  f1b80f00          CMP      r8,#0
00002a  d103              BNE      |L22.52|
00002c  2011              MOVS     r0,#0x11
                  |L22.46|
;;;3526   		res = follow_path(&dj, path);			/* Follow the file path */
;;;3527   		if (res == FR_OK) res = FR_EXIST;		/* Any object with same name is already existing */
;;;3528   		if (_FS_RPATH && res == FR_NO_FILE && (dj.fn[NS] & NS_DOT))
;;;3529   			res = FR_INVALID_NAME;
;;;3530   		if (res == FR_NO_FILE) {				/* Can create a new directory */
;;;3531   			dcl = create_chain(dj.fs, 0);		/* Allocate a cluster for the new directory table */
;;;3532   			res = FR_OK;
;;;3533   			if (dcl == 0) res = FR_DENIED;		/* No space to allocate a new cluster */
;;;3534   			if (dcl == 1) res = FR_INT_ERR;
;;;3535   			if (dcl == 0xFFFFFFFF) res = FR_DISK_ERR;
;;;3536   			if (res == FR_OK)					/* Flush FAT */
;;;3537   				res = sync_window(dj.fs);
;;;3538   			if (res == FR_OK) {					/* Initialize the new directory table */
;;;3539   				dsc = clust2sect(dj.fs, dcl);
;;;3540   				dir = dj.fs->win;
;;;3541   				mem_set(dir, 0, SS(dj.fs));
;;;3542   				mem_set(dir+DIR_Name, ' ', 11);	/* Create "." entry */
;;;3543   				dir[DIR_Name] = '.';
;;;3544   				dir[DIR_Attr] = AM_DIR;
;;;3545   				ST_DWORD(dir+DIR_WrtTime, tm);
;;;3546   				st_clust(dir, dcl);
;;;3547   				mem_cpy(dir+SZ_DIR, dir, SZ_DIR); 	/* Create ".." entry */
;;;3548   				dir[SZ_DIR+1] = '.'; pcl = dj.sclust;
;;;3549   				if (dj.fs->fs_type == FS_FAT32 && pcl == dj.fs->dirbase)
;;;3550   					pcl = 0;
;;;3551   				st_clust(dir+SZ_DIR, pcl);
;;;3552   				for (n = dj.fs->csize; n; n--) {	/* Write dot entries and clear following sectors */
;;;3553   					dj.fs->winsect = dsc++;
;;;3554   					dj.fs->wflag = 1;
;;;3555   					res = sync_window(dj.fs);
;;;3556   					if (res != FR_OK) break;
;;;3557   					mem_set(dir, 0, SS(dj.fs));
;;;3558   				}
;;;3559   			}
;;;3560   			if (res == FR_OK) res = dir_register(&dj);	/* Register the object to the directoy */
;;;3561   			if (res != FR_OK) {
;;;3562   				remove_chain(dj.fs, dcl);			/* Could not register, remove cluster chain */
;;;3563   			} else {
;;;3564   				dir = dj.dir;
;;;3565   				dir[DIR_Attr] = AM_DIR;				/* Attribute */
;;;3566   				ST_DWORD(dir+DIR_WrtTime, tm);		/* Created time */
;;;3567   				st_clust(dir, dcl);					/* Table start cluster */
;;;3568   				dj.fs->wflag = 1;
;;;3569   				res = sync_fs(dj.fs);
;;;3570   			}
;;;3571   		}
;;;3572   		FREE_BUF();
;;;3573   	}
;;;3574   
;;;3575   	LEAVE_FF(dj.fs, res);
;;;3576   }
00002e  b00d              ADD      sp,sp,#0x34
000030  e8bd8ff0          POP      {r4-r11,pc}
                  |L22.52|
000034  f8cd8028          STR      r8,[sp,#0x28]         ;3525
000038  f8cdd024          STR      sp,[sp,#0x24]         ;3525
00003c  a803              ADD      r0,sp,#0xc            ;3526
00003e  990c              LDR      r1,[sp,#0x30]         ;3526
000040  f7fffffe          BL       follow_path
000044  4605              MOV      r5,r0                 ;3526
000046  b905              CBNZ     r5,|L22.74|
000048  2508              MOVS     r5,#8                 ;3527
                  |L22.74|
00004a  bf00              NOP                            ;3528
00004c  2d04              CMP      r5,#4                 ;3530
00004e  d17a              BNE      |L22.326|
000050  2100              MOVS     r1,#0                 ;3531
000052  9803              LDR      r0,[sp,#0xc]          ;3531
000054  f7fffffe          BL       create_chain
000058  4607              MOV      r7,r0                 ;3531
00005a  2500              MOVS     r5,#0                 ;3532
00005c  b907              CBNZ     r7,|L22.96|
00005e  2507              MOVS     r5,#7                 ;3533
                  |L22.96|
000060  2f01              CMP      r7,#1                 ;3534
000062  d100              BNE      |L22.102|
000064  2502              MOVS     r5,#2                 ;3534
                  |L22.102|
000066  1c78              ADDS     r0,r7,#1              ;3535
000068  b900              CBNZ     r0,|L22.108|
00006a  2501              MOVS     r5,#1                 ;3535
                  |L22.108|
00006c  b91d              CBNZ     r5,|L22.118|
00006e  9803              LDR      r0,[sp,#0xc]          ;3537
000070  f7fffffe          BL       sync_window
000074  4605              MOV      r5,r0                 ;3537
                  |L22.118|
000076  2d00              CMP      r5,#0                 ;3538
000078  d15b              BNE      |L22.306|
00007a  4639              MOV      r1,r7                 ;3539
00007c  9803              LDR      r0,[sp,#0xc]          ;3539
00007e  f7fffffe          BL       clust2sect
000082  4682              MOV      r10,r0                ;3539
000084  9803              LDR      r0,[sp,#0xc]          ;3540
000086  f1000430          ADD      r4,r0,#0x30           ;3540
00008a  f44f7200          MOV      r2,#0x200             ;3541
00008e  2100              MOVS     r1,#0                 ;3541
000090  4620              MOV      r0,r4                 ;3541
000092  f7fffffe          BL       mem_set
000096  220b              MOVS     r2,#0xb               ;3542
000098  2120              MOVS     r1,#0x20              ;3542
00009a  4620              MOV      r0,r4                 ;3542
00009c  f7fffffe          BL       mem_set
0000a0  202e              MOVS     r0,#0x2e              ;3543
0000a2  7020              STRB     r0,[r4,#0]            ;3543
0000a4  2010              MOVS     r0,#0x10              ;3544
0000a6  72e0              STRB     r0,[r4,#0xb]          ;3544
0000a8  75a6              STRB     r6,[r4,#0x16]         ;3545
0000aa  0a31              LSRS     r1,r6,#8              ;3545
0000ac  75e1              STRB     r1,[r4,#0x17]         ;3545
0000ae  0c31              LSRS     r1,r6,#16             ;3545
0000b0  7621              STRB     r1,[r4,#0x18]         ;3545
0000b2  0e31              LSRS     r1,r6,#24             ;3545
0000b4  7661              STRB     r1,[r4,#0x19]         ;3545
0000b6  4639              MOV      r1,r7                 ;3546
0000b8  4620              MOV      r0,r4                 ;3546
0000ba  f7fffffe          BL       st_clust
0000be  2220              MOVS     r2,#0x20              ;3547
0000c0  4621              MOV      r1,r4                 ;3547
0000c2  f1040020          ADD      r0,r4,#0x20           ;3547
0000c6  f7fffffe          BL       mem_cpy
0000ca  202e              MOVS     r0,#0x2e              ;3548
0000cc  f8840021          STRB     r0,[r4,#0x21]         ;3548
0000d0  f8ddb014          LDR      r11,[sp,#0x14]        ;3548
0000d4  9803              LDR      r0,[sp,#0xc]          ;3549
0000d6  7800              LDRB     r0,[r0,#0]            ;3549
0000d8  2803              CMP      r0,#3                 ;3549
0000da  d104              BNE      |L22.230|
0000dc  9803              LDR      r0,[sp,#0xc]          ;3549
0000de  6a40              LDR      r0,[r0,#0x24]         ;3549
0000e0  4558              CMP      r0,r11                ;3549
0000e2  d100              BNE      |L22.230|
0000e4  46ab              MOV      r11,r5                ;3550
                  |L22.230|
0000e6  4659              MOV      r1,r11                ;3551
0000e8  f1040020          ADD      r0,r4,#0x20           ;3551
0000ec  f7fffffe          BL       st_clust
0000f0  9803              LDR      r0,[sp,#0xc]          ;3552
0000f2  f8909002          LDRB     r9,[r0,#2]            ;3552
0000f6  e018              B        |L22.298|
                  |L22.248|
0000f8  9803              LDR      r0,[sp,#0xc]          ;3553
0000fa  f8c0a02c          STR      r10,[r0,#0x2c]        ;3553
0000fe  f10a0a01          ADD      r10,r10,#1            ;3553
000102  2001              MOVS     r0,#1                 ;3554
000104  9903              LDR      r1,[sp,#0xc]          ;3554
000106  7108              STRB     r0,[r1,#4]            ;3554
000108  9803              LDR      r0,[sp,#0xc]          ;3555
00010a  f7fffffe          BL       sync_window
00010e  4605              MOV      r5,r0                 ;3555
000110  b10d              CBZ      r5,|L22.278|
000112  e00d              B        |L22.304|
                  |L22.276|
000114  e030              B        |L22.376|
                  |L22.278|
000116  f44f7200          MOV      r2,#0x200             ;3557
00011a  2100              MOVS     r1,#0                 ;3557
00011c  4620              MOV      r0,r4                 ;3557
00011e  f7fffffe          BL       mem_set
000122  f1a90001          SUB      r0,r9,#1              ;3552
000126  f00009ff          AND      r9,r0,#0xff           ;3552
                  |L22.298|
00012a  f1b90f00          CMP      r9,#0                 ;3552
00012e  d1e3              BNE      |L22.248|
                  |L22.304|
000130  bf00              NOP                            ;3556
                  |L22.306|
000132  b91d              CBNZ     r5,|L22.316|
000134  a803              ADD      r0,sp,#0xc            ;3560
000136  f7fffffe          BL       dir_register
00013a  4605              MOV      r5,r0                 ;3560
                  |L22.316|
00013c  b125              CBZ      r5,|L22.328|
00013e  4639              MOV      r1,r7                 ;3562
000140  9803              LDR      r0,[sp,#0xc]          ;3562
000142  f7fffffe          BL       remove_chain
                  |L22.326|
000146  e014              B        |L22.370|
                  |L22.328|
000148  9c08              LDR      r4,[sp,#0x20]         ;3564
00014a  2010              MOVS     r0,#0x10              ;3565
00014c  72e0              STRB     r0,[r4,#0xb]          ;3565
00014e  75a6              STRB     r6,[r4,#0x16]         ;3566
000150  0a31              LSRS     r1,r6,#8              ;3566
000152  75e1              STRB     r1,[r4,#0x17]         ;3566
000154  0c31              LSRS     r1,r6,#16             ;3566
000156  7621              STRB     r1,[r4,#0x18]         ;3566
000158  0e31              LSRS     r1,r6,#24             ;3566
00015a  7661              STRB     r1,[r4,#0x19]         ;3566
00015c  4639              MOV      r1,r7                 ;3567
00015e  4620              MOV      r0,r4                 ;3567
000160  f7fffffe          BL       st_clust
000164  2001              MOVS     r0,#1                 ;3568
000166  9903              LDR      r1,[sp,#0xc]          ;3568
000168  7108              STRB     r0,[r1,#4]            ;3568
00016a  9803              LDR      r0,[sp,#0xc]          ;3569
00016c  f7fffffe          BL       sync_fs
000170  4605              MOV      r5,r0                 ;3569
                  |L22.370|
000172  4640              MOV      r0,r8                 ;3572
000174  f7fffffe          BL       ff_memfree
                  |L22.376|
000178  4628              MOV      r0,r5                 ;3575
00017a  e758              B        |L22.46|
;;;3577   
                          ENDP


                          AREA ||i.f_mkfs||, CODE, READONLY, ALIGN=2

                  f_mkfs PROC
;;;3976   
;;;3977   FRESULT f_mkfs (
000000  e92d4ff7          PUSH     {r0-r2,r4-r11,lr}
;;;3978   	const TCHAR* path,	/* Logical drive number */
;;;3979   	BYTE sfd,			/* Partitioning rule 0:FDISK, 1:SFD */
;;;3980   	UINT au				/* Allocation unit [bytes] */
;;;3981   )
;;;3982   {
000004  b090              SUB      sp,sp,#0x40
000006  4691              MOV      r9,r2
;;;3983   	static const WORD vst[] = { 1024,   512,  256,  128,   64,    32,   16,    8,    4,    2,   0};
;;;3984   	static const WORD cst[] = {32768, 16384, 8192, 4096, 2048, 16384, 8192, 4096, 2048, 1024, 512};
;;;3985   	int vol;
;;;3986   	BYTE fmt, md, sys, *tbl, pdrv, part;
;;;3987   	DWORD n_clst, vs, n, wsect;
;;;3988   	UINT i;
;;;3989   	DWORD b_vol, b_fat, b_dir, b_data;	/* LBA */
;;;3990   	DWORD n_vol, n_rsv, n_fat, n_dir;	/* Size */
;;;3991   	FATFS *fs;
;;;3992   	DSTATUS stat;
;;;3993   
;;;3994   
;;;3995   	/* Check mounted drive and clear work area */
;;;3996   	vol = get_ldnumber(&path);
000008  a810              ADD      r0,sp,#0x40
00000a  f7fffffe          BL       get_ldnumber
00000e  900f              STR      r0,[sp,#0x3c]
;;;3997   	if (vol < 0) return FR_INVALID_DRIVE;
000010  980f              LDR      r0,[sp,#0x3c]
000012  2800              CMP      r0,#0
000014  da03              BGE      |L23.30|
000016  200b              MOVS     r0,#0xb
                  |L23.24|
;;;3998   	if (sfd > 1) return FR_INVALID_PARAMETER;
;;;3999   	if (au & (au - 1)) return FR_INVALID_PARAMETER;
;;;4000   	fs = FatFs[vol];
;;;4001   	if (!fs) return FR_NOT_ENABLED;
;;;4002   	fs->fs_type = 0;
;;;4003   	pdrv = LD2PD(vol);	/* Physical drive */
;;;4004   	part = LD2PT(vol);	/* Partition (0:auto detect, 1-4:get from partition table)*/
;;;4005   
;;;4006   	/* Get disk statics */
;;;4007   	stat = disk_initialize(pdrv);
;;;4008   	if (stat & STA_NOINIT) return FR_NOT_READY;
;;;4009   	if (stat & STA_PROTECT) return FR_WRITE_PROTECTED;
;;;4010   #if _MAX_SS != _MIN_SS		/* Get disk sector size */
;;;4011   	if (disk_ioctl(pdrv, GET_SECTOR_SIZE, &SS(fs)) != RES_OK || SS(fs) > _MAX_SS || SS(fs) < _MIN_SS)
;;;4012   		return FR_DISK_ERR;
;;;4013   #endif
;;;4014   	if (_MULTI_PARTITION && part) {
;;;4015   		/* Get partition information from partition table in the MBR */
;;;4016   		if (disk_read(pdrv, fs->win, 0, 1)) return FR_DISK_ERR;
;;;4017   		if (LD_WORD(fs->win+BS_55AA) != 0xAA55) return FR_MKFS_ABORTED;
;;;4018   		tbl = &fs->win[MBR_Table + (part - 1) * SZ_PTE];
;;;4019   		if (!tbl[4]) return FR_MKFS_ABORTED;	/* No partition? */
;;;4020   		b_vol = LD_DWORD(tbl+8);	/* Volume start sector */
;;;4021   		n_vol = LD_DWORD(tbl+12);	/* Volume size */
;;;4022   	} else {
;;;4023   		/* Create a partition in this function */
;;;4024   		if (disk_ioctl(pdrv, GET_SECTOR_COUNT, &n_vol) != RES_OK || n_vol < 128)
;;;4025   			return FR_DISK_ERR;
;;;4026   		b_vol = (sfd) ? 0 : 63;		/* Volume start sector */
;;;4027   		n_vol -= b_vol;				/* Volume size */
;;;4028   	}
;;;4029   
;;;4030   	if (!au) {				/* AU auto selection */
;;;4031   		vs = n_vol / (2000 / (SS(fs) / 512));
;;;4032   		for (i = 0; vs < vst[i]; i++) ;
;;;4033   		au = cst[i];
;;;4034   	}
;;;4035   	au /= SS(fs);		/* Number of sectors per cluster */
;;;4036   	if (au == 0) au = 1;
;;;4037   	if (au > 128) au = 128;
;;;4038   
;;;4039   	/* Pre-compute number of clusters and FAT sub-type */
;;;4040   	n_clst = n_vol / au;
;;;4041   	fmt = FS_FAT12;
;;;4042   	if (n_clst >= MIN_FAT16) fmt = FS_FAT16;
;;;4043   	if (n_clst >= MIN_FAT32) fmt = FS_FAT32;
;;;4044   
;;;4045   	/* Determine offset and size of FAT structure */
;;;4046   	if (fmt == FS_FAT32) {
;;;4047   		n_fat = ((n_clst * 4) + 8 + SS(fs) - 1) / SS(fs);
;;;4048   		n_rsv = 32;
;;;4049   		n_dir = 0;
;;;4050   	} else {
;;;4051   		n_fat = (fmt == FS_FAT12) ? (n_clst * 3 + 1) / 2 + 3 : (n_clst * 2) + 4;
;;;4052   		n_fat = (n_fat + SS(fs) - 1) / SS(fs);
;;;4053   		n_rsv = 1;
;;;4054   		n_dir = (DWORD)N_ROOTDIR * SZ_DIR / SS(fs);
;;;4055   	}
;;;4056   	b_fat = b_vol + n_rsv;				/* FAT area start sector */
;;;4057   	b_dir = b_fat + n_fat * N_FATS;		/* Directory area start sector */
;;;4058   	b_data = b_dir + n_dir;				/* Data area start sector */
;;;4059   	if (n_vol < b_data + au - b_vol) return FR_MKFS_ABORTED;	/* Too small volume */
;;;4060   
;;;4061   	/* Align data start sector to erase block boundary (for flash memory media) */
;;;4062   	if (disk_ioctl(pdrv, GET_BLOCK_SIZE, &n) != RES_OK || !n || n > 32768) n = 1;
;;;4063   	n = (b_data + n - 1) & ~(n - 1);	/* Next nearest erase block from current data start */
;;;4064   	n = (n - b_data) / N_FATS;
;;;4065   	if (fmt == FS_FAT32) {		/* FAT32: Move FAT offset */
;;;4066   		n_rsv += n;
;;;4067   		b_fat += n;
;;;4068   	} else {					/* FAT12/16: Expand FAT size */
;;;4069   		n_fat += n;
;;;4070   	}
;;;4071   
;;;4072   	/* Determine number of clusters and final check of validity of the FAT sub-type */
;;;4073   	n_clst = (n_vol - n_rsv - n_fat * N_FATS - n_dir) / au;
;;;4074   	if (   (fmt == FS_FAT16 && n_clst < MIN_FAT16)
;;;4075   		|| (fmt == FS_FAT32 && n_clst < MIN_FAT32))
;;;4076   		return FR_MKFS_ABORTED;
;;;4077   
;;;4078   	/* Determine system ID in the partition table */
;;;4079   	if (fmt == FS_FAT32) {
;;;4080   		sys = 0x0C;		/* FAT32X */
;;;4081   	} else {
;;;4082   		if (fmt == FS_FAT12 && n_vol < 0x10000) {
;;;4083   			sys = 0x01;	/* FAT12(<65536) */
;;;4084   		} else {
;;;4085   			sys = (n_vol < 0x10000) ? 0x04 : 0x06;	/* FAT16(<65536) : FAT12/16(>=65536) */
;;;4086   		}
;;;4087   	}
;;;4088   
;;;4089   	if (_MULTI_PARTITION && part) {
;;;4090   		/* Update system ID in the partition table */
;;;4091   		tbl = &fs->win[MBR_Table + (part - 1) * SZ_PTE];
;;;4092   		tbl[4] = sys;
;;;4093   		if (disk_write(pdrv, fs->win, 0, 1))	/* Write it to teh MBR */
;;;4094   			return FR_DISK_ERR;
;;;4095   		md = 0xF8;
;;;4096   	} else {
;;;4097   		if (sfd) {	/* No partition table (SFD) */
;;;4098   			md = 0xF0;
;;;4099   		} else {	/* Create partition table (FDISK) */
;;;4100   			mem_set(fs->win, 0, SS(fs));
;;;4101   			tbl = fs->win+MBR_Table;	/* Create partition table for single partition in the drive */
;;;4102   			tbl[1] = 1;						/* Partition start head */
;;;4103   			tbl[2] = 1;						/* Partition start sector */
;;;4104   			tbl[3] = 0;						/* Partition start cylinder */
;;;4105   			tbl[4] = sys;					/* System type */
;;;4106   			tbl[5] = 254;					/* Partition end head */
;;;4107   			n = (b_vol + n_vol) / 63 / 255;
;;;4108   			tbl[6] = (BYTE)(n >> 2 | 63);	/* Partition end sector */
;;;4109   			tbl[7] = (BYTE)n;				/* End cylinder */
;;;4110   			ST_DWORD(tbl+8, 63);			/* Partition start in LBA */
;;;4111   			ST_DWORD(tbl+12, n_vol);		/* Partition size in LBA */
;;;4112   			ST_WORD(fs->win+BS_55AA, 0xAA55);	/* MBR signature */
;;;4113   			if (disk_write(pdrv, fs->win, 0, 1))	/* Write it to the MBR */
;;;4114   				return FR_DISK_ERR;
;;;4115   			md = 0xF8;
;;;4116   		}
;;;4117   	}
;;;4118   
;;;4119   	/* Create BPB in the VBR */
;;;4120   	tbl = fs->win;							/* Clear sector */
;;;4121   	mem_set(tbl, 0, SS(fs));
;;;4122   	mem_cpy(tbl, "\xEB\xFE\x90" "MSDOS5.0", 11);/* Boot jump code, OEM name */
;;;4123   	i = SS(fs);								/* Sector size */
;;;4124   	ST_WORD(tbl+BPB_BytsPerSec, i);
;;;4125   	tbl[BPB_SecPerClus] = (BYTE)au;			/* Sectors per cluster */
;;;4126   	ST_WORD(tbl+BPB_RsvdSecCnt, n_rsv);		/* Reserved sectors */
;;;4127   	tbl[BPB_NumFATs] = N_FATS;				/* Number of FATs */
;;;4128   	i = (fmt == FS_FAT32) ? 0 : N_ROOTDIR;	/* Number of root directory entries */
;;;4129   	ST_WORD(tbl+BPB_RootEntCnt, i);
;;;4130   	if (n_vol < 0x10000) {					/* Number of total sectors */
;;;4131   		ST_WORD(tbl+BPB_TotSec16, n_vol);
;;;4132   	} else {
;;;4133   		ST_DWORD(tbl+BPB_TotSec32, n_vol);
;;;4134   	}
;;;4135   	tbl[BPB_Media] = md;					/* Media descriptor */
;;;4136   	ST_WORD(tbl+BPB_SecPerTrk, 63);			/* Number of sectors per track */
;;;4137   	ST_WORD(tbl+BPB_NumHeads, 255);			/* Number of heads */
;;;4138   	ST_DWORD(tbl+BPB_HiddSec, b_vol);		/* Hidden sectors */
;;;4139   	n = get_fattime();						/* Use current time as VSN */
;;;4140   	if (fmt == FS_FAT32) {
;;;4141   		ST_DWORD(tbl+BS_VolID32, n);		/* VSN */
;;;4142   		ST_DWORD(tbl+BPB_FATSz32, n_fat);	/* Number of sectors per FAT */
;;;4143   		ST_DWORD(tbl+BPB_RootClus, 2);		/* Root directory start cluster (2) */
;;;4144   		ST_WORD(tbl+BPB_FSInfo, 1);			/* FSINFO record offset (VBR+1) */
;;;4145   		ST_WORD(tbl+BPB_BkBootSec, 6);		/* Backup boot record offset (VBR+6) */
;;;4146   		tbl[BS_DrvNum32] = 0x80;			/* Drive number */
;;;4147   		tbl[BS_BootSig32] = 0x29;			/* Extended boot signature */
;;;4148   		mem_cpy(tbl+BS_VolLab32, "NO NAME    " "FAT32   ", 19);	/* Volume label, FAT signature */
;;;4149   	} else {
;;;4150   		ST_DWORD(tbl+BS_VolID, n);			/* VSN */
;;;4151   		ST_WORD(tbl+BPB_FATSz16, n_fat);	/* Number of sectors per FAT */
;;;4152   		tbl[BS_DrvNum] = 0x80;				/* Drive number */
;;;4153   		tbl[BS_BootSig] = 0x29;				/* Extended boot signature */
;;;4154   		mem_cpy(tbl+BS_VolLab, "NO NAME    " "FAT     ", 19);	/* Volume label, FAT signature */
;;;4155   	}
;;;4156   	ST_WORD(tbl+BS_55AA, 0xAA55);			/* Signature (Offset is fixed here regardless of sector size) */
;;;4157   	if (disk_write(pdrv, tbl, b_vol, 1))	/* Write it to the VBR sector */
;;;4158   		return FR_DISK_ERR;
;;;4159   	if (fmt == FS_FAT32)					/* Write backup VBR if needed (VBR+6) */
;;;4160   		disk_write(pdrv, tbl, b_vol + 6, 1);
;;;4161   
;;;4162   	/* Initialize FAT area */
;;;4163   	wsect = b_fat;
;;;4164   	for (i = 0; i < N_FATS; i++) {		/* Initialize each FAT copy */
;;;4165   		mem_set(tbl, 0, SS(fs));			/* 1st sector of the FAT  */
;;;4166   		n = md;								/* Media descriptor byte */
;;;4167   		if (fmt != FS_FAT32) {
;;;4168   			n |= (fmt == FS_FAT12) ? 0x00FFFF00 : 0xFFFFFF00;
;;;4169   			ST_DWORD(tbl+0, n);				/* Reserve cluster #0-1 (FAT12/16) */
;;;4170   		} else {
;;;4171   			n |= 0xFFFFFF00;
;;;4172   			ST_DWORD(tbl+0, n);				/* Reserve cluster #0-1 (FAT32) */
;;;4173   			ST_DWORD(tbl+4, 0xFFFFFFFF);
;;;4174   			ST_DWORD(tbl+8, 0x0FFFFFFF);	/* Reserve cluster #2 for root directory */
;;;4175   		}
;;;4176   		if (disk_write(pdrv, tbl, wsect++, 1))
;;;4177   			return FR_DISK_ERR;
;;;4178   		mem_set(tbl, 0, SS(fs));			/* Fill following FAT entries with zero */
;;;4179   		for (n = 1; n < n_fat; n++) {		/* This loop may take a time on FAT32 volume due to many single sector writes */
;;;4180   			if (disk_write(pdrv, tbl, wsect++, 1))
;;;4181   				return FR_DISK_ERR;
;;;4182   		}
;;;4183   	}
;;;4184   
;;;4185   	/* Initialize root directory */
;;;4186   	i = (fmt == FS_FAT32) ? au : (UINT)n_dir;
;;;4187   	do {
;;;4188   		if (disk_write(pdrv, tbl, wsect++, 1))
;;;4189   			return FR_DISK_ERR;
;;;4190   	} while (--i);
;;;4191   
;;;4192   #if _USE_ERASE	/* Erase data area if needed */
;;;4193   	{
;;;4194   		DWORD eb[2];
;;;4195   
;;;4196   		eb[0] = wsect; eb[1] = wsect + (n_clst - ((fmt == FS_FAT32) ? 1 : 0)) * au - 1;
;;;4197   		disk_ioctl(pdrv, CTRL_ERASE_SECTOR, eb);
;;;4198   	}
;;;4199   #endif
;;;4200   
;;;4201   	/* Create FSINFO if needed */
;;;4202   	if (fmt == FS_FAT32) {
;;;4203   		ST_DWORD(tbl+FSI_LeadSig, 0x41615252);
;;;4204   		ST_DWORD(tbl+FSI_StrucSig, 0x61417272);
;;;4205   		ST_DWORD(tbl+FSI_Free_Count, n_clst - 1);	/* Number of free clusters */
;;;4206   		ST_DWORD(tbl+FSI_Nxt_Free, 2);				/* Last allocated cluster# */
;;;4207   		ST_WORD(tbl+BS_55AA, 0xAA55);
;;;4208   		disk_write(pdrv, tbl, b_vol + 1, 1);	/* Write original (VBR+1) */
;;;4209   		disk_write(pdrv, tbl, b_vol + 7, 1);	/* Write backup (VBR+7) */
;;;4210   	}
;;;4211   
;;;4212   	return (disk_ioctl(pdrv, CTRL_SYNC, 0) == RES_OK) ? FR_OK : FR_DISK_ERR;
;;;4213   }
000018  b013              ADD      sp,sp,#0x4c
00001a  e8bd8ff0          POP      {r4-r11,pc}
                  |L23.30|
00001e  9811              LDR      r0,[sp,#0x44]         ;3998
000020  2801              CMP      r0,#1                 ;3998
000022  dd01              BLE      |L23.40|
000024  2013              MOVS     r0,#0x13              ;3998
000026  e7f7              B        |L23.24|
                  |L23.40|
000028  f1a90001          SUB      r0,r9,#1              ;3999
00002c  ea000009          AND      r0,r0,r9              ;3999
000030  b108              CBZ      r0,|L23.54|
000032  2013              MOVS     r0,#0x13              ;3999
000034  e7f0              B        |L23.24|
                  |L23.54|
000036  49fe              LDR      r1,|L23.1072|
000038  980f              LDR      r0,[sp,#0x3c]         ;4000
00003a  f851b020          LDR      r11,[r1,r0,LSL #2]    ;4000
00003e  f1bb0f00          CMP      r11,#0                ;4001
000042  d101              BNE      |L23.72|
000044  200c              MOVS     r0,#0xc               ;4001
000046  e7e7              B        |L23.24|
                  |L23.72|
000048  2000              MOVS     r0,#0                 ;4002
00004a  f88b0000          STRB     r0,[r11,#0]           ;4002
00004e  980f              LDR      r0,[sp,#0x3c]         ;4003
000050  b2c0              UXTB     r0,r0                 ;4003
000052  900c              STR      r0,[sp,#0x30]         ;4003
000054  2000              MOVS     r0,#0                 ;4004
000056  900b              STR      r0,[sp,#0x2c]         ;4004
000058  980c              LDR      r0,[sp,#0x30]         ;4007
00005a  f7fffffe          BL       disk_initialize
00005e  9001              STR      r0,[sp,#4]            ;4007
000060  9801              LDR      r0,[sp,#4]            ;4008
000062  f0000001          AND      r0,r0,#1              ;4008
000066  b108              CBZ      r0,|L23.108|
000068  2003              MOVS     r0,#3                 ;4008
00006a  e7d5              B        |L23.24|
                  |L23.108|
00006c  9801              LDR      r0,[sp,#4]            ;4009
00006e  f0000004          AND      r0,r0,#4              ;4009
000072  b108              CBZ      r0,|L23.120|
000074  200a              MOVS     r0,#0xa               ;4009
000076  e7cf              B        |L23.24|
                  |L23.120|
000078  bf00              NOP                            ;4014
00007a  aa04              ADD      r2,sp,#0x10           ;4024
00007c  2101              MOVS     r1,#1                 ;4024
00007e  980c              LDR      r0,[sp,#0x30]         ;4024
000080  f7fffffe          BL       disk_ioctl
000084  b910              CBNZ     r0,|L23.140|
000086  9804              LDR      r0,[sp,#0x10]         ;4024
000088  2880              CMP      r0,#0x80              ;4024
00008a  d201              BCS      |L23.144|
                  |L23.140|
00008c  2001              MOVS     r0,#1                 ;4025
00008e  e7c3              B        |L23.24|
                  |L23.144|
000090  9811              LDR      r0,[sp,#0x44]         ;4026
000092  b108              CBZ      r0,|L23.152|
000094  2000              MOVS     r0,#0                 ;4026
000096  e000              B        |L23.154|
                  |L23.152|
000098  203f              MOVS     r0,#0x3f              ;4026
                  |L23.154|
00009a  4680              MOV      r8,r0                 ;4026
00009c  9804              LDR      r0,[sp,#0x10]         ;4027
00009e  eba00008          SUB      r0,r0,r8              ;4027
0000a2  9004              STR      r0,[sp,#0x10]         ;4027
0000a4  f1b90f00          CMP      r9,#0                 ;4030
0000a8  d113              BNE      |L23.210|
0000aa  f44f61fa          MOV      r1,#0x7d0             ;4031
0000ae  9804              LDR      r0,[sp,#0x10]         ;4031
0000b0  fbb0f0f1          UDIV     r0,r0,r1              ;4031
0000b4  900a              STR      r0,[sp,#0x28]         ;4031
0000b6  f04f0a00          MOV      r10,#0                ;4032
0000ba  e001              B        |L23.192|
                  |L23.188|
0000bc  f10a0a01          ADD      r10,r10,#1            ;4032
                  |L23.192|
0000c0  48dc              LDR      r0,|L23.1076|
0000c2  f830101a          LDRH     r1,[r0,r10,LSL #1]    ;4032
0000c6  980a              LDR      r0,[sp,#0x28]         ;4032
0000c8  4281              CMP      r1,r0                 ;4032
0000ca  d8f7              BHI      |L23.188|
0000cc  48da              LDR      r0,|L23.1080|
0000ce  f830901a          LDRH     r9,[r0,r10,LSL #1]    ;4033
                  |L23.210|
0000d2  ea4f2959          LSR      r9,r9,#9              ;4035
0000d6  f1b90f00          CMP      r9,#0                 ;4036
0000da  d101              BNE      |L23.224|
0000dc  f04f0901          MOV      r9,#1                 ;4036
                  |L23.224|
0000e0  f1b90f80          CMP      r9,#0x80              ;4037
0000e4  d901              BLS      |L23.234|
0000e6  f04f0980          MOV      r9,#0x80              ;4037
                  |L23.234|
0000ea  9804              LDR      r0,[sp,#0x10]         ;4040
0000ec  fbb0f7f9          UDIV     r7,r0,r9              ;4040
0000f0  2501              MOVS     r5,#1                 ;4041
0000f2  f64070f6          MOV      r0,#0xff6             ;4042
0000f6  4287              CMP      r7,r0                 ;4042
0000f8  d300              BCC      |L23.252|
0000fa  2502              MOVS     r5,#2                 ;4042
                  |L23.252|
0000fc  f64f70f6          MOV      r0,#0xfff6            ;4043
000100  4287              CMP      r7,r0                 ;4043
000102  d300              BCC      |L23.262|
000104  2503              MOVS     r5,#3                 ;4043
                  |L23.262|
000106  2d03              CMP      r5,#3                 ;4046
000108  d10a              BNE      |L23.288|
00010a  2008              MOVS     r0,#8                 ;4047
00010c  eb000087          ADD      r0,r0,r7,LSL #2       ;4047
000110  f20010ff          ADD      r0,r0,#0x1ff          ;4047
000114  0a46              LSRS     r6,r0,#9              ;4047
000116  2020              MOVS     r0,#0x20              ;4048
000118  9003              STR      r0,[sp,#0xc]          ;4048
00011a  2000              MOVS     r0,#0                 ;4049
00011c  9002              STR      r0,[sp,#8]            ;4049
00011e  e011              B        |L23.324|
                  |L23.288|
000120  2d01              CMP      r5,#1                 ;4051
000122  d105              BNE      |L23.304|
000124  eb070047          ADD      r0,r7,r7,LSL #1       ;4051
000128  1c40              ADDS     r0,r0,#1              ;4051
00012a  0840              LSRS     r0,r0,#1              ;4051
00012c  1cc0              ADDS     r0,r0,#3              ;4051
00012e  e001              B        |L23.308|
                  |L23.304|
000130  0078              LSLS     r0,r7,#1              ;4051
000132  1d00              ADDS     r0,r0,#4              ;4051
                  |L23.308|
000134  4606              MOV      r6,r0                 ;4051
000136  f20610ff          ADD      r0,r6,#0x1ff          ;4052
00013a  0a46              LSRS     r6,r0,#9              ;4052
00013c  2001              MOVS     r0,#1                 ;4053
00013e  9003              STR      r0,[sp,#0xc]          ;4053
000140  2020              MOVS     r0,#0x20              ;4054
000142  9002              STR      r0,[sp,#8]            ;4054
                  |L23.324|
000144  9803              LDR      r0,[sp,#0xc]          ;4056
000146  4440              ADD      r0,r0,r8              ;4056
000148  9007              STR      r0,[sp,#0x1c]         ;4056
00014a  9807              LDR      r0,[sp,#0x1c]         ;4057
00014c  4430              ADD      r0,r0,r6              ;4057
00014e  9006              STR      r0,[sp,#0x18]         ;4057
000150  9902              LDR      r1,[sp,#8]            ;4058
000152  9806              LDR      r0,[sp,#0x18]         ;4058
000154  4408              ADD      r0,r0,r1              ;4058
000156  9005              STR      r0,[sp,#0x14]         ;4058
000158  9805              LDR      r0,[sp,#0x14]         ;4059
00015a  4448              ADD      r0,r0,r9              ;4059
00015c  eba00008          SUB      r0,r0,r8              ;4059
000160  9904              LDR      r1,[sp,#0x10]         ;4059
000162  4288              CMP      r0,r1                 ;4059
000164  d901              BLS      |L23.362|
000166  200e              MOVS     r0,#0xe               ;4059
000168  e756              B        |L23.24|
                  |L23.362|
00016a  aa09              ADD      r2,sp,#0x24           ;4062
00016c  2103              MOVS     r1,#3                 ;4062
00016e  980c              LDR      r0,[sp,#0x30]         ;4062
000170  f7fffffe          BL       disk_ioctl
000174  b928              CBNZ     r0,|L23.386|
000176  9809              LDR      r0,[sp,#0x24]         ;4062
000178  b118              CBZ      r0,|L23.386|
00017a  9809              LDR      r0,[sp,#0x24]         ;4062
00017c  f5b04f00          CMP      r0,#0x8000            ;4062
000180  d901              BLS      |L23.390|
                  |L23.386|
000182  2001              MOVS     r0,#1                 ;4062
000184  9009              STR      r0,[sp,#0x24]         ;4062
                  |L23.390|
000186  9909              LDR      r1,[sp,#0x24]         ;4063
000188  9805              LDR      r0,[sp,#0x14]         ;4063
00018a  4408              ADD      r0,r0,r1              ;4063
00018c  1e40              SUBS     r0,r0,#1              ;4063
00018e  1e49              SUBS     r1,r1,#1              ;4063
000190  4388              BICS     r0,r0,r1              ;4063
000192  9009              STR      r0,[sp,#0x24]         ;4063
000194  9909              LDR      r1,[sp,#0x24]         ;4064
000196  9805              LDR      r0,[sp,#0x14]         ;4064
000198  1a08              SUBS     r0,r1,r0              ;4064
00019a  9009              STR      r0,[sp,#0x24]         ;4064
00019c  2d03              CMP      r5,#3                 ;4065
00019e  d108              BNE      |L23.434|
0001a0  9909              LDR      r1,[sp,#0x24]         ;4066
0001a2  9803              LDR      r0,[sp,#0xc]          ;4066
0001a4  4408              ADD      r0,r0,r1              ;4066
0001a6  9003              STR      r0,[sp,#0xc]          ;4066
0001a8  9909              LDR      r1,[sp,#0x24]         ;4067
0001aa  9807              LDR      r0,[sp,#0x1c]         ;4067
0001ac  4408              ADD      r0,r0,r1              ;4067
0001ae  9007              STR      r0,[sp,#0x1c]         ;4067
0001b0  e001              B        |L23.438|
                  |L23.434|
0001b2  9809              LDR      r0,[sp,#0x24]         ;4069
0001b4  4406              ADD      r6,r6,r0              ;4069
                  |L23.438|
0001b6  e9dd0103          LDRD     r0,r1,[sp,#0xc]       ;4073
0001ba  1a08              SUBS     r0,r1,r0              ;4073
0001bc  1b81              SUBS     r1,r0,r6              ;4073
0001be  9802              LDR      r0,[sp,#8]            ;4073
0001c0  1a08              SUBS     r0,r1,r0              ;4073
0001c2  fbb0f7f9          UDIV     r7,r0,r9              ;4073
0001c6  2d02              CMP      r5,#2                 ;4074
0001c8  d103              BNE      |L23.466|
0001ca  f64070f6          MOV      r0,#0xff6             ;4074
0001ce  4287              CMP      r7,r0                 ;4074
0001d0  d305              BCC      |L23.478|
                  |L23.466|
0001d2  2d03              CMP      r5,#3                 ;4075
0001d4  d105              BNE      |L23.482|
0001d6  f64f70f6          MOV      r0,#0xfff6            ;4075
0001da  4287              CMP      r7,r0                 ;4075
0001dc  d201              BCS      |L23.482|
                  |L23.478|
0001de  200e              MOVS     r0,#0xe               ;4076
0001e0  e71a              B        |L23.24|
                  |L23.482|
0001e2  2d03              CMP      r5,#3                 ;4079
0001e4  d102              BNE      |L23.492|
0001e6  200c              MOVS     r0,#0xc               ;4080
0001e8  900d              STR      r0,[sp,#0x34]         ;4080
0001ea  e010              B        |L23.526|
                  |L23.492|
0001ec  2d01              CMP      r5,#1                 ;4082
0001ee  d106              BNE      |L23.510|
0001f0  9804              LDR      r0,[sp,#0x10]         ;4082
0001f2  f5b03f80          CMP      r0,#0x10000           ;4082
0001f6  d202              BCS      |L23.510|
0001f8  2001              MOVS     r0,#1                 ;4083
0001fa  900d              STR      r0,[sp,#0x34]         ;4083
0001fc  e007              B        |L23.526|
                  |L23.510|
0001fe  9804              LDR      r0,[sp,#0x10]         ;4085
000200  f5b03f80          CMP      r0,#0x10000           ;4085
000204  d201              BCS      |L23.522|
000206  2004              MOVS     r0,#4                 ;4085
000208  e000              B        |L23.524|
                  |L23.522|
00020a  2006              MOVS     r0,#6                 ;4085
                  |L23.524|
00020c  900d              STR      r0,[sp,#0x34]         ;4085
                  |L23.526|
00020e  bf00              NOP                            ;4089
000210  9811              LDR      r0,[sp,#0x44]         ;4097
000212  b110              CBZ      r0,|L23.538|
000214  20f0              MOVS     r0,#0xf0              ;4098
000216  900e              STR      r0,[sp,#0x38]         ;4098
000218  e044              B        |L23.676|
                  |L23.538|
00021a  f44f7200          MOV      r2,#0x200             ;4100
00021e  2100              MOVS     r1,#0                 ;4100
000220  f10b0030          ADD      r0,r11,#0x30          ;4100
000224  f7fffffe          BL       mem_set
000228  f50b74f7          ADD      r4,r11,#0x1ee         ;4101
00022c  2001              MOVS     r0,#1                 ;4102
00022e  7060              STRB     r0,[r4,#1]            ;4102
000230  70a0              STRB     r0,[r4,#2]            ;4103
000232  2000              MOVS     r0,#0                 ;4104
000234  70e0              STRB     r0,[r4,#3]            ;4104
000236  980d              LDR      r0,[sp,#0x34]         ;4105
000238  7120              STRB     r0,[r4,#4]            ;4105
00023a  20fe              MOVS     r0,#0xfe              ;4106
00023c  7160              STRB     r0,[r4,#5]            ;4106
00023e  9804              LDR      r0,[sp,#0x10]         ;4107
000240  4440              ADD      r0,r0,r8              ;4107
000242  213f              MOVS     r1,#0x3f              ;4107
000244  fbb0f0f1          UDIV     r0,r0,r1              ;4107
000248  21ff              MOVS     r1,#0xff              ;4107
00024a  fbb0f0f1          UDIV     r0,r0,r1              ;4107
00024e  9009              STR      r0,[sp,#0x24]         ;4107
000250  213f              MOVS     r1,#0x3f              ;4108
000252  9809              LDR      r0,[sp,#0x24]         ;4108
000254  ea410090          ORR      r0,r1,r0,LSR #2       ;4108
000258  71a0              STRB     r0,[r4,#6]            ;4108
00025a  9809              LDR      r0,[sp,#0x24]         ;4109
00025c  71e0              STRB     r0,[r4,#7]            ;4109
00025e  203f              MOVS     r0,#0x3f              ;4110
000260  7220              STRB     r0,[r4,#8]            ;4110
000262  2100              MOVS     r1,#0                 ;4110
000264  7261              STRB     r1,[r4,#9]            ;4110
000266  72a1              STRB     r1,[r4,#0xa]          ;4110
000268  72e1              STRB     r1,[r4,#0xb]          ;4110
00026a  9804              LDR      r0,[sp,#0x10]         ;4111
00026c  7320              STRB     r0,[r4,#0xc]          ;4111
00026e  9804              LDR      r0,[sp,#0x10]         ;4111
000270  0a01              LSRS     r1,r0,#8              ;4111
000272  7361              STRB     r1,[r4,#0xd]          ;4111
000274  9804              LDR      r0,[sp,#0x10]         ;4111
000276  0c01              LSRS     r1,r0,#16             ;4111
000278  73a1              STRB     r1,[r4,#0xe]          ;4111
00027a  9804              LDR      r0,[sp,#0x10]         ;4111
00027c  0e01              LSRS     r1,r0,#24             ;4111
00027e  73e1              STRB     r1,[r4,#0xf]          ;4111
000280  2155              MOVS     r1,#0x55              ;4112
000282  f88b122e          STRB     r1,[r11,#0x22e]       ;4112
000286  21aa              MOVS     r1,#0xaa              ;4112
000288  f88b122f          STRB     r1,[r11,#0x22f]       ;4112
00028c  2301              MOVS     r3,#1                 ;4113
00028e  2200              MOVS     r2,#0                 ;4113
000290  f10b0130          ADD      r1,r11,#0x30          ;4113
000294  980c              LDR      r0,[sp,#0x30]         ;4113
000296  f7fffffe          BL       disk_write
00029a  b108              CBZ      r0,|L23.672|
00029c  2001              MOVS     r0,#1                 ;4114
00029e  e6bb              B        |L23.24|
                  |L23.672|
0002a0  20f8              MOVS     r0,#0xf8              ;4115
0002a2  900e              STR      r0,[sp,#0x38]         ;4115
                  |L23.676|
0002a4  f10b0430          ADD      r4,r11,#0x30          ;4120
0002a8  f44f7200          MOV      r2,#0x200             ;4121
0002ac  2100              MOVS     r1,#0                 ;4121
0002ae  4620              MOV      r0,r4                 ;4121
0002b0  f7fffffe          BL       mem_set
0002b4  220b              MOVS     r2,#0xb               ;4122
0002b6  a161              ADR      r1,|L23.1084|
0002b8  4620              MOV      r0,r4                 ;4122
0002ba  f7fffffe          BL       mem_cpy
0002be  f44f7a00          MOV      r10,#0x200            ;4123
0002c2  f884a00b          STRB     r10,[r4,#0xb]         ;4124
0002c6  ea4f211a          LSR      r1,r10,#8             ;4124
0002ca  7321              STRB     r1,[r4,#0xc]          ;4124
0002cc  f884900d          STRB     r9,[r4,#0xd]          ;4125
0002d0  9803              LDR      r0,[sp,#0xc]          ;4126
0002d2  73a0              STRB     r0,[r4,#0xe]          ;4126
0002d4  9803              LDR      r0,[sp,#0xc]          ;4126
0002d6  0a01              LSRS     r1,r0,#8              ;4126
0002d8  73e1              STRB     r1,[r4,#0xf]          ;4126
0002da  2001              MOVS     r0,#1                 ;4127
0002dc  7420              STRB     r0,[r4,#0x10]         ;4127
0002de  2d03              CMP      r5,#3                 ;4128
0002e0  d101              BNE      |L23.742|
0002e2  2000              MOVS     r0,#0                 ;4128
0002e4  e001              B        |L23.746|
                  |L23.742|
0002e6  f44f7000          MOV      r0,#0x200             ;4128
                  |L23.746|
0002ea  4682              MOV      r10,r0                ;4128
0002ec  f884a011          STRB     r10,[r4,#0x11]        ;4129
0002f0  ea4f211a          LSR      r1,r10,#8             ;4129
0002f4  74a1              STRB     r1,[r4,#0x12]         ;4129
0002f6  9804              LDR      r0,[sp,#0x10]         ;4130
0002f8  f5b03f80          CMP      r0,#0x10000           ;4130
0002fc  d205              BCS      |L23.778|
0002fe  9804              LDR      r0,[sp,#0x10]         ;4131
000300  74e0              STRB     r0,[r4,#0x13]         ;4131
000302  9804              LDR      r0,[sp,#0x10]         ;4131
000304  0a01              LSRS     r1,r0,#8              ;4131
000306  7521              STRB     r1,[r4,#0x14]         ;4131
000308  e010              B        |L23.812|
                  |L23.778|
00030a  9804              LDR      r0,[sp,#0x10]         ;4133
00030c  f8840020          STRB     r0,[r4,#0x20]         ;4133
000310  9804              LDR      r0,[sp,#0x10]         ;4133
000312  f3c02107          UBFX     r1,r0,#8,#8           ;4133
000316  2021              MOVS     r0,#0x21              ;4133
000318  5501              STRB     r1,[r0,r4]            ;4133
00031a  9804              LDR      r0,[sp,#0x10]         ;4133
00031c  f3c04107          UBFX     r1,r0,#16,#8          ;4133
000320  2022              MOVS     r0,#0x22              ;4133
000322  5501              STRB     r1,[r0,r4]            ;4133
000324  9804              LDR      r0,[sp,#0x10]         ;4133
000326  0e01              LSRS     r1,r0,#24             ;4133
000328  2023              MOVS     r0,#0x23              ;4133
00032a  5501              STRB     r1,[r0,r4]            ;4133
                  |L23.812|
00032c  980e              LDR      r0,[sp,#0x38]         ;4135
00032e  7560              STRB     r0,[r4,#0x15]         ;4135
000330  203f              MOVS     r0,#0x3f              ;4136
000332  7620              STRB     r0,[r4,#0x18]         ;4136
000334  2100              MOVS     r1,#0                 ;4136
000336  7661              STRB     r1,[r4,#0x19]         ;4136
000338  20ff              MOVS     r0,#0xff              ;4137
00033a  76a0              STRB     r0,[r4,#0x1a]         ;4137
00033c  76e1              STRB     r1,[r4,#0x1b]         ;4137
00033e  f884801c          STRB     r8,[r4,#0x1c]         ;4138
000342  ea4f2118          LSR      r1,r8,#8              ;4138
000346  7761              STRB     r1,[r4,#0x1d]         ;4138
000348  ea4f4118          LSR      r1,r8,#16             ;4138
00034c  77a1              STRB     r1,[r4,#0x1e]         ;4138
00034e  ea4f6118          LSR      r1,r8,#24             ;4138
000352  77e1              STRB     r1,[r4,#0x1f]         ;4138
000354  f7fffffe          BL       get_fattime
000358  9009              STR      r0,[sp,#0x24]         ;4139
00035a  2d03              CMP      r5,#3                 ;4140
00035c  d13e              BNE      |L23.988|
00035e  9809              LDR      r0,[sp,#0x24]         ;4141
000360  f8840043          STRB     r0,[r4,#0x43]         ;4141
000364  9809              LDR      r0,[sp,#0x24]         ;4141
000366  f3c02107          UBFX     r1,r0,#8,#8           ;4141
00036a  2044              MOVS     r0,#0x44              ;4141
00036c  5501              STRB     r1,[r0,r4]            ;4141
00036e  9809              LDR      r0,[sp,#0x24]         ;4141
000370  f3c04107          UBFX     r1,r0,#16,#8          ;4141
000374  2045              MOVS     r0,#0x45              ;4141
000376  5501              STRB     r1,[r0,r4]            ;4141
000378  9809              LDR      r0,[sp,#0x24]         ;4141
00037a  0e01              LSRS     r1,r0,#24             ;4141
00037c  2046              MOVS     r0,#0x46              ;4141
00037e  5501              STRB     r1,[r0,r4]            ;4141
000380  f8846024          STRB     r6,[r4,#0x24]         ;4142
000384  f3c62107          UBFX     r1,r6,#8,#8           ;4142
000388  2025              MOVS     r0,#0x25              ;4142
00038a  5501              STRB     r1,[r0,r4]            ;4142
00038c  f3c64107          UBFX     r1,r6,#16,#8          ;4142
000390  2026              MOVS     r0,#0x26              ;4142
000392  5501              STRB     r1,[r0,r4]            ;4142
000394  0e31              LSRS     r1,r6,#24             ;4142
000396  2027              MOVS     r0,#0x27              ;4142
000398  5501              STRB     r1,[r0,r4]            ;4142
00039a  2002              MOVS     r0,#2                 ;4143
00039c  f884002c          STRB     r0,[r4,#0x2c]         ;4143
0003a0  2100              MOVS     r1,#0                 ;4143
0003a2  202d              MOVS     r0,#0x2d              ;4143
0003a4  5501              STRB     r1,[r0,r4]            ;4143
0003a6  202e              MOVS     r0,#0x2e              ;4143
0003a8  5501              STRB     r1,[r0,r4]            ;4143
0003aa  202f              MOVS     r0,#0x2f              ;4143
0003ac  5501              STRB     r1,[r0,r4]            ;4143
0003ae  2001              MOVS     r0,#1                 ;4144
0003b0  f8840030          STRB     r0,[r4,#0x30]         ;4144
0003b4  2031              MOVS     r0,#0x31              ;4144
0003b6  5501              STRB     r1,[r0,r4]            ;4144
0003b8  2006              MOVS     r0,#6                 ;4145
0003ba  f8840032          STRB     r0,[r4,#0x32]         ;4145
0003be  2033              MOVS     r0,#0x33              ;4145
0003c0  5501              STRB     r1,[r0,r4]            ;4145
0003c2  2080              MOVS     r0,#0x80              ;4146
0003c4  f8840040          STRB     r0,[r4,#0x40]         ;4146
0003c8  2029              MOVS     r0,#0x29              ;4147
0003ca  f8840042          STRB     r0,[r4,#0x42]         ;4147
0003ce  2213              MOVS     r2,#0x13              ;4148
0003d0  a11d              ADR      r1,|L23.1096|
0003d2  f1040047          ADD      r0,r4,#0x47           ;4148
0003d6  f7fffffe          BL       mem_cpy
0003da  e01f              B        |L23.1052|
                  |L23.988|
0003dc  9809              LDR      r0,[sp,#0x24]         ;4150
0003de  f8840027          STRB     r0,[r4,#0x27]         ;4150
0003e2  9809              LDR      r0,[sp,#0x24]         ;4150
0003e4  f3c02107          UBFX     r1,r0,#8,#8           ;4150
0003e8  2028              MOVS     r0,#0x28              ;4150
0003ea  5501              STRB     r1,[r0,r4]            ;4150
0003ec  9809              LDR      r0,[sp,#0x24]         ;4150
0003ee  f3c04107          UBFX     r1,r0,#16,#8          ;4150
0003f2  2029              MOVS     r0,#0x29              ;4150
0003f4  5501              STRB     r1,[r0,r4]            ;4150
0003f6  9809              LDR      r0,[sp,#0x24]         ;4150
0003f8  0e01              LSRS     r1,r0,#24             ;4150
0003fa  202a              MOVS     r0,#0x2a              ;4150
0003fc  5501              STRB     r1,[r0,r4]            ;4150
0003fe  75a6              STRB     r6,[r4,#0x16]         ;4151
000400  0a31              LSRS     r1,r6,#8              ;4151
000402  75e1              STRB     r1,[r4,#0x17]         ;4151
000404  2080              MOVS     r0,#0x80              ;4152
000406  f8840024          STRB     r0,[r4,#0x24]         ;4152
00040a  2029              MOVS     r0,#0x29              ;4153
00040c  f8840026          STRB     r0,[r4,#0x26]         ;4153
000410  2213              MOVS     r2,#0x13              ;4154
000412  a112              ADR      r1,|L23.1116|
000414  f104002b          ADD      r0,r4,#0x2b           ;4154
000418  f7fffffe          BL       mem_cpy
                  |L23.1052|
00041c  2055              MOVS     r0,#0x55              ;4156
00041e  f88401fe          STRB     r0,[r4,#0x1fe]        ;4156
000422  21aa              MOVS     r1,#0xaa              ;4156
000424  f24010ff          MOV      r0,#0x1ff             ;4156
000428  5501              STRB     r1,[r0,r4]            ;4156
00042a  2301              MOVS     r3,#1                 ;4157
00042c  4642              MOV      r2,r8                 ;4157
00042e  e01f              B        |L23.1136|
                  |L23.1072|
                          DCD      FatFs
                  |L23.1076|
                          DCD      vst
                  |L23.1080|
                          DCD      ||cst||
                  |L23.1084|
00043c  ebfe904d          DCB      235,254,144,"MSDOS5.0",0
000440  53444f53
000444  352e3000
                  |L23.1096|
000448  4e4f204e          DCB      "NO NAME    FAT32   ",0
00044c  414d4520
000450  20202046
000454  41543332
000458  20202000
                  |L23.1116|
00045c  4e4f204e          DCB      "NO NAME    FAT     ",0
000460  414d4520
000464  20202046
000468  41542020
00046c  20202000
                  |L23.1136|
000470  4621              MOV      r1,r4                 ;4157
000472  980c              LDR      r0,[sp,#0x30]         ;4157
000474  f7fffffe          BL       disk_write
000478  b108              CBZ      r0,|L23.1150|
00047a  2001              MOVS     r0,#1                 ;4158
00047c  e5cc              B        |L23.24|
                  |L23.1150|
00047e  2d03              CMP      r5,#3                 ;4159
000480  d106              BNE      |L23.1168|
000482  2301              MOVS     r3,#1                 ;4160
000484  f1080206          ADD      r2,r8,#6              ;4160
000488  4621              MOV      r1,r4                 ;4160
00048a  980c              LDR      r0,[sp,#0x30]         ;4160
00048c  f7fffffe          BL       disk_write
                  |L23.1168|
000490  9807              LDR      r0,[sp,#0x1c]         ;4163
000492  9008              STR      r0,[sp,#0x20]         ;4163
000494  f04f0a00          MOV      r10,#0                ;4164
000498  e061              B        |L23.1374|
                  |L23.1178|
00049a  f44f7200          MOV      r2,#0x200             ;4165
00049e  2100              MOVS     r1,#0                 ;4165
0004a0  4620              MOV      r0,r4                 ;4165
0004a2  f7fffffe          BL       mem_set
0004a6  980e              LDR      r0,[sp,#0x38]         ;4166
0004a8  9009              STR      r0,[sp,#0x24]         ;4166
0004aa  2d03              CMP      r5,#3                 ;4167
0004ac  d014              BEQ      |L23.1240|
0004ae  2d01              CMP      r5,#1                 ;4168
0004b0  d101              BNE      |L23.1206|
0004b2  4862              LDR      r0,|L23.1596|
0004b4  e001              B        |L23.1210|
                  |L23.1206|
0004b6  f06f00ff          MVN      r0,#0xff              ;4168
                  |L23.1210|
0004ba  9909              LDR      r1,[sp,#0x24]         ;4168
0004bc  4308              ORRS     r0,r0,r1              ;4168
0004be  9009              STR      r0,[sp,#0x24]         ;4168
0004c0  9809              LDR      r0,[sp,#0x24]         ;4169
0004c2  7020              STRB     r0,[r4,#0]            ;4169
0004c4  9809              LDR      r0,[sp,#0x24]         ;4169
0004c6  0a00              LSRS     r0,r0,#8              ;4169
0004c8  7060              STRB     r0,[r4,#1]            ;4169
0004ca  9809              LDR      r0,[sp,#0x24]         ;4169
0004cc  0c00              LSRS     r0,r0,#16             ;4169
0004ce  70a0              STRB     r0,[r4,#2]            ;4169
0004d0  9809              LDR      r0,[sp,#0x24]         ;4169
0004d2  0e00              LSRS     r0,r0,#24             ;4169
0004d4  70e0              STRB     r0,[r4,#3]            ;4169
0004d6  e019              B        |L23.1292|
                  |L23.1240|
0004d8  9809              LDR      r0,[sp,#0x24]         ;4171
0004da  f06000ff          ORN      r0,r0,#0xff           ;4171
0004de  9009              STR      r0,[sp,#0x24]         ;4171
0004e0  9809              LDR      r0,[sp,#0x24]         ;4172
0004e2  7020              STRB     r0,[r4,#0]            ;4172
0004e4  9809              LDR      r0,[sp,#0x24]         ;4172
0004e6  0a00              LSRS     r0,r0,#8              ;4172
0004e8  7060              STRB     r0,[r4,#1]            ;4172
0004ea  9809              LDR      r0,[sp,#0x24]         ;4172
0004ec  0c00              LSRS     r0,r0,#16             ;4172
0004ee  70a0              STRB     r0,[r4,#2]            ;4172
0004f0  9809              LDR      r0,[sp,#0x24]         ;4172
0004f2  0e00              LSRS     r0,r0,#24             ;4172
0004f4  70e0              STRB     r0,[r4,#3]            ;4172
0004f6  20ff              MOVS     r0,#0xff              ;4173
0004f8  7120              STRB     r0,[r4,#4]            ;4173
0004fa  21ff              MOVS     r1,#0xff              ;4173
0004fc  7161              STRB     r1,[r4,#5]            ;4173
0004fe  71a1              STRB     r1,[r4,#6]            ;4173
000500  71e1              STRB     r1,[r4,#7]            ;4173
000502  7220              STRB     r0,[r4,#8]            ;4174
000504  7261              STRB     r1,[r4,#9]            ;4174
000506  72a1              STRB     r1,[r4,#0xa]          ;4174
000508  210f              MOVS     r1,#0xf               ;4174
00050a  72e1              STRB     r1,[r4,#0xb]          ;4174
                  |L23.1292|
00050c  9808              LDR      r0,[sp,#0x20]         ;4176
00050e  1c41              ADDS     r1,r0,#1              ;4176
000510  4602              MOV      r2,r0                 ;4176
000512  2301              MOVS     r3,#1                 ;4176
000514  9108              STR      r1,[sp,#0x20]         ;4176
000516  4621              MOV      r1,r4                 ;4176
000518  980c              LDR      r0,[sp,#0x30]         ;4176
00051a  f7fffffe          BL       disk_write
00051e  b108              CBZ      r0,|L23.1316|
000520  2001              MOVS     r0,#1                 ;4177
000522  e579              B        |L23.24|
                  |L23.1316|
000524  f44f7200          MOV      r2,#0x200             ;4178
000528  2100              MOVS     r1,#0                 ;4178
00052a  4620              MOV      r0,r4                 ;4178
00052c  f7fffffe          BL       mem_set
000530  2001              MOVS     r0,#1                 ;4179
000532  9009              STR      r0,[sp,#0x24]         ;4179
000534  e00e              B        |L23.1364|
                  |L23.1334|
000536  9808              LDR      r0,[sp,#0x20]         ;4180
000538  1c41              ADDS     r1,r0,#1              ;4180
00053a  4602              MOV      r2,r0                 ;4180
00053c  2301              MOVS     r3,#1                 ;4180
00053e  9108              STR      r1,[sp,#0x20]         ;4180
000540  4621              MOV      r1,r4                 ;4180
000542  980c              LDR      r0,[sp,#0x30]         ;4180
000544  f7fffffe          BL       disk_write
000548  b108              CBZ      r0,|L23.1358|
00054a  2001              MOVS     r0,#1                 ;4181
00054c  e564              B        |L23.24|
                  |L23.1358|
00054e  9809              LDR      r0,[sp,#0x24]         ;4179
000550  1c40              ADDS     r0,r0,#1              ;4179
000552  9009              STR      r0,[sp,#0x24]         ;4179
                  |L23.1364|
000554  9809              LDR      r0,[sp,#0x24]         ;4179
000556  42b0              CMP      r0,r6                 ;4179
000558  d3ed              BCC      |L23.1334|
00055a  f10a0a01          ADD      r10,r10,#1            ;4164
                  |L23.1374|
00055e  f1ba0f00          CMP      r10,#0                ;4164
000562  d09a              BEQ      |L23.1178|
000564  2d03              CMP      r5,#3                 ;4186
000566  d101              BNE      |L23.1388|
000568  4648              MOV      r0,r9                 ;4186
00056a  e000              B        |L23.1390|
                  |L23.1388|
00056c  9802              LDR      r0,[sp,#8]            ;4186
                  |L23.1390|
00056e  4682              MOV      r10,r0                ;4186
000570  bf00              NOP                            ;4187
                  |L23.1394|
000572  9808              LDR      r0,[sp,#0x20]         ;4188
000574  1c41              ADDS     r1,r0,#1              ;4188
000576  4602              MOV      r2,r0                 ;4188
000578  2301              MOVS     r3,#1                 ;4188
00057a  9108              STR      r1,[sp,#0x20]         ;4188
00057c  4621              MOV      r1,r4                 ;4188
00057e  980c              LDR      r0,[sp,#0x30]         ;4188
000580  f7fffffe          BL       disk_write
000584  b108              CBZ      r0,|L23.1418|
000586  2001              MOVS     r0,#1                 ;4189
000588  e546              B        |L23.24|
                  |L23.1418|
00058a  f1aa0001          SUB      r0,r10,#1             ;4190
00058e  f1b00a00          SUBS     r10,r0,#0             ;4190
000592  d1ee              BNE      |L23.1394|
000594  2d03              CMP      r5,#3                 ;4202
000596  d146              BNE      |L23.1574|
000598  2052              MOVS     r0,#0x52              ;4203
00059a  7020              STRB     r0,[r4,#0]            ;4203
00059c  7060              STRB     r0,[r4,#1]            ;4203
00059e  2061              MOVS     r0,#0x61              ;4203
0005a0  70a0              STRB     r0,[r4,#2]            ;4203
0005a2  2041              MOVS     r0,#0x41              ;4203
0005a4  70e0              STRB     r0,[r4,#3]            ;4203
0005a6  2072              MOVS     r0,#0x72              ;4204
0005a8  f88401e4          STRB     r0,[r4,#0x1e4]        ;4204
0005ac  2172              MOVS     r1,#0x72              ;4204
0005ae  f24010e5          MOV      r0,#0x1e5             ;4204
0005b2  5501              STRB     r1,[r0,r4]            ;4204
0005b4  2141              MOVS     r1,#0x41              ;4204
0005b6  1c40              ADDS     r0,r0,#1              ;4204
0005b8  5501              STRB     r1,[r0,r4]            ;4204
0005ba  2161              MOVS     r1,#0x61              ;4204
0005bc  1c40              ADDS     r0,r0,#1              ;4204
0005be  5501              STRB     r1,[r0,r4]            ;4204
0005c0  1e78              SUBS     r0,r7,#1              ;4205
0005c2  f88401e8          STRB     r0,[r4,#0x1e8]        ;4205
0005c6  f3c02107          UBFX     r1,r0,#8,#8           ;4205
0005ca  f24010e9          MOV      r0,#0x1e9             ;4205
0005ce  5501              STRB     r1,[r0,r4]            ;4205
0005d0  1e78              SUBS     r0,r7,#1              ;4205
0005d2  f3c04107          UBFX     r1,r0,#16,#8          ;4205
0005d6  f44f70f5          MOV      r0,#0x1ea             ;4205
0005da  5501              STRB     r1,[r0,r4]            ;4205
0005dc  1e78              SUBS     r0,r7,#1              ;4205
0005de  0e01              LSRS     r1,r0,#24             ;4205
0005e0  f24010eb          MOV      r0,#0x1eb             ;4205
0005e4  5501              STRB     r1,[r0,r4]            ;4205
0005e6  2002              MOVS     r0,#2                 ;4206
0005e8  f88401ec          STRB     r0,[r4,#0x1ec]        ;4206
0005ec  2100              MOVS     r1,#0                 ;4206
0005ee  f24010ed          MOV      r0,#0x1ed             ;4206
0005f2  5501              STRB     r1,[r0,r4]            ;4206
0005f4  1c40              ADDS     r0,r0,#1              ;4206
0005f6  5501              STRB     r1,[r0,r4]            ;4206
0005f8  1c40              ADDS     r0,r0,#1              ;4206
0005fa  5501              STRB     r1,[r0,r4]            ;4206
0005fc  2055              MOVS     r0,#0x55              ;4207
0005fe  f88401fe          STRB     r0,[r4,#0x1fe]        ;4207
000602  21aa              MOVS     r1,#0xaa              ;4207
000604  f24010ff          MOV      r0,#0x1ff             ;4207
000608  5501              STRB     r1,[r0,r4]            ;4207
00060a  2301              MOVS     r3,#1                 ;4208
00060c  f1080201          ADD      r2,r8,#1              ;4208
000610  4621              MOV      r1,r4                 ;4208
000612  980c              LDR      r0,[sp,#0x30]         ;4208
000614  f7fffffe          BL       disk_write
000618  2301              MOVS     r3,#1                 ;4209
00061a  f1080207          ADD      r2,r8,#7              ;4209
00061e  4621              MOV      r1,r4                 ;4209
000620  980c              LDR      r0,[sp,#0x30]         ;4209
000622  f7fffffe          BL       disk_write
                  |L23.1574|
000626  2200              MOVS     r2,#0                 ;4212
000628  4611              MOV      r1,r2                 ;4212
00062a  980c              LDR      r0,[sp,#0x30]         ;4212
00062c  f7fffffe          BL       disk_ioctl
000630  b108              CBZ      r0,|L23.1590|
000632  2001              MOVS     r0,#1                 ;4212
000634  e4f0              B        |L23.24|
                  |L23.1590|
000636  2000              MOVS     r0,#0                 ;4212
000638  e4ee              B        |L23.24|
;;;4214   
                          ENDP

00063a  0000              DCW      0x0000
                  |L23.1596|
                          DCD      0x00ffff00

                          AREA ||i.f_mount||, CODE, READONLY, ALIGN=2

                  f_mount PROC
;;;2366   
;;;2367   FRESULT f_mount (
000000  b5f7              PUSH     {r0-r2,r4-r7,lr}
;;;2368   	FATFS* fs,			/* Pointer to the file system object (NULL:unmount)*/
;;;2369   	const TCHAR* path,	/* Logical drive number to be mounted/unmounted */
;;;2370   	BYTE opt			/* 0:Do not mount (delayed mount), 1:Mount immediately */
;;;2371   )
;;;2372   {
000002  b082              SUB      sp,sp,#8
000004  4616              MOV      r6,r2
;;;2373   	FATFS *cfs;
;;;2374   	int vol;
;;;2375   	FRESULT res;
;;;2376   	const TCHAR *rp = path;
000006  9803              LDR      r0,[sp,#0xc]
000008  9001              STR      r0,[sp,#4]
;;;2377   
;;;2378   
;;;2379   	vol = get_ldnumber(&rp);
00000a  a801              ADD      r0,sp,#4
00000c  f7fffffe          BL       get_ldnumber
000010  4605              MOV      r5,r0
;;;2380   	if (vol < 0) return FR_INVALID_DRIVE;
000012  2d00              CMP      r5,#0
000014  da02              BGE      |L24.28|
000016  200b              MOVS     r0,#0xb
                  |L24.24|
;;;2381   	cfs = FatFs[vol];					/* Pointer to fs object */
;;;2382   
;;;2383   	if (cfs) {
;;;2384   #if _FS_LOCK
;;;2385   		clear_lock(cfs);
;;;2386   #endif
;;;2387   #if _FS_REENTRANT						/* Discard sync object of the current volume */
;;;2388   		if (!ff_del_syncobj(cfs->sobj)) return FR_INT_ERR;
;;;2389   #endif
;;;2390   		cfs->fs_type = 0;				/* Clear old fs object */
;;;2391   	}
;;;2392   
;;;2393   	if (fs) {
;;;2394   		fs->fs_type = 0;				/* Clear new fs object */
;;;2395   #if _FS_REENTRANT						/* Create sync object for the new volume */
;;;2396   		if (!ff_cre_syncobj((BYTE)vol, &fs->sobj)) return FR_INT_ERR;
;;;2397   #endif
;;;2398   	}
;;;2399   	FatFs[vol] = fs;					/* Register new fs object */
;;;2400   
;;;2401   	if (!fs || opt != 1) return FR_OK;	/* Do not mount now, it will be mounted later */
;;;2402   
;;;2403   	res = find_volume(&fs, &path, 0);	/* Force mounted the volume */
;;;2404   	LEAVE_FF(fs, res);
;;;2405   }
000018  b005              ADD      sp,sp,#0x14
00001a  bdf0              POP      {r4-r7,pc}
                  |L24.28|
00001c  480e              LDR      r0,|L24.88|
00001e  f8504025          LDR      r4,[r0,r5,LSL #2]     ;2381
000022  b10c              CBZ      r4,|L24.40|
000024  2000              MOVS     r0,#0                 ;2390
000026  7020              STRB     r0,[r4,#0]            ;2390
                  |L24.40|
000028  9802              LDR      r0,[sp,#8]            ;2393
00002a  b110              CBZ      r0,|L24.50|
00002c  2000              MOVS     r0,#0                 ;2394
00002e  9902              LDR      r1,[sp,#8]            ;2394
000030  7008              STRB     r0,[r1,#0]            ;2394
                  |L24.50|
000032  4909              LDR      r1,|L24.88|
000034  9802              LDR      r0,[sp,#8]            ;2399
000036  f8410025          STR      r0,[r1,r5,LSL #2]     ;2399
00003a  9802              LDR      r0,[sp,#8]            ;2401
00003c  b108              CBZ      r0,|L24.66|
00003e  2e01              CMP      r6,#1                 ;2401
000040  d001              BEQ      |L24.70|
                  |L24.66|
000042  2000              MOVS     r0,#0                 ;2401
000044  e7e8              B        |L24.24|
                  |L24.70|
000046  2200              MOVS     r2,#0                 ;2403
000048  a903              ADD      r1,sp,#0xc            ;2403
00004a  a802              ADD      r0,sp,#8              ;2403
00004c  f7fffffe          BL       find_volume
000050  4607              MOV      r7,r0                 ;2403
000052  4638              MOV      r0,r7                 ;2404
000054  e7e0              B        |L24.24|
;;;2406   
                          ENDP

000056  0000              DCW      0x0000
                  |L24.88|
                          DCD      FatFs

                          AREA ||i.f_open||, CODE, READONLY, ALIGN=1

                  f_open PROC
;;;2413   
;;;2414   FRESULT f_open (
000000  e92d47f7          PUSH     {r0-r2,r4-r10,lr}
;;;2415   	FIL* fp,			/* Pointer to the blank file object */
;;;2416   	const TCHAR* path,	/* Pointer to the file name */
;;;2417   	BYTE mode			/* Access mode and file open mode flags */
;;;2418   )
;;;2419   {
000004  b08d              SUB      sp,sp,#0x34
000006  4605              MOV      r5,r0
000008  4616              MOV      r6,r2
;;;2420   	FRESULT res;
;;;2421   	DIR dj;
;;;2422   	BYTE *dir;
;;;2423   	DEF_NAMEBUF;
;;;2424   
;;;2425   
;;;2426   	if (!fp) return FR_INVALID_OBJECT;
00000a  b91d              CBNZ     r5,|L25.20|
00000c  2009              MOVS     r0,#9
                  |L25.14|
;;;2427   	fp->fs = 0;			/* Clear file object */
;;;2428   
;;;2429   	/* Get logical drive number */
;;;2430   #if !_FS_READONLY
;;;2431   	mode &= FA_READ | FA_WRITE | FA_CREATE_ALWAYS | FA_OPEN_ALWAYS | FA_CREATE_NEW;
;;;2432   	res = find_volume(&dj.fs, &path, (BYTE)(mode & ~FA_READ));
;;;2433   #else
;;;2434   	mode &= FA_READ;
;;;2435   	res = find_volume(&dj.fs, &path, 0);
;;;2436   #endif
;;;2437   	if (res == FR_OK) {
;;;2438   		INIT_BUF(dj);
;;;2439   		res = follow_path(&dj, path);	/* Follow the file path */
;;;2440   		dir = dj.dir;
;;;2441   #if !_FS_READONLY	/* R/W configuration */
;;;2442   		if (res == FR_OK) {
;;;2443   			if (!dir)	/* Default directory itself */
;;;2444   				res = FR_INVALID_NAME;
;;;2445   #if _FS_LOCK
;;;2446   			else
;;;2447   				res = chk_lock(&dj, (mode & ~FA_READ) ? 1 : 0);
;;;2448   #endif
;;;2449   		}
;;;2450   		/* Create or Open a file */
;;;2451   		if (mode & (FA_CREATE_ALWAYS | FA_OPEN_ALWAYS | FA_CREATE_NEW)) {
;;;2452   			DWORD dw, cl;
;;;2453   
;;;2454   			if (res != FR_OK) {					/* No file, create new */
;;;2455   				if (res == FR_NO_FILE)			/* There is no file to open, create a new entry */
;;;2456   #if _FS_LOCK
;;;2457   					res = enq_lock() ? dir_register(&dj) : FR_TOO_MANY_OPEN_FILES;
;;;2458   #else
;;;2459   					res = dir_register(&dj);
;;;2460   #endif
;;;2461   				mode |= FA_CREATE_ALWAYS;		/* File is created */
;;;2462   				dir = dj.dir;					/* New entry */
;;;2463   			}
;;;2464   			else {								/* Any object is already existing */
;;;2465   				if (dir[DIR_Attr] & (AM_RDO | AM_DIR)) {	/* Cannot overwrite it (R/O or DIR) */
;;;2466   					res = FR_DENIED;
;;;2467   				} else {
;;;2468   					if (mode & FA_CREATE_NEW)	/* Cannot create as new file */
;;;2469   						res = FR_EXIST;
;;;2470   				}
;;;2471   			}
;;;2472   			if (res == FR_OK && (mode & FA_CREATE_ALWAYS)) {	/* Truncate it if overwrite mode */
;;;2473   				dw = get_fattime();				/* Created time */
;;;2474   				ST_DWORD(dir+DIR_CrtTime, dw);
;;;2475   				dir[DIR_Attr] = 0;				/* Reset attribute */
;;;2476   				ST_DWORD(dir+DIR_FileSize, 0);	/* size = 0 */
;;;2477   				cl = ld_clust(dj.fs, dir);		/* Get start cluster */
;;;2478   				st_clust(dir, 0);				/* cluster = 0 */
;;;2479   				dj.fs->wflag = 1;
;;;2480   				if (cl) {						/* Remove the cluster chain if exist */
;;;2481   					dw = dj.fs->winsect;
;;;2482   					res = remove_chain(dj.fs, cl);
;;;2483   					if (res == FR_OK) {
;;;2484   						dj.fs->last_clust = cl - 1;	/* Reuse the cluster hole */
;;;2485   						res = move_window(dj.fs, dw);
;;;2486   					}
;;;2487   				}
;;;2488   			}
;;;2489   		}
;;;2490   		else {	/* Open an existing file */
;;;2491   			if (res == FR_OK) {					/* Follow succeeded */
;;;2492   				if (dir[DIR_Attr] & AM_DIR) {	/* It is a directory */
;;;2493   					res = FR_NO_FILE;
;;;2494   				} else {
;;;2495   					if ((mode & FA_WRITE) && (dir[DIR_Attr] & AM_RDO)) /* R/O violation */
;;;2496   						res = FR_DENIED;
;;;2497   				}
;;;2498   			}
;;;2499   		}
;;;2500   		if (res == FR_OK) {
;;;2501   			if (mode & FA_CREATE_ALWAYS)		/* Set file change flag if created or overwritten */
;;;2502   				mode |= FA__WRITTEN;
;;;2503   			fp->dir_sect = dj.fs->winsect;		/* Pointer to the directory entry */
;;;2504   			fp->dir_ptr = dir;
;;;2505   #if _FS_LOCK
;;;2506   			fp->lockid = inc_lock(&dj, (mode & ~FA_READ) ? 1 : 0);
;;;2507   			if (!fp->lockid) res = FR_INT_ERR;
;;;2508   #endif
;;;2509   		}
;;;2510   
;;;2511   #else				/* R/O configuration */
;;;2512   		if (res == FR_OK) {					/* Follow succeeded */
;;;2513   			dir = dj.dir;
;;;2514   			if (!dir) {						/* Current directory itself */
;;;2515   				res = FR_INVALID_NAME;
;;;2516   			} else {
;;;2517   				if (dir[DIR_Attr] & AM_DIR)	/* It is a directory */
;;;2518   					res = FR_NO_FILE;
;;;2519   			}
;;;2520   		}
;;;2521   #endif
;;;2522   		FREE_BUF();
;;;2523   
;;;2524   		if (res == FR_OK) {
;;;2525   			fp->flag = mode;					/* File access mode */
;;;2526   			fp->err = 0;						/* Clear error flag */
;;;2527   			fp->sclust = ld_clust(dj.fs, dir);	/* File start cluster */
;;;2528   			fp->fsize = LD_DWORD(dir+DIR_FileSize);	/* File size */
;;;2529   			fp->fptr = 0;						/* File pointer */
;;;2530   			fp->dsect = 0;
;;;2531   #if _USE_FASTSEEK
;;;2532   			fp->cltbl = 0;						/* Normal seek mode */
;;;2533   #endif
;;;2534   			fp->fs = dj.fs;	 					/* Validate file object */
;;;2535   			fp->id = fp->fs->id;
;;;2536   		}
;;;2537   	}
;;;2538   
;;;2539   	LEAVE_FF(dj.fs, res);
;;;2540   }
00000e  b010              ADD      sp,sp,#0x40
000010  e8bd87f0          POP      {r4-r10,pc}
                  |L25.20|
000014  2000              MOVS     r0,#0                 ;2427
000016  6028              STR      r0,[r5,#0]            ;2427
000018  f006061f          AND      r6,r6,#0x1f           ;2431
00001c  f0260201          BIC      r2,r6,#1              ;2432
000020  a90e              ADD      r1,sp,#0x38           ;2432
000022  a804              ADD      r0,sp,#0x10           ;2432
000024  f7fffffe          BL       find_volume
000028  4607              MOV      r7,r0                 ;2432
00002a  2f00              CMP      r7,#0                 ;2437
00002c  d173              BNE      |L25.278|
00002e  f44f7000          MOV      r0,#0x200             ;2438
000032  f7fffffe          BL       ff_memalloc
000036  4681              MOV      r9,r0                 ;2438
000038  f1b90f00          CMP      r9,#0                 ;2438
00003c  d101              BNE      |L25.66|
00003e  2011              MOVS     r0,#0x11              ;2438
000040  e7e5              B        |L25.14|
                  |L25.66|
000042  f8cd902c          STR      r9,[sp,#0x2c]         ;2438
000046  a801              ADD      r0,sp,#4              ;2438
000048  900a              STR      r0,[sp,#0x28]         ;2438
00004a  a804              ADD      r0,sp,#0x10           ;2439
00004c  990e              LDR      r1,[sp,#0x38]         ;2439
00004e  f7fffffe          BL       follow_path
000052  4607              MOV      r7,r0                 ;2439
000054  9c09              LDR      r4,[sp,#0x24]         ;2440
000056  b90f              CBNZ     r7,|L25.92|
000058  b904              CBNZ     r4,|L25.92|
00005a  2706              MOVS     r7,#6                 ;2444
                  |L25.92|
00005c  f006001c          AND      r0,r6,#0x1c           ;2451
000060  2800              CMP      r0,#0                 ;2451
000062  d051              BEQ      |L25.264|
000064  b14f              CBZ      r7,|L25.122|
000066  2f04              CMP      r7,#4                 ;2455
000068  d103              BNE      |L25.114|
00006a  a804              ADD      r0,sp,#0x10           ;2459
00006c  f7fffffe          BL       dir_register
000070  4607              MOV      r7,r0                 ;2459
                  |L25.114|
000072  f0460608          ORR      r6,r6,#8              ;2461
000076  9c09              LDR      r4,[sp,#0x24]         ;2462
000078  e009              B        |L25.142|
                  |L25.122|
00007a  7ae0              LDRB     r0,[r4,#0xb]          ;2465
00007c  f0000011          AND      r0,r0,#0x11           ;2465
000080  b108              CBZ      r0,|L25.134|
000082  2707              MOVS     r7,#7                 ;2466
000084  e003              B        |L25.142|
                  |L25.134|
000086  f0060004          AND      r0,r6,#4              ;2468
00008a  b100              CBZ      r0,|L25.142|
00008c  2708              MOVS     r7,#8                 ;2469
                  |L25.142|
00008e  2f00              CMP      r7,#0                 ;2472
000090  d139              BNE      |L25.262|
000092  f0060008          AND      r0,r6,#8              ;2472
000096  2800              CMP      r0,#0                 ;2472
000098  d035              BEQ      |L25.262|
00009a  f7fffffe          BL       get_fattime
00009e  4680              MOV      r8,r0                 ;2473
0000a0  f884800e          STRB     r8,[r4,#0xe]          ;2474
0000a4  ea4f2118          LSR      r1,r8,#8              ;2474
0000a8  73e1              STRB     r1,[r4,#0xf]          ;2474
0000aa  ea4f4118          LSR      r1,r8,#16             ;2474
0000ae  7421              STRB     r1,[r4,#0x10]         ;2474
0000b0  ea4f6118          LSR      r1,r8,#24             ;2474
0000b4  7461              STRB     r1,[r4,#0x11]         ;2474
0000b6  2000              MOVS     r0,#0                 ;2475
0000b8  72e0              STRB     r0,[r4,#0xb]          ;2475
0000ba  7720              STRB     r0,[r4,#0x1c]         ;2476
0000bc  2100              MOVS     r1,#0                 ;2476
0000be  7761              STRB     r1,[r4,#0x1d]         ;2476
0000c0  77a1              STRB     r1,[r4,#0x1e]         ;2476
0000c2  77e1              STRB     r1,[r4,#0x1f]         ;2476
0000c4  4621              MOV      r1,r4                 ;2477
0000c6  9804              LDR      r0,[sp,#0x10]         ;2477
0000c8  f7fffffe          BL       ld_clust
0000cc  4682              MOV      r10,r0                ;2477
0000ce  2100              MOVS     r1,#0                 ;2478
0000d0  4620              MOV      r0,r4                 ;2478
0000d2  f7fffffe          BL       st_clust
0000d6  2001              MOVS     r0,#1                 ;2479
0000d8  9904              LDR      r1,[sp,#0x10]         ;2479
0000da  7108              STRB     r0,[r1,#4]            ;2479
0000dc  f1ba0f00          CMP      r10,#0                ;2480
0000e0  d011              BEQ      |L25.262|
0000e2  9804              LDR      r0,[sp,#0x10]         ;2481
0000e4  f8d0802c          LDR      r8,[r0,#0x2c]         ;2481
0000e8  4651              MOV      r1,r10                ;2482
0000ea  9804              LDR      r0,[sp,#0x10]         ;2482
0000ec  f7fffffe          BL       remove_chain
0000f0  4607              MOV      r7,r0                 ;2482
0000f2  b947              CBNZ     r7,|L25.262|
0000f4  f1aa0001          SUB      r0,r10,#1             ;2484
0000f8  9904              LDR      r1,[sp,#0x10]         ;2484
0000fa  60c8              STR      r0,[r1,#0xc]          ;2484
0000fc  4641              MOV      r1,r8                 ;2485
0000fe  9804              LDR      r0,[sp,#0x10]         ;2485
000100  f7fffffe          BL       move_window
000104  4607              MOV      r7,r0                 ;2485
                  |L25.262|
000106  e00f              B        |L25.296|
                  |L25.264|
000108  b977              CBNZ     r7,|L25.296|
00010a  7ae0              LDRB     r0,[r4,#0xb]          ;2492
00010c  f0000010          AND      r0,r0,#0x10           ;2492
000110  b110              CBZ      r0,|L25.280|
000112  2704              MOVS     r7,#4                 ;2493
000114  e008              B        |L25.296|
                  |L25.278|
000116  e031              B        |L25.380|
                  |L25.280|
000118  f0060002          AND      r0,r6,#2              ;2495
00011c  b120              CBZ      r0,|L25.296|
00011e  7ae0              LDRB     r0,[r4,#0xb]          ;2495
000120  f0000001          AND      r0,r0,#1              ;2495
000124  b100              CBZ      r0,|L25.296|
000126  2707              MOVS     r7,#7                 ;2496
                  |L25.296|
000128  b947              CBNZ     r7,|L25.316|
00012a  f0060008          AND      r0,r6,#8              ;2501
00012e  b108              CBZ      r0,|L25.308|
000130  f0460620          ORR      r6,r6,#0x20           ;2502
                  |L25.308|
000134  9804              LDR      r0,[sp,#0x10]         ;2503
000136  6ac0              LDR      r0,[r0,#0x2c]         ;2503
000138  61e8              STR      r0,[r5,#0x1c]         ;2503
00013a  622c              STR      r4,[r5,#0x20]         ;2504
                  |L25.316|
00013c  4648              MOV      r0,r9                 ;2522
00013e  f7fffffe          BL       ff_memfree
000142  b9df              CBNZ     r7,|L25.380|
000144  71ae              STRB     r6,[r5,#6]            ;2525
000146  2000              MOVS     r0,#0                 ;2526
000148  71e8              STRB     r0,[r5,#7]            ;2526
00014a  4621              MOV      r1,r4                 ;2527
00014c  9804              LDR      r0,[sp,#0x10]         ;2527
00014e  f7fffffe          BL       ld_clust
000152  6128              STR      r0,[r5,#0x10]         ;2527
000154  7fe0              LDRB     r0,[r4,#0x1f]         ;2528
000156  0601              LSLS     r1,r0,#24             ;2528
000158  7fa0              LDRB     r0,[r4,#0x1e]         ;2528
00015a  ea414100          ORR      r1,r1,r0,LSL #16      ;2528
00015e  7f60              LDRB     r0,[r4,#0x1d]         ;2528
000160  ea412000          ORR      r0,r1,r0,LSL #8       ;2528
000164  7f21              LDRB     r1,[r4,#0x1c]         ;2528
000166  4308              ORRS     r0,r0,r1              ;2528
000168  60e8              STR      r0,[r5,#0xc]          ;2528
00016a  2000              MOVS     r0,#0                 ;2529
00016c  60a8              STR      r0,[r5,#8]            ;2529
00016e  61a8              STR      r0,[r5,#0x18]         ;2530
000170  6268              STR      r0,[r5,#0x24]         ;2532
000172  9804              LDR      r0,[sp,#0x10]         ;2534
000174  6028              STR      r0,[r5,#0]            ;2534
000176  6828              LDR      r0,[r5,#0]            ;2535
000178  88c0              LDRH     r0,[r0,#6]            ;2535
00017a  80a8              STRH     r0,[r5,#4]            ;2535
                  |L25.380|
00017c  4638              MOV      r0,r7                 ;2539
00017e  e746              B        |L25.14|
;;;2541   
                          ENDP


                          AREA ||i.f_opendir||, CODE, READONLY, ALIGN=1

                  f_opendir PROC
;;;3151   
;;;3152   FRESULT f_opendir (
000000  b573              PUSH     {r0,r1,r4-r6,lr}
;;;3153   	DIR* dp,			/* Pointer to directory object to create */
;;;3154   	const TCHAR* path	/* Pointer to the directory path */
;;;3155   )
;;;3156   {
000002  b084              SUB      sp,sp,#0x10
000004  4604              MOV      r4,r0
;;;3157   	FRESULT res;
;;;3158   	FATFS* fs;
;;;3159   	DEF_NAMEBUF;
;;;3160   
;;;3161   
;;;3162   	if (!dp) return FR_INVALID_OBJECT;
000006  b914              CBNZ     r4,|L26.14|
000008  2009              MOVS     r0,#9
                  |L26.10|
;;;3163   
;;;3164   	/* Get logical drive number */
;;;3165   	res = find_volume(&fs, &path, 0);
;;;3166   	if (res == FR_OK) {
;;;3167   		dp->fs = fs;
;;;3168   		INIT_BUF(*dp);
;;;3169   		res = follow_path(dp, path);			/* Follow the path to the directory */
;;;3170   		FREE_BUF();
;;;3171   		if (res == FR_OK) {						/* Follow completed */
;;;3172   			if (dp->dir) {						/* It is not the origin directory itself */
;;;3173   				if (dp->dir[DIR_Attr] & AM_DIR)	/* The object is a sub directory */
;;;3174   					dp->sclust = ld_clust(fs, dp->dir);
;;;3175   				else							/* The object is a file */
;;;3176   					res = FR_NO_PATH;
;;;3177   			}
;;;3178   			if (res == FR_OK) {
;;;3179   				dp->id = fs->id;
;;;3180   				res = dir_sdi(dp, 0);			/* Rewind directory */
;;;3181   #if _FS_LOCK
;;;3182   				if (res == FR_OK) {
;;;3183   					if (dp->sclust) {
;;;3184   						dp->lockid = inc_lock(dp, 0);	/* Lock the sub directory */
;;;3185   						if (!dp->lockid)
;;;3186   							res = FR_TOO_MANY_OPEN_FILES;
;;;3187   					} else {
;;;3188   						dp->lockid = 0;	/* Root directory need not to be locked */
;;;3189   					}
;;;3190   				}
;;;3191   #endif
;;;3192   			}
;;;3193   		}
;;;3194   		if (res == FR_NO_FILE) res = FR_NO_PATH;
;;;3195   	}
;;;3196   	if (res != FR_OK) dp->fs = 0;		/* Invalidate the directory object if function faild */
;;;3197   
;;;3198   	LEAVE_FF(fs, res);
;;;3199   }
00000a  b006              ADD      sp,sp,#0x18
00000c  bd70              POP      {r4-r6,pc}
                  |L26.14|
00000e  2200              MOVS     r2,#0                 ;3165
000010  a905              ADD      r1,sp,#0x14           ;3165
000012  a803              ADD      r0,sp,#0xc            ;3165
000014  f7fffffe          BL       find_volume
000018  4605              MOV      r5,r0                 ;3165
00001a  2d00              CMP      r5,#0                 ;3166
00001c  d12f              BNE      |L26.126|
00001e  9803              LDR      r0,[sp,#0xc]          ;3167
000020  6020              STR      r0,[r4,#0]            ;3167
000022  f44f7000          MOV      r0,#0x200             ;3168
000026  f7fffffe          BL       ff_memalloc
00002a  4606              MOV      r6,r0                 ;3168
00002c  b90e              CBNZ     r6,|L26.50|
00002e  2011              MOVS     r0,#0x11              ;3168
000030  e7eb              B        |L26.10|
                  |L26.50|
000032  61e6              STR      r6,[r4,#0x1c]         ;3168
000034  f8c4d018          STR      sp,[r4,#0x18]         ;3168
000038  4620              MOV      r0,r4                 ;3169
00003a  9905              LDR      r1,[sp,#0x14]         ;3169
00003c  f7fffffe          BL       follow_path
000040  4605              MOV      r5,r0                 ;3169
000042  4630              MOV      r0,r6                 ;3170
000044  f7fffffe          BL       ff_memfree
000048  b9b5              CBNZ     r5,|L26.120|
00004a  6960              LDR      r0,[r4,#0x14]         ;3172
00004c  b158              CBZ      r0,|L26.102|
00004e  6960              LDR      r0,[r4,#0x14]         ;3173
000050  7ac0              LDRB     r0,[r0,#0xb]          ;3173
000052  f0000010          AND      r0,r0,#0x10           ;3173
000056  b128              CBZ      r0,|L26.100|
000058  6961              LDR      r1,[r4,#0x14]         ;3174
00005a  9803              LDR      r0,[sp,#0xc]          ;3174
00005c  f7fffffe          BL       ld_clust
000060  60a0              STR      r0,[r4,#8]            ;3174
000062  e000              B        |L26.102|
                  |L26.100|
000064  2505              MOVS     r5,#5                 ;3176
                  |L26.102|
000066  b93d              CBNZ     r5,|L26.120|
000068  9803              LDR      r0,[sp,#0xc]          ;3179
00006a  88c0              LDRH     r0,[r0,#6]            ;3179
00006c  80a0              STRH     r0,[r4,#4]            ;3179
00006e  2100              MOVS     r1,#0                 ;3180
000070  4620              MOV      r0,r4                 ;3180
000072  f7fffffe          BL       dir_sdi
000076  4605              MOV      r5,r0                 ;3180
                  |L26.120|
000078  2d04              CMP      r5,#4                 ;3194
00007a  d100              BNE      |L26.126|
00007c  2505              MOVS     r5,#5                 ;3194
                  |L26.126|
00007e  b10d              CBZ      r5,|L26.132|
000080  2000              MOVS     r0,#0                 ;3196
000082  6020              STR      r0,[r4,#0]            ;3196
                  |L26.132|
000084  4628              MOV      r0,r5                 ;3198
000086  e7c0              B        |L26.10|
;;;3200   
                          ENDP


                          AREA ||i.f_printf||, CODE, READONLY, ALIGN=1

                  f_printf PROC
;;;4490   
;;;4491   int f_printf (
000000  b40f              PUSH     {r0-r3}
;;;4492   	FIL* fp,			/* Pointer to the file object */
;;;4493   	const TCHAR* fmt,	/* Pointer to the format string */
;;;4494   	...					/* Optional arguments... */
;;;4495   )
;;;4496   {
000002  e92d4ff0          PUSH     {r4-r11,lr}
000006  b09b              SUB      sp,sp,#0x6c
;;;4497   	va_list arp;
;;;4498   	BYTE f, r;
;;;4499   	UINT nw, i, j, w;
;;;4500   	DWORD v;
;;;4501   	TCHAR c, d, s[16], *p;
;;;4502   	putbuff pb;
;;;4503   
;;;4504   
;;;4505   	pb.fp = fp;				/* Initialize output buffer */
000008  9824              LDR      r0,[sp,#0x90]
00000a  9001              STR      r0,[sp,#4]
;;;4506   	pb.nchr = pb.idx = 0;
00000c  2000              MOVS     r0,#0
00000e  9002              STR      r0,[sp,#8]
000010  9003              STR      r0,[sp,#0xc]
;;;4507   
;;;4508   	va_start(arp, fmt);
000012  a826              ADD      r0,sp,#0x98
000014  901a              STR      r0,[sp,#0x68]
;;;4509   
;;;4510   	for (;;) {
000016  bf00              NOP      
                  |L27.24|
;;;4511   		c = *fmt++;
000018  9825              LDR      r0,[sp,#0x94]
00001a  f8104b01          LDRB     r4,[r0],#1
00001e  9025              STR      r0,[sp,#0x94]
;;;4512   		if (c == 0) break;			/* End of string */
000020  b904              CBNZ     r4,|L27.36|
000022  e10d              B        |L27.576|
                  |L27.36|
;;;4513   		if (c != '%') {				/* Non escape character */
000024  2c25              CMP      r4,#0x25
000026  d004              BEQ      |L27.50|
;;;4514   			putc_bfd(&pb, c);
000028  4621              MOV      r1,r4
00002a  a801              ADD      r0,sp,#4
00002c  f7fffffe          BL       putc_bfd
;;;4515   			continue;
000030  e7f2              B        |L27.24|
                  |L27.50|
;;;4516   		}
;;;4517   		w = f = 0;
000032  2000              MOVS     r0,#0
000034  4606              MOV      r6,r0
000036  4681              MOV      r9,r0
;;;4518   		c = *fmt++;
000038  9825              LDR      r0,[sp,#0x94]
00003a  f8104b01          LDRB     r4,[r0],#1
00003e  9025              STR      r0,[sp,#0x94]
;;;4519   		if (c == '0') {				/* Flag: '0' padding */
000040  2c30              CMP      r4,#0x30
000042  d105              BNE      |L27.80|
;;;4520   			f = 1; c = *fmt++;
000044  2601              MOVS     r6,#1
000046  9825              LDR      r0,[sp,#0x94]
000048  f8104b01          LDRB     r4,[r0],#1
00004c  9025              STR      r0,[sp,#0x94]
00004e  e006              B        |L27.94|
                  |L27.80|
;;;4521   		} else {
;;;4522   			if (c == '-') {			/* Flag: left justified */
000050  2c2d              CMP      r4,#0x2d
000052  d104              BNE      |L27.94|
;;;4523   				f = 2; c = *fmt++;
000054  2602              MOVS     r6,#2
000056  9825              LDR      r0,[sp,#0x94]
000058  f8104b01          LDRB     r4,[r0],#1
00005c  9025              STR      r0,[sp,#0x94]
                  |L27.94|
;;;4524   			}
;;;4525   		}
;;;4526   		while (IsDigit(c)) {		/* Precision */
00005e  e009              B        |L27.116|
                  |L27.96|
;;;4527   			w = w * 10 + c - '0';
000060  eb090089          ADD      r0,r9,r9,LSL #2
000064  eb040040          ADD      r0,r4,r0,LSL #1
000068  f1a00930          SUB      r9,r0,#0x30
;;;4528   			c = *fmt++;
00006c  9825              LDR      r0,[sp,#0x94]
00006e  f8104b01          LDRB     r4,[r0],#1
000072  9025              STR      r0,[sp,#0x94]
                  |L27.116|
000074  2c30              CMP      r4,#0x30              ;4526
000076  db01              BLT      |L27.124|
000078  2c39              CMP      r4,#0x39              ;4526
00007a  ddf1              BLE      |L27.96|
                  |L27.124|
;;;4529   		}
;;;4530   		if (c == 'l' || c == 'L') {	/* Prefix: Size is long int */
00007c  2c6c              CMP      r4,#0x6c
00007e  d001              BEQ      |L27.132|
000080  2c4c              CMP      r4,#0x4c
000082  d105              BNE      |L27.144|
                  |L27.132|
;;;4531   			f |= 4; c = *fmt++;
000084  f0460604          ORR      r6,r6,#4
000088  9825              LDR      r0,[sp,#0x94]
00008a  f8104b01          LDRB     r4,[r0],#1
00008e  9025              STR      r0,[sp,#0x94]
                  |L27.144|
;;;4532   		}
;;;4533   		if (!c) break;
000090  b904              CBNZ     r4,|L27.148|
000092  e0d5              B        |L27.576|
                  |L27.148|
;;;4534   		d = c;
000094  4625              MOV      r5,r4
;;;4535   		if (IsLower(d)) d -= 0x20;
000096  2d61              CMP      r5,#0x61
000098  db04              BLT      |L27.164|
00009a  2d7a              CMP      r5,#0x7a
00009c  dc02              BGT      |L27.164|
00009e  f1a50020          SUB      r0,r5,#0x20
0000a2  b2c5              UXTB     r5,r0
                  |L27.164|
;;;4536   		switch (d) {				/* Type is... */
0000a4  2d4f              CMP      r5,#0x4f
0000a6  d049              BEQ      |L27.316|
0000a8  dc06              BGT      |L27.184|
0000aa  2d42              CMP      r5,#0x42
0000ac  d043              BEQ      |L27.310|
0000ae  2d43              CMP      r5,#0x43
0000b0  d038              BEQ      |L27.292|
0000b2  2d44              CMP      r5,#0x44
0000b4  d14c              BNE      |L27.336|
0000b6  e044              B        |L27.322|
                  |L27.184|
0000b8  2d53              CMP      r5,#0x53
0000ba  d004              BEQ      |L27.198|
0000bc  2d55              CMP      r5,#0x55
0000be  d041              BEQ      |L27.324|
0000c0  2d58              CMP      r5,#0x58
0000c2  d145              BNE      |L27.336|
0000c4  e041              B        |L27.330|
                  |L27.198|
;;;4537   		case 'S' :					/* String */
;;;4538   			p = va_arg(arp, TCHAR*);
0000c6  981a              LDR      r0,[sp,#0x68]
0000c8  f850bb04          LDR      r11,[r0],#4
0000cc  901a              STR      r0,[sp,#0x68]
;;;4539   			for (j = 0; p[j]; j++) ;
0000ce  f04f0800          MOV      r8,#0
0000d2  e001              B        |L27.216|
                  |L27.212|
0000d4  f1080801          ADD      r8,r8,#1
                  |L27.216|
0000d8  f81b0008          LDRB     r0,[r11,r8]
0000dc  2800              CMP      r0,#0
0000de  d1f9              BNE      |L27.212|
;;;4540   			if (!(f & 2)) {
0000e0  f0060002          AND      r0,r6,#2
0000e4  b948              CBNZ     r0,|L27.250|
;;;4541   				while (j++ < w) putc_bfd(&pb, ' ');
0000e6  e003              B        |L27.240|
                  |L27.232|
0000e8  2120              MOVS     r1,#0x20
0000ea  a801              ADD      r0,sp,#4
0000ec  f7fffffe          BL       putc_bfd
                  |L27.240|
0000f0  4640              MOV      r0,r8
0000f2  f1080801          ADD      r8,r8,#1
0000f6  4548              CMP      r0,r9
0000f8  d3f6              BCC      |L27.232|
                  |L27.250|
;;;4542   			}
;;;4543   			while (*p) putc_bfd(&pb, *p++);
0000fa  e004              B        |L27.262|
                  |L27.252|
0000fc  f81b1b01          LDRB     r1,[r11],#1
000100  a801              ADD      r0,sp,#4
000102  f7fffffe          BL       putc_bfd
                  |L27.262|
000106  f89b0000          LDRB     r0,[r11,#0]
00010a  2800              CMP      r0,#0
00010c  d1f6              BNE      |L27.252|
;;;4544   			while (j++ < w) putc_bfd(&pb, ' ');
00010e  e003              B        |L27.280|
                  |L27.272|
000110  2120              MOVS     r1,#0x20
000112  a801              ADD      r0,sp,#4
000114  f7fffffe          BL       putc_bfd
                  |L27.280|
000118  4640              MOV      r0,r8
00011a  f1080801          ADD      r8,r8,#1
00011e  4548              CMP      r0,r9
000120  d3f6              BCC      |L27.272|
;;;4545   			continue;
000122  e779              B        |L27.24|
                  |L27.292|
;;;4546   		case 'C' :					/* Character */
;;;4547   			putc_bfd(&pb, (TCHAR)va_arg(arp, int)); continue;
000124  981a              LDR      r0,[sp,#0x68]
000126  f8102b04          LDRB     r2,[r0],#4
00012a  b2d1              UXTB     r1,r2
00012c  901a              STR      r0,[sp,#0x68]
00012e  a801              ADD      r0,sp,#4
000130  f7fffffe          BL       putc_bfd
000134  e770              B        |L27.24|
                  |L27.310|
;;;4548   		case 'B' :					/* Binary */
;;;4549   			r = 2; break;
000136  2002              MOVS     r0,#2
000138  9019              STR      r0,[sp,#0x64]
00013a  e00e              B        |L27.346|
                  |L27.316|
;;;4550   		case 'O' :					/* Octal */
;;;4551   			r = 8; break;
00013c  2008              MOVS     r0,#8
00013e  9019              STR      r0,[sp,#0x64]
000140  e00b              B        |L27.346|
                  |L27.322|
;;;4552   		case 'D' :					/* Signed decimal */
;;;4553   		case 'U' :					/* Unsigned decimal */
000142  bf00              NOP      
                  |L27.324|
;;;4554   			r = 10; break;
000144  200a              MOVS     r0,#0xa
000146  9019              STR      r0,[sp,#0x64]
000148  e007              B        |L27.346|
                  |L27.330|
;;;4555   		case 'X' :					/* Hexdecimal */
;;;4556   			r = 16; break;
00014a  2010              MOVS     r0,#0x10
00014c  9019              STR      r0,[sp,#0x64]
00014e  e004              B        |L27.346|
                  |L27.336|
;;;4557   		default:					/* Unknown type (pass-through) */
;;;4558   			putc_bfd(&pb, c); continue;
000150  4621              MOV      r1,r4
000152  a801              ADD      r0,sp,#4
000154  f7fffffe          BL       putc_bfd
000158  e75e              B        |L27.24|
                  |L27.346|
00015a  bf00              NOP                            ;4549
;;;4559   		}
;;;4560   
;;;4561   		/* Get an argument and put it in numeral */
;;;4562   		v = (f & 4) ? (DWORD)va_arg(arp, long) : ((d == 'D') ? (DWORD)(long)va_arg(arp, int) : (DWORD)va_arg(arp, unsigned int));
00015c  f0060004          AND      r0,r6,#4
000160  b128              CBZ      r0,|L27.366|
000162  981a              LDR      r0,[sp,#0x68]
000164  6800              LDR      r0,[r0,#0]
000166  991a              LDR      r1,[sp,#0x68]
000168  1d09              ADDS     r1,r1,#4
00016a  911a              STR      r1,[sp,#0x68]
00016c  e00c              B        |L27.392|
                  |L27.366|
00016e  2d44              CMP      r5,#0x44
000170  d105              BNE      |L27.382|
000172  981a              LDR      r0,[sp,#0x68]
000174  6800              LDR      r0,[r0,#0]
000176  991a              LDR      r1,[sp,#0x68]
000178  1d09              ADDS     r1,r1,#4
00017a  911a              STR      r1,[sp,#0x68]
00017c  e004              B        |L27.392|
                  |L27.382|
00017e  981a              LDR      r0,[sp,#0x68]
000180  6800              LDR      r0,[r0,#0]
000182  991a              LDR      r1,[sp,#0x68]
000184  1d09              ADDS     r1,r1,#4
000186  911a              STR      r1,[sp,#0x68]
                  |L27.392|
000188  4682              MOV      r10,r0
;;;4563   		if (d == 'D' && (v & 0x80000000)) {
00018a  2d44              CMP      r5,#0x44
00018c  d106              BNE      |L27.412|
00018e  f00a4000          AND      r0,r10,#0x80000000
000192  b118              CBZ      r0,|L27.412|
;;;4564   			v = 0 - v;
000194  f1ca0a00          RSB      r10,r10,#0
;;;4565   			f |= 8;
000198  f0460608          ORR      r6,r6,#8
                  |L27.412|
;;;4566   		}
;;;4567   		i = 0;
00019c  2700              MOVS     r7,#0
;;;4568   		do {
00019e  bf00              NOP      
                  |L27.416|
;;;4569   			d = (TCHAR)(v % r); v /= r;
0001a0  9819              LDR      r0,[sp,#0x64]
0001a2  fbbaf1f0          UDIV     r1,r10,r0
0001a6  fb00a011          MLS      r0,r0,r1,r10
0001aa  b2c5              UXTB     r5,r0
0001ac  9819              LDR      r0,[sp,#0x64]
0001ae  fbbafaf0          UDIV     r10,r10,r0
;;;4570   			if (d > 9) d += (c == 'x') ? 0x27 : 0x07;
0001b2  2d09              CMP      r5,#9
0001b4  dd06              BLE      |L27.452|
0001b6  2c78              CMP      r4,#0x78
0001b8  d101              BNE      |L27.446|
0001ba  2027              MOVS     r0,#0x27
0001bc  e000              B        |L27.448|
                  |L27.446|
0001be  2007              MOVS     r0,#7
                  |L27.448|
0001c0  4428              ADD      r0,r0,r5
0001c2  b2c5              UXTB     r5,r0
                  |L27.452|
;;;4571   			s[i++] = d + '0';
0001c4  f1050030          ADD      r0,r5,#0x30
0001c8  b2c2              UXTB     r2,r0
0001ca  4638              MOV      r0,r7
0001cc  1c7f              ADDS     r7,r7,#1
0001ce  a914              ADD      r1,sp,#0x50
0001d0  540a              STRB     r2,[r1,r0]
;;;4572   		} while (v && i < sizeof s / sizeof s[0]);
0001d2  f1ba0f00          CMP      r10,#0
0001d6  d001              BEQ      |L27.476|
0001d8  2f10              CMP      r7,#0x10
0001da  d3e1              BCC      |L27.416|
                  |L27.476|
;;;4573   		if (f & 8) s[i++] = '-';
0001dc  f0060008          AND      r0,r6,#8
0001e0  b120              CBZ      r0,|L27.492|
0001e2  222d              MOVS     r2,#0x2d
0001e4  4638              MOV      r0,r7
0001e6  1c7f              ADDS     r7,r7,#1
0001e8  a914              ADD      r1,sp,#0x50
0001ea  540a              STRB     r2,[r1,r0]
                  |L27.492|
;;;4574   		j = i; d = (f & 1) ? '0' : ' ';
0001ec  46b8              MOV      r8,r7
0001ee  f0060001          AND      r0,r6,#1
0001f2  b108              CBZ      r0,|L27.504|
0001f4  2030              MOVS     r0,#0x30
0001f6  e000              B        |L27.506|
                  |L27.504|
0001f8  2020              MOVS     r0,#0x20
                  |L27.506|
0001fa  4605              MOV      r5,r0
;;;4575   		while (!(f & 2) && j++ < w) putc_bfd(&pb, d);
0001fc  e003              B        |L27.518|
                  |L27.510|
0001fe  4629              MOV      r1,r5
000200  a801              ADD      r0,sp,#4
000202  f7fffffe          BL       putc_bfd
                  |L27.518|
000206  f0060002          AND      r0,r6,#2
00020a  b920              CBNZ     r0,|L27.534|
00020c  4640              MOV      r0,r8
00020e  f1080801          ADD      r8,r8,#1
000212  4548              CMP      r0,r9
000214  d3f3              BCC      |L27.510|
                  |L27.534|
;;;4576   		do putc_bfd(&pb, s[--i]); while (i);
000216  bf00              NOP      
                  |L27.536|
000218  1e78              SUBS     r0,r7,#1
00021a  4607              MOV      r7,r0
00021c  aa14              ADD      r2,sp,#0x50
00021e  5c11              LDRB     r1,[r2,r0]
000220  a801              ADD      r0,sp,#4
000222  f7fffffe          BL       putc_bfd
000226  2f00              CMP      r7,#0
000228  d1f6              BNE      |L27.536|
;;;4577   		while (j++ < w) putc_bfd(&pb, d);
00022a  e003              B        |L27.564|
                  |L27.556|
00022c  4629              MOV      r1,r5
00022e  a801              ADD      r0,sp,#4
000230  f7fffffe          BL       putc_bfd
                  |L27.564|
000234  4640              MOV      r0,r8
000236  f1080801          ADD      r8,r8,#1
00023a  4548              CMP      r0,r9
00023c  d3f6              BCC      |L27.556|
00023e  e6eb              B        |L27.24|
                  |L27.576|
000240  bf00              NOP                            ;4512
;;;4578   	}
;;;4579   
;;;4580   	va_end(arp);
000242  2000              MOVS     r0,#0
000244  901a              STR      r0,[sp,#0x68]
;;;4581   
;;;4582   	if (   pb.idx >= 0		/* Flush buffered characters to the file */
000246  9802              LDR      r0,[sp,#8]
000248  2800              CMP      r0,#0
00024a  db10              BLT      |L27.622|
;;;4583   		&& f_write(pb.fp, pb.buf, (UINT)pb.idx, &nw) == FR_OK
00024c  ab18              ADD      r3,sp,#0x60
00024e  a904              ADD      r1,sp,#0x10
000250  e9dd0201          LDRD     r0,r2,[sp,#4]
000254  f7fffffe          BL       f_write
000258  b948              CBNZ     r0,|L27.622|
;;;4584   		&& (UINT)pb.idx == nw) return pb.nchr;
00025a  9918              LDR      r1,[sp,#0x60]
00025c  9802              LDR      r0,[sp,#8]
00025e  4288              CMP      r0,r1
000260  d105              BNE      |L27.622|
000262  9803              LDR      r0,[sp,#0xc]
                  |L27.612|
;;;4585   	return EOF;
;;;4586   }
000264  b01b              ADD      sp,sp,#0x6c
000266  e8bd0ff0          POP      {r4-r11}
00026a  f85dfb14          LDR      pc,[sp],#0x14
                  |L27.622|
00026e  f04f30ff          MOV      r0,#0xffffffff        ;4585
000272  e7f7              B        |L27.612|
;;;4587   
                          ENDP


                          AREA ||i.f_putc||, CODE, READONLY, ALIGN=1

                  f_putc PROC
;;;4435   
;;;4436   int f_putc (
000000  b530              PUSH     {r4,r5,lr}
;;;4437   	TCHAR c,	/* A character to be output */
;;;4438   	FIL* fp		/* Pointer to the file object */
;;;4439   )
;;;4440   {
000002  b095              SUB      sp,sp,#0x54
000004  4604              MOV      r4,r0
000006  460d              MOV      r5,r1
;;;4441   	putbuff pb;
;;;4442   	UINT nw;
;;;4443   
;;;4444   
;;;4445   	pb.fp = fp;			/* Initialize output buffer */
000008  9502              STR      r5,[sp,#8]
;;;4446   	pb.nchr = pb.idx = 0;
00000a  2000              MOVS     r0,#0
00000c  9003              STR      r0,[sp,#0xc]
00000e  9004              STR      r0,[sp,#0x10]
;;;4447   
;;;4448   	putc_bfd(&pb, c);	/* Put a character */
000010  4621              MOV      r1,r4
000012  a802              ADD      r0,sp,#8
000014  f7fffffe          BL       putc_bfd
;;;4449   
;;;4450   	if (   pb.idx >= 0	/* Flush buffered characters to the file */
000018  9803              LDR      r0,[sp,#0xc]
00001a  2800              CMP      r0,#0
00001c  db0d              BLT      |L28.58|
;;;4451   		&& f_write(pb.fp, pb.buf, (UINT)pb.idx, &nw) == FR_OK
00001e  ab01              ADD      r3,sp,#4
000020  a905              ADD      r1,sp,#0x14
000022  e9dd0202          LDRD     r0,r2,[sp,#8]
000026  f7fffffe          BL       f_write
00002a  b930              CBNZ     r0,|L28.58|
;;;4452   		&& (UINT)pb.idx == nw) return pb.nchr;
00002c  9901              LDR      r1,[sp,#4]
00002e  9803              LDR      r0,[sp,#0xc]
000030  4288              CMP      r0,r1
000032  d102              BNE      |L28.58|
000034  9804              LDR      r0,[sp,#0x10]
                  |L28.54|
;;;4453   	return EOF;
;;;4454   }
000036  b015              ADD      sp,sp,#0x54
000038  bd30              POP      {r4,r5,pc}
                  |L28.58|
00003a  f04f30ff          MOV      r0,#0xffffffff        ;4453
00003e  e7fa              B        |L28.54|
;;;4455   
                          ENDP


                          AREA ||i.f_puts||, CODE, READONLY, ALIGN=1

                  f_puts PROC
;;;4462   
;;;4463   int f_puts (
000000  b530              PUSH     {r4,r5,lr}
;;;4464   	const TCHAR* str,	/* Pointer to the string to be output */
;;;4465   	FIL* fp				/* Pointer to the file object */
;;;4466   )
;;;4467   {
000002  b095              SUB      sp,sp,#0x54
000004  4604              MOV      r4,r0
000006  460d              MOV      r5,r1
;;;4468   	putbuff pb;
;;;4469   	UINT nw;
;;;4470   
;;;4471   
;;;4472   	pb.fp = fp;				/* Initialize output buffer */
000008  9502              STR      r5,[sp,#8]
;;;4473   	pb.nchr = pb.idx = 0;
00000a  2000              MOVS     r0,#0
00000c  9003              STR      r0,[sp,#0xc]
00000e  9004              STR      r0,[sp,#0x10]
;;;4474   
;;;4475   	while (*str)			/* Put the string */
000010  e004              B        |L29.28|
                  |L29.18|
;;;4476   		putc_bfd(&pb, *str++);
000012  f8141b01          LDRB     r1,[r4],#1
000016  a802              ADD      r0,sp,#8
000018  f7fffffe          BL       putc_bfd
                  |L29.28|
00001c  7820              LDRB     r0,[r4,#0]            ;4475
00001e  2800              CMP      r0,#0                 ;4475
000020  d1f7              BNE      |L29.18|
;;;4477   
;;;4478   	if (   pb.idx >= 0		/* Flush buffered characters to the file */
000022  9803              LDR      r0,[sp,#0xc]
000024  2800              CMP      r0,#0
000026  db0d              BLT      |L29.68|
;;;4479   		&& f_write(pb.fp, pb.buf, (UINT)pb.idx, &nw) == FR_OK
000028  ab01              ADD      r3,sp,#4
00002a  a905              ADD      r1,sp,#0x14
00002c  e9dd0202          LDRD     r0,r2,[sp,#8]
000030  f7fffffe          BL       f_write
000034  b930              CBNZ     r0,|L29.68|
;;;4480   		&& (UINT)pb.idx == nw) return pb.nchr;
000036  9901              LDR      r1,[sp,#4]
000038  9803              LDR      r0,[sp,#0xc]
00003a  4288              CMP      r0,r1
00003c  d102              BNE      |L29.68|
00003e  9804              LDR      r0,[sp,#0x10]
                  |L29.64|
;;;4481   	return EOF;
;;;4482   }
000040  b015              ADD      sp,sp,#0x54
000042  bd30              POP      {r4,r5,pc}
                  |L29.68|
000044  f04f30ff          MOV      r0,#0xffffffff        ;4481
000048  e7fa              B        |L29.64|
;;;4483   
                          ENDP


                          AREA ||i.f_read||, CODE, READONLY, ALIGN=1

                  f_read PROC
;;;2548   
;;;2549   FRESULT f_read (
000000  e92d4fff          PUSH     {r0-r11,lr}
;;;2550   	FIL* fp, 		/* Pointer to the file object */
;;;2551   	void* buff,		/* Pointer to data buffer */
;;;2552   	UINT btr,		/* Number of bytes to read */
;;;2553   	UINT* br		/* Pointer to number of bytes read */
;;;2554   )
;;;2555   {
000004  b083              SUB      sp,sp,#0xc
000006  4604              MOV      r4,r0
000008  4615              MOV      r5,r2
00000a  469a              MOV      r10,r3
;;;2556   	FRESULT res;
;;;2557   	DWORD clst, sect, remain;
;;;2558   	UINT rcnt, cc;
;;;2559   	BYTE csect, *rbuff = (BYTE*)buff;
00000c  f8ddb010          LDR      r11,[sp,#0x10]
;;;2560   
;;;2561   
;;;2562   	*br = 0;	/* Clear read byte counter */
000010  2000              MOVS     r0,#0
000012  f8ca0000          STR      r0,[r10,#0]
;;;2563   
;;;2564   	res = validate(fp);							/* Check validity */
000016  4620              MOV      r0,r4
000018  f7fffffe          BL       validate
00001c  9002              STR      r0,[sp,#8]
;;;2565   	if (res != FR_OK) LEAVE_FF(fp->fs, res);
00001e  9802              LDR      r0,[sp,#8]
000020  b118              CBZ      r0,|L30.42|
000022  9802              LDR      r0,[sp,#8]
                  |L30.36|
;;;2566   	if (fp->err)								/* Check error */
;;;2567   		LEAVE_FF(fp->fs, (FRESULT)fp->err);
;;;2568   	if (!(fp->flag & FA_READ)) 					/* Check access mode */
;;;2569   		LEAVE_FF(fp->fs, FR_DENIED);
;;;2570   	remain = fp->fsize - fp->fptr;
;;;2571   	if (btr > remain) btr = (UINT)remain;		/* Truncate btr by remaining bytes */
;;;2572   
;;;2573   	for ( ;  btr;								/* Repeat until all data read */
;;;2574   		rbuff += rcnt, fp->fptr += rcnt, *br += rcnt, btr -= rcnt) {
;;;2575   		if ((fp->fptr % SS(fp->fs)) == 0) {		/* On the sector boundary? */
;;;2576   			csect = (BYTE)(fp->fptr / SS(fp->fs) & (fp->fs->csize - 1));	/* Sector offset in the cluster */
;;;2577   			if (!csect) {						/* On the cluster boundary? */
;;;2578   				if (fp->fptr == 0) {			/* On the top of the file? */
;;;2579   					clst = fp->sclust;			/* Follow from the origin */
;;;2580   				} else {						/* Middle or end of the file */
;;;2581   #if _USE_FASTSEEK
;;;2582   					if (fp->cltbl)
;;;2583   						clst = clmt_clust(fp, fp->fptr);	/* Get cluster# from the CLMT */
;;;2584   					else
;;;2585   #endif
;;;2586   						clst = get_fat(fp->fs, fp->clust);	/* Follow cluster chain on the FAT */
;;;2587   				}
;;;2588   				if (clst < 2) ABORT(fp->fs, FR_INT_ERR);
;;;2589   				if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;2590   				fp->clust = clst;				/* Update current cluster */
;;;2591   			}
;;;2592   			sect = clust2sect(fp->fs, fp->clust);	/* Get current sector */
;;;2593   			if (!sect) ABORT(fp->fs, FR_INT_ERR);
;;;2594   			sect += csect;
;;;2595   			cc = btr / SS(fp->fs);				/* When remaining bytes >= sector size, */
;;;2596   			if (cc) {							/* Read maximum contiguous sectors directly */
;;;2597   				if (csect + cc > fp->fs->csize)	/* Clip at cluster boundary */
;;;2598   					cc = fp->fs->csize - csect;
;;;2599   				if (disk_read(fp->fs->drv, rbuff, sect, cc))
;;;2600   					ABORT(fp->fs, FR_DISK_ERR);
;;;2601   #if !_FS_READONLY && _FS_MINIMIZE <= 2			/* Replace one of the read sectors with cached data if it contains a dirty sector */
;;;2602   #if _FS_TINY
;;;2603   				if (fp->fs->wflag && fp->fs->winsect - sect < cc)
;;;2604   					mem_cpy(rbuff + ((fp->fs->winsect - sect) * SS(fp->fs)), fp->fs->win, SS(fp->fs));
;;;2605   #else
;;;2606   				if ((fp->flag & FA__DIRTY) && fp->dsect - sect < cc)
;;;2607   					mem_cpy(rbuff + ((fp->dsect - sect) * SS(fp->fs)), fp->buf, SS(fp->fs));
;;;2608   #endif
;;;2609   #endif
;;;2610   				rcnt = SS(fp->fs) * cc;			/* Number of bytes transferred */
;;;2611   				continue;
;;;2612   			}
;;;2613   #if !_FS_TINY
;;;2614   			if (fp->dsect != sect) {			/* Load data sector if not in cache */
;;;2615   #if !_FS_READONLY
;;;2616   				if (fp->flag & FA__DIRTY) {		/* Write-back dirty sector cache */
;;;2617   					if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
;;;2618   						ABORT(fp->fs, FR_DISK_ERR);
;;;2619   					fp->flag &= ~FA__DIRTY;
;;;2620   				}
;;;2621   #endif
;;;2622   				if (disk_read(fp->fs->drv, fp->buf, sect, 1))	/* Fill sector cache */
;;;2623   					ABORT(fp->fs, FR_DISK_ERR);
;;;2624   			}
;;;2625   #endif
;;;2626   			fp->dsect = sect;
;;;2627   		}
;;;2628   		rcnt = SS(fp->fs) - ((UINT)fp->fptr % SS(fp->fs));	/* Get partial sector data from sector buffer */
;;;2629   		if (rcnt > btr) rcnt = btr;
;;;2630   #if _FS_TINY
;;;2631   		if (move_window(fp->fs, fp->dsect))		/* Move sector window */
;;;2632   			ABORT(fp->fs, FR_DISK_ERR);
;;;2633   		mem_cpy(rbuff, &fp->fs->win[fp->fptr % SS(fp->fs)], rcnt);	/* Pick partial sector */
;;;2634   #else
;;;2635   		mem_cpy(rbuff, &fp->buf[fp->fptr % SS(fp->fs)], rcnt);	/* Pick partial sector */
;;;2636   #endif
;;;2637   	}
;;;2638   
;;;2639   	LEAVE_FF(fp->fs, FR_OK);
;;;2640   }
000024  b007              ADD      sp,sp,#0x1c
000026  e8bd8ff0          POP      {r4-r11,pc}
                  |L30.42|
00002a  79e0              LDRB     r0,[r4,#7]            ;2566
00002c  b108              CBZ      r0,|L30.50|
00002e  79e0              LDRB     r0,[r4,#7]            ;2567
000030  e7f8              B        |L30.36|
                  |L30.50|
000032  79a0              LDRB     r0,[r4,#6]            ;2568
000034  f0000001          AND      r0,r0,#1              ;2568
000038  b908              CBNZ     r0,|L30.62|
00003a  2007              MOVS     r0,#7                 ;2569
00003c  e7f2              B        |L30.36|
                  |L30.62|
00003e  e9d41002          LDRD     r1,r0,[r4,#8]         ;2570
000042  1a40              SUBS     r0,r0,r1              ;2570
000044  9000              STR      r0,[sp,#0]            ;2570
000046  9800              LDR      r0,[sp,#0]            ;2571
000048  4285              CMP      r5,r0                 ;2571
00004a  d900              BLS      |L30.78|
00004c  9d00              LDR      r5,[sp,#0]            ;2571
                  |L30.78|
00004e  e0aa              B        |L30.422|
                  |L30.80|
000050  8920              LDRH     r0,[r4,#8]            ;2575
000052  f3c00008          UBFX     r0,r0,#0,#9           ;2575
000056  2800              CMP      r0,#0                 ;2575
000058  d176              BNE      |L30.328|
00005a  6820              LDR      r0,[r4,#0]            ;2576
00005c  7880              LDRB     r0,[r0,#2]            ;2576
00005e  1e40              SUBS     r0,r0,#1              ;2576
000060  68a1              LDR      r1,[r4,#8]            ;2576
000062  ea002051          AND      r0,r0,r1,LSR #9       ;2576
000066  f00009ff          AND      r9,r0,#0xff           ;2576
00006a  f1b90f00          CMP      r9,#0                 ;2577
00006e  d11f              BNE      |L30.176|
000070  68a0              LDR      r0,[r4,#8]            ;2578
000072  b910              CBNZ     r0,|L30.122|
000074  6920              LDR      r0,[r4,#0x10]         ;2579
000076  9001              STR      r0,[sp,#4]            ;2579
000078  e00c              B        |L30.148|
                  |L30.122|
00007a  6a60              LDR      r0,[r4,#0x24]         ;2582
00007c  b128              CBZ      r0,|L30.138|
00007e  4620              MOV      r0,r4                 ;2583
000080  68a1              LDR      r1,[r4,#8]            ;2583
000082  f7fffffe          BL       clmt_clust
000086  9001              STR      r0,[sp,#4]            ;2583
000088  e004              B        |L30.148|
                  |L30.138|
00008a  6961              LDR      r1,[r4,#0x14]         ;2586
00008c  6820              LDR      r0,[r4,#0]            ;2586
00008e  f7fffffe          BL       get_fat
000092  9001              STR      r0,[sp,#4]            ;2586
                  |L30.148|
000094  9801              LDR      r0,[sp,#4]            ;2588
000096  2802              CMP      r0,#2                 ;2588
000098  d202              BCS      |L30.160|
00009a  2002              MOVS     r0,#2                 ;2588
00009c  71e0              STRB     r0,[r4,#7]            ;2588
00009e  e7c1              B        |L30.36|
                  |L30.160|
0000a0  9801              LDR      r0,[sp,#4]            ;2589
0000a2  1c40              ADDS     r0,r0,#1              ;2589
0000a4  b910              CBNZ     r0,|L30.172|
0000a6  2001              MOVS     r0,#1                 ;2589
0000a8  71e0              STRB     r0,[r4,#7]            ;2589
0000aa  e7bb              B        |L30.36|
                  |L30.172|
0000ac  9801              LDR      r0,[sp,#4]            ;2590
0000ae  6160              STR      r0,[r4,#0x14]         ;2590
                  |L30.176|
0000b0  6961              LDR      r1,[r4,#0x14]         ;2592
0000b2  6820              LDR      r0,[r4,#0]            ;2592
0000b4  f7fffffe          BL       clust2sect
0000b8  4606              MOV      r6,r0                 ;2592
0000ba  b916              CBNZ     r6,|L30.194|
0000bc  2002              MOVS     r0,#2                 ;2593
0000be  71e0              STRB     r0,[r4,#7]            ;2593
0000c0  e7b0              B        |L30.36|
                  |L30.194|
0000c2  444e              ADD      r6,r6,r9              ;2594
0000c4  ea4f2855          LSR      r8,r5,#9              ;2595
0000c8  f1b80f00          CMP      r8,#0                 ;2596
0000cc  d029              BEQ      |L30.290|
0000ce  eb090008          ADD      r0,r9,r8              ;2597
0000d2  6821              LDR      r1,[r4,#0]            ;2597
0000d4  7889              LDRB     r1,[r1,#2]            ;2597
0000d6  4288              CMP      r0,r1                 ;2597
0000d8  d903              BLS      |L30.226|
0000da  6820              LDR      r0,[r4,#0]            ;2598
0000dc  7880              LDRB     r0,[r0,#2]            ;2598
0000de  eba00809          SUB      r8,r0,r9              ;2598
                  |L30.226|
0000e2  6821              LDR      r1,[r4,#0]            ;2599
0000e4  7848              LDRB     r0,[r1,#1]            ;2599
0000e6  4643              MOV      r3,r8                 ;2599
0000e8  4632              MOV      r2,r6                 ;2599
0000ea  4659              MOV      r1,r11                ;2599
0000ec  f7fffffe          BL       disk_read
0000f0  b110              CBZ      r0,|L30.248|
0000f2  2001              MOVS     r0,#1                 ;2600
0000f4  71e0              STRB     r0,[r4,#7]            ;2600
0000f6  e795              B        |L30.36|
                  |L30.248|
0000f8  79a0              LDRB     r0,[r4,#6]            ;2606
0000fa  f0000040          AND      r0,r0,#0x40           ;2606
0000fe  b168              CBZ      r0,|L30.284|
000100  69a0              LDR      r0,[r4,#0x18]         ;2606
000102  1b80              SUBS     r0,r0,r6              ;2606
000104  4540              CMP      r0,r8                 ;2606
000106  d209              BCS      |L30.284|
000108  69a1              LDR      r1,[r4,#0x18]         ;2607
00010a  1b89              SUBS     r1,r1,r6              ;2607
00010c  eb0b2041          ADD      r0,r11,r1,LSL #9      ;2607
000110  f44f7200          MOV      r2,#0x200             ;2607
000114  f1040128          ADD      r1,r4,#0x28           ;2607
000118  f7fffffe          BL       mem_cpy
                  |L30.284|
00011c  ea4f2748          LSL      r7,r8,#9              ;2610
000120  e037              B        |L30.402|
                  |L30.290|
000122  69a0              LDR      r0,[r4,#0x18]         ;2614
000124  42b0              CMP      r0,r6                 ;2614
000126  d020              BEQ      |L30.362|
000128  79a0              LDRB     r0,[r4,#6]            ;2616
00012a  f0000040          AND      r0,r0,#0x40           ;2616
00012e  b180              CBZ      r0,|L30.338|
000130  6821              LDR      r1,[r4,#0]            ;2617
000132  7848              LDRB     r0,[r1,#1]            ;2617
000134  2301              MOVS     r3,#1                 ;2617
000136  f1040128          ADD      r1,r4,#0x28           ;2617
00013a  69a2              LDR      r2,[r4,#0x18]         ;2617
00013c  f7fffffe          BL       disk_write
000140  b118              CBZ      r0,|L30.330|
000142  2001              MOVS     r0,#1                 ;2618
000144  71e0              STRB     r0,[r4,#7]            ;2618
000146  e76d              B        |L30.36|
                  |L30.328|
000148  e010              B        |L30.364|
                  |L30.330|
00014a  79a0              LDRB     r0,[r4,#6]            ;2619
00014c  f0200040          BIC      r0,r0,#0x40           ;2619
000150  71a0              STRB     r0,[r4,#6]            ;2619
                  |L30.338|
000152  6821              LDR      r1,[r4,#0]            ;2622
000154  7848              LDRB     r0,[r1,#1]            ;2622
000156  2301              MOVS     r3,#1                 ;2622
000158  4632              MOV      r2,r6                 ;2622
00015a  f1040128          ADD      r1,r4,#0x28           ;2622
00015e  f7fffffe          BL       disk_read
000162  b110              CBZ      r0,|L30.362|
000164  2001              MOVS     r0,#1                 ;2623
000166  71e0              STRB     r0,[r4,#7]            ;2623
000168  e75c              B        |L30.36|
                  |L30.362|
00016a  61a6              STR      r6,[r4,#0x18]         ;2626
                  |L30.364|
00016c  8920              LDRH     r0,[r4,#8]            ;2628
00016e  f3c00008          UBFX     r0,r0,#0,#9           ;2628
000172  f5c07700          RSB      r7,r0,#0x200          ;2628
000176  42af              CMP      r7,r5                 ;2629
000178  d900              BLS      |L30.380|
00017a  462f              MOV      r7,r5                 ;2629
                  |L30.380|
00017c  8920              LDRH     r0,[r4,#8]            ;2635
00017e  f3c00208          UBFX     r2,r0,#0,#9           ;2635
000182  f1040028          ADD      r0,r4,#0x28           ;2635
000186  1811              ADDS     r1,r2,r0              ;2635
000188  463a              MOV      r2,r7                 ;2635
00018a  4658              MOV      r0,r11                ;2635
00018c  f7fffffe          BL       mem_cpy
000190  bf00              NOP                            ;2611
                  |L30.402|
000192  44bb              ADD      r11,r11,r7            ;2574
000194  68a0              LDR      r0,[r4,#8]            ;2574
000196  4438              ADD      r0,r0,r7              ;2574
000198  60a0              STR      r0,[r4,#8]            ;2574
00019a  f8da0000          LDR      r0,[r10,#0]           ;2574
00019e  4438              ADD      r0,r0,r7              ;2574
0001a0  f8ca0000          STR      r0,[r10,#0]           ;2574
0001a4  1bed              SUBS     r5,r5,r7              ;2574
                  |L30.422|
0001a6  2d00              CMP      r5,#0                 ;2573
0001a8  f47faf52          BNE      |L30.80|
0001ac  2000              MOVS     r0,#0                 ;2639
0001ae  e739              B        |L30.36|
;;;2641   
                          ENDP


                          AREA ||i.f_readdir||, CODE, READONLY, ALIGN=1

                  f_readdir PROC
;;;3240   
;;;3241   FRESULT f_readdir (
000000  b5fe              PUSH     {r1-r7,lr}
;;;3242   	DIR* dp,			/* Pointer to the open directory object */
;;;3243   	FILINFO* fno		/* Pointer to file information to return */
;;;3244   )
;;;3245   {
000002  4604              MOV      r4,r0
000004  460f              MOV      r7,r1
;;;3246   	FRESULT res;
;;;3247   	DEF_NAMEBUF;
;;;3248   
;;;3249   
;;;3250   	res = validate(dp);						/* Check validity of the object */
000006  4620              MOV      r0,r4
000008  f7fffffe          BL       validate
00000c  4605              MOV      r5,r0
;;;3251   	if (res == FR_OK) {
00000e  2d00              CMP      r5,#0
000010  d12d              BNE      |L31.110|
;;;3252   		if (!fno) {
000012  b92f              CBNZ     r7,|L31.32|
;;;3253   			res = dir_sdi(dp, 0);			/* Rewind the directory object */
000014  2100              MOVS     r1,#0
000016  4620              MOV      r0,r4
000018  f7fffffe          BL       dir_sdi
00001c  4605              MOV      r5,r0
00001e  e026              B        |L31.110|
                  |L31.32|
;;;3254   		} else {
;;;3255   			INIT_BUF(*dp);
000020  f44f7000          MOV      r0,#0x200
000024  f7fffffe          BL       ff_memalloc
000028  4606              MOV      r6,r0
00002a  b90e              CBNZ     r6,|L31.48|
00002c  2011              MOVS     r0,#0x11
                  |L31.46|
;;;3256   			res = dir_read(dp, 0);			/* Read an item */
;;;3257   			if (res == FR_NO_FILE) {		/* Reached end of directory */
;;;3258   				dp->sect = 0;
;;;3259   				res = FR_OK;
;;;3260   			}
;;;3261   			if (res == FR_OK) {				/* A valid entry is found */
;;;3262   				get_fileinfo(dp, fno);		/* Get the object information */
;;;3263   				res = dir_next(dp, 0);		/* Increment index for next */
;;;3264   				if (res == FR_NO_FILE) {
;;;3265   					dp->sect = 0;
;;;3266   					res = FR_OK;
;;;3267   				}
;;;3268   			}
;;;3269   			FREE_BUF();
;;;3270   		}
;;;3271   	}
;;;3272   
;;;3273   	LEAVE_FF(dp->fs, res);
;;;3274   }
00002e  bdfe              POP      {r1-r7,pc}
                  |L31.48|
000030  61e6              STR      r6,[r4,#0x1c]         ;3255
000032  f8c4d018          STR      sp,[r4,#0x18]         ;3255
000036  2100              MOVS     r1,#0                 ;3256
000038  4620              MOV      r0,r4                 ;3256
00003a  f7fffffe          BL       dir_read
00003e  4605              MOV      r5,r0                 ;3256
000040  2d04              CMP      r5,#4                 ;3257
000042  d102              BNE      |L31.74|
000044  2000              MOVS     r0,#0                 ;3258
000046  6120              STR      r0,[r4,#0x10]         ;3258
000048  2500              MOVS     r5,#0                 ;3259
                  |L31.74|
00004a  b96d              CBNZ     r5,|L31.104|
00004c  4639              MOV      r1,r7                 ;3262
00004e  4620              MOV      r0,r4                 ;3262
000050  f7fffffe          BL       get_fileinfo
000054  2100              MOVS     r1,#0                 ;3263
000056  4620              MOV      r0,r4                 ;3263
000058  f7fffffe          BL       dir_next
00005c  4605              MOV      r5,r0                 ;3263
00005e  2d04              CMP      r5,#4                 ;3264
000060  d102              BNE      |L31.104|
000062  2000              MOVS     r0,#0                 ;3265
000064  6120              STR      r0,[r4,#0x10]         ;3265
000066  2500              MOVS     r5,#0                 ;3266
                  |L31.104|
000068  4630              MOV      r0,r6                 ;3269
00006a  f7fffffe          BL       ff_memfree
                  |L31.110|
00006e  4628              MOV      r0,r5                 ;3273
000070  e7dd              B        |L31.46|
;;;3275   
                          ENDP


                          AREA ||i.f_rename||, CODE, READONLY, ALIGN=1

                  f_rename PROC
;;;3669   
;;;3670   FRESULT f_rename (
000000  e92d41f3          PUSH     {r0,r1,r4-r8,lr}
;;;3671   	const TCHAR* path_old,	/* Pointer to the object to be renamed */
;;;3672   	const TCHAR* path_new	/* Pointer to the new name */
;;;3673   )
;;;3674   {
000004  b09c              SUB      sp,sp,#0x70
;;;3675   	FRESULT res;
;;;3676   	DIR djo, djn;
;;;3677   	BYTE buf[21], *dir;
;;;3678   	DWORD dw;
;;;3679   	DEF_NAMEBUF;
;;;3680   
;;;3681   
;;;3682   	/* Get logical drive number of the source object */
;;;3683   	res = find_volume(&djo.fs, &path_old, 1);
000006  2201              MOVS     r2,#1
000008  a91c              ADD      r1,sp,#0x70
00000a  a813              ADD      r0,sp,#0x4c
00000c  f7fffffe          BL       find_volume
000010  4604              MOV      r4,r0
;;;3684   	if (res == FR_OK) {
000012  2c00              CMP      r4,#0
000014  d178              BNE      |L32.264|
;;;3685   		djn.fs = djo.fs;
000016  9813              LDR      r0,[sp,#0x4c]
000018  900a              STR      r0,[sp,#0x28]
;;;3686   		INIT_BUF(djo);
00001a  f44f7000          MOV      r0,#0x200
00001e  f7fffffe          BL       ff_memalloc
000022  4607              MOV      r7,r0
000024  b91f              CBNZ     r7,|L32.46|
000026  2011              MOVS     r0,#0x11
                  |L32.40|
;;;3687   		res = follow_path(&djo, path_old);		/* Check old object */
;;;3688   		if (_FS_RPATH && res == FR_OK && (djo.fn[NS] & NS_DOT))
;;;3689   			res = FR_INVALID_NAME;
;;;3690   #if _FS_LOCK
;;;3691   		if (res == FR_OK) res = chk_lock(&djo, 2);
;;;3692   #endif
;;;3693   		if (res == FR_OK) {						/* Old object is found */
;;;3694   			if (!djo.dir) {						/* Is root dir? */
;;;3695   				res = FR_NO_FILE;
;;;3696   			} else {
;;;3697   				mem_cpy(buf, djo.dir+DIR_Attr, 21);		/* Save the object information except name */
;;;3698   				mem_cpy(&djn, &djo, sizeof (DIR));		/* Duplicate the directory object */
;;;3699   				if (get_ldnumber(&path_new) >= 0)		/* Snip drive number off and ignore it */
;;;3700   					res = follow_path(&djn, path_new);	/* and check if new object is exist */
;;;3701   				else
;;;3702   					res = FR_INVALID_DRIVE;
;;;3703   				if (res == FR_OK) res = FR_EXIST;		/* The new object name is already existing */
;;;3704   				if (res == FR_NO_FILE) { 				/* Is it a valid path and no name collision? */
;;;3705   /* Start critical section that any interruption can cause a cross-link */
;;;3706   					res = dir_register(&djn);			/* Register the new entry */
;;;3707   					if (res == FR_OK) {
;;;3708   						dir = djn.dir;					/* Copy object information except name */
;;;3709   						mem_cpy(dir+13, buf+2, 19);
;;;3710   						dir[DIR_Attr] = buf[0] | AM_ARC;
;;;3711   						djo.fs->wflag = 1;
;;;3712   						if (djo.sclust != djn.sclust && (dir[DIR_Attr] & AM_DIR)) {		/* Update .. entry in the directory if needed */
;;;3713   							dw = clust2sect(djo.fs, ld_clust(djo.fs, dir));
;;;3714   							if (!dw) {
;;;3715   								res = FR_INT_ERR;
;;;3716   							} else {
;;;3717   								res = move_window(djo.fs, dw);
;;;3718   								dir = djo.fs->win+SZ_DIR;	/* .. entry */
;;;3719   								if (res == FR_OK && dir[1] == '.') {
;;;3720   									dw = (djo.fs->fs_type == FS_FAT32 && djn.sclust == djo.fs->dirbase) ? 0 : djn.sclust;
;;;3721   									st_clust(dir, dw);
;;;3722   									djo.fs->wflag = 1;
;;;3723   								}
;;;3724   							}
;;;3725   						}
;;;3726   						if (res == FR_OK) {
;;;3727   							res = dir_remove(&djo);		/* Remove old entry */
;;;3728   							if (res == FR_OK)
;;;3729   								res = sync_fs(djo.fs);
;;;3730   						}
;;;3731   					}
;;;3732   /* End critical section */
;;;3733   				}
;;;3734   			}
;;;3735   		}
;;;3736   		FREE_BUF();
;;;3737   	}
;;;3738   
;;;3739   	LEAVE_FF(djo.fs, res);
;;;3740   }
000028  b01e              ADD      sp,sp,#0x78
00002a  e8bd81f0          POP      {r4-r8,pc}
                  |L32.46|
00002e  971a              STR      r7,[sp,#0x68]         ;3686
000030  a801              ADD      r0,sp,#4              ;3686
000032  9019              STR      r0,[sp,#0x64]         ;3686
000034  a813              ADD      r0,sp,#0x4c           ;3687
000036  991c              LDR      r1,[sp,#0x70]         ;3687
000038  f7fffffe          BL       follow_path
00003c  4604              MOV      r4,r0                 ;3687
00003e  bf00              NOP                            ;3688
000040  2c00              CMP      r4,#0                 ;3693
000042  d175              BNE      |L32.304|
000044  9818              LDR      r0,[sp,#0x60]         ;3694
000046  b908              CBNZ     r0,|L32.76|
000048  2404              MOVS     r4,#4                 ;3695
00004a  e071              B        |L32.304|
                  |L32.76|
00004c  9818              LDR      r0,[sp,#0x60]         ;3697
00004e  f100010b          ADD      r1,r0,#0xb            ;3697
000052  2215              MOVS     r2,#0x15              ;3697
000054  a804              ADD      r0,sp,#0x10           ;3697
000056  f7fffffe          BL       mem_cpy
00005a  2224              MOVS     r2,#0x24              ;3698
00005c  a913              ADD      r1,sp,#0x4c           ;3698
00005e  a80a              ADD      r0,sp,#0x28           ;3698
000060  f7fffffe          BL       mem_cpy
000064  a81d              ADD      r0,sp,#0x74           ;3699
000066  f7fffffe          BL       get_ldnumber
00006a  2800              CMP      r0,#0                 ;3699
00006c  db05              BLT      |L32.122|
00006e  a80a              ADD      r0,sp,#0x28           ;3700
000070  991d              LDR      r1,[sp,#0x74]         ;3700
000072  f7fffffe          BL       follow_path
000076  4604              MOV      r4,r0                 ;3700
000078  e000              B        |L32.124|
                  |L32.122|
00007a  240b              MOVS     r4,#0xb               ;3702
                  |L32.124|
00007c  b904              CBNZ     r4,|L32.128|
00007e  2408              MOVS     r4,#8                 ;3703
                  |L32.128|
000080  2c04              CMP      r4,#4                 ;3704
000082  d155              BNE      |L32.304|
000084  a80a              ADD      r0,sp,#0x28           ;3706
000086  f7fffffe          BL       dir_register
00008a  4604              MOV      r4,r0                 ;3706
00008c  2c00              CMP      r4,#0                 ;3707
00008e  d14f              BNE      |L32.304|
000090  9d0f              LDR      r5,[sp,#0x3c]         ;3708
000092  2213              MOVS     r2,#0x13              ;3709
000094  f10d0112          ADD      r1,sp,#0x12           ;3709
000098  f105000d          ADD      r0,r5,#0xd            ;3709
00009c  f7fffffe          BL       mem_cpy
0000a0  f89d0010          LDRB     r0,[sp,#0x10]         ;3710
0000a4  f0400020          ORR      r0,r0,#0x20           ;3710
0000a8  72e8              STRB     r0,[r5,#0xb]          ;3710
0000aa  2001              MOVS     r0,#1                 ;3711
0000ac  9913              LDR      r1,[sp,#0x4c]         ;3711
0000ae  7108              STRB     r0,[r1,#4]            ;3711
0000b0  990c              LDR      r1,[sp,#0x30]         ;3712
0000b2  9815              LDR      r0,[sp,#0x54]         ;3712
0000b4  4288              CMP      r0,r1                 ;3712
0000b6  d031              BEQ      |L32.284|
0000b8  7ae8              LDRB     r0,[r5,#0xb]          ;3712
0000ba  f0000010          AND      r0,r0,#0x10           ;3712
0000be  b368              CBZ      r0,|L32.284|
0000c0  4629              MOV      r1,r5                 ;3713
0000c2  9813              LDR      r0,[sp,#0x4c]         ;3713
0000c4  f7fffffe          BL       ld_clust
0000c8  4680              MOV      r8,r0                 ;3713
0000ca  4641              MOV      r1,r8                 ;3713
0000cc  9813              LDR      r0,[sp,#0x4c]         ;3713
0000ce  f7fffffe          BL       clust2sect
0000d2  4606              MOV      r6,r0                 ;3713
0000d4  b90e              CBNZ     r6,|L32.218|
0000d6  2402              MOVS     r4,#2                 ;3715
0000d8  e020              B        |L32.284|
                  |L32.218|
0000da  4631              MOV      r1,r6                 ;3717
0000dc  9813              LDR      r0,[sp,#0x4c]         ;3717
0000de  f7fffffe          BL       move_window
0000e2  4604              MOV      r4,r0                 ;3717
0000e4  9813              LDR      r0,[sp,#0x4c]         ;3718
0000e6  f1000550          ADD      r5,r0,#0x50           ;3718
0000ea  b9bc              CBNZ     r4,|L32.284|
0000ec  7868              LDRB     r0,[r5,#1]            ;3719
0000ee  282e              CMP      r0,#0x2e              ;3719
0000f0  d114              BNE      |L32.284|
0000f2  9813              LDR      r0,[sp,#0x4c]         ;3720
0000f4  7800              LDRB     r0,[r0,#0]            ;3720
0000f6  2803              CMP      r0,#3                 ;3720
0000f8  d107              BNE      |L32.266|
0000fa  9913              LDR      r1,[sp,#0x4c]         ;3720
0000fc  980c              LDR      r0,[sp,#0x30]         ;3720
0000fe  6a49              LDR      r1,[r1,#0x24]         ;3720
000100  4288              CMP      r0,r1                 ;3720
000102  d102              BNE      |L32.266|
000104  2000              MOVS     r0,#0                 ;3720
000106  e001              B        |L32.268|
                  |L32.264|
000108  e015              B        |L32.310|
                  |L32.266|
00010a  980c              LDR      r0,[sp,#0x30]         ;3720
                  |L32.268|
00010c  4606              MOV      r6,r0                 ;3720
00010e  4631              MOV      r1,r6                 ;3721
000110  4628              MOV      r0,r5                 ;3721
000112  f7fffffe          BL       st_clust
000116  2001              MOVS     r0,#1                 ;3722
000118  9913              LDR      r1,[sp,#0x4c]         ;3722
00011a  7108              STRB     r0,[r1,#4]            ;3722
                  |L32.284|
00011c  b944              CBNZ     r4,|L32.304|
00011e  a813              ADD      r0,sp,#0x4c           ;3727
000120  f7fffffe          BL       dir_remove
000124  4604              MOV      r4,r0                 ;3727
000126  b91c              CBNZ     r4,|L32.304|
000128  9813              LDR      r0,[sp,#0x4c]         ;3729
00012a  f7fffffe          BL       sync_fs
00012e  4604              MOV      r4,r0                 ;3729
                  |L32.304|
000130  4638              MOV      r0,r7                 ;3736
000132  f7fffffe          BL       ff_memfree
                  |L32.310|
000136  4620              MOV      r0,r4                 ;3739
000138  e776              B        |L32.40|
;;;3741   
                          ENDP


                          AREA ||i.f_setlabel||, CODE, READONLY, ALIGN=2

                  f_setlabel PROC
;;;3818   
;;;3819   FRESULT f_setlabel (
000000  e92d4ff1          PUSH     {r0,r4-r11,lr}
;;;3820   	const TCHAR* label	/* Pointer to the volume label to set */
;;;3821   )
;;;3822   {
000004  b08c              SUB      sp,sp,#0x30
;;;3823   	FRESULT res;
;;;3824   	DIR dj;
;;;3825   	BYTE vn[11];
;;;3826   	UINT i, j, sl;
;;;3827   	WCHAR w;
;;;3828   	DWORD tm;
;;;3829   
;;;3830   
;;;3831   	/* Get logical drive number */
;;;3832   	res = find_volume(&dj.fs, &label, 1);
000006  2201              MOVS     r2,#1
000008  a90c              ADD      r1,sp,#0x30
00000a  a803              ADD      r0,sp,#0xc
00000c  f7fffffe          BL       find_volume
000010  4681              MOV      r9,r0
;;;3833   	if (res) LEAVE_FF(dj.fs, res);
000012  f1b90f00          CMP      r9,#0
000016  d003              BEQ      |L33.32|
000018  4648              MOV      r0,r9
                  |L33.26|
;;;3834   
;;;3835   	/* Create a volume label in directory form */
;;;3836   	vn[0] = 0;
;;;3837   	for (sl = 0; label[sl]; sl++) ;				/* Get name length */
;;;3838   	for ( ; sl && label[sl-1] == ' '; sl--) ;	/* Remove trailing spaces */
;;;3839   	if (sl) {	/* Create volume label in directory form */
;;;3840   		i = j = 0;
;;;3841   		do {
;;;3842   #if _USE_LFN && _LFN_UNICODE
;;;3843   			w = ff_convert(ff_wtoupper(label[i++]), 0);
;;;3844   #else
;;;3845   			w = (BYTE)label[i++];
;;;3846   			if (IsDBCS1(w))
;;;3847   				w = (j < 10 && i < sl && IsDBCS2(label[i])) ? w << 8 | (BYTE)label[i++] : 0;
;;;3848   #if _USE_LFN
;;;3849   			w = ff_convert(ff_wtoupper(ff_convert(w, 1)), 0);
;;;3850   #else
;;;3851   			if (IsLower(w)) w -= 0x20;			/* To upper ASCII characters */
;;;3852   #ifdef _EXCVT
;;;3853   			if (w >= 0x80) w = ExCvt[w - 0x80];	/* To upper extended characters (SBCS cfg) */
;;;3854   #else
;;;3855   			if (!_DF1S && w >= 0x80) w = 0;		/* Reject extended characters (ASCII cfg) */
;;;3856   #endif
;;;3857   #endif
;;;3858   #endif
;;;3859   			if (!w || chk_chr("\"*+,.:;<=>\?[]|\x7F", w) || j >= (UINT)((w >= 0x100) ? 10 : 11)) /* Reject invalid characters for volume label */
;;;3860   				LEAVE_FF(dj.fs, FR_INVALID_NAME);
;;;3861   			if (w >= 0x100) vn[j++] = (BYTE)(w >> 8);
;;;3862   			vn[j++] = (BYTE)w;
;;;3863   		} while (i < sl);
;;;3864   		while (j < 11) vn[j++] = ' ';
;;;3865   	}
;;;3866   
;;;3867   	/* Set volume label */
;;;3868   	dj.sclust = 0;					/* Open root directory */
;;;3869   	res = dir_sdi(&dj, 0);
;;;3870   	if (res == FR_OK) {
;;;3871   		res = dir_read(&dj, 1);		/* Get an entry with AM_VOL */
;;;3872   		if (res == FR_OK) {			/* A volume label is found */
;;;3873   			if (vn[0]) {
;;;3874   				mem_cpy(dj.dir, vn, 11);	/* Change the volume label name */
;;;3875   				tm = get_fattime();
;;;3876   				ST_DWORD(dj.dir+DIR_WrtTime, tm);
;;;3877   			} else {
;;;3878   				dj.dir[0] = DDE;			/* Remove the volume label */
;;;3879   			}
;;;3880   			dj.fs->wflag = 1;
;;;3881   			res = sync_fs(dj.fs);
;;;3882   		} else {					/* No volume label is found or error */
;;;3883   			if (res == FR_NO_FILE) {
;;;3884   				res = FR_OK;
;;;3885   				if (vn[0]) {				/* Create volume label as new */
;;;3886   					res = dir_alloc(&dj, 1);	/* Allocate an entry for volume label */
;;;3887   					if (res == FR_OK) {
;;;3888   						mem_set(dj.dir, 0, SZ_DIR);	/* Set volume label */
;;;3889   						mem_cpy(dj.dir, vn, 11);
;;;3890   						dj.dir[DIR_Attr] = AM_VOL;
;;;3891   						tm = get_fattime();
;;;3892   						ST_DWORD(dj.dir+DIR_WrtTime, tm);
;;;3893   						dj.fs->wflag = 1;
;;;3894   						res = sync_fs(dj.fs);
;;;3895   					}
;;;3896   				}
;;;3897   			}
;;;3898   		}
;;;3899   	}
;;;3900   
;;;3901   	LEAVE_FF(dj.fs, res);
;;;3902   }
00001a  b00d              ADD      sp,sp,#0x34
00001c  e8bd8ff0          POP      {r4-r11,pc}
                  |L33.32|
000020  2000              MOVS     r0,#0                 ;3836
000022  f88d0000          STRB     r0,[sp,#0]            ;3836
000026  2700              MOVS     r7,#0                 ;3837
000028  e000              B        |L33.44|
                  |L33.42|
00002a  1c7f              ADDS     r7,r7,#1              ;3837
                  |L33.44|
00002c  980c              LDR      r0,[sp,#0x30]         ;3837
00002e  5dc0              LDRB     r0,[r0,r7]            ;3837
000030  2800              CMP      r0,#0                 ;3837
000032  d1fa              BNE      |L33.42|
000034  e000              B        |L33.56|
                  |L33.54|
000036  1e7f              SUBS     r7,r7,#1              ;3838
                  |L33.56|
000038  b127              CBZ      r7,|L33.68|
00003a  1e78              SUBS     r0,r7,#1              ;3838
00003c  990c              LDR      r1,[sp,#0x30]         ;3838
00003e  5c08              LDRB     r0,[r1,r0]            ;3838
000040  2820              CMP      r0,#0x20              ;3838
000042  d0f8              BEQ      |L33.54|
                  |L33.68|
000044  2f00              CMP      r7,#0                 ;3839
000046  d05e              BEQ      |L33.262|
000048  2600              MOVS     r6,#0                 ;3840
00004a  46b0              MOV      r8,r6                 ;3840
00004c  bf00              NOP                            ;3841
                  |L33.78|
00004e  4630              MOV      r0,r6                 ;3845
000050  1c76              ADDS     r6,r6,#1              ;3845
000052  990c              LDR      r1,[sp,#0x30]         ;3845
000054  5c0c              LDRB     r4,[r1,r0]            ;3845
000056  2c81              CMP      r4,#0x81              ;3846
000058  db20              BLT      |L33.156|
00005a  b2e0              UXTB     r0,r4                 ;3846
00005c  28fe              CMP      r0,#0xfe              ;3846
00005e  dc1d              BGT      |L33.156|
000060  f1b80f0a          CMP      r8,#0xa               ;3847
000064  d218              BCS      |L33.152|
000066  42be              CMP      r6,r7                 ;3847
000068  d216              BCS      |L33.152|
00006a  980c              LDR      r0,[sp,#0x30]         ;3847
00006c  5d80              LDRB     r0,[r0,r6]            ;3847
00006e  2840              CMP      r0,#0x40              ;3847
000070  db03              BLT      |L33.122|
000072  980c              LDR      r0,[sp,#0x30]         ;3847
000074  5d80              LDRB     r0,[r0,r6]            ;3847
000076  287e              CMP      r0,#0x7e              ;3847
000078  dd07              BLE      |L33.138|
                  |L33.122|
00007a  980c              LDR      r0,[sp,#0x30]         ;3847
00007c  5d80              LDRB     r0,[r0,r6]            ;3847
00007e  2880              CMP      r0,#0x80              ;3847
000080  db0a              BLT      |L33.152|
000082  980c              LDR      r0,[sp,#0x30]         ;3847
000084  5d80              LDRB     r0,[r0,r6]            ;3847
000086  28fe              CMP      r0,#0xfe              ;3847
000088  dc06              BGT      |L33.152|
                  |L33.138|
00008a  4630              MOV      r0,r6                 ;3847
00008c  1c76              ADDS     r6,r6,#1              ;3847
00008e  990c              LDR      r1,[sp,#0x30]         ;3847
000090  5c08              LDRB     r0,[r1,r0]            ;3847
000092  ea402004          ORR      r0,r0,r4,LSL #8       ;3847
000096  e000              B        |L33.154|
                  |L33.152|
000098  2000              MOVS     r0,#0                 ;3847
                  |L33.154|
00009a  b284              UXTH     r4,r0                 ;3847
                  |L33.156|
00009c  2101              MOVS     r1,#1                 ;3849
00009e  4620              MOV      r0,r4                 ;3849
0000a0  f7fffffe          BL       ff_convert
0000a4  4683              MOV      r11,r0                ;3849
0000a6  f7fffffe          BL       ff_wtoupper
0000aa  4682              MOV      r10,r0                ;3849
0000ac  2100              MOVS     r1,#0                 ;3849
0000ae  f7fffffe          BL       ff_convert
0000b2  4604              MOV      r4,r0                 ;3849
0000b4  b15c              CBZ      r4,|L33.206|
0000b6  4621              MOV      r1,r4                 ;3859
0000b8  a047              ADR      r0,|L33.472|
0000ba  f7fffffe          BL       chk_chr
0000be  b930              CBNZ     r0,|L33.206|
0000c0  2cff              CMP      r4,#0xff              ;3859
0000c2  dd01              BLE      |L33.200|
0000c4  200a              MOVS     r0,#0xa               ;3859
0000c6  e000              B        |L33.202|
                  |L33.200|
0000c8  200b              MOVS     r0,#0xb               ;3859
                  |L33.202|
0000ca  4540              CMP      r0,r8                 ;3859
0000cc  d801              BHI      |L33.210|
                  |L33.206|
0000ce  2006              MOVS     r0,#6                 ;3860
0000d0  e7a3              B        |L33.26|
                  |L33.210|
0000d2  2cff              CMP      r4,#0xff              ;3861
0000d4  dd05              BLE      |L33.226|
0000d6  1222              ASRS     r2,r4,#8              ;3861
0000d8  4640              MOV      r0,r8                 ;3861
0000da  f1080801          ADD      r8,r8,#1              ;3861
0000de  f80d2000          STRB     r2,[sp,r0]            ;3861
                  |L33.226|
0000e2  b2e2              UXTB     r2,r4                 ;3862
0000e4  4640              MOV      r0,r8                 ;3862
0000e6  f1080801          ADD      r8,r8,#1              ;3862
0000ea  f80d2000          STRB     r2,[sp,r0]            ;3862
0000ee  42be              CMP      r6,r7                 ;3863
0000f0  d3ad              BCC      |L33.78|
0000f2  e005              B        |L33.256|
                  |L33.244|
0000f4  2220              MOVS     r2,#0x20              ;3864
0000f6  4640              MOV      r0,r8                 ;3864
0000f8  f1080801          ADD      r8,r8,#1              ;3864
0000fc  f80d2000          STRB     r2,[sp,r0]            ;3864
                  |L33.256|
000100  f1b80f0b          CMP      r8,#0xb               ;3864
000104  d3f6              BCC      |L33.244|
                  |L33.262|
000106  2000              MOVS     r0,#0                 ;3868
000108  9005              STR      r0,[sp,#0x14]         ;3868
00010a  2100              MOVS     r1,#0                 ;3869
00010c  a803              ADD      r0,sp,#0xc            ;3869
00010e  f7fffffe          BL       dir_sdi
000112  4681              MOV      r9,r0                 ;3869
000114  f1b90f00          CMP      r9,#0                 ;3870
000118  d15b              BNE      |L33.466|
00011a  2101              MOVS     r1,#1                 ;3871
00011c  a803              ADD      r0,sp,#0xc            ;3871
00011e  f7fffffe          BL       dir_read
000122  4681              MOV      r9,r0                 ;3871
000124  f1b90f00          CMP      r9,#0                 ;3872
000128  d121              BNE      |L33.366|
00012a  f89d0000          LDRB     r0,[sp,#0]            ;3873
00012e  b198              CBZ      r0,|L33.344|
000130  220b              MOVS     r2,#0xb               ;3874
000132  4669              MOV      r1,sp                 ;3874
000134  9808              LDR      r0,[sp,#0x20]         ;3874
000136  f7fffffe          BL       mem_cpy
00013a  f7fffffe          BL       get_fattime
00013e  4605              MOV      r5,r0                 ;3875
000140  9908              LDR      r1,[sp,#0x20]         ;3876
000142  758d              STRB     r5,[r1,#0x16]         ;3876
000144  0a29              LSRS     r1,r5,#8              ;3876
000146  9808              LDR      r0,[sp,#0x20]         ;3876
000148  75c1              STRB     r1,[r0,#0x17]         ;3876
00014a  0c29              LSRS     r1,r5,#16             ;3876
00014c  9808              LDR      r0,[sp,#0x20]         ;3876
00014e  7601              STRB     r1,[r0,#0x18]         ;3876
000150  0e29              LSRS     r1,r5,#24             ;3876
000152  9808              LDR      r0,[sp,#0x20]         ;3876
000154  7641              STRB     r1,[r0,#0x19]         ;3876
000156  e002              B        |L33.350|
                  |L33.344|
000158  20e5              MOVS     r0,#0xe5              ;3878
00015a  9908              LDR      r1,[sp,#0x20]         ;3878
00015c  7008              STRB     r0,[r1,#0]            ;3878
                  |L33.350|
00015e  2001              MOVS     r0,#1                 ;3880
000160  9903              LDR      r1,[sp,#0xc]          ;3880
000162  7108              STRB     r0,[r1,#4]            ;3880
000164  9803              LDR      r0,[sp,#0xc]          ;3881
000166  f7fffffe          BL       sync_fs
00016a  4681              MOV      r9,r0                 ;3881
00016c  e031              B        |L33.466|
                  |L33.366|
00016e  f1b90f04          CMP      r9,#4                 ;3883
000172  d12e              BNE      |L33.466|
000174  f04f0900          MOV      r9,#0                 ;3884
000178  f89d0000          LDRB     r0,[sp,#0]            ;3885
00017c  b348              CBZ      r0,|L33.466|
00017e  2101              MOVS     r1,#1                 ;3886
000180  a803              ADD      r0,sp,#0xc            ;3886
000182  f7fffffe          BL       dir_alloc
000186  4681              MOV      r9,r0                 ;3886
000188  f1b90f00          CMP      r9,#0                 ;3887
00018c  d121              BNE      |L33.466|
00018e  2220              MOVS     r2,#0x20              ;3888
000190  2100              MOVS     r1,#0                 ;3888
000192  9808              LDR      r0,[sp,#0x20]         ;3888
000194  f7fffffe          BL       mem_set
000198  220b              MOVS     r2,#0xb               ;3889
00019a  4669              MOV      r1,sp                 ;3889
00019c  9808              LDR      r0,[sp,#0x20]         ;3889
00019e  f7fffffe          BL       mem_cpy
0001a2  2008              MOVS     r0,#8                 ;3890
0001a4  9908              LDR      r1,[sp,#0x20]         ;3890
0001a6  72c8              STRB     r0,[r1,#0xb]          ;3890
0001a8  f7fffffe          BL       get_fattime
0001ac  4605              MOV      r5,r0                 ;3891
0001ae  9908              LDR      r1,[sp,#0x20]         ;3892
0001b0  758d              STRB     r5,[r1,#0x16]         ;3892
0001b2  0a29              LSRS     r1,r5,#8              ;3892
0001b4  9808              LDR      r0,[sp,#0x20]         ;3892
0001b6  75c1              STRB     r1,[r0,#0x17]         ;3892
0001b8  0c29              LSRS     r1,r5,#16             ;3892
0001ba  9808              LDR      r0,[sp,#0x20]         ;3892
0001bc  7601              STRB     r1,[r0,#0x18]         ;3892
0001be  0e29              LSRS     r1,r5,#24             ;3892
0001c0  9808              LDR      r0,[sp,#0x20]         ;3892
0001c2  7641              STRB     r1,[r0,#0x19]         ;3892
0001c4  2001              MOVS     r0,#1                 ;3893
0001c6  9903              LDR      r1,[sp,#0xc]          ;3893
0001c8  7108              STRB     r0,[r1,#4]            ;3893
0001ca  9803              LDR      r0,[sp,#0xc]          ;3894
0001cc  f7fffffe          BL       sync_fs
0001d0  4681              MOV      r9,r0                 ;3894
                  |L33.466|
0001d2  4648              MOV      r0,r9                 ;3901
0001d4  e721              B        |L33.26|
;;;3903   
                          ENDP

0001d6  0000              DCW      0x0000
                  |L33.472|
0001d8  222a2b2c          DCB      """*+,.:;<=>?[]|",127,0
0001dc  2e3a3b3c
0001e0  3d3e3f5b
0001e4  5d7c7f00

                          AREA ||i.f_stat||, CODE, READONLY, ALIGN=1

                  f_stat PROC
;;;3282   
;;;3283   FRESULT f_stat (
000000  b573              PUSH     {r0,r1,r4-r6,lr}
;;;3284   	const TCHAR* path,	/* Pointer to the file path */
;;;3285   	FILINFO* fno		/* Pointer to file information to return */
;;;3286   )
;;;3287   {
000002  b08c              SUB      sp,sp,#0x30
000004  460e              MOV      r6,r1
;;;3288   	FRESULT res;
;;;3289   	DIR dj;
;;;3290   	DEF_NAMEBUF;
;;;3291   
;;;3292   
;;;3293   	/* Get logical drive number */
;;;3294   	res = find_volume(&dj.fs, &path, 0);
000006  2200              MOVS     r2,#0
000008  a90c              ADD      r1,sp,#0x30
00000a  a803              ADD      r0,sp,#0xc
00000c  f7fffffe          BL       find_volume
000010  4605              MOV      r5,r0
;;;3295   	if (res == FR_OK) {
000012  b9ed              CBNZ     r5,|L34.80|
;;;3296   		INIT_BUF(dj);
000014  f44f7000          MOV      r0,#0x200
000018  f7fffffe          BL       ff_memalloc
00001c  4604              MOV      r4,r0
00001e  b914              CBNZ     r4,|L34.38|
000020  2011              MOVS     r0,#0x11
                  |L34.34|
;;;3297   		res = follow_path(&dj, path);	/* Follow the file path */
;;;3298   		if (res == FR_OK) {				/* Follow completed */
;;;3299   			if (dj.dir) {		/* Found an object */
;;;3300   				if (fno) get_fileinfo(&dj, fno);
;;;3301   			} else {			/* It is root directory */
;;;3302   				res = FR_INVALID_NAME;
;;;3303   			}
;;;3304   		}
;;;3305   		FREE_BUF();
;;;3306   	}
;;;3307   
;;;3308   	LEAVE_FF(dj.fs, res);
;;;3309   }
000022  b00e              ADD      sp,sp,#0x38
000024  bd70              POP      {r4-r6,pc}
                  |L34.38|
000026  940a              STR      r4,[sp,#0x28]         ;3296
000028  f8cdd024          STR      sp,[sp,#0x24]         ;3296
00002c  a803              ADD      r0,sp,#0xc            ;3297
00002e  990c              LDR      r1,[sp,#0x30]         ;3297
000030  f7fffffe          BL       follow_path
000034  4605              MOV      r5,r0                 ;3297
000036  b945              CBNZ     r5,|L34.74|
000038  9808              LDR      r0,[sp,#0x20]         ;3299
00003a  b128              CBZ      r0,|L34.72|
00003c  b12e              CBZ      r6,|L34.74|
00003e  4631              MOV      r1,r6                 ;3300
000040  a803              ADD      r0,sp,#0xc            ;3300
000042  f7fffffe          BL       get_fileinfo
000046  e000              B        |L34.74|
                  |L34.72|
000048  2506              MOVS     r5,#6                 ;3302
                  |L34.74|
00004a  4620              MOV      r0,r4                 ;3305
00004c  f7fffffe          BL       ff_memfree
                  |L34.80|
000050  4628              MOV      r0,r5                 ;3308
000052  e7e6              B        |L34.34|
;;;3310   
                          ENDP


                          AREA ||i.f_sync||, CODE, READONLY, ALIGN=1

                  f_sync PROC
;;;2771   
;;;2772   FRESULT f_sync (
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;2773   	FIL* fp		/* Pointer to the file object */
;;;2774   )
;;;2775   {
000004  4604              MOV      r4,r0
;;;2776   	FRESULT res;
;;;2777   	DWORD tm;
;;;2778   	BYTE *dir;
;;;2779   
;;;2780   
;;;2781   	res = validate(fp);					/* Check validity of the object */
000006  4620              MOV      r0,r4
000008  f7fffffe          BL       validate
00000c  4607              MOV      r7,r0
;;;2782   	if (res == FR_OK) {
00000e  2f00              CMP      r7,#0
000010  d14c              BNE      |L35.172|
;;;2783   		if (fp->flag & FA__WRITTEN) {	/* Has the file been written? */
000012  79a0              LDRB     r0,[r4,#6]
000014  f0000020          AND      r0,r0,#0x20
000018  2800              CMP      r0,#0
00001a  d047              BEQ      |L35.172|
;;;2784   			/* Write-back dirty buffer */
;;;2785   #if !_FS_TINY
;;;2786   			if (fp->flag & FA__DIRTY) {
00001c  79a0              LDRB     r0,[r4,#6]
00001e  f0000040          AND      r0,r0,#0x40
000022  b178              CBZ      r0,|L35.68|
;;;2787   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
000024  6821              LDR      r1,[r4,#0]
000026  7848              LDRB     r0,[r1,#1]
000028  2301              MOVS     r3,#1
00002a  f1040128          ADD      r1,r4,#0x28
00002e  69a2              LDR      r2,[r4,#0x18]
000030  f7fffffe          BL       disk_write
000034  b110              CBZ      r0,|L35.60|
;;;2788   					LEAVE_FF(fp->fs, FR_DISK_ERR);
000036  2001              MOVS     r0,#1
                  |L35.56|
;;;2789   				fp->flag &= ~FA__DIRTY;
;;;2790   			}
;;;2791   #endif
;;;2792   			/* Update the directory entry */
;;;2793   			res = move_window(fp->fs, fp->dir_sect);
;;;2794   			if (res == FR_OK) {
;;;2795   				dir = fp->dir_ptr;
;;;2796   				dir[DIR_Attr] |= AM_ARC;					/* Set archive bit */
;;;2797   				ST_DWORD(dir+DIR_FileSize, fp->fsize);		/* Update file size */
;;;2798   				st_clust(dir, fp->sclust);					/* Update start cluster */
;;;2799   				tm = get_fattime();							/* Update updated time */
;;;2800   				ST_DWORD(dir+DIR_WrtTime, tm);
;;;2801   				ST_WORD(dir+DIR_LstAccDate, 0);
;;;2802   				fp->flag &= ~FA__WRITTEN;
;;;2803   				fp->fs->wflag = 1;
;;;2804   				res = sync_fs(fp->fs);
;;;2805   			}
;;;2806   		}
;;;2807   	}
;;;2808   
;;;2809   	LEAVE_FF(fp->fs, res);
;;;2810   }
000038  e8bd81f0          POP      {r4-r8,pc}
                  |L35.60|
00003c  79a0              LDRB     r0,[r4,#6]            ;2789
00003e  f0200040          BIC      r0,r0,#0x40           ;2789
000042  71a0              STRB     r0,[r4,#6]            ;2789
                  |L35.68|
000044  69e1              LDR      r1,[r4,#0x1c]         ;2793
000046  6820              LDR      r0,[r4,#0]            ;2793
000048  f7fffffe          BL       move_window
00004c  4607              MOV      r7,r0                 ;2793
00004e  2f00              CMP      r7,#0                 ;2794
000050  d12c              BNE      |L35.172|
000052  6a25              LDR      r5,[r4,#0x20]         ;2795
000054  7ae8              LDRB     r0,[r5,#0xb]          ;2796
000056  f0400020          ORR      r0,r0,#0x20           ;2796
00005a  72e8              STRB     r0,[r5,#0xb]          ;2796
00005c  7b20              LDRB     r0,[r4,#0xc]          ;2797
00005e  7728              STRB     r0,[r5,#0x1c]         ;2797
000060  89a0              LDRH     r0,[r4,#0xc]          ;2797
000062  0a01              LSRS     r1,r0,#8              ;2797
000064  7769              STRB     r1,[r5,#0x1d]         ;2797
000066  68e0              LDR      r0,[r4,#0xc]          ;2797
000068  0c01              LSRS     r1,r0,#16             ;2797
00006a  77a9              STRB     r1,[r5,#0x1e]         ;2797
00006c  68e0              LDR      r0,[r4,#0xc]          ;2797
00006e  0e01              LSRS     r1,r0,#24             ;2797
000070  77e9              STRB     r1,[r5,#0x1f]         ;2797
000072  4628              MOV      r0,r5                 ;2798
000074  6921              LDR      r1,[r4,#0x10]         ;2798
000076  f7fffffe          BL       st_clust
00007a  f7fffffe          BL       get_fattime
00007e  4606              MOV      r6,r0                 ;2799
000080  75ae              STRB     r6,[r5,#0x16]         ;2800
000082  0a31              LSRS     r1,r6,#8              ;2800
000084  75e9              STRB     r1,[r5,#0x17]         ;2800
000086  0c31              LSRS     r1,r6,#16             ;2800
000088  7629              STRB     r1,[r5,#0x18]         ;2800
00008a  0e31              LSRS     r1,r6,#24             ;2800
00008c  7669              STRB     r1,[r5,#0x19]         ;2800
00008e  2000              MOVS     r0,#0                 ;2801
000090  74a8              STRB     r0,[r5,#0x12]         ;2801
000092  2100              MOVS     r1,#0                 ;2801
000094  74e9              STRB     r1,[r5,#0x13]         ;2801
000096  79a0              LDRB     r0,[r4,#6]            ;2802
000098  f0200020          BIC      r0,r0,#0x20           ;2802
00009c  71a0              STRB     r0,[r4,#6]            ;2802
00009e  2001              MOVS     r0,#1                 ;2803
0000a0  6821              LDR      r1,[r4,#0]            ;2803
0000a2  7108              STRB     r0,[r1,#4]            ;2803
0000a4  6820              LDR      r0,[r4,#0]            ;2804
0000a6  f7fffffe          BL       sync_fs
0000aa  4607              MOV      r7,r0                 ;2804
                  |L35.172|
0000ac  4638              MOV      r0,r7                 ;2809
0000ae  e7c3              B        |L35.56|
;;;2811   
                          ENDP


                          AREA ||i.f_truncate||, CODE, READONLY, ALIGN=1

                  f_truncate PROC
;;;3384   
;;;3385   FRESULT f_truncate (
000000  b570              PUSH     {r4-r6,lr}
;;;3386   	FIL* fp		/* Pointer to the file object */
;;;3387   )
;;;3388   {
000002  4604              MOV      r4,r0
;;;3389   	FRESULT res;
;;;3390   	DWORD ncl;
;;;3391   
;;;3392   
;;;3393   	res = validate(fp);						/* Check validity of the object */
000004  4620              MOV      r0,r4
000006  f7fffffe          BL       validate
00000a  4605              MOV      r5,r0
;;;3394   	if (res == FR_OK) {
00000c  b945              CBNZ     r5,|L36.32|
;;;3395   		if (fp->err) {						/* Check error */
00000e  79e0              LDRB     r0,[r4,#7]
000010  b108              CBZ      r0,|L36.22|
;;;3396   			res = (FRESULT)fp->err;
000012  79e5              LDRB     r5,[r4,#7]
000014  e004              B        |L36.32|
                  |L36.22|
;;;3397   		} else {
;;;3398   			if (!(fp->flag & FA_WRITE))		/* Check access mode */
000016  79a0              LDRB     r0,[r4,#6]
000018  f0000002          AND      r0,r0,#2
00001c  b900              CBNZ     r0,|L36.32|
;;;3399   				res = FR_DENIED;
00001e  2507              MOVS     r5,#7
                  |L36.32|
;;;3400   		}
;;;3401   	}
;;;3402   	if (res == FR_OK) {
000020  2d00              CMP      r5,#0
000022  d147              BNE      |L36.180|
;;;3403   		if (fp->fsize > fp->fptr) {
000024  e9d41002          LDRD     r1,r0,[r4,#8]
000028  4288              CMP      r0,r1
00002a  d941              BLS      |L36.176|
;;;3404   			fp->fsize = fp->fptr;	/* Set file size to current R/W point */
00002c  68a0              LDR      r0,[r4,#8]
00002e  60e0              STR      r0,[r4,#0xc]
;;;3405   			fp->flag |= FA__WRITTEN;
000030  79a0              LDRB     r0,[r4,#6]
000032  f0400020          ORR      r0,r0,#0x20
000036  71a0              STRB     r0,[r4,#6]
;;;3406   			if (fp->fptr == 0) {	/* When set file size to zero, remove entire cluster chain */
000038  68a0              LDR      r0,[r4,#8]
00003a  b938              CBNZ     r0,|L36.76|
;;;3407   				res = remove_chain(fp->fs, fp->sclust);
00003c  6921              LDR      r1,[r4,#0x10]
00003e  6820              LDR      r0,[r4,#0]
000040  f7fffffe          BL       remove_chain
000044  4605              MOV      r5,r0
;;;3408   				fp->sclust = 0;
000046  2000              MOVS     r0,#0
000048  6120              STR      r0,[r4,#0x10]
00004a  e01d              B        |L36.136|
                  |L36.76|
;;;3409   			} else {				/* When truncate a part of the file, remove remaining clusters */
;;;3410   				ncl = get_fat(fp->fs, fp->clust);
00004c  6961              LDR      r1,[r4,#0x14]
00004e  6820              LDR      r0,[r4,#0]
000050  f7fffffe          BL       get_fat
000054  4606              MOV      r6,r0
;;;3411   				res = FR_OK;
000056  2500              MOVS     r5,#0
;;;3412   				if (ncl == 0xFFFFFFFF) res = FR_DISK_ERR;
000058  1c70              ADDS     r0,r6,#1
00005a  b900              CBNZ     r0,|L36.94|
00005c  2501              MOVS     r5,#1
                  |L36.94|
;;;3413   				if (ncl == 1) res = FR_INT_ERR;
00005e  2e01              CMP      r6,#1
000060  d100              BNE      |L36.100|
000062  2502              MOVS     r5,#2
                  |L36.100|
;;;3414   				if (res == FR_OK && ncl < fp->fs->n_fatent) {
000064  b985              CBNZ     r5,|L36.136|
000066  6820              LDR      r0,[r4,#0]
000068  6940              LDR      r0,[r0,#0x14]
00006a  42b0              CMP      r0,r6
00006c  d90c              BLS      |L36.136|
;;;3415   					res = put_fat(fp->fs, fp->clust, 0x0FFFFFFF);
00006e  f06f4270          MVN      r2,#0xf0000000
000072  6961              LDR      r1,[r4,#0x14]
000074  6820              LDR      r0,[r4,#0]
000076  f7fffffe          BL       put_fat
00007a  4605              MOV      r5,r0
;;;3416   					if (res == FR_OK) res = remove_chain(fp->fs, ncl);
00007c  b925              CBNZ     r5,|L36.136|
00007e  4631              MOV      r1,r6
000080  6820              LDR      r0,[r4,#0]
000082  f7fffffe          BL       remove_chain
000086  4605              MOV      r5,r0
                  |L36.136|
;;;3417   				}
;;;3418   			}
;;;3419   #if !_FS_TINY
;;;3420   			if (res == FR_OK && (fp->flag & FA__DIRTY)) {
000088  b995              CBNZ     r5,|L36.176|
00008a  79a0              LDRB     r0,[r4,#6]
00008c  f0000040          AND      r0,r0,#0x40
000090  b170              CBZ      r0,|L36.176|
;;;3421   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
000092  6821              LDR      r1,[r4,#0]
000094  7848              LDRB     r0,[r1,#1]
000096  2301              MOVS     r3,#1
000098  f1040128          ADD      r1,r4,#0x28
00009c  69a2              LDR      r2,[r4,#0x18]
00009e  f7fffffe          BL       disk_write
0000a2  b108              CBZ      r0,|L36.168|
;;;3422   					res = FR_DISK_ERR;
0000a4  2501              MOVS     r5,#1
0000a6  e003              B        |L36.176|
                  |L36.168|
;;;3423   				else
;;;3424   					fp->flag &= ~FA__DIRTY;
0000a8  79a0              LDRB     r0,[r4,#6]
0000aa  f0200040          BIC      r0,r0,#0x40
0000ae  71a0              STRB     r0,[r4,#6]
                  |L36.176|
;;;3425   			}
;;;3426   #endif
;;;3427   		}
;;;3428   		if (res != FR_OK) fp->err = (FRESULT)res;
0000b0  b105              CBZ      r5,|L36.180|
0000b2  71e5              STRB     r5,[r4,#7]
                  |L36.180|
;;;3429   	}
;;;3430   
;;;3431   	LEAVE_FF(fp->fs, res);
0000b4  4628              MOV      r0,r5
;;;3432   }
0000b6  bd70              POP      {r4-r6,pc}
;;;3433   
                          ENDP


                          AREA ||i.f_unlink||, CODE, READONLY, ALIGN=1

                  f_unlink PROC
;;;3440   
;;;3441   FRESULT f_unlink (
000000  b5f1              PUSH     {r0,r4-r7,lr}
;;;3442   	const TCHAR* path		/* Pointer to the file or directory path */
;;;3443   )
;;;3444   {
000002  b096              SUB      sp,sp,#0x58
;;;3445   	FRESULT res;
;;;3446   	DIR dj, sdj;
;;;3447   	BYTE *dir;
;;;3448   	DWORD dclst;
;;;3449   	DEF_NAMEBUF;
;;;3450   
;;;3451   
;;;3452   	/* Get logical drive number */
;;;3453   	res = find_volume(&dj.fs, &path, 1);
000004  2201              MOVS     r2,#1
000006  a916              ADD      r1,sp,#0x58
000008  a80d              ADD      r0,sp,#0x34
00000a  f7fffffe          BL       find_volume
00000e  4604              MOV      r4,r0
;;;3454   	if (res == FR_OK) {
000010  2c00              CMP      r4,#0
000012  d154              BNE      |L37.190|
;;;3455   		INIT_BUF(dj);
000014  f44f7000          MOV      r0,#0x200
000018  f7fffffe          BL       ff_memalloc
00001c  4607              MOV      r7,r0
00001e  b917              CBNZ     r7,|L37.38|
000020  2011              MOVS     r0,#0x11
                  |L37.34|
;;;3456   		res = follow_path(&dj, path);		/* Follow the file path */
;;;3457   		if (_FS_RPATH && res == FR_OK && (dj.fn[NS] & NS_DOT))
;;;3458   			res = FR_INVALID_NAME;			/* Cannot remove dot entry */
;;;3459   #if _FS_LOCK
;;;3460   		if (res == FR_OK) res = chk_lock(&dj, 2);	/* Cannot remove open file */
;;;3461   #endif
;;;3462   		if (res == FR_OK) {					/* The object is accessible */
;;;3463   			dir = dj.dir;
;;;3464   			if (!dir) {
;;;3465   				res = FR_INVALID_NAME;		/* Cannot remove the start directory */
;;;3466   			} else {
;;;3467   				if (dir[DIR_Attr] & AM_RDO)
;;;3468   					res = FR_DENIED;		/* Cannot remove R/O object */
;;;3469   			}
;;;3470   			dclst = ld_clust(dj.fs, dir);
;;;3471   			if (res == FR_OK && (dir[DIR_Attr] & AM_DIR)) {	/* Is it a sub-dir? */
;;;3472   				if (dclst < 2) {
;;;3473   					res = FR_INT_ERR;
;;;3474   				} else {
;;;3475   					mem_cpy(&sdj, &dj, sizeof (DIR));	/* Check if the sub-directory is empty or not */
;;;3476   					sdj.sclust = dclst;
;;;3477   					res = dir_sdi(&sdj, 2);		/* Exclude dot entries */
;;;3478   					if (res == FR_OK) {
;;;3479   						res = dir_read(&sdj, 0);	/* Read an item */
;;;3480   						if (res == FR_OK		/* Not empty directory */
;;;3481   #if _FS_RPATH
;;;3482   						|| dclst == dj.fs->cdir	/* Current directory */
;;;3483   #endif
;;;3484   						) res = FR_DENIED;
;;;3485   						if (res == FR_NO_FILE) res = FR_OK;	/* Empty */
;;;3486   					}
;;;3487   				}
;;;3488   			}
;;;3489   			if (res == FR_OK) {
;;;3490   				res = dir_remove(&dj);		/* Remove the directory entry */
;;;3491   				if (res == FR_OK) {
;;;3492   					if (dclst)				/* Remove the cluster chain if exist */
;;;3493   						res = remove_chain(dj.fs, dclst);
;;;3494   					if (res == FR_OK) res = sync_fs(dj.fs);
;;;3495   				}
;;;3496   			}
;;;3497   		}
;;;3498   		FREE_BUF();
;;;3499   	}
;;;3500   
;;;3501   	LEAVE_FF(dj.fs, res);
;;;3502   }
000022  b017              ADD      sp,sp,#0x5c
000024  bdf0              POP      {r4-r7,pc}
                  |L37.38|
000026  9714              STR      r7,[sp,#0x50]         ;3455
000028  a801              ADD      r0,sp,#4              ;3455
00002a  9013              STR      r0,[sp,#0x4c]         ;3455
00002c  a80d              ADD      r0,sp,#0x34           ;3456
00002e  9916              LDR      r1,[sp,#0x58]         ;3456
000030  f7fffffe          BL       follow_path
000034  4604              MOV      r4,r0                 ;3456
000036  bf00              NOP                            ;3457
000038  2c00              CMP      r4,#0                 ;3462
00003a  d13d              BNE      |L37.184|
00003c  9e12              LDR      r6,[sp,#0x48]         ;3463
00003e  b90e              CBNZ     r6,|L37.68|
000040  2406              MOVS     r4,#6                 ;3465
000042  e004              B        |L37.78|
                  |L37.68|
000044  7af0              LDRB     r0,[r6,#0xb]          ;3467
000046  f0000001          AND      r0,r0,#1              ;3467
00004a  b100              CBZ      r0,|L37.78|
00004c  2407              MOVS     r4,#7                 ;3468
                  |L37.78|
00004e  4631              MOV      r1,r6                 ;3470
000050  980d              LDR      r0,[sp,#0x34]         ;3470
000052  f7fffffe          BL       ld_clust
000056  4605              MOV      r5,r0                 ;3470
000058  b9ec              CBNZ     r4,|L37.150|
00005a  7af0              LDRB     r0,[r6,#0xb]          ;3471
00005c  f0000010          AND      r0,r0,#0x10           ;3471
000060  b1c8              CBZ      r0,|L37.150|
000062  2d02              CMP      r5,#2                 ;3472
000064  d201              BCS      |L37.106|
000066  2402              MOVS     r4,#2                 ;3473
000068  e015              B        |L37.150|
                  |L37.106|
00006a  2224              MOVS     r2,#0x24              ;3475
00006c  a90d              ADD      r1,sp,#0x34           ;3475
00006e  a804              ADD      r0,sp,#0x10           ;3475
000070  f7fffffe          BL       mem_cpy
000074  9506              STR      r5,[sp,#0x18]         ;3476
000076  2102              MOVS     r1,#2                 ;3477
000078  a804              ADD      r0,sp,#0x10           ;3477
00007a  f7fffffe          BL       dir_sdi
00007e  4604              MOV      r4,r0                 ;3477
000080  b94c              CBNZ     r4,|L37.150|
000082  2100              MOVS     r1,#0                 ;3479
000084  a804              ADD      r0,sp,#0x10           ;3479
000086  f7fffffe          BL       dir_read
00008a  4604              MOV      r4,r0                 ;3479
00008c  b904              CBNZ     r4,|L37.144|
00008e  2407              MOVS     r4,#7                 ;3484
                  |L37.144|
000090  2c04              CMP      r4,#4                 ;3485
000092  d100              BNE      |L37.150|
000094  2400              MOVS     r4,#0                 ;3485
                  |L37.150|
000096  b97c              CBNZ     r4,|L37.184|
000098  a80d              ADD      r0,sp,#0x34           ;3490
00009a  f7fffffe          BL       dir_remove
00009e  4604              MOV      r4,r0                 ;3490
0000a0  b954              CBNZ     r4,|L37.184|
0000a2  b125              CBZ      r5,|L37.174|
0000a4  4629              MOV      r1,r5                 ;3493
0000a6  980d              LDR      r0,[sp,#0x34]         ;3493
0000a8  f7fffffe          BL       remove_chain
0000ac  4604              MOV      r4,r0                 ;3493
                  |L37.174|
0000ae  b91c              CBNZ     r4,|L37.184|
0000b0  980d              LDR      r0,[sp,#0x34]         ;3494
0000b2  f7fffffe          BL       sync_fs
0000b6  4604              MOV      r4,r0                 ;3494
                  |L37.184|
0000b8  4638              MOV      r0,r7                 ;3498
0000ba  f7fffffe          BL       ff_memfree
                  |L37.190|
0000be  4620              MOV      r0,r4                 ;3501
0000c0  e7af              B        |L37.34|
;;;3503   
                          ENDP


                          AREA ||i.f_utime||, CODE, READONLY, ALIGN=1

                  f_utime PROC
;;;3627   
;;;3628   FRESULT f_utime (
000000  b5f3              PUSH     {r0,r1,r4-r7,lr}
;;;3629   	const TCHAR* path,	/* Pointer to the file/directory name */
;;;3630   	const FILINFO* fno	/* Pointer to the time stamp to be set */
;;;3631   )
;;;3632   {
000002  b08d              SUB      sp,sp,#0x34
000004  460d              MOV      r5,r1
;;;3633   	FRESULT res;
;;;3634   	DIR dj;
;;;3635   	BYTE *dir;
;;;3636   	DEF_NAMEBUF;
;;;3637   
;;;3638   
;;;3639   	/* Get logical drive number */
;;;3640   	res = find_volume(&dj.fs, &path, 1);
000006  2201              MOVS     r2,#1
000008  a90d              ADD      r1,sp,#0x34
00000a  a804              ADD      r0,sp,#0x10
00000c  f7fffffe          BL       find_volume
000010  4607              MOV      r7,r0
;;;3641   	if (res == FR_OK) {
000012  bb57              CBNZ     r7,|L38.106|
;;;3642   		INIT_BUF(dj);
000014  f44f7000          MOV      r0,#0x200
000018  f7fffffe          BL       ff_memalloc
00001c  4606              MOV      r6,r0
00001e  b916              CBNZ     r6,|L38.38|
000020  2011              MOVS     r0,#0x11
                  |L38.34|
;;;3643   		res = follow_path(&dj, path);	/* Follow the file path */
;;;3644   		FREE_BUF();
;;;3645   		if (_FS_RPATH && res == FR_OK && (dj.fn[NS] & NS_DOT))
;;;3646   			res = FR_INVALID_NAME;
;;;3647   		if (res == FR_OK) {
;;;3648   			dir = dj.dir;
;;;3649   			if (!dir) {					/* Root directory */
;;;3650   				res = FR_INVALID_NAME;
;;;3651   			} else {					/* File or sub-directory */
;;;3652   				ST_WORD(dir+DIR_WrtTime, fno->ftime);
;;;3653   				ST_WORD(dir+DIR_WrtDate, fno->fdate);
;;;3654   				dj.fs->wflag = 1;
;;;3655   				res = sync_fs(dj.fs);
;;;3656   			}
;;;3657   		}
;;;3658   	}
;;;3659   
;;;3660   	LEAVE_FF(dj.fs, res);
;;;3661   }
000022  b00f              ADD      sp,sp,#0x3c
000024  bdf0              POP      {r4-r7,pc}
                  |L38.38|
000026  960b              STR      r6,[sp,#0x2c]         ;3642
000028  a801              ADD      r0,sp,#4              ;3642
00002a  900a              STR      r0,[sp,#0x28]         ;3642
00002c  a804              ADD      r0,sp,#0x10           ;3643
00002e  990d              LDR      r1,[sp,#0x34]         ;3643
000030  f7fffffe          BL       follow_path
000034  4607              MOV      r7,r0                 ;3643
000036  4630              MOV      r0,r6                 ;3644
000038  f7fffffe          BL       ff_memfree
00003c  bf00              NOP                            ;3645
00003e  b9a7              CBNZ     r7,|L38.106|
000040  9c09              LDR      r4,[sp,#0x24]         ;3648
000042  b90c              CBNZ     r4,|L38.72|
000044  2706              MOVS     r7,#6                 ;3650
000046  e010              B        |L38.106|
                  |L38.72|
000048  79a8              LDRB     r0,[r5,#6]            ;3652
00004a  75a0              STRB     r0,[r4,#0x16]         ;3652
00004c  88e8              LDRH     r0,[r5,#6]            ;3652
00004e  1201              ASRS     r1,r0,#8              ;3652
000050  75e1              STRB     r1,[r4,#0x17]         ;3652
000052  7928              LDRB     r0,[r5,#4]            ;3653
000054  7620              STRB     r0,[r4,#0x18]         ;3653
000056  88a8              LDRH     r0,[r5,#4]            ;3653
000058  1201              ASRS     r1,r0,#8              ;3653
00005a  7661              STRB     r1,[r4,#0x19]         ;3653
00005c  2001              MOVS     r0,#1                 ;3654
00005e  9904              LDR      r1,[sp,#0x10]         ;3654
000060  7108              STRB     r0,[r1,#4]            ;3654
000062  9804              LDR      r0,[sp,#0x10]         ;3655
000064  f7fffffe          BL       sync_fs
000068  4607              MOV      r7,r0                 ;3655
                  |L38.106|
00006a  4638              MOV      r0,r7                 ;3660
00006c  e7d9              B        |L38.34|
;;;3662   
                          ENDP


                          AREA ||i.f_write||, CODE, READONLY, ALIGN=1

                  f_write PROC
;;;2649   
;;;2650   FRESULT f_write (
000000  e92d4fff          PUSH     {r0-r11,lr}
;;;2651   	FIL* fp,			/* Pointer to the file object */
;;;2652   	const void *buff,	/* Pointer to the data to be written */
;;;2653   	UINT btw,			/* Number of bytes to write */
;;;2654   	UINT* bw			/* Pointer to number of bytes written */
;;;2655   )
;;;2656   {
000004  b083              SUB      sp,sp,#0xc
000006  4604              MOV      r4,r0
000008  4615              MOV      r5,r2
00000a  469b              MOV      r11,r3
;;;2657   	FRESULT res;
;;;2658   	DWORD clst, sect;
;;;2659   	UINT wcnt, cc;
;;;2660   	const BYTE *wbuff = (const BYTE*)buff;
00000c  9804              LDR      r0,[sp,#0x10]
00000e  9001              STR      r0,[sp,#4]
;;;2661   	BYTE csect;
;;;2662   
;;;2663   
;;;2664   	*bw = 0;	/* Clear write byte counter */
000010  2000              MOVS     r0,#0
000012  f8cb0000          STR      r0,[r11,#0]
;;;2665   
;;;2666   	res = validate(fp);						/* Check validity */
000016  4620              MOV      r0,r4
000018  f7fffffe          BL       validate
00001c  9002              STR      r0,[sp,#8]
;;;2667   	if (res != FR_OK) LEAVE_FF(fp->fs, res);
00001e  9802              LDR      r0,[sp,#8]
000020  b118              CBZ      r0,|L39.42|
000022  9802              LDR      r0,[sp,#8]
                  |L39.36|
;;;2668   	if (fp->err)							/* Check error */
;;;2669   		LEAVE_FF(fp->fs, (FRESULT)fp->err);
;;;2670   	if (!(fp->flag & FA_WRITE))				/* Check access mode */
;;;2671   		LEAVE_FF(fp->fs, FR_DENIED);
;;;2672   	if (fp->fptr + btw < fp->fptr) btw = 0;	/* File size cannot reach 4GB */
;;;2673   
;;;2674   	for ( ;  btw;							/* Repeat until all data written */
;;;2675   		wbuff += wcnt, fp->fptr += wcnt, *bw += wcnt, btw -= wcnt) {
;;;2676   		if ((fp->fptr % SS(fp->fs)) == 0) {	/* On the sector boundary? */
;;;2677   			csect = (BYTE)(fp->fptr / SS(fp->fs) & (fp->fs->csize - 1));	/* Sector offset in the cluster */
;;;2678   			if (!csect) {					/* On the cluster boundary? */
;;;2679   				if (fp->fptr == 0) {		/* On the top of the file? */
;;;2680   					clst = fp->sclust;		/* Follow from the origin */
;;;2681   					if (clst == 0)			/* When no cluster is allocated, */
;;;2682   						clst = create_chain(fp->fs, 0);	/* Create a new cluster chain */
;;;2683   				} else {					/* Middle or end of the file */
;;;2684   #if _USE_FASTSEEK
;;;2685   					if (fp->cltbl)
;;;2686   						clst = clmt_clust(fp, fp->fptr);	/* Get cluster# from the CLMT */
;;;2687   					else
;;;2688   #endif
;;;2689   						clst = create_chain(fp->fs, fp->clust);	/* Follow or stretch cluster chain on the FAT */
;;;2690   				}
;;;2691   				if (clst == 0) break;		/* Could not allocate a new cluster (disk full) */
;;;2692   				if (clst == 1) ABORT(fp->fs, FR_INT_ERR);
;;;2693   				if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;2694   				fp->clust = clst;			/* Update current cluster */
;;;2695   				if (fp->sclust == 0) fp->sclust = clst;	/* Set start cluster if the first write */
;;;2696   			}
;;;2697   #if _FS_TINY
;;;2698   			if (fp->fs->winsect == fp->dsect && sync_window(fp->fs))	/* Write-back sector cache */
;;;2699   				ABORT(fp->fs, FR_DISK_ERR);
;;;2700   #else
;;;2701   			if (fp->flag & FA__DIRTY) {		/* Write-back sector cache */
;;;2702   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1))
;;;2703   					ABORT(fp->fs, FR_DISK_ERR);
;;;2704   				fp->flag &= ~FA__DIRTY;
;;;2705   			}
;;;2706   #endif
;;;2707   			sect = clust2sect(fp->fs, fp->clust);	/* Get current sector */
;;;2708   			if (!sect) ABORT(fp->fs, FR_INT_ERR);
;;;2709   			sect += csect;
;;;2710   			cc = btw / SS(fp->fs);			/* When remaining bytes >= sector size, */
;;;2711   			if (cc) {						/* Write maximum contiguous sectors directly */
;;;2712   				if (csect + cc > fp->fs->csize)	/* Clip at cluster boundary */
;;;2713   					cc = fp->fs->csize - csect;
;;;2714   				if (disk_write(fp->fs->drv, wbuff, sect, cc))
;;;2715   					ABORT(fp->fs, FR_DISK_ERR);
;;;2716   #if _FS_MINIMIZE <= 2
;;;2717   #if _FS_TINY
;;;2718   				if (fp->fs->winsect - sect < cc) {	/* Refill sector cache if it gets invalidated by the direct write */
;;;2719   					mem_cpy(fp->fs->win, wbuff + ((fp->fs->winsect - sect) * SS(fp->fs)), SS(fp->fs));
;;;2720   					fp->fs->wflag = 0;
;;;2721   				}
;;;2722   #else
;;;2723   				if (fp->dsect - sect < cc) { /* Refill sector cache if it gets invalidated by the direct write */
;;;2724   					mem_cpy(fp->buf, wbuff + ((fp->dsect - sect) * SS(fp->fs)), SS(fp->fs));
;;;2725   					fp->flag &= ~FA__DIRTY;
;;;2726   				}
;;;2727   #endif
;;;2728   #endif
;;;2729   				wcnt = SS(fp->fs) * cc;		/* Number of bytes transferred */
;;;2730   				continue;
;;;2731   			}
;;;2732   #if _FS_TINY
;;;2733   			if (fp->fptr >= fp->fsize) {	/* Avoid silly cache filling at growing edge */
;;;2734   				if (sync_window(fp->fs)) ABORT(fp->fs, FR_DISK_ERR);
;;;2735   				fp->fs->winsect = sect;
;;;2736   			}
;;;2737   #else
;;;2738   			if (fp->dsect != sect) {		/* Fill sector cache with file data */
;;;2739   				if (fp->fptr < fp->fsize &&
;;;2740   					disk_read(fp->fs->drv, fp->buf, sect, 1))
;;;2741   						ABORT(fp->fs, FR_DISK_ERR);
;;;2742   			}
;;;2743   #endif
;;;2744   			fp->dsect = sect;
;;;2745   		}
;;;2746   		wcnt = SS(fp->fs) - ((UINT)fp->fptr % SS(fp->fs));/* Put partial sector into file I/O buffer */
;;;2747   		if (wcnt > btw) wcnt = btw;
;;;2748   #if _FS_TINY
;;;2749   		if (move_window(fp->fs, fp->dsect))	/* Move sector window */
;;;2750   			ABORT(fp->fs, FR_DISK_ERR);
;;;2751   		mem_cpy(&fp->fs->win[fp->fptr % SS(fp->fs)], wbuff, wcnt);	/* Fit partial sector */
;;;2752   		fp->fs->wflag = 1;
;;;2753   #else
;;;2754   		mem_cpy(&fp->buf[fp->fptr % SS(fp->fs)], wbuff, wcnt);	/* Fit partial sector */
;;;2755   		fp->flag |= FA__DIRTY;
;;;2756   #endif
;;;2757   	}
;;;2758   
;;;2759   	if (fp->fptr > fp->fsize) fp->fsize = fp->fptr;	/* Update file size if needed */
;;;2760   	fp->flag |= FA__WRITTEN;						/* Set file change flag */
;;;2761   
;;;2762   	LEAVE_FF(fp->fs, FR_OK);
;;;2763   }
000024  b007              ADD      sp,sp,#0x1c
000026  e8bd8ff0          POP      {r4-r11,pc}
                  |L39.42|
00002a  79e0              LDRB     r0,[r4,#7]            ;2668
00002c  b108              CBZ      r0,|L39.50|
00002e  79e0              LDRB     r0,[r4,#7]            ;2669
000030  e7f8              B        |L39.36|
                  |L39.50|
000032  79a0              LDRB     r0,[r4,#6]            ;2670
000034  f0000002          AND      r0,r0,#2              ;2670
000038  b908              CBNZ     r0,|L39.62|
00003a  2007              MOVS     r0,#7                 ;2671
00003c  e7f2              B        |L39.36|
                  |L39.62|
00003e  68a0              LDR      r0,[r4,#8]            ;2672
000040  4428              ADD      r0,r0,r5              ;2672
000042  68a1              LDR      r1,[r4,#8]            ;2672
000044  4288              CMP      r0,r1                 ;2672
000046  d200              BCS      |L39.74|
000048  2500              MOVS     r5,#0                 ;2672
                  |L39.74|
00004a  e0be              B        |L39.458|
                  |L39.76|
00004c  8920              LDRH     r0,[r4,#8]            ;2676
00004e  f3c00008          UBFX     r0,r0,#0,#9           ;2676
000052  2800              CMP      r0,#0                 ;2676
000054  d17d              BNE      |L39.338|
000056  6820              LDR      r0,[r4,#0]            ;2677
000058  7880              LDRB     r0,[r0,#2]            ;2677
00005a  1e40              SUBS     r0,r0,#1              ;2677
00005c  68a1              LDR      r1,[r4,#8]            ;2677
00005e  ea002051          AND      r0,r0,r1,LSR #9       ;2677
000062  f0000aff          AND      r10,r0,#0xff          ;2677
000066  f1ba0f00          CMP      r10,#0                ;2678
00006a  d126              BNE      |L39.186|
00006c  68a0              LDR      r0,[r4,#8]            ;2679
00006e  b938              CBNZ     r0,|L39.128|
000070  6927              LDR      r7,[r4,#0x10]         ;2680
000072  b997              CBNZ     r7,|L39.154|
000074  2100              MOVS     r1,#0                 ;2682
000076  6820              LDR      r0,[r4,#0]            ;2682
000078  f7fffffe          BL       create_chain
00007c  4607              MOV      r7,r0                 ;2682
00007e  e00c              B        |L39.154|
                  |L39.128|
000080  6a60              LDR      r0,[r4,#0x24]         ;2685
000082  b128              CBZ      r0,|L39.144|
000084  4620              MOV      r0,r4                 ;2686
000086  68a1              LDR      r1,[r4,#8]            ;2686
000088  f7fffffe          BL       clmt_clust
00008c  4607              MOV      r7,r0                 ;2686
00008e  e004              B        |L39.154|
                  |L39.144|
000090  6961              LDR      r1,[r4,#0x14]         ;2689
000092  6820              LDR      r0,[r4,#0]            ;2689
000094  f7fffffe          BL       create_chain
000098  4607              MOV      r7,r0                 ;2689
                  |L39.154|
00009a  b907              CBNZ     r7,|L39.158|
00009c  e098              B        |L39.464|
                  |L39.158|
00009e  2f01              CMP      r7,#1                 ;2692
0000a0  d102              BNE      |L39.168|
0000a2  2002              MOVS     r0,#2                 ;2692
0000a4  71e0              STRB     r0,[r4,#7]            ;2692
0000a6  e7bd              B        |L39.36|
                  |L39.168|
0000a8  1c78              ADDS     r0,r7,#1              ;2693
0000aa  b910              CBNZ     r0,|L39.178|
0000ac  2001              MOVS     r0,#1                 ;2693
0000ae  71e0              STRB     r0,[r4,#7]            ;2693
0000b0  e7b8              B        |L39.36|
                  |L39.178|
0000b2  6167              STR      r7,[r4,#0x14]         ;2694
0000b4  6920              LDR      r0,[r4,#0x10]         ;2695
0000b6  b900              CBNZ     r0,|L39.186|
0000b8  6127              STR      r7,[r4,#0x10]         ;2695
                  |L39.186|
0000ba  79a0              LDRB     r0,[r4,#6]            ;2701
0000bc  f0000040          AND      r0,r0,#0x40           ;2701
0000c0  b178              CBZ      r0,|L39.226|
0000c2  6821              LDR      r1,[r4,#0]            ;2702
0000c4  7848              LDRB     r0,[r1,#1]            ;2702
0000c6  2301              MOVS     r3,#1                 ;2702
0000c8  f1040128          ADD      r1,r4,#0x28           ;2702
0000cc  69a2              LDR      r2,[r4,#0x18]         ;2702
0000ce  f7fffffe          BL       disk_write
0000d2  b110              CBZ      r0,|L39.218|
0000d4  2001              MOVS     r0,#1                 ;2703
0000d6  71e0              STRB     r0,[r4,#7]            ;2703
0000d8  e7a4              B        |L39.36|
                  |L39.218|
0000da  79a0              LDRB     r0,[r4,#6]            ;2704
0000dc  f0200040          BIC      r0,r0,#0x40           ;2704
0000e0  71a0              STRB     r0,[r4,#6]            ;2704
                  |L39.226|
0000e2  6961              LDR      r1,[r4,#0x14]         ;2707
0000e4  6820              LDR      r0,[r4,#0]            ;2707
0000e6  f7fffffe          BL       clust2sect
0000ea  4606              MOV      r6,r0                 ;2707
0000ec  b916              CBNZ     r6,|L39.244|
0000ee  2002              MOVS     r0,#2                 ;2708
0000f0  71e0              STRB     r0,[r4,#7]            ;2708
0000f2  e797              B        |L39.36|
                  |L39.244|
0000f4  4456              ADD      r6,r6,r10             ;2709
0000f6  ea4f2955          LSR      r9,r5,#9              ;2710
0000fa  f1b90f00          CMP      r9,#0                 ;2711
0000fe  d02c              BEQ      |L39.346|
000100  eb0a0009          ADD      r0,r10,r9             ;2712
000104  6821              LDR      r1,[r4,#0]            ;2712
000106  7889              LDRB     r1,[r1,#2]            ;2712
000108  4288              CMP      r0,r1                 ;2712
00010a  d903              BLS      |L39.276|
00010c  6820              LDR      r0,[r4,#0]            ;2713
00010e  7880              LDRB     r0,[r0,#2]            ;2713
000110  eba0090a          SUB      r9,r0,r10             ;2713
                  |L39.276|
000114  6821              LDR      r1,[r4,#0]            ;2714
000116  7848              LDRB     r0,[r1,#1]            ;2714
000118  464b              MOV      r3,r9                 ;2714
00011a  4632              MOV      r2,r6                 ;2714
00011c  9901              LDR      r1,[sp,#4]            ;2714
00011e  f7fffffe          BL       disk_write
000122  b110              CBZ      r0,|L39.298|
000124  2001              MOVS     r0,#1                 ;2715
000126  71e0              STRB     r0,[r4,#7]            ;2715
000128  e77c              B        |L39.36|
                  |L39.298|
00012a  69a0              LDR      r0,[r4,#0x18]         ;2723
00012c  1b80              SUBS     r0,r0,r6              ;2723
00012e  4548              CMP      r0,r9                 ;2723
000130  d20e              BCS      |L39.336|
000132  69a0              LDR      r0,[r4,#0x18]         ;2724
000134  1b80              SUBS     r0,r0,r6              ;2724
000136  9a01              LDR      r2,[sp,#4]            ;2724
000138  eb022140          ADD      r1,r2,r0,LSL #9       ;2724
00013c  f44f7200          MOV      r2,#0x200             ;2724
000140  f1040028          ADD      r0,r4,#0x28           ;2724
000144  f7fffffe          BL       mem_cpy
000148  79a0              LDRB     r0,[r4,#6]            ;2725
00014a  f0200040          BIC      r0,r0,#0x40           ;2725
00014e  71a0              STRB     r0,[r4,#6]            ;2725
                  |L39.336|
000150  e000              B        |L39.340|
                  |L39.338|
000152  e016              B        |L39.386|
                  |L39.340|
000154  ea4f2849          LSL      r8,r9,#9              ;2729
000158  e02a              B        |L39.432|
                  |L39.346|
00015a  69a0              LDR      r0,[r4,#0x18]         ;2738
00015c  42b0              CMP      r0,r6                 ;2738
00015e  d00f              BEQ      |L39.384|
000160  e9d40102          LDRD     r0,r1,[r4,#8]         ;2739
000164  4288              CMP      r0,r1                 ;2739
000166  d20b              BCS      |L39.384|
000168  6821              LDR      r1,[r4,#0]            ;2740
00016a  7848              LDRB     r0,[r1,#1]            ;2740
00016c  2301              MOVS     r3,#1                 ;2740
00016e  4632              MOV      r2,r6                 ;2740
000170  f1040128          ADD      r1,r4,#0x28           ;2740
000174  f7fffffe          BL       disk_read
000178  b110              CBZ      r0,|L39.384|
00017a  2001              MOVS     r0,#1                 ;2741
00017c  71e0              STRB     r0,[r4,#7]            ;2741
00017e  e751              B        |L39.36|
                  |L39.384|
000180  61a6              STR      r6,[r4,#0x18]         ;2744
                  |L39.386|
000182  8920              LDRH     r0,[r4,#8]            ;2746
000184  f3c00008          UBFX     r0,r0,#0,#9           ;2746
000188  f5c07800          RSB      r8,r0,#0x200          ;2746
00018c  45a8              CMP      r8,r5                 ;2747
00018e  d900              BLS      |L39.402|
000190  46a8              MOV      r8,r5                 ;2747
                  |L39.402|
000192  8921              LDRH     r1,[r4,#8]            ;2754
000194  f3c10208          UBFX     r2,r1,#0,#9           ;2754
000198  f1040128          ADD      r1,r4,#0x28           ;2754
00019c  1850              ADDS     r0,r2,r1              ;2754
00019e  4642              MOV      r2,r8                 ;2754
0001a0  9901              LDR      r1,[sp,#4]            ;2754
0001a2  f7fffffe          BL       mem_cpy
0001a6  79a0              LDRB     r0,[r4,#6]            ;2755
0001a8  f0400040          ORR      r0,r0,#0x40           ;2755
0001ac  71a0              STRB     r0,[r4,#6]            ;2755
0001ae  bf00              NOP                            ;2730
                  |L39.432|
0001b0  9801              LDR      r0,[sp,#4]            ;2675
0001b2  4440              ADD      r0,r0,r8              ;2675
0001b4  9001              STR      r0,[sp,#4]            ;2675
0001b6  68a0              LDR      r0,[r4,#8]            ;2675
0001b8  4440              ADD      r0,r0,r8              ;2675
0001ba  60a0              STR      r0,[r4,#8]            ;2675
0001bc  f8db0000          LDR      r0,[r11,#0]           ;2675
0001c0  4440              ADD      r0,r0,r8              ;2675
0001c2  f8cb0000          STR      r0,[r11,#0]           ;2675
0001c6  eba50508          SUB      r5,r5,r8              ;2675
                  |L39.458|
0001ca  2d00              CMP      r5,#0                 ;2674
0001cc  f47faf3e          BNE      |L39.76|
                  |L39.464|
0001d0  bf00              NOP                            ;2691
0001d2  e9d40102          LDRD     r0,r1,[r4,#8]         ;2759
0001d6  4288              CMP      r0,r1                 ;2759
0001d8  d901              BLS      |L39.478|
0001da  68a0              LDR      r0,[r4,#8]            ;2759
0001dc  60e0              STR      r0,[r4,#0xc]          ;2759
                  |L39.478|
0001de  79a0              LDRB     r0,[r4,#6]            ;2760
0001e0  f0400020          ORR      r0,r0,#0x20           ;2760
0001e4  71a0              STRB     r0,[r4,#6]            ;2760
0001e6  2000              MOVS     r0,#0                 ;2762
0001e8  e71c              B        |L39.36|
;;;2764   
                          ENDP


                          AREA ||i.find_volume||, CODE, READONLY, ALIGN=2

                  find_volume PROC
;;;2162   static
;;;2163   FRESULT find_volume (	/* FR_OK(0): successful, !=0: any error occurred */
000000  e92d4ff7          PUSH     {r0-r2,r4-r11,lr}
;;;2164   	FATFS** rfs,		/* Pointer to pointer to the found file system object */
;;;2165   	const TCHAR** path,	/* Pointer to pointer to the path name (drive number) */
;;;2166   	BYTE wmode			/* !=0: Check write protection for write access */
;;;2167   )
;;;2168   {
000004  b088              SUB      sp,sp,#0x20
;;;2169   	BYTE fmt;
;;;2170   	int vol;
;;;2171   	DSTATUS stat;
;;;2172   	DWORD bsect, fasize, tsect, sysect, nclst, szbfat;
;;;2173   	WORD nrsv;
;;;2174   	FATFS *fs;
;;;2175   
;;;2176   
;;;2177   	/* Get logical drive number from the path name */
;;;2178   	*rfs = 0;
000006  2100              MOVS     r1,#0
000008  9808              LDR      r0,[sp,#0x20]
00000a  6001              STR      r1,[r0,#0]
;;;2179   	vol = get_ldnumber(path);
00000c  9809              LDR      r0,[sp,#0x24]
00000e  f7fffffe          BL       get_ldnumber
000012  9007              STR      r0,[sp,#0x1c]
;;;2180   	if (vol < 0) return FR_INVALID_DRIVE;
000014  9807              LDR      r0,[sp,#0x1c]
000016  2800              CMP      r0,#0
000018  da03              BGE      |L40.34|
00001a  200b              MOVS     r0,#0xb
                  |L40.28|
;;;2181   
;;;2182   	/* Check if the file system object is valid or not */
;;;2183   	fs = FatFs[vol];					/* Get pointer to the file system object */
;;;2184   	if (!fs) return FR_NOT_ENABLED;		/* Is the file system object available? */
;;;2185   
;;;2186   	ENTER_FF(fs);						/* Lock the volume */
;;;2187   	*rfs = fs;							/* Return pointer to the file system object */
;;;2188   
;;;2189   	if (fs->fs_type) {					/* If the volume has been mounted */
;;;2190   		stat = disk_status(fs->drv);
;;;2191   		if (!(stat & STA_NOINIT)) {		/* and the physical drive is kept initialized */
;;;2192   			if (!_FS_READONLY && wmode && (stat & STA_PROTECT))	/* Check write protection if needed */
;;;2193   				return FR_WRITE_PROTECTED;
;;;2194   			return FR_OK;				/* The file system object is valid */
;;;2195   		}
;;;2196   	}
;;;2197   
;;;2198   	/* The file system object is not valid. */
;;;2199   	/* Following code attempts to mount the volume. (analyze BPB and initialize the fs object) */
;;;2200   
;;;2201   	fs->fs_type = 0;					/* Clear the file system object */
;;;2202   	fs->drv = LD2PD(vol);				/* Bind the logical drive and a physical drive */
;;;2203   	stat = disk_initialize(fs->drv);	/* Initialize the physical drive */
;;;2204   	if (stat & STA_NOINIT)				/* Check if the initialization succeeded */
;;;2205   		return FR_NOT_READY;			/* Failed to initialize due to no medium or hard error */
;;;2206   	if (!_FS_READONLY && wmode && (stat & STA_PROTECT))	/* Check disk write protection if needed */
;;;2207   		return FR_WRITE_PROTECTED;
;;;2208   #if _MAX_SS != _MIN_SS						/* Get sector size (multiple sector size cfg only) */
;;;2209   	if (disk_ioctl(fs->drv, GET_SECTOR_SIZE, &SS(fs)) != RES_OK
;;;2210   		|| SS(fs) < _MIN_SS || SS(fs) > _MAX_SS) return FR_DISK_ERR;
;;;2211   #endif
;;;2212   	/* Find an FAT partition on the drive. Supports only generic partitioning, FDISK and SFD. */
;;;2213   	bsect = 0;
;;;2214   	fmt = check_fs(fs, bsect);					/* Load sector 0 and check if it is an FAT boot sector as SFD */
;;;2215   	if (fmt == 1 || (!fmt && (LD2PT(vol)))) {	/* Not an FAT boot sector or forced partition number */
;;;2216   		UINT i;
;;;2217   		DWORD br[4];
;;;2218   
;;;2219   		for (i = 0; i < 4; i++) {			/* Get partition offset */
;;;2220   			BYTE *pt = fs->win+MBR_Table + i * SZ_PTE;
;;;2221   			br[i] = pt[4] ? LD_DWORD(&pt[8]) : 0;
;;;2222   		}
;;;2223   		i = LD2PT(vol);						/* Partition number: 0:auto, 1-4:forced */
;;;2224   		if (i) i--;
;;;2225   		do {								/* Find an FAT volume */
;;;2226   			bsect = br[i];
;;;2227   			fmt = bsect ? check_fs(fs, bsect) : 2;	/* Check the partition */
;;;2228   		} while (!LD2PT(vol) && fmt && ++i < 4);
;;;2229   	}
;;;2230   	if (fmt == 3) return FR_DISK_ERR;		/* An error occured in the disk I/O layer */
;;;2231   	if (fmt) return FR_NO_FILESYSTEM;		/* No FAT volume is found */
;;;2232   
;;;2233   	/* An FAT volume is found. Following code initializes the file system object */
;;;2234   
;;;2235   	if (LD_WORD(fs->win+BPB_BytsPerSec) != SS(fs))		/* (BPB_BytsPerSec must be equal to the physical sector size) */
;;;2236   		return FR_NO_FILESYSTEM;
;;;2237   
;;;2238   	fasize = LD_WORD(fs->win+BPB_FATSz16);				/* Number of sectors per FAT */
;;;2239   	if (!fasize) fasize = LD_DWORD(fs->win+BPB_FATSz32);
;;;2240   	fs->fsize = fasize;
;;;2241   
;;;2242   	fs->n_fats = fs->win[BPB_NumFATs];					/* Number of FAT copies */
;;;2243   	if (fs->n_fats != 1 && fs->n_fats != 2)				/* (Must be 1 or 2) */
;;;2244   		return FR_NO_FILESYSTEM;
;;;2245   	fasize *= fs->n_fats;								/* Number of sectors for FAT area */
;;;2246   
;;;2247   	fs->csize = fs->win[BPB_SecPerClus];				/* Number of sectors per cluster */
;;;2248   	if (!fs->csize || (fs->csize & (fs->csize - 1)))	/* (Must be power of 2) */
;;;2249   		return FR_NO_FILESYSTEM;
;;;2250   
;;;2251   	fs->n_rootdir = LD_WORD(fs->win+BPB_RootEntCnt);	/* Number of root directory entries */
;;;2252   	if (fs->n_rootdir % (SS(fs) / SZ_DIR))				/* (Must be sector aligned) */
;;;2253   		return FR_NO_FILESYSTEM;
;;;2254   
;;;2255   	tsect = LD_WORD(fs->win+BPB_TotSec16);				/* Number of sectors on the volume */
;;;2256   	if (!tsect) tsect = LD_DWORD(fs->win+BPB_TotSec32);
;;;2257   
;;;2258   	nrsv = LD_WORD(fs->win+BPB_RsvdSecCnt);				/* Number of reserved sectors */
;;;2259   	if (!nrsv) return FR_NO_FILESYSTEM;					/* (Must not be 0) */
;;;2260   
;;;2261   	/* Determine the FAT sub type */
;;;2262   	sysect = nrsv + fasize + fs->n_rootdir / (SS(fs) / SZ_DIR);	/* RSV+FAT+DIR */
;;;2263   	if (tsect < sysect) return FR_NO_FILESYSTEM;		/* (Invalid volume size) */
;;;2264   	nclst = (tsect - sysect) / fs->csize;				/* Number of clusters */
;;;2265   	if (!nclst) return FR_NO_FILESYSTEM;				/* (Invalid volume size) */
;;;2266   	fmt = FS_FAT12;
;;;2267   	if (nclst >= MIN_FAT16) fmt = FS_FAT16;
;;;2268   	if (nclst >= MIN_FAT32) fmt = FS_FAT32;
;;;2269   
;;;2270   	/* Boundaries and Limits */
;;;2271   	fs->n_fatent = nclst + 2;							/* Number of FAT entries */
;;;2272   	fs->volbase = bsect;								/* Volume start sector */
;;;2273   	fs->fatbase = bsect + nrsv; 						/* FAT start sector */
;;;2274   	fs->database = bsect + sysect;						/* Data start sector */
;;;2275   	if (fmt == FS_FAT32) {
;;;2276   		if (fs->n_rootdir) return FR_NO_FILESYSTEM;		/* (BPB_RootEntCnt must be 0) */
;;;2277   		fs->dirbase = LD_DWORD(fs->win+BPB_RootClus);	/* Root directory start cluster */
;;;2278   		szbfat = fs->n_fatent * 4;						/* (Needed FAT size) */
;;;2279   	} else {
;;;2280   		if (!fs->n_rootdir)	return FR_NO_FILESYSTEM;	/* (BPB_RootEntCnt must not be 0) */
;;;2281   		fs->dirbase = fs->fatbase + fasize;				/* Root directory start sector */
;;;2282   		szbfat = (fmt == FS_FAT16) ?					/* (Needed FAT size) */
;;;2283   			fs->n_fatent * 2 : fs->n_fatent * 3 / 2 + (fs->n_fatent & 1);
;;;2284   	}
;;;2285   	if (fs->fsize < (szbfat + (SS(fs) - 1)) / SS(fs))	/* (BPB_FATSz must not be less than needed) */
;;;2286   		return FR_NO_FILESYSTEM;
;;;2287   
;;;2288   #if !_FS_READONLY
;;;2289   	/* Initialize cluster allocation information */
;;;2290   	fs->last_clust = fs->free_clust = 0xFFFFFFFF;
;;;2291   
;;;2292   	/* Get fsinfo if available */
;;;2293   	fs->fsi_flag = 0x80;
;;;2294   #if (_FS_NOFSINFO & 3) != 3
;;;2295   	if (fmt == FS_FAT32				/* Enable FSINFO only if FAT32 and BPB_FSInfo is 1 */
;;;2296   		&& LD_WORD(fs->win+BPB_FSInfo) == 1
;;;2297   		&& move_window(fs, bsect + 1) == FR_OK)
;;;2298   	{
;;;2299   		fs->fsi_flag = 0;
;;;2300   		if (LD_WORD(fs->win+BS_55AA) == 0xAA55	/* Load FSINFO data if available */
;;;2301   			&& LD_DWORD(fs->win+FSI_LeadSig) == 0x41615252
;;;2302   			&& LD_DWORD(fs->win+FSI_StrucSig) == 0x61417272)
;;;2303   		{
;;;2304   #if (_FS_NOFSINFO & 1) == 0
;;;2305   			fs->free_clust = LD_DWORD(fs->win+FSI_Free_Count);
;;;2306   #endif
;;;2307   #if (_FS_NOFSINFO & 2) == 0
;;;2308   			fs->last_clust = LD_DWORD(fs->win+FSI_Nxt_Free);
;;;2309   #endif
;;;2310   		}
;;;2311   	}
;;;2312   #endif
;;;2313   #endif
;;;2314   	fs->fs_type = fmt;	/* FAT sub-type */
;;;2315   	fs->id = ++Fsid;	/* File system mount ID */
;;;2316   #if _FS_RPATH
;;;2317   	fs->cdir = 0;		/* Set current directory to root */
;;;2318   #endif
;;;2319   #if _FS_LOCK			/* Clear file lock semaphores */
;;;2320   	clear_lock(fs);
;;;2321   #endif
;;;2322   
;;;2323   	return FR_OK;
;;;2324   }
00001c  b00b              ADD      sp,sp,#0x2c
00001e  e8bd8ff0          POP      {r4-r11,pc}
                  |L40.34|
000022  49d5              LDR      r1,|L40.888|
000024  9807              LDR      r0,[sp,#0x1c]         ;2183
000026  f8514020          LDR      r4,[r1,r0,LSL #2]     ;2183
00002a  b90c              CBNZ     r4,|L40.48|
00002c  200c              MOVS     r0,#0xc               ;2184
00002e  e7f5              B        |L40.28|
                  |L40.48|
000030  9808              LDR      r0,[sp,#0x20]         ;2187
000032  6004              STR      r4,[r0,#0]            ;2187
000034  7820              LDRB     r0,[r4,#0]            ;2189
000036  b178              CBZ      r0,|L40.88|
000038  7860              LDRB     r0,[r4,#1]            ;2190
00003a  f7fffffe          BL       disk_status
00003e  4680              MOV      r8,r0                 ;2190
000040  f0080001          AND      r0,r8,#1              ;2191
000044  b940              CBNZ     r0,|L40.88|
000046  980a              LDR      r0,[sp,#0x28]         ;2192
000048  b120              CBZ      r0,|L40.84|
00004a  f0080004          AND      r0,r8,#4              ;2192
00004e  b108              CBZ      r0,|L40.84|
000050  200a              MOVS     r0,#0xa               ;2193
000052  e7e3              B        |L40.28|
                  |L40.84|
000054  2000              MOVS     r0,#0                 ;2194
000056  e7e1              B        |L40.28|
                  |L40.88|
000058  2000              MOVS     r0,#0                 ;2201
00005a  7020              STRB     r0,[r4,#0]            ;2201
00005c  9807              LDR      r0,[sp,#0x1c]         ;2202
00005e  7060              STRB     r0,[r4,#1]            ;2202
000060  7860              LDRB     r0,[r4,#1]            ;2203
000062  f7fffffe          BL       disk_initialize
000066  4680              MOV      r8,r0                 ;2203
000068  f0080001          AND      r0,r8,#1              ;2204
00006c  b108              CBZ      r0,|L40.114|
00006e  2003              MOVS     r0,#3                 ;2205
000070  e7d4              B        |L40.28|
                  |L40.114|
000072  980a              LDR      r0,[sp,#0x28]         ;2206
000074  b120              CBZ      r0,|L40.128|
000076  f0080004          AND      r0,r8,#4              ;2206
00007a  b108              CBZ      r0,|L40.128|
00007c  200a              MOVS     r0,#0xa               ;2207
00007e  e7cd              B        |L40.28|
                  |L40.128|
000080  2700              MOVS     r7,#0                 ;2213
000082  4639              MOV      r1,r7                 ;2214
000084  4620              MOV      r0,r4                 ;2214
000086  f7fffffe          BL       check_fs
00008a  4605              MOV      r5,r0                 ;2214
00008c  2d01              CMP      r5,#1                 ;2215
00008e  d001              BEQ      |L40.148|
000090  bb6d              CBNZ     r5,|L40.238|
000092  e02c              B        |L40.238|
                  |L40.148|
000094  2600              MOVS     r6,#0                 ;2219
000096  e014              B        |L40.194|
                  |L40.152|
000098  f50471f7          ADD      r1,r4,#0x1ee          ;2220
00009c  eb011006          ADD      r0,r1,r6,LSL #4       ;2220
0000a0  7901              LDRB     r1,[r0,#4]            ;2221
0000a2  b151              CBZ      r1,|L40.186|
0000a4  7ac1              LDRB     r1,[r0,#0xb]          ;2221
0000a6  060a              LSLS     r2,r1,#24             ;2221
0000a8  7a81              LDRB     r1,[r0,#0xa]          ;2221
0000aa  ea424201          ORR      r2,r2,r1,LSL #16      ;2221
0000ae  7a41              LDRB     r1,[r0,#9]            ;2221
0000b0  ea422101          ORR      r1,r2,r1,LSL #8       ;2221
0000b4  7a02              LDRB     r2,[r0,#8]            ;2221
0000b6  4311              ORRS     r1,r1,r2              ;2221
0000b8  e000              B        |L40.188|
                  |L40.186|
0000ba  2100              MOVS     r1,#0                 ;2221
                  |L40.188|
0000bc  f84d1026          STR      r1,[sp,r6,LSL #2]     ;2221
0000c0  1c76              ADDS     r6,r6,#1              ;2219
                  |L40.194|
0000c2  2e04              CMP      r6,#4                 ;2219
0000c4  d3e8              BCC      |L40.152|
0000c6  2600              MOVS     r6,#0                 ;2223
0000c8  b106              CBZ      r6,|L40.204|
0000ca  1e76              SUBS     r6,r6,#1              ;2224
                  |L40.204|
0000cc  bf00              NOP                            ;2225
                  |L40.206|
0000ce  f85d7026          LDR      r7,[sp,r6,LSL #2]     ;2226
0000d2  b127              CBZ      r7,|L40.222|
0000d4  4639              MOV      r1,r7                 ;2227
0000d6  4620              MOV      r0,r4                 ;2227
0000d8  f7fffffe          BL       check_fs
0000dc  e000              B        |L40.224|
                  |L40.222|
0000de  2002              MOVS     r0,#2                 ;2227
                  |L40.224|
0000e0  4605              MOV      r5,r0                 ;2227
0000e2  b11d              CBZ      r5,|L40.236|
0000e4  1c70              ADDS     r0,r6,#1              ;2228
0000e6  4606              MOV      r6,r0                 ;2228
0000e8  2804              CMP      r0,#4                 ;2228
0000ea  d3f0              BCC      |L40.206|
                  |L40.236|
0000ec  bf00              NOP                            ;2229
                  |L40.238|
0000ee  2d03              CMP      r5,#3                 ;2230
0000f0  d101              BNE      |L40.246|
0000f2  2001              MOVS     r0,#1                 ;2230
0000f4  e792              B        |L40.28|
                  |L40.246|
0000f6  b10d              CBZ      r5,|L40.252|
0000f8  200d              MOVS     r0,#0xd               ;2231
0000fa  e78f              B        |L40.28|
                  |L40.252|
0000fc  203b              MOVS     r0,#0x3b              ;2235
0000fe  5d01              LDRB     r1,[r0,r4]            ;2235
000100  f894003c          LDRB     r0,[r4,#0x3c]         ;2235
000104  ea412000          ORR      r0,r1,r0,LSL #8       ;2235
000108  f5b07f00          CMP      r0,#0x200             ;2235
00010c  d001              BEQ      |L40.274|
00010e  200d              MOVS     r0,#0xd               ;2236
000110  e784              B        |L40.28|
                  |L40.274|
000112  2046              MOVS     r0,#0x46              ;2238
000114  5d01              LDRB     r1,[r0,r4]            ;2238
000116  f8940047          LDRB     r0,[r4,#0x47]         ;2238
00011a  ea412900          ORR      r9,r1,r0,LSL #8       ;2238
00011e  f1b90f00          CMP      r9,#0                 ;2239
000122  d10e              BNE      |L40.322|
000124  f8940057          LDRB     r0,[r4,#0x57]         ;2239
000128  0601              LSLS     r1,r0,#24             ;2239
00012a  f8940056          LDRB     r0,[r4,#0x56]         ;2239
00012e  ea414100          ORR      r1,r1,r0,LSL #16      ;2239
000132  f8940055          LDRB     r0,[r4,#0x55]         ;2239
000136  ea412000          ORR      r0,r1,r0,LSL #8       ;2239
00013a  f8941054          LDRB     r1,[r4,#0x54]         ;2239
00013e  ea400901          ORR      r9,r0,r1              ;2239
                  |L40.322|
000142  f8c49018          STR      r9,[r4,#0x18]         ;2240
000146  2040              MOVS     r0,#0x40              ;2242
000148  5d00              LDRB     r0,[r0,r4]            ;2242
00014a  70e0              STRB     r0,[r4,#3]            ;2242
00014c  78e0              LDRB     r0,[r4,#3]            ;2243
00014e  2801              CMP      r0,#1                 ;2243
000150  d004              BEQ      |L40.348|
000152  78e0              LDRB     r0,[r4,#3]            ;2243
000154  2802              CMP      r0,#2                 ;2243
000156  d001              BEQ      |L40.348|
000158  200d              MOVS     r0,#0xd               ;2244
00015a  e75f              B        |L40.28|
                  |L40.348|
00015c  78e0              LDRB     r0,[r4,#3]            ;2245
00015e  fb09f900          MUL      r9,r9,r0              ;2245
000162  203d              MOVS     r0,#0x3d              ;2247
000164  5d00              LDRB     r0,[r0,r4]            ;2247
000166  70a0              STRB     r0,[r4,#2]            ;2247
000168  78a0              LDRB     r0,[r4,#2]            ;2248
00016a  b118              CBZ      r0,|L40.372|
00016c  78a0              LDRB     r0,[r4,#2]            ;2248
00016e  1e41              SUBS     r1,r0,#1              ;2248
000170  4008              ANDS     r0,r0,r1              ;2248
000172  b108              CBZ      r0,|L40.376|
                  |L40.372|
000174  200d              MOVS     r0,#0xd               ;2249
000176  e751              B        |L40.28|
                  |L40.376|
000178  2041              MOVS     r0,#0x41              ;2251
00017a  5d01              LDRB     r1,[r0,r4]            ;2251
00017c  f8940042          LDRB     r0,[r4,#0x42]         ;2251
000180  ea412000          ORR      r0,r1,r0,LSL #8       ;2251
000184  8120              STRH     r0,[r4,#8]            ;2251
000186  7a20              LDRB     r0,[r4,#8]            ;2252
000188  f000000f          AND      r0,r0,#0xf            ;2252
00018c  b108              CBZ      r0,|L40.402|
00018e  200d              MOVS     r0,#0xd               ;2253
000190  e744              B        |L40.28|
                  |L40.402|
000192  2043              MOVS     r0,#0x43              ;2255
000194  5d01              LDRB     r1,[r0,r4]            ;2255
000196  f8940044          LDRB     r0,[r4,#0x44]         ;2255
00019a  ea412b00          ORR      r11,r1,r0,LSL #8      ;2255
00019e  f1bb0f00          CMP      r11,#0                ;2256
0001a2  d10e              BNE      |L40.450|
0001a4  f8940053          LDRB     r0,[r4,#0x53]         ;2256
0001a8  0601              LSLS     r1,r0,#24             ;2256
0001aa  f8940052          LDRB     r0,[r4,#0x52]         ;2256
0001ae  ea414100          ORR      r1,r1,r0,LSL #16      ;2256
0001b2  f8940051          LDRB     r0,[r4,#0x51]         ;2256
0001b6  ea412000          ORR      r0,r1,r0,LSL #8       ;2256
0001ba  f8941050          LDRB     r1,[r4,#0x50]         ;2256
0001be  ea400b01          ORR      r11,r0,r1             ;2256
                  |L40.450|
0001c2  203e              MOVS     r0,#0x3e              ;2258
0001c4  5d01              LDRB     r1,[r0,r4]            ;2258
0001c6  f894003f          LDRB     r0,[r4,#0x3f]         ;2258
0001ca  ea412000          ORR      r0,r1,r0,LSL #8       ;2258
0001ce  9004              STR      r0,[sp,#0x10]         ;2258
0001d0  9804              LDR      r0,[sp,#0x10]         ;2259
0001d2  b908              CBNZ     r0,|L40.472|
0001d4  200d              MOVS     r0,#0xd               ;2259
0001d6  e721              B        |L40.28|
                  |L40.472|
0001d8  9804              LDR      r0,[sp,#0x10]         ;2262
0001da  4448              ADD      r0,r0,r9              ;2262
0001dc  8921              LDRH     r1,[r4,#8]            ;2262
0001de  eb001011          ADD      r0,r0,r1,LSR #4       ;2262
0001e2  9006              STR      r0,[sp,#0x18]         ;2262
0001e4  9806              LDR      r0,[sp,#0x18]         ;2263
0001e6  4583              CMP      r11,r0                ;2263
0001e8  d201              BCS      |L40.494|
0001ea  200d              MOVS     r0,#0xd               ;2263
0001ec  e716              B        |L40.28|
                  |L40.494|
0001ee  9806              LDR      r0,[sp,#0x18]         ;2264
0001f0  ebab0000          SUB      r0,r11,r0             ;2264
0001f4  78a1              LDRB     r1,[r4,#2]            ;2264
0001f6  fbb0faf1          UDIV     r10,r0,r1             ;2264
0001fa  f1ba0f00          CMP      r10,#0                ;2265
0001fe  d101              BNE      |L40.516|
000200  200d              MOVS     r0,#0xd               ;2265
000202  e70b              B        |L40.28|
                  |L40.516|
000204  2501              MOVS     r5,#1                 ;2266
000206  f64070f6          MOV      r0,#0xff6             ;2267
00020a  4582              CMP      r10,r0                ;2267
00020c  d300              BCC      |L40.528|
00020e  2502              MOVS     r5,#2                 ;2267
                  |L40.528|
000210  f64f70f6          MOV      r0,#0xfff6            ;2268
000214  4582              CMP      r10,r0                ;2268
000216  d300              BCC      |L40.538|
000218  2503              MOVS     r5,#3                 ;2268
                  |L40.538|
00021a  f10a0002          ADD      r0,r10,#2             ;2271
00021e  6160              STR      r0,[r4,#0x14]         ;2271
000220  61e7              STR      r7,[r4,#0x1c]         ;2272
000222  9804              LDR      r0,[sp,#0x10]         ;2273
000224  4438              ADD      r0,r0,r7              ;2273
000226  6220              STR      r0,[r4,#0x20]         ;2273
000228  9806              LDR      r0,[sp,#0x18]         ;2274
00022a  4438              ADD      r0,r0,r7              ;2274
00022c  62a0              STR      r0,[r4,#0x28]         ;2274
00022e  2d03              CMP      r5,#3                 ;2275
000230  d116              BNE      |L40.608|
000232  8920              LDRH     r0,[r4,#8]            ;2276
000234  b108              CBZ      r0,|L40.570|
000236  200d              MOVS     r0,#0xd               ;2276
000238  e6f0              B        |L40.28|
                  |L40.570|
00023a  f894005f          LDRB     r0,[r4,#0x5f]         ;2277
00023e  0601              LSLS     r1,r0,#24             ;2277
000240  f894005e          LDRB     r0,[r4,#0x5e]         ;2277
000244  ea414100          ORR      r1,r1,r0,LSL #16      ;2277
000248  f894005d          LDRB     r0,[r4,#0x5d]         ;2277
00024c  ea412000          ORR      r0,r1,r0,LSL #8       ;2277
000250  f894105c          LDRB     r1,[r4,#0x5c]         ;2277
000254  4308              ORRS     r0,r0,r1              ;2277
000256  6260              STR      r0,[r4,#0x24]         ;2277
000258  6960              LDR      r0,[r4,#0x14]         ;2278
00025a  0080              LSLS     r0,r0,#2              ;2278
00025c  9005              STR      r0,[sp,#0x14]         ;2278
00025e  e014              B        |L40.650|
                  |L40.608|
000260  8920              LDRH     r0,[r4,#8]            ;2280
000262  b908              CBNZ     r0,|L40.616|
000264  200d              MOVS     r0,#0xd               ;2280
000266  e6d9              B        |L40.28|
                  |L40.616|
000268  6a20              LDR      r0,[r4,#0x20]         ;2281
00026a  4448              ADD      r0,r0,r9              ;2281
00026c  6260              STR      r0,[r4,#0x24]         ;2281
00026e  2d02              CMP      r5,#2                 ;2282
000270  d102              BNE      |L40.632|
000272  6960              LDR      r0,[r4,#0x14]         ;2283
000274  0040              LSLS     r0,r0,#1              ;2283
000276  e007              B        |L40.648|
                  |L40.632|
000278  7d20              LDRB     r0,[r4,#0x14]         ;2283
00027a  f0000001          AND      r0,r0,#1              ;2283
00027e  6961              LDR      r1,[r4,#0x14]         ;2283
000280  eb010141          ADD      r1,r1,r1,LSL #1       ;2283
000284  eb000051          ADD      r0,r0,r1,LSR #1       ;2283
                  |L40.648|
000288  9005              STR      r0,[sp,#0x14]         ;2283
                  |L40.650|
00028a  69a1              LDR      r1,[r4,#0x18]         ;2285
00028c  9805              LDR      r0,[sp,#0x14]         ;2285
00028e  f20010ff          ADD      r0,r0,#0x1ff          ;2285
000292  ebb12f50          CMP      r1,r0,LSR #9          ;2285
000296  d201              BCS      |L40.668|
000298  200d              MOVS     r0,#0xd               ;2286
00029a  e6bf              B        |L40.28|
                  |L40.668|
00029c  f04f30ff          MOV      r0,#0xffffffff        ;2290
0002a0  6120              STR      r0,[r4,#0x10]         ;2290
0002a2  60e0              STR      r0,[r4,#0xc]          ;2290
0002a4  2080              MOVS     r0,#0x80              ;2293
0002a6  7160              STRB     r0,[r4,#5]            ;2293
0002a8  2d03              CMP      r5,#3                 ;2295
0002aa  d15a              BNE      |L40.866|
0002ac  f8941060          LDRB     r1,[r4,#0x60]         ;2296
0002b0  f8940061          LDRB     r0,[r4,#0x61]         ;2296
0002b4  ea412000          ORR      r0,r1,r0,LSL #8       ;2296
0002b8  2801              CMP      r0,#1                 ;2296
0002ba  d152              BNE      |L40.866|
0002bc  1c79              ADDS     r1,r7,#1              ;2297
0002be  4620              MOV      r0,r4                 ;2297
0002c0  f7fffffe          BL       move_window
0002c4  bbe8              CBNZ     r0,|L40.834|
0002c6  2000              MOVS     r0,#0                 ;2299
0002c8  7160              STRB     r0,[r4,#5]            ;2299
0002ca  f894122e          LDRB     r1,[r4,#0x22e]        ;2300
0002ce  f894022f          LDRB     r0,[r4,#0x22f]        ;2300
0002d2  ea412000          ORR      r0,r1,r0,LSL #8       ;2300
0002d6  f64a2155          MOV      r1,#0xaa55            ;2300
0002da  4288              CMP      r0,r1                 ;2300
0002dc  d141              BNE      |L40.866|
0002de  2033              MOVS     r0,#0x33              ;2301
0002e0  5d00              LDRB     r0,[r0,r4]            ;2301
0002e2  0601              LSLS     r1,r0,#24             ;2301
0002e4  2032              MOVS     r0,#0x32              ;2301
0002e6  5d00              LDRB     r0,[r0,r4]            ;2301
0002e8  ea414100          ORR      r1,r1,r0,LSL #16      ;2301
0002ec  2031              MOVS     r0,#0x31              ;2301
0002ee  5d00              LDRB     r0,[r0,r4]            ;2301
0002f0  ea412000          ORR      r0,r1,r0,LSL #8       ;2301
0002f4  f8941030          LDRB     r1,[r4,#0x30]         ;2301
0002f8  4308              ORRS     r0,r0,r1              ;2301
0002fa  4920              LDR      r1,|L40.892|
0002fc  4288              CMP      r0,r1                 ;2301
0002fe  d130              BNE      |L40.866|
000300  f8940217          LDRB     r0,[r4,#0x217]        ;2302
000304  0601              LSLS     r1,r0,#24             ;2302
000306  f8940216          LDRB     r0,[r4,#0x216]        ;2302
00030a  ea414100          ORR      r1,r1,r0,LSL #16      ;2302
00030e  f8940215          LDRB     r0,[r4,#0x215]        ;2302
000312  ea412000          ORR      r0,r1,r0,LSL #8       ;2302
000316  f8941214          LDRB     r1,[r4,#0x214]        ;2302
00031a  4308              ORRS     r0,r0,r1              ;2302
00031c  4918              LDR      r1,|L40.896|
00031e  4288              CMP      r0,r1                 ;2302
000320  d11f              BNE      |L40.866|
000322  f894021b          LDRB     r0,[r4,#0x21b]        ;2305
000326  0601              LSLS     r1,r0,#24             ;2305
000328  f894021a          LDRB     r0,[r4,#0x21a]        ;2305
00032c  ea414100          ORR      r1,r1,r0,LSL #16      ;2305
000330  f8940219          LDRB     r0,[r4,#0x219]        ;2305
000334  ea412000          ORR      r0,r1,r0,LSL #8       ;2305
000338  f8941218          LDRB     r1,[r4,#0x218]        ;2305
00033c  4308              ORRS     r0,r0,r1              ;2305
00033e  6120              STR      r0,[r4,#0x10]         ;2305
000340  e000              B        |L40.836|
                  |L40.834|
000342  e00e              B        |L40.866|
                  |L40.836|
000344  f894021f          LDRB     r0,[r4,#0x21f]        ;2308
000348  0601              LSLS     r1,r0,#24             ;2308
00034a  f894021e          LDRB     r0,[r4,#0x21e]        ;2308
00034e  ea414100          ORR      r1,r1,r0,LSL #16      ;2308
000352  f894021d          LDRB     r0,[r4,#0x21d]        ;2308
000356  ea412000          ORR      r0,r1,r0,LSL #8       ;2308
00035a  f894121c          LDRB     r1,[r4,#0x21c]        ;2308
00035e  4308              ORRS     r0,r0,r1              ;2308
000360  60e0              STR      r0,[r4,#0xc]          ;2308
                  |L40.866|
000362  7025              STRB     r5,[r4,#0]            ;2314
000364  4807              LDR      r0,|L40.900|
000366  8800              LDRH     r0,[r0,#0]            ;2315  ; Fsid
000368  1c40              ADDS     r0,r0,#1              ;2315
00036a  b280              UXTH     r0,r0                 ;2315
00036c  4905              LDR      r1,|L40.900|
00036e  8008              STRH     r0,[r1,#0]            ;2315
000370  80e0              STRH     r0,[r4,#6]            ;2315
000372  2000              MOVS     r0,#0                 ;2323
000374  e652              B        |L40.28|
;;;2325   
                          ENDP

000376  0000              DCW      0x0000
                  |L40.888|
                          DCD      FatFs
                  |L40.892|
                          DCD      0x41615252
                  |L40.896|
                          DCD      0x61417272
                  |L40.900|
                          DCD      Fsid

                          AREA ||i.fit_lfn||, CODE, READONLY, ALIGN=2

                  fit_lfn PROC
;;;1371   static
;;;1372   void fit_lfn (
000000  b5f0              PUSH     {r4-r7,lr}
;;;1373   	const WCHAR* lfnbuf,	/* Pointer to the LFN buffer */
;;;1374   	BYTE* dir,				/* Pointer to the directory entry */
;;;1375   	BYTE ord,				/* LFN order (1-20) */
;;;1376   	BYTE sum				/* SFN sum */
;;;1377   )
;;;1378   {
000002  4604              MOV      r4,r0
000004  461d              MOV      r5,r3
;;;1379   	UINT i, s;
;;;1380   	WCHAR wc;
;;;1381   
;;;1382   
;;;1383   	dir[LDIR_Chksum] = sum;			/* Set check sum */
000006  734d              STRB     r5,[r1,#0xd]
;;;1384   	dir[LDIR_Attr] = AM_LFN;		/* Set attribute. LFN entry */
000008  270f              MOVS     r7,#0xf
00000a  72cf              STRB     r7,[r1,#0xb]
;;;1385   	dir[LDIR_Type] = 0;
00000c  2700              MOVS     r7,#0
00000e  730f              STRB     r7,[r1,#0xc]
;;;1386   	ST_WORD(dir+LDIR_FstClusLO, 0);
000010  768f              STRB     r7,[r1,#0x1a]
000012  46bc              MOV      r12,r7
000014  f881c01b          STRB     r12,[r1,#0x1b]
;;;1387   
;;;1388   	i = (ord - 1) * 13;				/* Get offset in the LFN buffer */
000018  1e57              SUBS     r7,r2,#1
00001a  eb070c87          ADD      r12,r7,r7,LSL #2
00001e  eb0c06c7          ADD      r6,r12,r7,LSL #3
;;;1389   	s = wc = 0;
000022  2700              MOVS     r7,#0
000024  4638              MOV      r0,r7
000026  463b              MOV      r3,r7
;;;1390   	do {
000028  bf00              NOP      
                  |L41.42|
;;;1391   		if (wc != 0xFFFF) wc = lfnbuf[i++];	/* Get an effective character */
00002a  f64f77ff          MOV      r7,#0xffff
00002e  42b8              CMP      r0,r7
000030  d003              BEQ      |L41.58|
000032  4637              MOV      r7,r6
000034  1c76              ADDS     r6,r6,#1
000036  f8340017          LDRH     r0,[r4,r7,LSL #1]
                  |L41.58|
;;;1392   		ST_WORD(dir+LfnOfs[s], wc);	/* Put it */
00003a  f8dfc040          LDR      r12,|L41.124|
00003e  f81cc003          LDRB     r12,[r12,r3]
000042  f801000c          STRB     r0,[r1,r12]
000046  1207              ASRS     r7,r0,#8
000048  f8dfc030          LDR      r12,|L41.124|
00004c  f81cc003          LDRB     r12,[r12,r3]
000050  448c              ADD      r12,r12,r1
000052  f88c7001          STRB     r7,[r12,#1]
;;;1393   		if (!wc) wc = 0xFFFF;		/* Padding characters following last character */
000056  b908              CBNZ     r0,|L41.92|
000058  f64f70ff          MOV      r0,#0xffff
                  |L41.92|
;;;1394   	} while (++s < 13);
00005c  1c5f              ADDS     r7,r3,#1
00005e  463b              MOV      r3,r7
000060  2f0d              CMP      r7,#0xd
000062  d3e2              BCC      |L41.42|
;;;1395   	if (wc == 0xFFFF || !lfnbuf[i]) ord |= LLE;	/* Bottom LFN part is the start of LFN sequence */
000064  f64f77ff          MOV      r7,#0xffff
000068  42b8              CMP      r0,r7
00006a  d002              BEQ      |L41.114|
00006c  f8347016          LDRH     r7,[r4,r6,LSL #1]
000070  b90f              CBNZ     r7,|L41.118|
                  |L41.114|
000072  f0420240          ORR      r2,r2,#0x40
                  |L41.118|
;;;1396   	dir[LDIR_Ord] = ord;			/* Set the LFN order */
000076  700a              STRB     r2,[r1,#0]
;;;1397   }
000078  bdf0              POP      {r4-r7,pc}
;;;1398   
                          ENDP

00007a  0000              DCW      0x0000
                  |L41.124|
                          DCD      LfnOfs

                          AREA ||i.follow_path||, CODE, READONLY, ALIGN=1

                  follow_path PROC
;;;2013   static
;;;2014   FRESULT follow_path (	/* FR_OK(0): successful, !=0: error code */
000000  e92d41f3          PUSH     {r0,r1,r4-r8,lr}
;;;2015   	DIR* dp,			/* Directory object to return last directory and found object */
;;;2016   	const TCHAR* path	/* Full-path string to find a file or directory */
;;;2017   )
;;;2018   {
000004  4604              MOV      r4,r0
;;;2019   	FRESULT res;
;;;2020   	BYTE *dir, ns;
;;;2021   
;;;2022   
;;;2023   #if _FS_RPATH
;;;2024   	if (*path == '/' || *path == '\\') {	/* There is a heading separator */
;;;2025   		path++;	dp->sclust = 0;				/* Strip it and start from the root directory */
;;;2026   	} else {								/* No heading separator */
;;;2027   		dp->sclust = dp->fs->cdir;			/* Start from the current directory */
;;;2028   	}
;;;2029   #else
;;;2030   	if (*path == '/' || *path == '\\')		/* Strip heading separator if exist */
000006  9801              LDR      r0,[sp,#4]
000008  7800              LDRB     r0,[r0,#0]
00000a  282f              CMP      r0,#0x2f
00000c  d003              BEQ      |L42.22|
00000e  9801              LDR      r0,[sp,#4]
000010  7800              LDRB     r0,[r0,#0]
000012  285c              CMP      r0,#0x5c
000014  d102              BNE      |L42.28|
                  |L42.22|
;;;2031   		path++;
000016  9801              LDR      r0,[sp,#4]
000018  1c40              ADDS     r0,r0,#1
00001a  9001              STR      r0,[sp,#4]
                  |L42.28|
;;;2032   	dp->sclust = 0;							/* Always start from the root directory */
00001c  2000              MOVS     r0,#0
00001e  60a0              STR      r0,[r4,#8]
;;;2033   #endif
;;;2034   
;;;2035   	if ((UINT)*path < ' ') {				/* Null path name is the origin directory itself */
000020  9801              LDR      r0,[sp,#4]
000022  7800              LDRB     r0,[r0,#0]
000024  2820              CMP      r0,#0x20
000026  d207              BCS      |L42.56|
;;;2036   		res = dir_sdi(dp, 0);
000028  2100              MOVS     r1,#0
00002a  4620              MOV      r0,r4
00002c  f7fffffe          BL       dir_sdi
000030  4605              MOV      r5,r0
;;;2037   		dp->dir = 0;
000032  2000              MOVS     r0,#0
000034  6160              STR      r0,[r4,#0x14]
000036  e028              B        |L42.138|
                  |L42.56|
;;;2038   	} else {								/* Follow path */
;;;2039   		for (;;) {
000038  bf00              NOP      
                  |L42.58|
;;;2040   			res = create_name(dp, &path);	/* Get a segment name of the path */
00003a  a901              ADD      r1,sp,#4
00003c  4620              MOV      r0,r4
00003e  f7fffffe          BL       create_name
000042  4605              MOV      r5,r0
;;;2041   			if (res != FR_OK) break;
000044  b105              CBZ      r5,|L42.72|
000046  e01f              B        |L42.136|
                  |L42.72|
;;;2042   			res = dir_find(dp);				/* Find an object with the sagment name */
000048  4620              MOV      r0,r4
00004a  f7fffffe          BL       dir_find
00004e  4605              MOV      r5,r0
;;;2043   			ns = dp->fn[NS];
000050  69a0              LDR      r0,[r4,#0x18]
000052  7ac6              LDRB     r6,[r0,#0xb]
;;;2044   			if (res != FR_OK) {				/* Failed to find the object */
000054  b13d              CBZ      r5,|L42.102|
;;;2045   				if (res == FR_NO_FILE) {	/* Object is not found */
000056  2d04              CMP      r5,#4
000058  d104              BNE      |L42.100|
;;;2046   					if (_FS_RPATH && (ns & NS_DOT)) {	/* If dot entry is not exist, */
00005a  bf00              NOP      
;;;2047   						dp->sclust = 0; dp->dir = 0;	/* it is the root directory and stay there */
;;;2048   						if (!(ns & NS_LAST)) continue;	/* Continue to follow if not last segment */
;;;2049   						res = FR_OK;					/* Ended at the root directroy. Function completed. */
;;;2050   					} else {							/* Could not find the object */
;;;2051   						if (!(ns & NS_LAST)) res = FR_NO_PATH;	/* Adjust error code if not last segment */
00005c  f0060004          AND      r0,r6,#4
000060  b900              CBNZ     r0,|L42.100|
000062  2505              MOVS     r5,#5
                  |L42.100|
;;;2052   					}
;;;2053   				}
;;;2054   				break;
000064  e010              B        |L42.136|
                  |L42.102|
;;;2055   			}
;;;2056   			if (ns & NS_LAST) break;			/* Last segment matched. Function completed. */
000066  f0060004          AND      r0,r6,#4
00006a  b100              CBZ      r0,|L42.110|
00006c  e00c              B        |L42.136|
                  |L42.110|
;;;2057   			dir = dp->dir;						/* Follow the sub-directory */
00006e  6967              LDR      r7,[r4,#0x14]
;;;2058   			if (!(dir[DIR_Attr] & AM_DIR)) {	/* It is not a sub-directory and cannot follow */
000070  7af8              LDRB     r0,[r7,#0xb]
000072  f0000010          AND      r0,r0,#0x10
000076  b908              CBNZ     r0,|L42.124|
;;;2059   				res = FR_NO_PATH; break;
000078  2505              MOVS     r5,#5
00007a  e005              B        |L42.136|
                  |L42.124|
;;;2060   			}
;;;2061   			dp->sclust = ld_clust(dp->fs, dir);
00007c  4639              MOV      r1,r7
00007e  6820              LDR      r0,[r4,#0]
000080  f7fffffe          BL       ld_clust
000084  60a0              STR      r0,[r4,#8]
000086  e7d8              B        |L42.58|
                  |L42.136|
000088  bf00              NOP                            ;2041
                  |L42.138|
;;;2062   		}
;;;2063   	}
;;;2064   
;;;2065   	return res;
00008a  4628              MOV      r0,r5
;;;2066   }
00008c  e8bd81fc          POP      {r2-r8,pc}
;;;2067   
                          ENDP


                          AREA ||i.gen_numname||, CODE, READONLY, ALIGN=2

                  gen_numname PROC
;;;1409   static
;;;1410   void gen_numname (
000000  e92d47fc          PUSH     {r2-r10,lr}
;;;1411   	BYTE* dst,			/* Pointer to the buffer to store numbered SFN */
;;;1412   	const BYTE* src,	/* Pointer to SFN */
;;;1413   	const WCHAR* lfn,	/* Pointer to LFN */
;;;1414   	UINT seq			/* Sequence number */
;;;1415   )
;;;1416   {
000004  4607              MOV      r7,r0
000006  468a              MOV      r10,r1
000008  4690              MOV      r8,r2
00000a  461e              MOV      r6,r3
;;;1417   	BYTE ns[8], c;
;;;1418   	UINT i, j;
;;;1419   
;;;1420   
;;;1421   	mem_cpy(dst, src, 11);
00000c  220b              MOVS     r2,#0xb
00000e  4651              MOV      r1,r10
000010  4638              MOV      r0,r7
000012  f7fffffe          BL       mem_cpy
;;;1422   
;;;1423   	if (seq > 5) {	/* On many collisions, generate a hash number instead of sequential number */
000016  2e05              CMP      r6,#5
000018  d918              BLS      |L43.76|
;;;1424   		WCHAR wc;
;;;1425   		DWORD sr = seq;
00001a  4630              MOV      r0,r6
;;;1426   
;;;1427   		while (*lfn) {	/* Create a CRC */
00001c  e010              B        |L43.64|
                  |L43.30|
;;;1428   			wc = *lfn++;
00001e  f8381b02          LDRH     r1,[r8],#2
;;;1429   			for (i = 0; i < 16; i++) {
000022  2500              MOVS     r5,#0
000024  e00a              B        |L43.60|
                  |L43.38|
;;;1430   				sr = (sr << 1) + (wc & 1);
000026  460a              MOV      r2,r1
000028  f360025f          BFI      r2,r0,#1,#31
00002c  4610              MOV      r0,r2
;;;1431   				wc >>= 1;
00002e  1049              ASRS     r1,r1,#1
;;;1432   				if (sr & 0x10000) sr ^= 0x11021;
000030  f4003280          AND      r2,r0,#0x10000
000034  b10a              CBZ      r2,|L43.58|
000036  4a23              LDR      r2,|L43.196|
000038  4050              EORS     r0,r0,r2
                  |L43.58|
00003a  1c6d              ADDS     r5,r5,#1              ;1429
                  |L43.60|
00003c  2d10              CMP      r5,#0x10              ;1429
00003e  d3f2              BCC      |L43.38|
                  |L43.64|
000040  f8b82000          LDRH     r2,[r8,#0]            ;1427
000044  2a00              CMP      r2,#0                 ;1427
000046  d1ea              BNE      |L43.30|
;;;1433   			}
;;;1434   		}
;;;1435   		seq = (UINT)sr;
000048  4606              MOV      r6,r0
;;;1436   	}
00004a  bf00              NOP      
                  |L43.76|
;;;1437   
;;;1438   	/* itoa (hexdecimal) */
;;;1439   	i = 7;
00004c  2507              MOVS     r5,#7
;;;1440   	do {
00004e  bf00              NOP      
                  |L43.80|
;;;1441   		c = (seq % 16) + '0';
000050  f006000f          AND      r0,r6,#0xf
000054  f1000930          ADD      r9,r0,#0x30
;;;1442   		if (c > '9') c += 7;
000058  f1b90f39          CMP      r9,#0x39
00005c  dd03              BLE      |L43.102|
00005e  f1090007          ADD      r0,r9,#7
000062  f00009ff          AND      r9,r0,#0xff
                  |L43.102|
;;;1443   		ns[i--] = c;
000066  4628              MOV      r0,r5
000068  1e6d              SUBS     r5,r5,#1
00006a  f80d9000          STRB     r9,[sp,r0]
;;;1444   		seq /= 16;
00006e  0936              LSRS     r6,r6,#4
;;;1445   	} while (seq);
000070  2e00              CMP      r6,#0
000072  d1ed              BNE      |L43.80|
;;;1446   	ns[i] = '~';
000074  207e              MOVS     r0,#0x7e
000076  f80d0005          STRB     r0,[sp,r5]
;;;1447   
;;;1448   	/* Append the number */
;;;1449   	for (j = 0; j < i && dst[j] != ' '; j++) {
00007a  2400              MOVS     r4,#0
00007c  e00b              B        |L43.150|
                  |L43.126|
;;;1450   		if (IsDBCS1(dst[j])) {
00007e  5d38              LDRB     r0,[r7,r4]
000080  2881              CMP      r0,#0x81
000082  db07              BLT      |L43.148|
000084  5d38              LDRB     r0,[r7,r4]
000086  28fe              CMP      r0,#0xfe
000088  dc04              BGT      |L43.148|
;;;1451   			if (j == i - 1) break;
00008a  1e68              SUBS     r0,r5,#1
00008c  42a0              CMP      r0,r4
00008e  d100              BNE      |L43.146|
000090  e006              B        |L43.160|
                  |L43.146|
;;;1452   			j++;
000092  1c64              ADDS     r4,r4,#1
                  |L43.148|
000094  1c64              ADDS     r4,r4,#1              ;1449
                  |L43.150|
000096  42ac              CMP      r4,r5                 ;1449
000098  d202              BCS      |L43.160|
00009a  5d38              LDRB     r0,[r7,r4]            ;1449
00009c  2820              CMP      r0,#0x20              ;1449
00009e  d1ee              BNE      |L43.126|
                  |L43.160|
0000a0  bf00              NOP                            ;1451
;;;1453   		}
;;;1454   	}
;;;1455   	do {
0000a2  bf00              NOP      
                  |L43.164|
;;;1456   		dst[j++] = (i < 8) ? ns[i++] : ' ';
0000a4  2d08              CMP      r5,#8
0000a6  d204              BCS      |L43.178|
0000a8  4628              MOV      r0,r5
0000aa  1c6d              ADDS     r5,r5,#1
0000ac  f81d1000          LDRB     r1,[sp,r0]
0000b0  e000              B        |L43.180|
                  |L43.178|
0000b2  2120              MOVS     r1,#0x20
                  |L43.180|
0000b4  4620              MOV      r0,r4
0000b6  1c64              ADDS     r4,r4,#1
0000b8  5439              STRB     r1,[r7,r0]
;;;1457   	} while (j < 8);
0000ba  2c08              CMP      r4,#8
0000bc  d3f2              BCC      |L43.164|
;;;1458   }
0000be  e8bd87fc          POP      {r2-r10,pc}
;;;1459   #endif
                          ENDP

0000c2  0000              DCW      0x0000
                  |L43.196|
                          DCD      0x00011021

                          AREA ||i.get_fat||, CODE, READONLY, ALIGN=1

                  get_fat PROC
;;;864    
;;;865    DWORD get_fat (	/* 0xFFFFFFFF:Disk error, 1:Internal error, Else:Cluster status */
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;866    	FATFS* fs,	/* File system object */
;;;867    	DWORD clst	/* Cluster# to get the link information */
;;;868    )
;;;869    {
000004  4605              MOV      r5,r0
000006  460c              MOV      r4,r1
;;;870    	UINT wc, bc;
;;;871    	BYTE *p;
;;;872    
;;;873    
;;;874    	if (clst < 2 || clst >= fs->n_fatent)	/* Check range */
000008  2c02              CMP      r4,#2
00000a  d302              BCC      |L44.18|
00000c  6968              LDR      r0,[r5,#0x14]
00000e  42a0              CMP      r0,r4
000010  d802              BHI      |L44.24|
                  |L44.18|
;;;875    		return 1;
000012  2001              MOVS     r0,#1
                  |L44.20|
;;;876    
;;;877    	switch (fs->fs_type) {
;;;878    	case FS_FAT12 :
;;;879    		bc = (UINT)clst; bc += bc / 2;
;;;880    		if (move_window(fs, fs->fatbase + (bc / SS(fs)))) break;
;;;881    		wc = fs->win[bc % SS(fs)]; bc++;
;;;882    		if (move_window(fs, fs->fatbase + (bc / SS(fs)))) break;
;;;883    		wc |= fs->win[bc % SS(fs)] << 8;
;;;884    		return clst & 1 ? wc >> 4 : (wc & 0xFFF);
;;;885    
;;;886    	case FS_FAT16 :
;;;887    		if (move_window(fs, fs->fatbase + (clst / (SS(fs) / 2)))) break;
;;;888    		p = &fs->win[clst * 2 % SS(fs)];
;;;889    		return LD_WORD(p);
;;;890    
;;;891    	case FS_FAT32 :
;;;892    		if (move_window(fs, fs->fatbase + (clst / (SS(fs) / 4)))) break;
;;;893    		p = &fs->win[clst * 4 % SS(fs)];
;;;894    		return LD_DWORD(p) & 0x0FFFFFFF;
;;;895    
;;;896    	default:
;;;897    		return 1;
;;;898    	}
;;;899    
;;;900    	return 0xFFFFFFFF;	/* An error occurred at the disk I/O layer */
;;;901    }
000014  e8bd81f0          POP      {r4-r8,pc}
                  |L44.24|
000018  7828              LDRB     r0,[r5,#0]            ;877
00001a  2801              CMP      r0,#1                 ;877
00001c  d004              BEQ      |L44.40|
00001e  2802              CMP      r0,#2                 ;877
000020  d02c              BEQ      |L44.124|
000022  2803              CMP      r0,#3                 ;877
000024  d15a              BNE      |L44.220|
000026  e03d              B        |L44.164|
                  |L44.40|
000028  4627              MOV      r7,r4                 ;879
00002a  eb070757          ADD      r7,r7,r7,LSR #1       ;879
00002e  6a28              LDR      r0,[r5,#0x20]         ;880
000030  eb002157          ADD      r1,r0,r7,LSR #9       ;880
000034  4628              MOV      r0,r5                 ;880
000036  f7fffffe          BL       move_window
00003a  b100              CBZ      r0,|L44.62|
00003c  e050              B        |L44.224|
                  |L44.62|
00003e  f3c70108          UBFX     r1,r7,#0,#9           ;881
000042  f1050030          ADD      r0,r5,#0x30           ;881
000046  f8108001          LDRB     r8,[r0,r1]            ;881
00004a  1c7f              ADDS     r7,r7,#1              ;881
00004c  6a28              LDR      r0,[r5,#0x20]         ;882
00004e  eb002157          ADD      r1,r0,r7,LSR #9       ;882
000052  4628              MOV      r0,r5                 ;882
000054  f7fffffe          BL       move_window
000058  b100              CBZ      r0,|L44.92|
00005a  e041              B        |L44.224|
                  |L44.92|
00005c  f3c70108          UBFX     r1,r7,#0,#9           ;883
000060  f1050030          ADD      r0,r5,#0x30           ;883
000064  5c40              LDRB     r0,[r0,r1]            ;883
000066  ea482800          ORR      r8,r8,r0,LSL #8       ;883
00006a  f0040001          AND      r0,r4,#1              ;884
00006e  b110              CBZ      r0,|L44.118|
000070  ea4f1018          LSR      r0,r8,#4              ;884
000074  e7ce              B        |L44.20|
                  |L44.118|
000076  f3c8000b          UBFX     r0,r8,#0,#12          ;884
00007a  e7cb              B        |L44.20|
                  |L44.124|
00007c  6a28              LDR      r0,[r5,#0x20]         ;887
00007e  eb002114          ADD      r1,r0,r4,LSR #8       ;887
000082  4628              MOV      r0,r5                 ;887
000084  f7fffffe          BL       move_window
000088  b100              CBZ      r0,|L44.140|
00008a  e029              B        |L44.224|
                  |L44.140|
00008c  f24010ff          MOV      r0,#0x1ff             ;888
000090  ea000144          AND      r1,r0,r4,LSL #1       ;888
000094  f1050030          ADD      r0,r5,#0x30           ;888
000098  180e              ADDS     r6,r1,r0              ;888
00009a  7830              LDRB     r0,[r6,#0]            ;889
00009c  7871              LDRB     r1,[r6,#1]            ;889
00009e  ea402001          ORR      r0,r0,r1,LSL #8       ;889
0000a2  e7b7              B        |L44.20|
                  |L44.164|
0000a4  6a28              LDR      r0,[r5,#0x20]         ;892
0000a6  eb0011d4          ADD      r1,r0,r4,LSR #7       ;892
0000aa  4628              MOV      r0,r5                 ;892
0000ac  f7fffffe          BL       move_window
0000b0  b100              CBZ      r0,|L44.180|
0000b2  e015              B        |L44.224|
                  |L44.180|
0000b4  f24010ff          MOV      r0,#0x1ff             ;893
0000b8  ea000184          AND      r1,r0,r4,LSL #2       ;893
0000bc  f1050030          ADD      r0,r5,#0x30           ;893
0000c0  180e              ADDS     r6,r1,r0              ;893
0000c2  78f0              LDRB     r0,[r6,#3]            ;894
0000c4  0600              LSLS     r0,r0,#24             ;894
0000c6  78b1              LDRB     r1,[r6,#2]            ;894
0000c8  ea404001          ORR      r0,r0,r1,LSL #16      ;894
0000cc  7871              LDRB     r1,[r6,#1]            ;894
0000ce  ea402001          ORR      r0,r0,r1,LSL #8       ;894
0000d2  7831              LDRB     r1,[r6,#0]            ;894
0000d4  4308              ORRS     r0,r0,r1              ;894
0000d6  f0204070          BIC      r0,r0,#0xf0000000     ;894
0000da  e79b              B        |L44.20|
                  |L44.220|
0000dc  2001              MOVS     r0,#1                 ;897
0000de  e799              B        |L44.20|
                  |L44.224|
0000e0  bf00              NOP                            ;880
0000e2  f04f30ff          MOV      r0,#0xffffffff        ;900
0000e6  e795              B        |L44.20|
;;;902    
                          ENDP


                          AREA ||i.get_fileinfo||, CODE, READONLY, ALIGN=1

                  get_fileinfo PROC
;;;1733   static
;;;1734   void get_fileinfo (		/* No return code */
000000  e92d47f0          PUSH     {r4-r10,lr}
;;;1735   	DIR* dp,			/* Pointer to the directory object */
;;;1736   	FILINFO* fno	 	/* Pointer to the file information to be filled */
;;;1737   )
;;;1738   {
000004  4607              MOV      r7,r0
000006  460c              MOV      r4,r1
;;;1739   	UINT i;
;;;1740   	TCHAR *p, c;
;;;1741   
;;;1742   
;;;1743   	p = fno->fname;
000008  f1040609          ADD      r6,r4,#9
;;;1744   	if (dp->sect) {		/* Get SFN */
00000c  6938              LDR      r0,[r7,#0x10]
00000e  2800              CMP      r0,#0
000010  d043              BEQ      |L45.154|
;;;1745   		BYTE *dir = dp->dir;
000012  6978              LDR      r0,[r7,#0x14]
;;;1746   
;;;1747   		i = 0;
000014  2500              MOVS     r5,#0
;;;1748   		while (i < 11) {		/* Copy name body and extension */
000016  e026              B        |L45.102|
                  |L45.24|
;;;1749   			c = (TCHAR)dir[i++];
000018  4629              MOV      r1,r5
00001a  1c6d              ADDS     r5,r5,#1
00001c  f8108001          LDRB     r8,[r0,r1]
;;;1750   			if (c == ' ') continue;			/* Skip padding spaces */
000020  f1b80f20          CMP      r8,#0x20
000024  d100              BNE      |L45.40|
000026  e01e              B        |L45.102|
                  |L45.40|
;;;1751   			if (c == NDDE) c = (TCHAR)DDE;	/* Restore replaced DDE character */
000028  f1b80f05          CMP      r8,#5
00002c  d101              BNE      |L45.50|
00002e  f04f08e5          MOV      r8,#0xe5
                  |L45.50|
;;;1752   			if (i == 9) *p++ = '.';			/* Insert a . if extension is exist */
000032  2d09              CMP      r5,#9
000034  d102              BNE      |L45.60|
000036  212e              MOVS     r1,#0x2e
000038  f8061b01          STRB     r1,[r6],#1
                  |L45.60|
;;;1753   #if _USE_LFN
;;;1754   			if (IsUpper(c) && (dir[DIR_NTres] & (i >= 9 ? NS_EXT : NS_BODY)))
00003c  f1b80f41          CMP      r8,#0x41
000040  db0e              BLT      |L45.96|
000042  f1b80f5a          CMP      r8,#0x5a
000046  dc0b              BGT      |L45.96|
000048  7b01              LDRB     r1,[r0,#0xc]
00004a  2d09              CMP      r5,#9
00004c  d301              BCC      |L45.82|
00004e  2210              MOVS     r2,#0x10
000050  e000              B        |L45.84|
                  |L45.82|
000052  2208              MOVS     r2,#8
                  |L45.84|
000054  4011              ANDS     r1,r1,r2
000056  b119              CBZ      r1,|L45.96|
;;;1755   				c += 0x20;			/* To lower */
000058  f1080120          ADD      r1,r8,#0x20
00005c  f00108ff          AND      r8,r1,#0xff
                  |L45.96|
;;;1756   #if _LFN_UNICODE
;;;1757   			if (IsDBCS1(c) && i != 8 && i != 11 && IsDBCS2(dir[i]))
;;;1758   				c = c << 8 | dir[i++];
;;;1759   			c = ff_convert(c, 1);	/* OEM -> Unicode */
;;;1760   			if (!c) c = '?';
;;;1761   #endif
;;;1762   #endif
;;;1763   			*p++ = c;
000060  f8068b01          STRB     r8,[r6],#1
000064  bf00              NOP                            ;1750
                  |L45.102|
000066  2d0b              CMP      r5,#0xb               ;1748
000068  d3d6              BCC      |L45.24|
;;;1764   		}
;;;1765   		fno->fattrib = dir[DIR_Attr];				/* Attribute */
00006a  7ac1              LDRB     r1,[r0,#0xb]
00006c  7221              STRB     r1,[r4,#8]
;;;1766   		fno->fsize = LD_DWORD(dir+DIR_FileSize);	/* Size */
00006e  7fc1              LDRB     r1,[r0,#0x1f]
000070  060a              LSLS     r2,r1,#24
000072  7f81              LDRB     r1,[r0,#0x1e]
000074  ea424201          ORR      r2,r2,r1,LSL #16
000078  7f41              LDRB     r1,[r0,#0x1d]
00007a  ea422101          ORR      r1,r2,r1,LSL #8
00007e  7f02              LDRB     r2,[r0,#0x1c]
000080  4311              ORRS     r1,r1,r2
000082  6021              STR      r1,[r4,#0]
;;;1767   		fno->fdate = LD_WORD(dir+DIR_WrtDate);		/* Date */
000084  7e02              LDRB     r2,[r0,#0x18]
000086  7e41              LDRB     r1,[r0,#0x19]
000088  ea422101          ORR      r1,r2,r1,LSL #8
00008c  80a1              STRH     r1,[r4,#4]
;;;1768   		fno->ftime = LD_WORD(dir+DIR_WrtTime);		/* Time */
00008e  7d82              LDRB     r2,[r0,#0x16]
000090  7dc1              LDRB     r1,[r0,#0x17]
000092  ea422101          ORR      r1,r2,r1,LSL #8
000096  80e1              STRH     r1,[r4,#6]
;;;1769   	}
000098  bf00              NOP      
                  |L45.154|
;;;1770   	*p = 0;		/* Terminate SFN string by a \0 */
00009a  2000              MOVS     r0,#0
00009c  7030              STRB     r0,[r6,#0]
;;;1771   
;;;1772   #if _USE_LFN
;;;1773   	if (fno->lfname) {
00009e  69a0              LDR      r0,[r4,#0x18]
0000a0  b390              CBZ      r0,|L45.264|
;;;1774   		WCHAR w, *lfn;
;;;1775   
;;;1776   		i = 0; p = fno->lfname;
0000a2  2500              MOVS     r5,#0
0000a4  69a6              LDR      r6,[r4,#0x18]
;;;1777   		if (dp->sect && fno->lfsize && dp->lfn_idx != 0xFFFF) {	/* Get LFN if available */
0000a6  6938              LDR      r0,[r7,#0x10]
0000a8  b358              CBZ      r0,|L45.258|
0000aa  69e0              LDR      r0,[r4,#0x1c]
0000ac  b348              CBZ      r0,|L45.258|
0000ae  8c38              LDRH     r0,[r7,#0x20]
0000b0  f64f71ff          MOV      r1,#0xffff
0000b4  4288              CMP      r0,r1
0000b6  d024              BEQ      |L45.258|
;;;1778   			lfn = dp->lfn;
0000b8  f8d7a01c          LDR      r10,[r7,#0x1c]
;;;1779   			while ((w = *lfn++) != 0) {		/* Get an LFN character */
0000bc  e01b              B        |L45.246|
                  |L45.190|
;;;1780   #if !_LFN_UNICODE
;;;1781   				w = ff_convert(w, 0);		/* Unicode -> OEM */
0000be  2100              MOVS     r1,#0
0000c0  4648              MOV      r0,r9
0000c2  f7fffffe          BL       ff_convert
0000c6  4681              MOV      r9,r0
;;;1782   				if (!w) { i = 0; break; }	/* No LFN if it could not be converted */
0000c8  f1b90f00          CMP      r9,#0
0000cc  d101              BNE      |L45.210|
0000ce  2500              MOVS     r5,#0
0000d0  e016              B        |L45.256|
                  |L45.210|
;;;1783   				if (_DF1S && w >= 0x100)	/* Put 1st byte if it is a DBC (always false on SBCS cfg) */
0000d2  f1b90fff          CMP      r9,#0xff
0000d6  dd04              BLE      |L45.226|
;;;1784   					p[i++] = (TCHAR)(w >> 8);
0000d8  ea4f2229          ASR      r2,r9,#8
0000dc  4628              MOV      r0,r5
0000de  1c6d              ADDS     r5,r5,#1
0000e0  5432              STRB     r2,[r6,r0]
                  |L45.226|
;;;1785   #endif
;;;1786   				if (i >= fno->lfsize - 1) { i = 0; break; }	/* No LFN if buffer overflow */
0000e2  69e0              LDR      r0,[r4,#0x1c]
0000e4  1e40              SUBS     r0,r0,#1
0000e6  42a8              CMP      r0,r5
0000e8  d801              BHI      |L45.238|
0000ea  2500              MOVS     r5,#0
0000ec  e008              B        |L45.256|
                  |L45.238|
;;;1787   				p[i++] = (TCHAR)w;
0000ee  4628              MOV      r0,r5
0000f0  1c6d              ADDS     r5,r5,#1
0000f2  f8069000          STRB     r9,[r6,r0]
                  |L45.246|
0000f6  f83a1b02          LDRH     r1,[r10],#2           ;1779
0000fa  f1b10900          SUBS     r9,r1,#0              ;1779
0000fe  d1de              BNE      |L45.190|
                  |L45.256|
000100  bf00              NOP                            ;1782
                  |L45.258|
;;;1788   			}
;;;1789   		}
;;;1790   		p[i] = 0;	/* Terminate LFN string by a \0 */
000102  2000              MOVS     r0,#0
000104  5570              STRB     r0,[r6,r5]
;;;1791   	}
000106  bf00              NOP      
                  |L45.264|
;;;1792   #endif
;;;1793   }
000108  e8bd87f0          POP      {r4-r10,pc}
;;;1794   #endif /* _FS_MINIMIZE <= 1 || _FS_RPATH >= 2*/
                          ENDP


                          AREA ||i.get_ldnumber||, CODE, READONLY, ALIGN=1

                  get_ldnumber PROC
;;;2075   static
;;;2076   int get_ldnumber (		/* Returns logical drive number (-1:invalid drive) */
000000  b570              PUSH     {r4-r6,lr}
;;;2077   	const TCHAR** path	/* Pointer to pointer to the path name */
;;;2078   )
;;;2079   {
000002  4602              MOV      r2,r0
;;;2080   	const TCHAR *tp, *tt;
;;;2081   	UINT i;
;;;2082   	int vol = -1;
000004  f04f30ff          MOV      r0,#0xffffffff
;;;2083   
;;;2084   
;;;2085   	if (*path) {	/* If the pointer is not a null */
000008  6815              LDR      r5,[r2,#0]
00000a  b1e5              CBZ      r5,|L46.70|
;;;2086   		for (tt = *path; (UINT)*tt >= (_USE_LFN ? ' ' : '!') && *tt != ':'; tt++) ;	/* Find ':' in the path */
00000c  6811              LDR      r1,[r2,#0]
00000e  e000              B        |L46.18|
                  |L46.16|
000010  1c49              ADDS     r1,r1,#1
                  |L46.18|
000012  780d              LDRB     r5,[r1,#0]
000014  2d20              CMP      r5,#0x20
000016  d302              BCC      |L46.30|
000018  780d              LDRB     r5,[r1,#0]
00001a  2d3a              CMP      r5,#0x3a
00001c  d1f8              BNE      |L46.16|
                  |L46.30|
;;;2087   		if (*tt == ':') {	/* If a ':' is exist in the path name */
00001e  780d              LDRB     r5,[r1,#0]
000020  2d3a              CMP      r5,#0x3a
000022  d10f              BNE      |L46.68|
;;;2088   			tp = *path;
000024  6814              LDR      r4,[r2,#0]
;;;2089   			i = *tp++ - '0'; 
000026  f8145b01          LDRB     r5,[r4],#1
00002a  f1a50330          SUB      r3,r5,#0x30
;;;2090   			if (i < 10 && tp == tt) {	/* Is there a numeric drive id? */
00002e  2b0a              CMP      r3,#0xa
000030  d207              BCS      |L46.66|
000032  428c              CMP      r4,r1
000034  d105              BNE      |L46.66|
;;;2091   				if (i < _VOLUMES) {	/* If a drive id is found, get the value and strip it */
000036  2b03              CMP      r3,#3
000038  d203              BCS      |L46.66|
;;;2092   					vol = (int)i;
00003a  4618              MOV      r0,r3
;;;2093   					*path = ++tt;
00003c  1c4d              ADDS     r5,r1,#1
00003e  4629              MOV      r1,r5
000040  6015              STR      r5,[r2,#0]
                  |L46.66|
;;;2094   				}
;;;2095   			} else {	/* No numeric drive number */
;;;2096   #if _STR_VOLUME_ID		/* Find string drive id */
;;;2097   				static const char* const str[] = {_VOLUME_STRS};
;;;2098   				const char *sp;
;;;2099   				char c;
;;;2100   				TCHAR tc;
;;;2101   
;;;2102   				i = 0; tt++;
;;;2103   				do {
;;;2104   					sp = str[i]; tp = *path;
;;;2105   					do {	/* Compare a string drive id with path name */
;;;2106   						c = *sp++; tc = *tp++;
;;;2107   						if (IsLower(tc)) tc -= 0x20;
;;;2108   					} while (c && (TCHAR)c == tc);
;;;2109   				} while ((c || tp != tt) && ++i < _VOLUMES);	/* Repeat for each id until pattern match */
;;;2110   				if (i < _VOLUMES) {	/* If a drive id is found, get the value and strip it */
;;;2111   					vol = (int)i;
;;;2112   					*path = tt;
;;;2113   				}
;;;2114   #endif
;;;2115   			}
;;;2116   			return vol;
;;;2117   		}
;;;2118   #if _FS_RPATH && _VOLUMES >= 2
;;;2119   		vol = CurrVol;	/* Current drive */
;;;2120   #else
;;;2121   		vol = 0;		/* Drive 0 */
;;;2122   #endif
;;;2123   	}
;;;2124   	return vol;
;;;2125   }
000042  bd70              POP      {r4-r6,pc}
                  |L46.68|
000044  2000              MOVS     r0,#0                 ;2121
                  |L46.70|
000046  bf00              NOP                            ;2124
000048  e7fb              B        |L46.66|
;;;2126   
                          ENDP


                          AREA ||i.ld_clust||, CODE, READONLY, ALIGN=1

                  ld_clust PROC
;;;1268   static
;;;1269   DWORD ld_clust (
000000  b510              PUSH     {r4,lr}
;;;1270   	FATFS* fs,	/* Pointer to the fs object */
;;;1271   	BYTE* dir	/* Pointer to the directory entry */
;;;1272   )
;;;1273   {
000002  4602              MOV      r2,r0
;;;1274   	DWORD cl;
;;;1275   
;;;1276   	cl = LD_WORD(dir+DIR_FstClusLO);
000004  7e8c              LDRB     r4,[r1,#0x1a]
000006  7ecb              LDRB     r3,[r1,#0x1b]
000008  ea442003          ORR      r0,r4,r3,LSL #8
;;;1277   	if (fs->fs_type == FS_FAT32)
00000c  7813              LDRB     r3,[r2,#0]
00000e  2b03              CMP      r3,#3
000010  d105              BNE      |L47.30|
;;;1278   		cl |= (DWORD)LD_WORD(dir+DIR_FstClusHI) << 16;
000012  7d0c              LDRB     r4,[r1,#0x14]
000014  7d4b              LDRB     r3,[r1,#0x15]
000016  ea442303          ORR      r3,r4,r3,LSL #8
00001a  ea404003          ORR      r0,r0,r3,LSL #16
                  |L47.30|
;;;1279   
;;;1280   	return cl;
;;;1281   }
00001e  bd10              POP      {r4,pc}
;;;1282   
                          ENDP


                          AREA ||i.mem_cmp||, CODE, READONLY, ALIGN=1

                  mem_cmp PROC
;;;587    static
;;;588    int mem_cmp (const void* dst, const void* src, UINT cnt) {
000000  b5f0              PUSH     {r4-r7,lr}
000002  4603              MOV      r3,r0
;;;589    	const BYTE *d = (const BYTE *)dst, *s = (const BYTE *)src;
000004  461c              MOV      r4,r3
000006  460d              MOV      r5,r1
;;;590    	int r = 0;
000008  2000              MOVS     r0,#0
;;;591    
;;;592    	while (cnt-- && (r = *d++ - *s++) == 0) ;
00000a  bf00              NOP      
                  |L48.12|
00000c  1e16              SUBS     r6,r2,#0
00000e  f1a20201          SUB      r2,r2,#1
000012  d007              BEQ      |L48.36|
000014  f8147b01          LDRB     r7,[r4],#1
000018  f815cb01          LDRB     r12,[r5],#1
00001c  eba7060c          SUB      r6,r7,r12
000020  1e30              SUBS     r0,r6,#0
000022  d0f3              BEQ      |L48.12|
                  |L48.36|
;;;593    	return r;
;;;594    }
000024  bdf0              POP      {r4-r7,pc}
;;;595    
                          ENDP


                          AREA ||i.mem_cpy||, CODE, READONLY, ALIGN=1

                  mem_cpy PROC
;;;561    static
;;;562    void mem_cpy (void* dst, const void* src, UINT cnt) {
000000  b570              PUSH     {r4-r6,lr}
;;;563    	BYTE *d = (BYTE*)dst;
000002  4603              MOV      r3,r0
;;;564    	const BYTE *s = (const BYTE*)src;
000004  460c              MOV      r4,r1
;;;565    
;;;566    #if _WORD_ACCESS == 1
;;;567    	while (cnt >= sizeof (int)) {
;;;568    		*(int*)d = *(int*)s;
;;;569    		d += sizeof (int); s += sizeof (int);
;;;570    		cnt -= sizeof (int);
;;;571    	}
;;;572    #endif
;;;573    	while (cnt--)
000006  e003              B        |L49.16|
                  |L49.8|
;;;574    		*d++ = *s++;
000008  f8145b01          LDRB     r5,[r4],#1
00000c  f8035b01          STRB     r5,[r3],#1
                  |L49.16|
000010  1e15              SUBS     r5,r2,#0              ;573
000012  f1a20201          SUB      r2,r2,#1              ;573
000016  d1f7              BNE      |L49.8|
;;;575    }
000018  bd70              POP      {r4-r6,pc}
;;;576    
                          ENDP


                          AREA ||i.mem_set||, CODE, READONLY, ALIGN=1

                  mem_set PROC
;;;578    static
;;;579    void mem_set (void* dst, int val, UINT cnt) {
000000  b530              PUSH     {r4,r5,lr}
;;;580    	BYTE *d = (BYTE*)dst;
000002  4603              MOV      r3,r0
;;;581    
;;;582    	while (cnt--)
000004  e001              B        |L50.10|
                  |L50.6|
;;;583    		*d++ = (BYTE)val;
000006  f8031b01          STRB     r1,[r3],#1
                  |L50.10|
00000a  1e14              SUBS     r4,r2,#0              ;582
00000c  f1a20201          SUB      r2,r2,#1              ;582
000010  d1f9              BNE      |L50.6|
;;;584    }
000012  bd30              POP      {r4,r5,pc}
;;;585    
                          ENDP


                          AREA ||i.move_window||, CODE, READONLY, ALIGN=1

                  move_window PROC
;;;780    static
;;;781    FRESULT move_window (
000000  b570              PUSH     {r4-r6,lr}
;;;782    	FATFS* fs,		/* File system object */
;;;783    	DWORD sector	/* Sector number to make appearance in the fs->win[] */
;;;784    )
;;;785    {
000002  4604              MOV      r4,r0
000004  460d              MOV      r5,r1
;;;786    	if (sector != fs->winsect) {	/* Changed current window */
000006  6ae0              LDR      r0,[r4,#0x2c]
000008  42a8              CMP      r0,r5
00000a  d010              BEQ      |L51.46|
;;;787    #if !_FS_READONLY
;;;788    		if (sync_window(fs) != FR_OK)
00000c  4620              MOV      r0,r4
00000e  f7fffffe          BL       sync_window
000012  b108              CBZ      r0,|L51.24|
;;;789    			return FR_DISK_ERR;
000014  2001              MOVS     r0,#1
                  |L51.22|
;;;790    #endif
;;;791    		if (disk_read(fs->drv, fs->win, sector, 1))
;;;792    			return FR_DISK_ERR;
;;;793    		fs->winsect = sector;
;;;794    	}
;;;795    
;;;796    	return FR_OK;
;;;797    }
000016  bd70              POP      {r4-r6,pc}
                  |L51.24|
000018  7860              LDRB     r0,[r4,#1]            ;791
00001a  2301              MOVS     r3,#1                 ;791
00001c  462a              MOV      r2,r5                 ;791
00001e  f1040130          ADD      r1,r4,#0x30           ;791
000022  f7fffffe          BL       disk_read
000026  b108              CBZ      r0,|L51.44|
000028  2001              MOVS     r0,#1                 ;792
00002a  e7f4              B        |L51.22|
                  |L51.44|
00002c  62e5              STR      r5,[r4,#0x2c]         ;793
                  |L51.46|
00002e  2000              MOVS     r0,#0                 ;796
000030  e7f1              B        |L51.22|
;;;798    
                          ENDP


                          AREA ||i.pick_lfn||, CODE, READONLY, ALIGN=2

                  pick_lfn PROC
;;;1338   static
;;;1339   int pick_lfn (			/* 1:Succeeded, 0:Buffer overflow */
000000  b5f0              PUSH     {r4-r7,lr}
;;;1340   	WCHAR* lfnbuf,		/* Pointer to the Unicode-LFN buffer */
;;;1341   	BYTE* dir			/* Pointer to the directory entry */
;;;1342   )
;;;1343   {
000002  4603              MOV      r3,r0
;;;1344   	UINT i, s;
;;;1345   	WCHAR wc, uc;
;;;1346   
;;;1347   
;;;1348   	i = ((dir[LDIR_Ord] & 0x3F) - 1) * 13;	/* Offset in the LFN buffer */
000004  7808              LDRB     r0,[r1,#0]
000006  f000003f          AND      r0,r0,#0x3f
00000a  1e40              SUBS     r0,r0,#1
00000c  eb000780          ADD      r7,r0,r0,LSL #2
000010  eb0702c0          ADD      r2,r7,r0,LSL #3
;;;1349   
;;;1350   	s = 0; wc = 1;
000014  2500              MOVS     r5,#0
000016  2601              MOVS     r6,#1
;;;1351   	do {
000018  bf00              NOP      
                  |L52.26|
;;;1352   		uc = LD_WORD(dir+LfnOfs[s]);		/* Pick an LFN character from the entry */
00001a  4815              LDR      r0,|L52.112|
00001c  5d40              LDRB     r0,[r0,r5]
00001e  5c08              LDRB     r0,[r1,r0]
000020  4f13              LDR      r7,|L52.112|
000022  5d7f              LDRB     r7,[r7,r5]
000024  440f              ADD      r7,r7,r1
000026  787f              LDRB     r7,[r7,#1]
000028  ea402407          ORR      r4,r0,r7,LSL #8
;;;1353   		if (wc) {	/* Last character has not been processed */
00002c  b14e              CBZ      r6,|L52.66|
;;;1354   			if (i >= _MAX_LFN) return 0;	/* Buffer overflow? */
00002e  2aff              CMP      r2,#0xff
000030  d301              BCC      |L52.54|
000032  2000              MOVS     r0,#0
                  |L52.52|
;;;1355   			lfnbuf[i++] = wc = uc;			/* Store it */
;;;1356   		} else {
;;;1357   			if (uc != 0xFFFF) return 0;		/* Check filler */
;;;1358   		}
;;;1359   	} while (++s < 13);						/* Read all character in the entry */
;;;1360   
;;;1361   	if (dir[LDIR_Ord] & LLE) {				/* Put terminator if it is the last LFN part */
;;;1362   		if (i >= _MAX_LFN) return 0;		/* Buffer overflow? */
;;;1363   		lfnbuf[i] = 0;
;;;1364   	}
;;;1365   
;;;1366   	return 1;
;;;1367   }
000034  bdf0              POP      {r4-r7,pc}
                  |L52.54|
000036  4626              MOV      r6,r4                 ;1355
000038  4610              MOV      r0,r2                 ;1355
00003a  1c52              ADDS     r2,r2,#1              ;1355
00003c  f8234010          STRH     r4,[r3,r0,LSL #1]     ;1355
000040  e005              B        |L52.78|
                  |L52.66|
000042  f64f70ff          MOV      r0,#0xffff            ;1357
000046  4284              CMP      r4,r0                 ;1357
000048  d001              BEQ      |L52.78|
00004a  2000              MOVS     r0,#0                 ;1357
00004c  e7f2              B        |L52.52|
                  |L52.78|
00004e  1c68              ADDS     r0,r5,#1              ;1359
000050  4605              MOV      r5,r0                 ;1359
000052  280d              CMP      r0,#0xd               ;1359
000054  d3e1              BCC      |L52.26|
000056  7808              LDRB     r0,[r1,#0]            ;1361
000058  f0000040          AND      r0,r0,#0x40           ;1361
00005c  b130              CBZ      r0,|L52.108|
00005e  2aff              CMP      r2,#0xff              ;1362
000060  d301              BCC      |L52.102|
000062  2000              MOVS     r0,#0                 ;1362
000064  e7e6              B        |L52.52|
                  |L52.102|
000066  2000              MOVS     r0,#0                 ;1363
000068  f8230012          STRH     r0,[r3,r2,LSL #1]     ;1363
                  |L52.108|
00006c  2001              MOVS     r0,#1                 ;1366
00006e  e7e1              B        |L52.52|
;;;1368   
                          ENDP

                  |L52.112|
                          DCD      LfnOfs

                          AREA ||i.put_fat||, CODE, READONLY, ALIGN=1

                  put_fat PROC
;;;910    
;;;911    FRESULT put_fat (
000000  e92d47f0          PUSH     {r4-r10,lr}
;;;912    	FATFS* fs,	/* File system object */
;;;913    	DWORD clst,	/* Cluster# to be changed in range of 2 to fs->n_fatent - 1 */
;;;914    	DWORD val	/* New value to mark the cluster */
;;;915    )
;;;916    {
000004  4605              MOV      r5,r0
000006  460e              MOV      r6,r1
000008  4617              MOV      r7,r2
;;;917    	UINT bc;
;;;918    	BYTE *p;
;;;919    	FRESULT res;
;;;920    
;;;921    
;;;922    	if (clst < 2 || clst >= fs->n_fatent) {	/* Check range */
00000a  2e02              CMP      r6,#2
00000c  d302              BCC      |L53.20|
00000e  6968              LDR      r0,[r5,#0x14]
000010  42b0              CMP      r0,r6
000012  d802              BHI      |L53.26|
                  |L53.20|
;;;923    		res = FR_INT_ERR;
000014  f04f0802          MOV      r8,#2
000018  e08a              B        |L53.304|
                  |L53.26|
;;;924    
;;;925    	} else {
;;;926    		switch (fs->fs_type) {
00001a  7828              LDRB     r0,[r5,#0]
00001c  2801              CMP      r0,#1
00001e  d004              BEQ      |L53.42|
000020  2802              CMP      r0,#2
000022  d041              BEQ      |L53.168|
000024  2803              CMP      r0,#3
000026  d17d              BNE      |L53.292|
000028  e054              B        |L53.212|
                  |L53.42|
;;;927    		case FS_FAT12 :
;;;928    			bc = (UINT)clst; bc += bc / 2;
00002a  46b1              MOV      r9,r6
00002c  eb090959          ADD      r9,r9,r9,LSR #1
;;;929    			res = move_window(fs, fs->fatbase + (bc / SS(fs)));
000030  6a28              LDR      r0,[r5,#0x20]
000032  eb002159          ADD      r1,r0,r9,LSR #9
000036  4628              MOV      r0,r5
000038  f7fffffe          BL       move_window
00003c  4680              MOV      r8,r0
;;;930    			if (res != FR_OK) break;
00003e  f1b80f00          CMP      r8,#0
000042  d000              BEQ      |L53.70|
000044  e071              B        |L53.298|
                  |L53.70|
;;;931    			p = &fs->win[bc % SS(fs)];
000046  f3c90108          UBFX     r1,r9,#0,#9
00004a  f1050030          ADD      r0,r5,#0x30
00004e  180c              ADDS     r4,r1,r0
;;;932    			*p = (clst & 1) ? ((*p & 0x0F) | ((BYTE)val << 4)) : (BYTE)val;
000050  f0060001          AND      r0,r6,#1
000054  b120              CBZ      r0,|L53.96|
000056  b2f9              UXTB     r1,r7
000058  7820              LDRB     r0,[r4,#0]
00005a  f361101f          BFI      r0,r1,#4,#28
00005e  e000              B        |L53.98|
                  |L53.96|
000060  4638              MOV      r0,r7
                  |L53.98|
000062  7020              STRB     r0,[r4,#0]
;;;933    			bc++;
000064  f1090901          ADD      r9,r9,#1
;;;934    			fs->wflag = 1;
000068  2001              MOVS     r0,#1
00006a  7128              STRB     r0,[r5,#4]
;;;935    			res = move_window(fs, fs->fatbase + (bc / SS(fs)));
00006c  6a28              LDR      r0,[r5,#0x20]
00006e  eb002159          ADD      r1,r0,r9,LSR #9
000072  4628              MOV      r0,r5
000074  f7fffffe          BL       move_window
000078  4680              MOV      r8,r0
;;;936    			if (res != FR_OK) break;
00007a  f1b80f00          CMP      r8,#0
00007e  d000              BEQ      |L53.130|
000080  e053              B        |L53.298|
                  |L53.130|
;;;937    			p = &fs->win[bc % SS(fs)];
000082  f3c90108          UBFX     r1,r9,#0,#9
000086  f1050030          ADD      r0,r5,#0x30
00008a  180c              ADDS     r4,r1,r0
;;;938    			*p = (clst & 1) ? (BYTE)(val >> 4) : ((*p & 0xF0) | ((BYTE)(val >> 8) & 0x0F));
00008c  f0060001          AND      r0,r6,#1
000090  b110              CBZ      r0,|L53.152|
000092  f3c71007          UBFX     r0,r7,#4,#8
000096  e005              B        |L53.164|
                  |L53.152|
000098  7820              LDRB     r0,[r4,#0]
00009a  f00000f0          AND      r0,r0,#0xf0
00009e  f3c72103          UBFX     r1,r7,#8,#4
0000a2  4308              ORRS     r0,r0,r1
                  |L53.164|
0000a4  7020              STRB     r0,[r4,#0]
;;;939    			break;
0000a6  e040              B        |L53.298|
                  |L53.168|
;;;940    
;;;941    		case FS_FAT16 :
;;;942    			res = move_window(fs, fs->fatbase + (clst / (SS(fs) / 2)));
0000a8  6a28              LDR      r0,[r5,#0x20]
0000aa  eb002116          ADD      r1,r0,r6,LSR #8
0000ae  4628              MOV      r0,r5
0000b0  f7fffffe          BL       move_window
0000b4  4680              MOV      r8,r0
;;;943    			if (res != FR_OK) break;
0000b6  f1b80f00          CMP      r8,#0
0000ba  d000              BEQ      |L53.190|
0000bc  e035              B        |L53.298|
                  |L53.190|
;;;944    			p = &fs->win[clst * 2 % SS(fs)];
0000be  f24010ff          MOV      r0,#0x1ff
0000c2  ea000146          AND      r1,r0,r6,LSL #1
0000c6  f1050030          ADD      r0,r5,#0x30
0000ca  180c              ADDS     r4,r1,r0
;;;945    			ST_WORD(p, (WORD)val);
0000cc  7027              STRB     r7,[r4,#0]
0000ce  0a38              LSRS     r0,r7,#8
0000d0  7060              STRB     r0,[r4,#1]
;;;946    			break;
0000d2  e02a              B        |L53.298|
                  |L53.212|
;;;947    
;;;948    		case FS_FAT32 :
;;;949    			res = move_window(fs, fs->fatbase + (clst / (SS(fs) / 4)));
0000d4  6a28              LDR      r0,[r5,#0x20]
0000d6  eb0011d6          ADD      r1,r0,r6,LSR #7
0000da  4628              MOV      r0,r5
0000dc  f7fffffe          BL       move_window
0000e0  4680              MOV      r8,r0
;;;950    			if (res != FR_OK) break;
0000e2  f1b80f00          CMP      r8,#0
0000e6  d000              BEQ      |L53.234|
0000e8  e01f              B        |L53.298|
                  |L53.234|
;;;951    			p = &fs->win[clst * 4 % SS(fs)];
0000ea  f24010ff          MOV      r0,#0x1ff
0000ee  ea000186          AND      r1,r0,r6,LSL #2
0000f2  f1050030          ADD      r0,r5,#0x30
0000f6  180c              ADDS     r4,r1,r0
;;;952    			val |= LD_DWORD(p) & 0xF0000000;
0000f8  78e0              LDRB     r0,[r4,#3]
0000fa  0600              LSLS     r0,r0,#24
0000fc  78a1              LDRB     r1,[r4,#2]
0000fe  ea404001          ORR      r0,r0,r1,LSL #16
000102  7861              LDRB     r1,[r4,#1]
000104  ea402001          ORR      r0,r0,r1,LSL #8
000108  7821              LDRB     r1,[r4,#0]
00010a  4308              ORRS     r0,r0,r1
00010c  f0004070          AND      r0,r0,#0xf0000000
000110  4307              ORRS     r7,r7,r0
;;;953    			ST_DWORD(p, val);
000112  7027              STRB     r7,[r4,#0]
000114  0a38              LSRS     r0,r7,#8
000116  7060              STRB     r0,[r4,#1]
000118  0c38              LSRS     r0,r7,#16
00011a  70a0              STRB     r0,[r4,#2]
00011c  0e38              LSRS     r0,r7,#24
00011e  70e0              STRB     r0,[r4,#3]
;;;954    			break;
000120  e003              B        |L53.298|
000122  e7ff              B        |L53.292|
                  |L53.292|
;;;955    
;;;956    		default :
;;;957    			res = FR_INT_ERR;
000124  f04f0802          MOV      r8,#2
000128  bf00              NOP                            ;926
                  |L53.298|
00012a  bf00              NOP                            ;930
;;;958    		}
;;;959    		fs->wflag = 1;
00012c  2001              MOVS     r0,#1
00012e  7128              STRB     r0,[r5,#4]
                  |L53.304|
;;;960    	}
;;;961    
;;;962    	return res;
000130  4640              MOV      r0,r8
;;;963    }
000132  e8bd87f0          POP      {r4-r10,pc}
;;;964    #endif /* !_FS_READONLY */
                          ENDP


                          AREA ||i.putc_bfd||, CODE, READONLY, ALIGN=1

                  putc_bfd PROC
;;;4380   static
;;;4381   void putc_bfd (
000000  b5f8              PUSH     {r3-r7,lr}
;;;4382   	putbuff* pb,
;;;4383   	TCHAR c
;;;4384   )
;;;4385   {
000002  4604              MOV      r4,r0
000004  460e              MOV      r6,r1
;;;4386   	UINT bw;
;;;4387   	int i;
;;;4388   
;;;4389   
;;;4390   	if (_USE_STRFUNC == 2 && c == '\n')	 /* LF -> CRLF conversion */
000006  bf00              NOP      
;;;4391   		putc_bfd(pb, '\r');
;;;4392   
;;;4393   	i = pb->idx;	/* Buffer write index (-1:error) */
000008  6865              LDR      r5,[r4,#4]
;;;4394   	if (i < 0) return;
00000a  2d00              CMP      r5,#0
00000c  da00              BGE      |L54.16|
                  |L54.14|
;;;4395   
;;;4396   #if _USE_LFN && _LFN_UNICODE
;;;4397   #if _STRF_ENCODE == 3			/* Write a character in UTF-8 */
;;;4398   	if (c < 0x80) {				/* 7-bit */
;;;4399   		pb->buf[i++] = (BYTE)c;
;;;4400   	} else {
;;;4401   		if (c < 0x800) {		/* 11-bit */
;;;4402   			pb->buf[i++] = (BYTE)(0xC0 | c >> 6);
;;;4403   		} else {				/* 16-bit */
;;;4404   			pb->buf[i++] = (BYTE)(0xE0 | c >> 12);
;;;4405   			pb->buf[i++] = (BYTE)(0x80 | (c >> 6 & 0x3F));
;;;4406   		}
;;;4407   		pb->buf[i++] = (BYTE)(0x80 | (c & 0x3F));
;;;4408   	}
;;;4409   #elif _STRF_ENCODE == 2			/* Write a character in UTF-16BE */
;;;4410   	pb->buf[i++] = (BYTE)(c >> 8);
;;;4411   	pb->buf[i++] = (BYTE)c;
;;;4412   #elif _STRF_ENCODE == 1			/* Write a character in UTF-16LE */
;;;4413   	pb->buf[i++] = (BYTE)c;
;;;4414   	pb->buf[i++] = (BYTE)(c >> 8);
;;;4415   #else							/* Write a character in ANSI/OEM */
;;;4416   	c = ff_convert(c, 0);	/* Unicode -> OEM */
;;;4417   	if (!c) c = '?';
;;;4418   	if (c >= 0x100)
;;;4419   		pb->buf[i++] = (BYTE)(c >> 8);
;;;4420   	pb->buf[i++] = (BYTE)c;
;;;4421   #endif
;;;4422   #else							/* Write a character without conversion */
;;;4423   	pb->buf[i++] = (BYTE)c;
;;;4424   #endif
;;;4425   
;;;4426   	if (i >= (int)(sizeof pb->buf) - 3) {	/* Write buffered characters to the file */
;;;4427   		f_write(pb->fp, pb->buf, (UINT)i, &bw);
;;;4428   		i = (bw == (UINT)i) ? 0 : -1;
;;;4429   	}
;;;4430   	pb->idx = i;
;;;4431   	pb->nchr++;
;;;4432   }
00000e  bdf8              POP      {r3-r7,pc}
                  |L54.16|
000010  4628              MOV      r0,r5                 ;4423
000012  1c6d              ADDS     r5,r5,#1              ;4423
000014  f104010c          ADD      r1,r4,#0xc            ;4423
000018  540e              STRB     r6,[r1,r0]            ;4423
00001a  2d3d              CMP      r5,#0x3d              ;4426
00001c  db0c              BLT      |L54.56|
00001e  466b              MOV      r3,sp                 ;4427
000020  462a              MOV      r2,r5                 ;4427
000022  6820              LDR      r0,[r4,#0]            ;4427
000024  f7fffffe          BL       f_write
000028  9800              LDR      r0,[sp,#0]            ;4428
00002a  42a8              CMP      r0,r5                 ;4428
00002c  d101              BNE      |L54.50|
00002e  2000              MOVS     r0,#0                 ;4428
000030  e001              B        |L54.54|
                  |L54.50|
000032  f04f30ff          MOV      r0,#0xffffffff        ;4428
                  |L54.54|
000036  4605              MOV      r5,r0                 ;4428
                  |L54.56|
000038  6065              STR      r5,[r4,#4]            ;4430
00003a  68a0              LDR      r0,[r4,#8]            ;4431
00003c  1c40              ADDS     r0,r0,#1              ;4431
00003e  60a0              STR      r0,[r4,#8]            ;4431
000040  bf00              NOP      
000042  e7e4              B        |L54.14|
;;;4433   
                          ENDP


                          AREA ||i.remove_chain||, CODE, READONLY, ALIGN=1

                  remove_chain PROC
;;;973    static
;;;974    FRESULT remove_chain (
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;975    	FATFS* fs,			/* File system object */
;;;976    	DWORD clst			/* Cluster# to remove a chain from */
;;;977    )
;;;978    {
000004  4604              MOV      r4,r0
000006  460e              MOV      r6,r1
;;;979    	FRESULT res;
;;;980    	DWORD nxt;
;;;981    #if _USE_ERASE
;;;982    	DWORD scl = clst, ecl = clst, rt[2];
;;;983    #endif
;;;984    
;;;985    	if (clst < 2 || clst >= fs->n_fatent) {	/* Check range */
000008  2e02              CMP      r6,#2
00000a  d302              BCC      |L55.18|
00000c  6960              LDR      r0,[r4,#0x14]
00000e  42b0              CMP      r0,r6
000010  d801              BHI      |L55.22|
                  |L55.18|
;;;986    		res = FR_INT_ERR;
000012  2702              MOVS     r7,#2
000014  e027              B        |L55.102|
                  |L55.22|
;;;987    
;;;988    	} else {
;;;989    		res = FR_OK;
000016  2700              MOVS     r7,#0
;;;990    		while (clst < fs->n_fatent) {			/* Not a last link? */
000018  e021              B        |L55.94|
                  |L55.26|
;;;991    			nxt = get_fat(fs, clst);			/* Get cluster status */
00001a  4631              MOV      r1,r6
00001c  4620              MOV      r0,r4
00001e  f7fffffe          BL       get_fat
000022  4605              MOV      r5,r0
;;;992    			if (nxt == 0) break;				/* Empty cluster? */
000024  b905              CBNZ     r5,|L55.40|
000026  e01d              B        |L55.100|
                  |L55.40|
;;;993    			if (nxt == 1) { res = FR_INT_ERR; break; }	/* Internal error? */
000028  2d01              CMP      r5,#1
00002a  d101              BNE      |L55.48|
00002c  2702              MOVS     r7,#2
00002e  e019              B        |L55.100|
                  |L55.48|
;;;994    			if (nxt == 0xFFFFFFFF) { res = FR_DISK_ERR; break; }	/* Disk error? */
000030  1c68              ADDS     r0,r5,#1
000032  b908              CBNZ     r0,|L55.56|
000034  2701              MOVS     r7,#1
000036  e015              B        |L55.100|
                  |L55.56|
;;;995    			res = put_fat(fs, clst, 0);			/* Mark the cluster "empty" */
000038  2200              MOVS     r2,#0
00003a  4631              MOV      r1,r6
00003c  4620              MOV      r0,r4
00003e  f7fffffe          BL       put_fat
000042  4607              MOV      r7,r0
;;;996    			if (res != FR_OK) break;
000044  b107              CBZ      r7,|L55.72|
000046  e00d              B        |L55.100|
                  |L55.72|
;;;997    			if (fs->free_clust != 0xFFFFFFFF) {	/* Update FSINFO */
000048  6920              LDR      r0,[r4,#0x10]
00004a  1c40              ADDS     r0,r0,#1
00004c  b130              CBZ      r0,|L55.92|
;;;998    				fs->free_clust++;
00004e  6920              LDR      r0,[r4,#0x10]
000050  1c40              ADDS     r0,r0,#1
000052  6120              STR      r0,[r4,#0x10]
;;;999    				fs->fsi_flag |= 1;
000054  7960              LDRB     r0,[r4,#5]
000056  f0400001          ORR      r0,r0,#1
00005a  7160              STRB     r0,[r4,#5]
                  |L55.92|
;;;1000   			}
;;;1001   #if _USE_ERASE
;;;1002   			if (ecl + 1 == nxt) {	/* Is next cluster contiguous? */
;;;1003   				ecl = nxt;
;;;1004   			} else {				/* End of contiguous clusters */ 
;;;1005   				rt[0] = clust2sect(fs, scl);					/* Start sector */
;;;1006   				rt[1] = clust2sect(fs, ecl) + fs->csize - 1;	/* End sector */
;;;1007   				disk_ioctl(fs->drv, CTRL_ERASE_SECTOR, rt);		/* Erase the block */
;;;1008   				scl = ecl = nxt;
;;;1009   			}
;;;1010   #endif
;;;1011   			clst = nxt;	/* Next cluster */
00005c  462e              MOV      r6,r5
                  |L55.94|
00005e  6960              LDR      r0,[r4,#0x14]         ;990
000060  42b0              CMP      r0,r6                 ;990
000062  d8da              BHI      |L55.26|
                  |L55.100|
000064  bf00              NOP                            ;992
                  |L55.102|
;;;1012   		}
;;;1013   	}
;;;1014   
;;;1015   	return res;
000066  4638              MOV      r0,r7
;;;1016   }
000068  e8bd81f0          POP      {r4-r8,pc}
;;;1017   #endif
                          ENDP


                          AREA ||i.st_clust||, CODE, READONLY, ALIGN=1

                  st_clust PROC
;;;1285   static
;;;1286   void st_clust (
000000  7681              STRB     r1,[r0,#0x1a]
;;;1287   	BYTE* dir,	/* Pointer to the directory entry */
;;;1288   	DWORD cl	/* Value to be set */
;;;1289   )
;;;1290   {
;;;1291   	ST_WORD(dir+DIR_FstClusLO, cl);
000002  0a0b              LSRS     r3,r1,#8
000004  76c3              STRB     r3,[r0,#0x1b]
;;;1292   	ST_WORD(dir+DIR_FstClusHI, cl >> 16);
000006  0c0a              LSRS     r2,r1,#16
000008  7502              STRB     r2,[r0,#0x14]
00000a  0e0b              LSRS     r3,r1,#24
00000c  7543              STRB     r3,[r0,#0x15]
;;;1293   }
00000e  4770              BX       lr
;;;1294   #endif
                          ENDP


                          AREA ||i.sum_sfn||, CODE, READONLY, ALIGN=1

                  sum_sfn PROC
;;;1468   static
;;;1469   BYTE sum_sfn (
000000  b530              PUSH     {r4,r5,lr}
;;;1470   	const BYTE* dir		/* Pointer to the SFN entry */
;;;1471   )
;;;1472   {
000002  4601              MOV      r1,r0
;;;1473   	BYTE sum = 0;
000004  2000              MOVS     r0,#0
;;;1474   	UINT n = 11;
000006  220b              MOVS     r2,#0xb
;;;1475   
;;;1476   	do sum = (sum >> 1) + (sum << 7) + *dir++; while (--n);
000008  bf00              NOP      
                  |L57.10|
00000a  1043              ASRS     r3,r0,#1
00000c  eb0314c0          ADD      r4,r3,r0,LSL #7
000010  f8115b01          LDRB     r5,[r1],#1
000014  1963              ADDS     r3,r4,r5
000016  b2d8              UXTB     r0,r3
000018  1e53              SUBS     r3,r2,#1
00001a  1e1a              SUBS     r2,r3,#0
00001c  d1f5              BNE      |L57.10|
;;;1477   	return sum;
;;;1478   }
00001e  bd30              POP      {r4,r5,pc}
;;;1479   #endif
                          ENDP


                          AREA ||i.sync_fs||, CODE, READONLY, ALIGN=1

                  sync_fs PROC
;;;806    static
;;;807    FRESULT sync_fs (	/* FR_OK: successful, FR_DISK_ERR: failed */
000000  b570              PUSH     {r4-r6,lr}
;;;808    	FATFS* fs		/* File system object */
;;;809    )
;;;810    {
000002  4604              MOV      r4,r0
;;;811    	FRESULT res;
;;;812    
;;;813    
;;;814    	res = sync_window(fs);
000004  4620              MOV      r0,r4
000006  f7fffffe          BL       sync_window
00000a  4605              MOV      r5,r0
;;;815    	if (res == FR_OK) {
00000c  2d00              CMP      r5,#0
00000e  d159              BNE      |L58.196|
;;;816    		/* Update FSINFO sector if needed */
;;;817    		if (fs->fs_type == FS_FAT32 && fs->fsi_flag == 1) {
000010  7820              LDRB     r0,[r4,#0]
000012  2803              CMP      r0,#3
000014  d14f              BNE      |L58.182|
000016  7960              LDRB     r0,[r4,#5]
000018  2801              CMP      r0,#1
00001a  d14c              BNE      |L58.182|
;;;818    			/* Create FSINFO structure */
;;;819    			mem_set(fs->win, 0, SS(fs));
00001c  0242              LSLS     r2,r0,#9
00001e  2100              MOVS     r1,#0
000020  f1040030          ADD      r0,r4,#0x30
000024  f7fffffe          BL       mem_set
;;;820    			ST_WORD(fs->win+BS_55AA, 0xAA55);
000028  2155              MOVS     r1,#0x55
00002a  f884122e          STRB     r1,[r4,#0x22e]
00002e  21aa              MOVS     r1,#0xaa
000030  f884122f          STRB     r1,[r4,#0x22f]
;;;821    			ST_DWORD(fs->win+FSI_LeadSig, 0x41615252);
000034  2052              MOVS     r0,#0x52
000036  f8840030          STRB     r0,[r4,#0x30]
00003a  2152              MOVS     r1,#0x52
00003c  2031              MOVS     r0,#0x31
00003e  5501              STRB     r1,[r0,r4]
000040  2161              MOVS     r1,#0x61
000042  2032              MOVS     r0,#0x32
000044  5501              STRB     r1,[r0,r4]
000046  2141              MOVS     r1,#0x41
000048  2033              MOVS     r0,#0x33
00004a  5501              STRB     r1,[r0,r4]
;;;822    			ST_DWORD(fs->win+FSI_StrucSig, 0x61417272);
00004c  2172              MOVS     r1,#0x72
00004e  f8841214          STRB     r1,[r4,#0x214]
000052  f8841215          STRB     r1,[r4,#0x215]
000056  2141              MOVS     r1,#0x41
000058  f8841216          STRB     r1,[r4,#0x216]
00005c  2161              MOVS     r1,#0x61
00005e  f8841217          STRB     r1,[r4,#0x217]
;;;823    			ST_DWORD(fs->win+FSI_Free_Count, fs->free_clust);
000062  7c21              LDRB     r1,[r4,#0x10]
000064  f8841218          STRB     r1,[r4,#0x218]
000068  8a20              LDRH     r0,[r4,#0x10]
00006a  0a01              LSRS     r1,r0,#8
00006c  f8841219          STRB     r1,[r4,#0x219]
000070  6920              LDR      r0,[r4,#0x10]
000072  0c01              LSRS     r1,r0,#16
000074  f884121a          STRB     r1,[r4,#0x21a]
000078  6920              LDR      r0,[r4,#0x10]
00007a  0e01              LSRS     r1,r0,#24
00007c  f884121b          STRB     r1,[r4,#0x21b]
;;;824    			ST_DWORD(fs->win+FSI_Nxt_Free, fs->last_clust);
000080  7b21              LDRB     r1,[r4,#0xc]
000082  f884121c          STRB     r1,[r4,#0x21c]
000086  89a0              LDRH     r0,[r4,#0xc]
000088  0a01              LSRS     r1,r0,#8
00008a  f884121d          STRB     r1,[r4,#0x21d]
00008e  68e0              LDR      r0,[r4,#0xc]
000090  0c01              LSRS     r1,r0,#16
000092  f884121e          STRB     r1,[r4,#0x21e]
000096  68e0              LDR      r0,[r4,#0xc]
000098  0e01              LSRS     r1,r0,#24
00009a  f884121f          STRB     r1,[r4,#0x21f]
;;;825    			/* Write it into the FSINFO sector */
;;;826    			fs->winsect = fs->volbase + 1;
00009e  69e0              LDR      r0,[r4,#0x1c]
0000a0  1c40              ADDS     r0,r0,#1
0000a2  62e0              STR      r0,[r4,#0x2c]
;;;827    			disk_write(fs->drv, fs->win, fs->winsect, 1);
0000a4  7860              LDRB     r0,[r4,#1]
0000a6  2301              MOVS     r3,#1
0000a8  f1040130          ADD      r1,r4,#0x30
0000ac  6ae2              LDR      r2,[r4,#0x2c]
0000ae  f7fffffe          BL       disk_write
;;;828    			fs->fsi_flag = 0;
0000b2  2000              MOVS     r0,#0
0000b4  7160              STRB     r0,[r4,#5]
                  |L58.182|
;;;829    		}
;;;830    		/* Make sure that no pending write process in the physical drive */
;;;831    		if (disk_ioctl(fs->drv, CTRL_SYNC, 0) != RES_OK)
0000b6  7860              LDRB     r0,[r4,#1]
0000b8  2200              MOVS     r2,#0
0000ba  4611              MOV      r1,r2
0000bc  f7fffffe          BL       disk_ioctl
0000c0  b100              CBZ      r0,|L58.196|
;;;832    			res = FR_DISK_ERR;
0000c2  2501              MOVS     r5,#1
                  |L58.196|
;;;833    	}
;;;834    
;;;835    	return res;
0000c4  4628              MOV      r0,r5
;;;836    }
0000c6  bd70              POP      {r4-r6,pc}
;;;837    #endif
                          ENDP


                          AREA ||i.sync_window||, CODE, READONLY, ALIGN=1

                  sync_window PROC
;;;754    static
;;;755    FRESULT sync_window (
000000  b570              PUSH     {r4-r6,lr}
;;;756    	FATFS* fs		/* File system object */
;;;757    )
;;;758    {
000002  4604              MOV      r4,r0
;;;759    	DWORD wsect;
;;;760    	UINT nf;
;;;761    
;;;762    
;;;763    	if (fs->wflag) {	/* Write back the sector if it is dirty */
000004  7920              LDRB     r0,[r4,#4]
000006  b1f8              CBZ      r0,|L59.72|
;;;764    		wsect = fs->winsect;	/* Current sector number */
000008  6ae5              LDR      r5,[r4,#0x2c]
;;;765    		if (disk_write(fs->drv, fs->win, wsect, 1))
00000a  7860              LDRB     r0,[r4,#1]
00000c  2301              MOVS     r3,#1
00000e  462a              MOV      r2,r5
000010  f1040130          ADD      r1,r4,#0x30
000014  f7fffffe          BL       disk_write
000018  b108              CBZ      r0,|L59.30|
;;;766    			return FR_DISK_ERR;
00001a  2001              MOVS     r0,#1
                  |L59.28|
;;;767    		fs->wflag = 0;
;;;768    		if (wsect - fs->fatbase < fs->fsize) {		/* Is it in the FAT area? */
;;;769    			for (nf = fs->n_fats; nf >= 2; nf--) {	/* Reflect the change to all FAT copies */
;;;770    				wsect += fs->fsize;
;;;771    				disk_write(fs->drv, fs->win, wsect, 1);
;;;772    			}
;;;773    		}
;;;774    	}
;;;775    	return FR_OK;
;;;776    }
00001c  bd70              POP      {r4-r6,pc}
                  |L59.30|
00001e  2000              MOVS     r0,#0                 ;767
000020  7120              STRB     r0,[r4,#4]            ;767
000022  6a20              LDR      r0,[r4,#0x20]         ;768
000024  1a28              SUBS     r0,r5,r0              ;768
000026  69a1              LDR      r1,[r4,#0x18]         ;768
000028  4288              CMP      r0,r1                 ;768
00002a  d20d              BCS      |L59.72|
00002c  78e6              LDRB     r6,[r4,#3]            ;769
00002e  e009              B        |L59.68|
                  |L59.48|
000030  69a0              LDR      r0,[r4,#0x18]         ;770
000032  4405              ADD      r5,r5,r0              ;770
000034  7860              LDRB     r0,[r4,#1]            ;771
000036  2301              MOVS     r3,#1                 ;771
000038  462a              MOV      r2,r5                 ;771
00003a  f1040130          ADD      r1,r4,#0x30           ;771
00003e  f7fffffe          BL       disk_write
000042  1e76              SUBS     r6,r6,#1              ;769
                  |L59.68|
000044  2e02              CMP      r6,#2                 ;769
000046  d2f3              BCS      |L59.48|
                  |L59.72|
000048  2000              MOVS     r0,#0                 ;775
00004a  e7e7              B        |L59.28|
;;;777    #endif
                          ENDP


                          AREA ||i.validate||, CODE, READONLY, ALIGN=1

                  validate PROC
;;;2333   static
;;;2334   FRESULT validate (	/* FR_OK(0): The object is valid, !=0: Invalid */
000000  b570              PUSH     {r4-r6,lr}
;;;2335   	void* obj		/* Pointer to the object FIL/DIR to check validity */
;;;2336   )
;;;2337   {
000002  4605              MOV      r5,r0
;;;2338   	FIL *fil = (FIL*)obj;	/* Assuming offset of .fs and .id in the FIL/DIR structure is identical */
000004  462c              MOV      r4,r5
;;;2339   
;;;2340   
;;;2341   	if (!fil || !fil->fs || !fil->fs->fs_type || fil->fs->id != fil->id)
000006  b14c              CBZ      r4,|L60.28|
000008  6820              LDR      r0,[r4,#0]
00000a  b138              CBZ      r0,|L60.28|
00000c  6820              LDR      r0,[r4,#0]
00000e  7800              LDRB     r0,[r0,#0]
000010  b120              CBZ      r0,|L60.28|
000012  6820              LDR      r0,[r4,#0]
000014  88c0              LDRH     r0,[r0,#6]
000016  88a1              LDRH     r1,[r4,#4]
000018  4288              CMP      r0,r1
00001a  d001              BEQ      |L60.32|
                  |L60.28|
;;;2342   		return FR_INVALID_OBJECT;
00001c  2009              MOVS     r0,#9
                  |L60.30|
;;;2343   
;;;2344   	ENTER_FF(fil->fs);		/* Lock file system */
;;;2345   
;;;2346   	if (disk_status(fil->fs->drv) & STA_NOINIT)
;;;2347   		return FR_NOT_READY;
;;;2348   
;;;2349   	return FR_OK;
;;;2350   }
00001e  bd70              POP      {r4-r6,pc}
                  |L60.32|
000020  6821              LDR      r1,[r4,#0]            ;2346
000022  7848              LDRB     r0,[r1,#1]            ;2346
000024  f7fffffe          BL       disk_status
000028  f0000001          AND      r0,r0,#1              ;2346
00002c  b108              CBZ      r0,|L60.50|
00002e  2003              MOVS     r0,#3                 ;2347
000030  e7f5              B        |L60.30|
                  |L60.50|
000032  2000              MOVS     r0,#0                 ;2349
000034  e7f3              B        |L60.30|
;;;2351   
                          ENDP


                          AREA ||.bss||, DATA, NOINIT, ALIGN=2

                  FatFs
                          %        12

                          AREA ||.constdata||, DATA, READONLY, ALIGN=1

                  LfnOfs
000000  01030507          DCB      0x01,0x03,0x05,0x07
000004  090e1012          DCB      0x09,0x0e,0x10,0x12
000008  1416181c          DCB      0x14,0x16,0x18,0x1c
00000c  1e00              DCB      0x1e,0x00
                  vst
00000e  0400              DCW      0x0400
000010  02000100          DCW      0x0200,0x0100
000014  00800040          DCW      0x0080,0x0040
000018  00200010          DCW      0x0020,0x0010
00001c  00080004          DCW      0x0008,0x0004
000020  00020000          DCW      0x0002,0x0000
                  ||cst||
000024  80004000          DCW      0x8000,0x4000
000028  20001000          DCW      0x2000,0x1000
00002c  08004000          DCW      0x0800,0x4000
000030  20001000          DCW      0x2000,0x1000
000034  08000400          DCW      0x0800,0x0400
000038  0200              DCW      0x0200

                          AREA ||.data||, DATA, ALIGN=1

                  Fsid
000000  0000              DCB      0x00,0x00
